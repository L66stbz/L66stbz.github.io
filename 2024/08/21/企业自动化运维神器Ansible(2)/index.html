<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>企业自动化运维神器Ansible(2) | L66</title><meta name="description" content="Ansible-playbook(2)12345678910111213141516171819202122232425group模块参数：name参数：必须参数，用于指定组名称。state参数：用于指定组的状态，两个值可选，present，absent，默认为 present，设置为absent 表示删除组。gid参数：用于指定组的gid。如果不指定为随机system参数:如果是yes为系统组。"><meta name="keywords" content="Linux,Ansible"><meta name="author" content="L66"><meta name="copyright" content="L66"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/3.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="企业自动化运维神器Ansible(2)"><meta name="twitter:description" content="Ansible-playbook(2)12345678910111213141516171819202122232425group模块参数：name参数：必须参数，用于指定组名称。state参数：用于指定组的状态，两个值可选，present，absent，默认为 present，设置为absent 表示删除组。gid参数：用于指定组的gid。如果不指定为随机system参数:如果是yes为系统组。"><meta name="twitter:image" content="https://l66stbz.github.io/2024/08/21/企业自动化运维神器Ansible(2)/1.png"><meta property="og:type" content="article"><meta property="og:title" content="企业自动化运维神器Ansible(2)"><meta property="og:url" content="https://l66stbz.github.io/2024/08/21/%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E7%A5%9E%E5%99%A8Ansible(2)/"><meta property="og:site_name" content="L66"><meta property="og:description" content="Ansible-playbook(2)12345678910111213141516171819202122232425group模块参数：name参数：必须参数，用于指定组名称。state参数：用于指定组的状态，两个值可选，present，absent，默认为 present，设置为absent 表示删除组。gid参数：用于指定组的gid。如果不指定为随机system参数:如果是yes为系统组。"><meta property="og:image" content="https://l66stbz.github.io/2024/08/21/企业自动化运维神器Ansible(2)/1.png"><meta property="article:published_time" content="2024-08-21T13:50:00.000Z"><meta property="article:modified_time" content="2024-08-24T12:37:54.914Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://l66stbz.github.io/2024/08/21/%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E7%A5%9E%E5%99%A8Ansible(2)/"><link rel="prev" title="企业级Zabbix监控平台" href="https://l66stbz.github.io/2024/08/23/%E4%BC%81%E4%B8%9A%E7%BA%A7Zabbix%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0/"><link rel="next" title="企业自动化运维神器Ansible(1)" href="https://l66stbz.github.io/2024/08/20/%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E7%A5%9E%E5%99%A8Ansible(1)/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="APlayer.min.css"><div id="aplayer"></div><script src="https://cdn.jsdelivr.net/gh/radium-bit/res@master/live2d/autoload.js" async></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js" async></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="L66" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/2.jpg" onerror="onerror=null;src='/img/2.jpg'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">55</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">35</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Photo</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Ansible-playbook-2"><span class="toc-number">1.</span> <span class="toc-text">Ansible-playbook(2)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Role角色"><span class="toc-number">1.1.</span> <span class="toc-text">Role角色</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目实战：通过ansible上线"><span class="toc-number">1.2.</span> <span class="toc-text">项目实战：通过ansible上线</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#批量部署Jdk-Tomcat"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">批量部署Jdk+Tomcat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#批量部署Jenkins"><span class="toc-number">1.2.0.2.</span> <span class="toc-text">批量部署Jenkins</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#批量部署Jdk-Tomcat-Jenkins"><span class="toc-number">1.2.0.3.</span> <span class="toc-text">批量部署Jdk+Tomcat+Jenkins</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#剧本实现批量部署Jdk-Tomcat-Jenkins"><span class="toc-number">1.2.0.4.</span> <span class="toc-text">剧本实现批量部署Jdk+Tomcat+Jenkins</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#剧本实现编译安装nginx"><span class="toc-number">1.2.0.5.</span> <span class="toc-text">剧本实现编译安装nginx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#剧本实现mysql登陆、修改密码、刷新权限、建库和导入数据"><span class="toc-number">1.2.0.6.</span> <span class="toc-text">剧本实现mysql登陆、修改密码、刷新权限、建库和导入数据</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://l66stbz.github.io/2024/08/21/企业自动化运维神器Ansible(2)/1.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">L66</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Photo</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">企业自动化运维神器Ansible(2)</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2024-08-21 21:50:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2024-08-21</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2024-08-24 20:37:54"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2024-08-24</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Ansible-playbook-2"><a href="#Ansible-playbook-2" class="headerlink" title="Ansible-playbook(2)"></a>Ansible-playbook(2)</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">group模块参数：</span><br><span class="line">name参数：必须参数，用于指定组名称。</span><br><span class="line">state参数：用于指定组的状态，两个值可选，present，absent，默认为 present，设置为absent 表示删除组。</span><br><span class="line">gid参数：用于指定组的gid。如果不指定为随机</span><br><span class="line">system参数:如果是yes为系统组。--可选</span><br><span class="line">=========================================================================================</span><br><span class="line">1.创建多个play</span><br><span class="line">[root@ansible ~]# cd /etc/ansible/</span><br><span class="line">[root@ansible ansible]# vim play.yml</span><br><span class="line">- hosts: webservers1</span><br><span class="line">  user: root</span><br><span class="line">  tasks:</span><br><span class="line">  - name: create a group</span><br><span class="line">    group: name=mygrp gid=2003 system=true</span><br><span class="line">  - name: create a user</span><br><span class="line">    user: name=tom group=mygrp system=true</span><br><span class="line"></span><br><span class="line">- hosts: webservers2</span><br><span class="line">  user: root</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install apache</span><br><span class="line">    yum: name=httpd state=latest</span><br><span class="line">  - name: start httpd service</span><br><span class="line">    service: name=httpd state=started</span><br><span class="line">=========================================================================================</span><br></pre></td></tr></table></figure>

<p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1569479193759.png" alt="1569479193759"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">检查并执行</span><br><span class="line">[root@ansible ansible]# ansible-playbook --syntax-check play.yml</span><br><span class="line">[root@ansible ansible]# ansible-playbook play.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">2.条件执行when模块</span><br><span class="line">先判断when条件是否成立</span><br><span class="line">[root@ansible ansible]# cat /etc/ansible/hosts</span><br><span class="line">[webservers1]</span><br><span class="line">ansible-web1</span><br><span class="line">ansible-web2</span><br><span class="line"></span><br><span class="line">[root@ansible ansible]# vim when.yml</span><br><span class="line">- hosts: webservers1</span><br><span class="line">  user: root</span><br><span class="line">  tasks:</span><br><span class="line">  - name: use when</span><br><span class="line">    file: state=touch path=/tmp/when.txt</span><br><span class="line">  - name: insert data</span><br><span class="line">    shell: echo 123 &gt;&gt; /tmp/when.txt          #2在执行这个模块命令</span><br><span class="line">    when: ansible_hostname == "ansible-web1"  #1.先条件执行，先判断when是否成立，如果成立则执行上面命令,ansible-web1指的是被控节点上真正的主机名称</span><br></pre></td></tr></table></figure>

<p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1569480152773.png" alt="1569480152773"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">执行</span><br><span class="line">[root@ansible ansible]# ansible-playbook when.yml</span><br><span class="line">[root@ansible-web1 ~]# cat /tmp/when.txt</span><br><span class="line">123</span><br><span class="line">[root@ansible-web2 ~]# cat /tmp/when.txt</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">3.使用变量并不显示搜集主机相关信息</span><br><span class="line">gather_facts参数：指定了在任务部分执行前，是否先执行setup模块获取主机相关信息，默认值为true，改成false之后在执行过程中不会搜集主机相关信息。</span><br><span class="line">==========================================================================================================</span><br><span class="line">[root@ansible ansible]# vim create_user.yml</span><br><span class="line">- hosts: ansible-web1</span><br><span class="line">  user: root</span><br><span class="line">  gather_facts: false  #是否执行setup模块，搜集对方机器的信息</span><br><span class="line">  vars:                #自定义变量</span><br><span class="line">  - user: "jack"       #user是自定义变量名称，“jack”是变量值</span><br><span class="line">  - src_path: "/root/a.txt"    #同上</span><br><span class="line">  - dest_path: "/mnt/"</span><br><span class="line">  tasks:</span><br><span class="line">  - name: create user</span><br><span class="line">    user: name=&#123;&#123; user &#125;&#125;</span><br><span class="line">  - name: copy file</span><br><span class="line">    copy: src=&#123;&#123; src_path &#125;&#125; dest=&#123;&#123; dest_path &#125;&#125;</span><br><span class="line"></span><br><span class="line">[root@ansible ansible]# vim /root/a.txt  #创建测试文件</span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1569482053656.png" alt="1569482053656"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">执行：</span><br><span class="line">[root@ansible ansible]# ansible-playbook create_user.yml</span><br></pre></td></tr></table></figure>

<h2 id="Role角色"><a href="#Role角色" class="headerlink" title="Role角色"></a>Role角色</h2><p>roles则是在ansible中，playbooks的目录组织结构。而模块化之后，成为roles的组织结构，易读，代码可重用，层次清晰。</p>
<p>实战目标：通过role远程部署nginx并配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">两台机器配置本地解析</span><br><span class="line">[root@ansible-server ~]# vim /etc/hosts</span><br><span class="line">192.168.1.9    ansible-server</span><br><span class="line">192.168.1.13   ansible-web4</span><br><span class="line">[root@ansible-web4 ~]# vim /etc/hosts</span><br><span class="line">192.168.1.9    ansible-server</span><br><span class="line">192.168.1.13   ansible-web4</span><br><span class="line">添加主机组</span><br><span class="line">[root@ansible-server ansible]# pwd</span><br><span class="line">/etc/ansible</span><br><span class="line">[root@ansible-server ansible]# vim hosts</span><br><span class="line">[webservers4]</span><br><span class="line">ansible-web4</span><br><span class="line">配置免密登录：</span><br><span class="line">[root@ansible-server ~]# ssh-copy-id -i 192.168.1.13</span><br></pre></td></tr></table></figure>

<p>1.目录结构：</p>
<img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1567322212880.png" alt="1567322212880" style="zoom:50%;">

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">目录顺序:</span><br><span class="line">role_name/     ---角色名称=目录</span><br><span class="line">    files/：存储一些可以用copy调用的静态文件。</span><br><span class="line">    tasks/： 存储任务的目录,此目录中至少应该有一个名为main.yml的文件，用于定义各task；其它的文件需要由main.yml进行“包含”调用； </span><br><span class="line">    handlers/:此目录中至少应该有一个名为main.yml的文件，用于定义各handler；其它的文件需要由（与notify:名字相同，方便notify通知执行下一条命令）通过main.yml进行“包含”调用； </span><br><span class="line">    vars/：此目录中至少应该有一个名为main.yml的文件，用于定义各variable；其它的文件需要由main.yml进行“包含”调用； </span><br><span class="line">    templates/：存储由template模块调用的模板文本； （也可以调用变量）</span><br><span class="line">    site.yml：定义哪个主机应用哪个角色</span><br><span class="line">=========================================================================================</span><br><span class="line">1.准备目录结构</span><br><span class="line">[root@ansible-server ~]# cd /etc/ansible/roles/  #roles为自带目录，如果不存在可以创建</span><br><span class="line">[root@ansible-server roles]# mkdir nginx/&#123;files,handlers,tasks,templates,vars&#125; -p</span><br><span class="line">2.创建文件</span><br><span class="line">[root@ansible-server roles]# touch site.yml nginx/&#123;handlers,tasks,vars&#125;/main.yml</span><br><span class="line">[root@ansible-server roles]# yum install -y tree</span><br></pre></td></tr></table></figure>

<p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1567322899375.png" alt="1567322899375"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.创建nginx的测试文件</span><br><span class="line">[root@ansible-server roles]# echo 1234 &gt; nginx/files/index.html</span><br><span class="line">2.安装nginx并配置模板</span><br><span class="line">[root@ansible-server roles]# yum install -y nginx &amp;&amp; cp /etc/nginx/nginx.conf nginx/templates/nginx.conf.j2</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">3.编写任务</span><br><span class="line">[root@ansible-server roles]# vim nginx/tasks/main.yml</span><br><span class="line">---</span><br><span class="line">- name: install epel</span><br><span class="line">  yum: name=epel-release state=latest</span><br><span class="line">- name: install nginx</span><br><span class="line">  yum: name=nginx state=latest</span><br><span class="line">- name: copy nginx.conf templte</span><br><span class="line">  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line">- name: copy index.html</span><br><span class="line">  copy: src=/etc/ansible/roles/nginx/files/index.html dest=/usr/share/nginx/html/index.html</span><br><span class="line">  notify: start nginx</span><br></pre></td></tr></table></figure>

<p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1567329259385.png" alt="1567329259385"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">4.准备配置文件</span><br><span class="line">[root@ansible-server roles]# vim nginx/templates/nginx.conf.j2</span><br><span class="line">修改成如下内容。自定义变量</span><br></pre></td></tr></table></figure>

<p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1567324084045.png" alt="1567324084045"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">5.编写变量</span><br><span class="line">[root@ansible-server roles]# vim nginx/vars/main.yml  #添加如下内容</span><br><span class="line">worker_connections: 2</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">6.编写handlers</span><br><span class="line">[root@ansible-server roles]# vim nginx/handlers/main.yml #编写如下内容</span><br><span class="line">---</span><br><span class="line">- name: start nginx  #和notify的名字必须一样</span><br><span class="line">  service: name=nginx state=started</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">7.编写剧本</span><br><span class="line">[root@ansible-server roles]# vim site.yml</span><br><span class="line">---</span><br><span class="line">- hosts: webservers4</span><br><span class="line">  user: root</span><br><span class="line">  roles:</span><br><span class="line">   - nginx</span><br></pre></td></tr></table></figure>

<p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1567325911030.png" alt="1567325911030"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">检测语法</span><br><span class="line">[root@ansible-server roles]# ansible-playbook site.yml --syntax-check</span><br><span class="line">playbook: site.yml</span><br><span class="line">执行剧本：</span><br><span class="line">[root@ansible-server roles]# ansible-playbook site.yml</span><br></pre></td></tr></table></figure>

<p>查看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible-web4 ~]# netstat -lntp </span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      3102/nginx: master  </span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      926/sshd            </span><br><span class="line">tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1007/master         </span><br><span class="line">tcp6       0      0 :::80                   :::*                    LISTEN      3102/nginx: master  </span><br><span class="line">tcp6       0      0 :::22                   :::*                    LISTEN      926/sshd            </span><br><span class="line">tcp6       0      0 ::1:25                  :::*                    LISTEN      1007/master         </span><br><span class="line">[root@ansible-web4 ~]# cat /etc/nginx/nginx.conf | grep pro</span><br><span class="line"><span class="meta">#</span><span class="bash">worker_processes auto;</span></span><br><span class="line">worker_processes 2;</span><br></pre></td></tr></table></figure>

<p>访问：</p>
<p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1567329307179.png" alt="1567329307179"></p>
<h2 id="项目实战：通过ansible上线"><a href="#项目实战：通过ansible上线" class="headerlink" title="项目实战：通过ansible上线"></a>项目实战：通过ansible上线</h2><h4 id="批量部署Jdk-Tomcat"><a href="#批量部署Jdk-Tomcat" class="headerlink" title="批量部署Jdk+Tomcat"></a>批量部署Jdk+Tomcat</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible-server src]# cat tomcat.yml</span><br><span class="line">- hosts: webservers</span><br><span class="line">  user: root</span><br><span class="line">  tasks:</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#配置JDK，上传jdk、tomcat的安装包到/usr/src</span></span></span><br><span class="line">  - name: configure Jdk1.8</span><br><span class="line">    copy: src=/usr/src/jdk-8u211-linux-x64.tar.gz  dest=/usr/src</span><br><span class="line">  - name: unzip</span><br><span class="line">    shell: tar -xvzf /usr/src/jdk-8u211-linux-x64.tar.gz -C /usr/local</span><br><span class="line">  - name: rename to java</span><br><span class="line">    shell: mv /usr/local/jdk1.8.0_211 /usr/local/java</span><br><span class="line">  - name: configure envirement1</span><br><span class="line">    shell: echo "JAVA_HOME=/usr/local/java" &gt;&gt; /etc/profile</span><br><span class="line">  - name: configure envirement2</span><br><span class="line">    shell: echo 'PATH=$JAVA_HOME/bin:$PATH' &gt;&gt; /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#Tomcat</span></span></span><br><span class="line">  - name: copy tomcat</span><br><span class="line">    copy: src=/usr/src/apache-tomcat-8.5.45.tar.gz dest=/usr/src</span><br><span class="line">  - name: unzip tomcat</span><br><span class="line">    shell: tar -xvzf /usr/src/apache-tomcat-8.5.45.tar.gz -C /usr/local</span><br><span class="line">  - name: rename to tomcat</span><br><span class="line">    shell: mv /usr/local/apache-tomcat-8.5.45 /usr/local/tomcat</span><br><span class="line">  - name: copy startup file</span><br><span class="line">    copy:  src=/usr/src/startup.sh dest=/usr/local/tomcat/bin</span><br><span class="line">    notify: start tomcat</span><br><span class="line">  handlers:</span><br><span class="line">  - name: start tomcat</span><br><span class="line">    shell: nohup /usr/local/tomcat/bin/startup.sh &amp;</span><br><span class="line">[root@java-server src]# ls</span><br><span class="line">apache-tomcat-8.5.45         debug                       kernels     tomcat.retry</span><br><span class="line">apache-tomcat-8.5.45.tar.gz  jdk-8u211-linux-x64.tar.gz  startup.sh  tomcat.yml</span><br><span class="line">[root@java-server src]# head -2 startup.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<h4 id="批量部署Jenkins"><a href="#批量部署Jenkins" class="headerlink" title="批量部署Jenkins"></a>批量部署Jenkins</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">项目描述：</span><br><span class="line">1.准备两台机器，一台作为nginx代理。一台为tomcat服务器。</span><br><span class="line">2.tomcat服务器手动部署tomcat服务，并将webapps目录下面的内容提前删掉。</span><br><span class="line">3.将jenkins.war包上传到nginx服务器。通过ansible将war包拷贝过去。并启动tomcat</span><br><span class="line">4.配置nginx反向代理tomcat，实现访问jenkins。</span><br><span class="line">操作如下:</span><br><span class="line">一、tomcat服务器</span><br><span class="line">1.安装jdk与tomcat略。</span><br><span class="line">2.添加tomcat启动脚本中添加环境变量</span><br><span class="line">[root@ansible-web2 ~]# vim /usr/local/tomcat/bin/startup.sh  #需要添加如下内容</span><br><span class="line">source /etc/profile</span><br><span class="line">====================================</span><br><span class="line">二、nginx服务器：</span><br><span class="line">1.安装nginx与ansible，上传jenkins的war包略。</span><br><span class="line">2.ansible配置如下：</span><br><span class="line">3.定义变量：</span><br><span class="line">[root@ansible ~]# cd /etc/ansible/</span><br><span class="line">[root@ansible ansible]# mkdir vars</span><br><span class="line">[root@ansible ansible]# vim vars/path.yml</span><br><span class="line">src_path: /root/jenkins.war</span><br><span class="line">dest_path: /usr/local/tomcat/webapps/</span><br><span class="line"></span><br><span class="line">4.配置playbook：</span><br><span class="line">[root@ansible ansible]# vim jenkins.yml</span><br><span class="line">- hosts: webserver2</span><br><span class="line">  user: root</span><br><span class="line">  vars_files:</span><br><span class="line">   - /etc/ansible/vars/path.yml</span><br><span class="line">  tasks:</span><br><span class="line">  - name: copy jenkins.war</span><br><span class="line">    copy: src=&#123;&#123; src_path &#125;&#125; dest=&#123;&#123; dest_path &#125;&#125;</span><br><span class="line">  - name: start tomcat</span><br><span class="line">    shell: nohup /usr/local/tomcat/bin/startup.sh &amp;</span><br><span class="line">[root@ansible ansible]# ansible-playbook jenkins.yml</span><br><span class="line"></span><br><span class="line">5.配置nginx反向代理</span><br><span class="line">[root@ansible ansible]# vim /etc/nginx/conf.d/jenkins.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    charset koi8-r;</span><br><span class="line">    access_log  /var/log/nginx/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location /jenkins &#123;</span><br><span class="line">        proxy_pass http://192.168.62.181:8080;</span><br><span class="line">        proxy_set_header Host $host:$server_port;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">6.启动nginx</span><br><span class="line">7.检查nginx与tomcat是否启动成功！</span><br><span class="line">8.访问nginx服务器http://ip/jenkins。</span><br></pre></td></tr></table></figure>

<h4 id="批量部署Jdk-Tomcat-Jenkins"><a href="#批量部署Jdk-Tomcat-Jenkins" class="headerlink" title="批量部署Jdk+Tomcat+Jenkins"></a>批量部署Jdk+Tomcat+Jenkins</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">将Jdk、Tomcat、Jenkins的安装包上传到ansbile控制节点的/usr/src下</span><br><span class="line">[root@ansible ansible]# ls /usr/src/</span><br></pre></td></tr></table></figure>

<p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1583207321017.png" alt="1583207321017"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@java-server ansible]# head -2 /usr/src/startup.sh 	//startup.sh是tomcat的启动脚本</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">source /etc/profile    #加上此行，是为了启动加载到环境变量</span><br></pre></td></tr></table></figure>

<p>下面是变量文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">变量文件</span><br><span class="line">[root@ansible ansible]# cat /etc/ansible/vars/file.yml</span><br></pre></td></tr></table></figure>

<p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1583207590404.png" alt="1583207590404"></p>
<p>下面是剧本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ansible]# cat jenkins.yml</span><br><span class="line">- hosts: ansible-web1</span><br><span class="line">  user: root</span><br><span class="line">  vars_files:</span><br><span class="line">  - /etc/ansible/vars/file.yml</span><br><span class="line">  tasks:</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#配置JDK，上传jdk、tomcat的安装包到/usr/src</span></span></span><br><span class="line">  - name: configure JDK1.8</span><br><span class="line">    copy: src=&#123;&#123; src_jdk_path &#125;&#125;  dest=&#123;&#123; dest_jdk_path &#125;&#125;</span><br><span class="line">  - name: unzip JDK</span><br><span class="line">    shell: tar -xvzf /usr/src/jdk-8u211-linux-x64.tar.gz -C /usr/local</span><br><span class="line">  - name: rename to java</span><br><span class="line">    shell: mv /usr/local/jdk1.8.0_211 /usr/local/java</span><br><span class="line">  - name: configure JDK envirement1</span><br><span class="line">    shell: echo "JAVA_HOME=/usr/local/java" &gt;&gt; /etc/profile</span><br><span class="line">  - name: configure JDK envirement2</span><br><span class="line">    shell: echo 'PATH=$JAVA_HOME/bin:$PATH' &gt;&gt; /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#Tomcat</span></span></span><br><span class="line">  - name: copy tomcat</span><br><span class="line">    copy: src=&#123;&#123; src_tomcat_path &#125;&#125; dest=&#123;&#123; dest_tomcat_path &#125;&#125;</span><br><span class="line">  - name: unzip tomcat</span><br><span class="line">    shell: tar -xvzf /usr/src/apache-tomcat-8.5.45.tar.gz -C /usr/local</span><br><span class="line">  - name: rename to tomcat</span><br><span class="line">    shell: mv /usr/local/apache-tomcat-8.5.45 /usr/local/tomcat</span><br><span class="line">  - name: copy startup file</span><br><span class="line">    copy: src=/usr/src/startup.sh dest=/usr/local/tomcat/bin</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#Jenkins</span></span></span><br><span class="line">  - name: copy jenkins</span><br><span class="line">    copy: src=/usr/src/jenkins.war  dest=/usr/local/tomcat/webapps/</span><br><span class="line">    notify: start jenkins</span><br><span class="line">  handlers:</span><br><span class="line">  - name: start jenkins</span><br><span class="line">    shell: nohup /usr/local/tomcat/bin/startup.sh &amp;</span><br></pre></td></tr></table></figure>





<h4 id="剧本实现批量部署Jdk-Tomcat-Jenkins"><a href="#剧本实现批量部署Jdk-Tomcat-Jenkins" class="headerlink" title="剧本实现批量部署Jdk+Tomcat+Jenkins"></a>剧本实现批量部署Jdk+Tomcat+Jenkins</h4><p>l66：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: webservers</span><br><span class="line">  user: root</span><br><span class="line">  vars: </span><br><span class="line">        install_dir: "/usr/local"</span><br><span class="line">  tasks: </span><br><span class="line">    - name: 解压安装到目标主机路径</span><br><span class="line">      unarchive: src=&#123;&#123; item &#125;&#125; dest=&#123;&#123; install_dir &#125;&#125;</span><br><span class="line">      loop: </span><br><span class="line">        - /opt/apache-tomcat-8.5.45.tar.gz</span><br><span class="line">        - /opt/jdk-8u211-linux-x64.tar.gz</span><br><span class="line"></span><br><span class="line">    - name: tomcat目录改名</span><br><span class="line">      shell: mv &#123;&#123; install_dir &#125;&#125;/apache-tomcat-8.5.45  &#123;&#123; install_dir &#125;&#125;/tomcat</span><br><span class="line">    - name: jdk目录改名</span><br><span class="line">      shell: mv &#123;&#123; install_dir &#125;&#125;/jdk1.8.0_211   &#123;&#123; install_dir &#125;&#125;/java</span><br><span class="line"></span><br><span class="line">    - name: 声明jdk环境变量</span><br><span class="line">      copy:</span><br><span class="line">        content: |</span><br><span class="line">         JAVA_HOME=/usr/local/java</span><br><span class="line">         PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">        dest: /etc/profile.d/java.sh</span><br><span class="line"></span><br><span class="line">    - name: 上限Jenkins</span><br><span class="line">      copy: src=/opt/jenkins.war dest=/usr/local/tomcat/webapps</span><br><span class="line"></span><br><span class="line">    - name: 重新加载环境变量，并启动Tomcat</span><br><span class="line">      shell: source /etc/profile.d/java.sh &amp;&amp; nohup /usr/local/tomcat/bin/startup.sh &amp;</span><br></pre></td></tr></table></figure>



<p>ming：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: web01</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: 解压安装包到目标主机</span><br><span class="line">      unarchive: src=&#123;&#123; item &#125;&#125; dest=/usr/local/</span><br><span class="line">      loop:</span><br><span class="line">       - /opt/jdk-8u211-linux-x64.tar.gz</span><br><span class="line">       - /opt/apache-tomcat-8.5.45.tar.gz</span><br><span class="line">    </span><br><span class="line">    - name: 声明jdk变量</span><br><span class="line">      copy: </span><br><span class="line">        content: |</span><br><span class="line">          JAVA_HOME=/usr/local/jdk1.8.0_211</span><br><span class="line">          PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">        dest: /etc/profile.d/jdk.sh</span><br><span class="line">    </span><br><span class="line">    - name: 上线jenkins</span><br><span class="line">      copy: src=/root/jenkins.war  dest=/usr/local/apache-tomcat-8.5.45/webapps</span><br><span class="line">      notify: start tomcat</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">  - name: start tomcat</span><br><span class="line">    shell: source /etc/profile.d/jdk.sh &amp;&amp; nohup /usr/local/apache-tomcat-8.5.45/bin/startup.sh &amp;</span><br></pre></td></tr></table></figure>

<h4 id="剧本实现编译安装nginx"><a href="#剧本实现编译安装nginx" class="headerlink" title="剧本实现编译安装nginx"></a>剧本实现编译安装nginx</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: web09</span><br><span class="line">  user: root</span><br><span class="line">  vars:</span><br><span class="line">        install_dir: "/usr/local"</span><br><span class="line">  tasks: </span><br><span class="line">    - name: 安装编译环境</span><br><span class="line">      yum: name=&#123;&#123; item &#125;&#125; state=present</span><br><span class="line">      loop: </span><br><span class="line">        - gcc</span><br><span class="line">        - gcc-c++</span><br><span class="line">        - pcre</span><br><span class="line">        - pcre-devel</span><br><span class="line">        - openssl</span><br><span class="line">        - openssl-devel</span><br><span class="line">        - zlib</span><br><span class="line">        - zlib-devel</span><br><span class="line">    </span><br><span class="line">    - name: 创建用户nginx</span><br><span class="line">      user: name=nginx state=present shell=/sbin/nologin</span><br><span class="line"></span><br><span class="line">    - name: 解压安装包</span><br><span class="line">      unarchive: src=/opt/nginx-1.24.0.tar.gz dest=&#123;&#123; install_dir &#125;&#125;</span><br><span class="line"></span><br><span class="line">    - name: 编译安装</span><br><span class="line">      shell: cd /usr/local/nginx-1.24.0/ &amp;&amp; ./configure --prefix=/usr/local/nginx --group=nginx --user=nginx --sbin-path=/usr/local/nginx/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/tmp/nginx/client_body --http-proxy-temp-path=/tmp/nginx/proxy --http-fastcgi-temp-path=/tmp/nginx/fastcgi --pid-path=/var/run/nginx.pid --lock-path=/var/lock/nginx --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-http_realip_module --with-stream  &amp;&amp;  make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">    - name: 创建目录/tmp/nginx</span><br><span class="line">      file: path=/tmp/nginx state=directory</span><br><span class="line"></span><br><span class="line">    - name: 配置systemd启动脚本</span><br><span class="line">      copy: </span><br><span class="line">        content: |</span><br><span class="line">         <span class="section">[Unit]</span></span><br><span class="line">         Description=nginx - high performance web server</span><br><span class="line">         Documentation=http://nginx.org/en/docs/</span><br><span class="line">         After=network-online.target remote-fs.target nss-lookup.target</span><br><span class="line">         Wants=network-online.target</span><br><span class="line"></span><br><span class="line">         <span class="section">[Service]</span></span><br><span class="line">         Type=forking</span><br><span class="line">         PIDFile=/var/run/nginx.pid</span><br><span class="line">         ExecStart=/usr/local/nginx/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class="line">         ExecReload=/bin/sh -c "/bin/kill -s HUP \$(/bin/cat /var/run/nginx.pid)"</span><br><span class="line">         ExecStop=/bin/sh -c "/bin/kill -s TERM \$(/bin/cat /var/run/nginx.pid)"</span><br><span class="line"></span><br><span class="line">         <span class="section">[Install]</span></span><br><span class="line">         WantedBy=multi-user.target </span><br><span class="line">        dest: /lib/systemd/system/nginx.service</span><br><span class="line"></span><br><span class="line">    - name: 启动nginx</span><br><span class="line">      service: name=nginx state=started enabled=yes</span><br></pre></td></tr></table></figure>

<h4 id="剧本实现mysql登陆、修改密码、刷新权限、建库和导入数据"><a href="#剧本实现mysql登陆、修改密码、刷新权限、建库和导入数据" class="headerlink" title="剧本实现mysql登陆、修改密码、刷新权限、建库和导入数据"></a>剧本实现mysql登陆、修改密码、刷新权限、建库和导入数据</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: web09</span><br><span class="line">  user: root</span><br><span class="line">  vars:</span><br><span class="line">    root_password: "1"</span><br><span class="line">    new_password: "ldqldq666"</span><br><span class="line">    db_name: "ruoyi"</span><br><span class="line">    db_charset: "utf8mb4" </span><br><span class="line">  tasks:</span><br><span class="line">    - name: 修改mysql密码并设置允许远程连接</span><br><span class="line">      mysql_user:</span><br><span class="line">        name: root</span><br><span class="line">        host: '%'</span><br><span class="line">        password: "&#123;&#123; new_password &#125;&#125;"</span><br><span class="line">        priv: '*.*:ALL,GRANT'</span><br><span class="line">        state: present</span><br><span class="line">        login_user: root</span><br><span class="line">        login_password: "&#123;&#123; root_password &#125;&#125;"</span><br><span class="line"></span><br><span class="line">    - name: 刷新权限</span><br><span class="line">      mysql_db:</span><br><span class="line">        name: mysql</span><br><span class="line">        state: import</span><br><span class="line">        target: /dev/null</span><br><span class="line">        login_user: root</span><br><span class="line">        login_password: "&#123;&#123; new_password &#125;&#125;"</span><br><span class="line">      ignore_errors: yes</span><br><span class="line"></span><br><span class="line">    - name: 重启mysql</span><br><span class="line">      service:</span><br><span class="line">        name: mysqld</span><br><span class="line">        state: restarted</span><br><span class="line"></span><br><span class="line">    - name: 创建ruoyi数据库</span><br><span class="line">      mysql_db:</span><br><span class="line">        name: "&#123;&#123; db_name &#125;&#125;"</span><br><span class="line">        encoding: "&#123;&#123; db_charset &#125;&#125;"</span><br><span class="line">        state: present</span><br><span class="line">        login_user: root</span><br><span class="line">        login_password: "&#123;&#123; new_password &#125;&#125;"</span><br><span class="line"></span><br><span class="line">    - name: 导入数据</span><br><span class="line">      shell: mysql -uroot -p'&#123;&#123; new_password  &#125;&#125;'  ruoyi &lt; /root/RuoYi-Vue/sql/ry_20240629.sql</span><br></pre></td></tr></table></figure>

</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">L66</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://l66stbz.github.io/2024/08/21/%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E7%A5%9E%E5%99%A8Ansible(2)/">https://l66stbz.github.io/2024/08/21/%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E7%A5%9E%E5%99%A8Ansible(2)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://l66stbz.github.io" target="_blank">L66</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/Ansible/">Ansible</a></div><div class="post_share"><div class="social-share" data-image="https://l66stbz.github.io/2024/09/09/若依项目动静分离/若依项目动静分离项目实现/6.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2024/08/23/%E4%BC%81%E4%B8%9A%E7%BA%A7Zabbix%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0/"><img class="prev_cover" src="https://l66stbz.github.io/2024/08/23/企业级Zabbix监控平台/1.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">企业级Zabbix监控平台</div></div></a></div><div class="next-post pull_right"><a href="/2024/08/20/%E4%BC%81%E4%B8%9A%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E7%A5%9E%E5%99%A8Ansible(1)/"><img class="next_cover" src="https://l66stbz.github.io/2024/08/20/企业自动化运维神器Ansible(1)/1.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">企业自动化运维神器Ansible(1)</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2024/08/20/企业自动化运维神器Ansible(1)/" title="企业自动化运维神器Ansible(1)"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/08/20/企业自动化运维神器Ansible(1)/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-08-20</div><div class="relatedPosts_title">企业自动化运维神器Ansible(1)</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/03/study/test/" title="study"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/03/study/test/1.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-03</div><div class="relatedPosts_title">study</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/06/Jenkins结合Ansible/Jenkins结合Ansible实战/" title="Jenkins结合Ansible实战"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/06/Jenkins结合Ansible/Jenkins结合Ansible实战/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-06</div><div class="relatedPosts_title">Jenkins结合Ansible实战</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/05/Jenkins_CI_CD应用/Jenkins_CI_CD应用/" title="Jenkins_CI_CD应用"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/05/Jenkins_CI_CD应用/Jenkins_CI_CD应用/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-05</div><div class="relatedPosts_title">Jenkins_CI_CD应用</div></div></a></div><div class="relatedPosts_item"><a href="/2024/05/17/安装zabbix前端包问题/" title="安装zabbix前端包问题"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/05/17/安装zabbix前端包问题/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-05-17</div><div class="relatedPosts_title">安装zabbix前端包问题</div></div></a></div><div class="relatedPosts_item"><a href="/2024/05/21/Keepalived/" title="Keepalived"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/05/21/Keepalived/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-05-21</div><div class="relatedPosts_title">Keepalived</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By L66</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/js/third-party/click_heart.js"></script></body></html>