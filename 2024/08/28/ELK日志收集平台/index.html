<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ELK日志收集平台 | L66</title><meta name="description" content="[TOC] 1、日志收集所解决的问题 ⽣产环境出现问题后，需要查看各种⽇志进⾏分析排错； 日常运维工作，日志文件分散，运维工作繁琐。可以实现日志聚合； 开发⼈员没有登陆服务器的权限。开发人员可以通过web界面查看日志； 面对大量的访问日志，可以统计出各项指标，比如PV UV。2、 Elastic Stack 组件介绍   Elasticsearch（简称ES）是一个分布式、RESTful风格的开源"><meta name="keywords" content="Linux,ELK"><meta name="author" content="L66"><meta name="copyright" content="L66"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/3.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="ELK日志收集平台"><meta name="twitter:description" content="[TOC] 1、日志收集所解决的问题 ⽣产环境出现问题后，需要查看各种⽇志进⾏分析排错； 日常运维工作，日志文件分散，运维工作繁琐。可以实现日志聚合； 开发⼈员没有登陆服务器的权限。开发人员可以通过web界面查看日志； 面对大量的访问日志，可以统计出各项指标，比如PV UV。2、 Elastic Stack 组件介绍   Elasticsearch（简称ES）是一个分布式、RESTful风格的开源"><meta name="twitter:image" content="https://l66stbz.github.io/2024/08/28/ELK日志收集平台/1.png"><meta property="og:type" content="article"><meta property="og:title" content="ELK日志收集平台"><meta property="og:url" content="https://l66stbz.github.io/2024/08/28/ELK%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0/"><meta property="og:site_name" content="L66"><meta property="og:description" content="[TOC] 1、日志收集所解决的问题 ⽣产环境出现问题后，需要查看各种⽇志进⾏分析排错； 日常运维工作，日志文件分散，运维工作繁琐。可以实现日志聚合； 开发⼈员没有登陆服务器的权限。开发人员可以通过web界面查看日志； 面对大量的访问日志，可以统计出各项指标，比如PV UV。2、 Elastic Stack 组件介绍   Elasticsearch（简称ES）是一个分布式、RESTful风格的开源"><meta property="og:image" content="https://l66stbz.github.io/2024/08/28/ELK日志收集平台/1.png"><meta property="article:published_time" content="2024-08-28T13:50:00.000Z"><meta property="article:modified_time" content="2024-08-31T02:30:55.772Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://l66stbz.github.io/2024/08/28/ELK%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0/"><link rel="prev" title="IPtables" href="https://l66stbz.github.io/2024/09/02/IPtables/iptables/"><link rel="next" title="Zabbix告警媒介" href="https://l66stbz.github.io/2024/08/27/Zabbix%E5%91%8A%E8%AD%A6%E5%AA%92%E4%BB%8B/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="APlayer.min.css"><div id="aplayer"></div><script src="https://cdn.jsdelivr.net/gh/radium-bit/res@master/live2d/autoload.js" async></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js" async></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="L66" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/2.jpg" onerror="onerror=null;src='/img/2.jpg'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">54</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">35</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Photo</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、日志收集所解决的问题"><span class="toc-number">1.</span> <span class="toc-text">1、日志收集所解决的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、-Elastic-Stack-组件介绍"><span class="toc-number">2.</span> <span class="toc-text">2、 Elastic Stack 组件介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、安装JAVA环境（所有es节点，logstash节点，kinbana节点）"><span class="toc-number">3.</span> <span class="toc-text">一、安装JAVA环境（所有es节点，logstash节点，kinbana节点）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、-安装ES集群"><span class="toc-number">4.</span> <span class="toc-text">二、 安装ES集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、单节点部署"><span class="toc-number">4.1.</span> <span class="toc-text">1、单节点部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、ES-JAVA调优-堆-heap-内存大小"><span class="toc-number">4.2.</span> <span class="toc-text">2、ES JAVA调优 堆(heap)内存大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、部署ES集群"><span class="toc-number">4.3.</span> <span class="toc-text">3、部署ES集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、Logstash安装（elk02）"><span class="toc-number">5.</span> <span class="toc-text">四、Logstash安装（elk02）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、Filebeat安装（elk01）"><span class="toc-number">6.</span> <span class="toc-text">五、Filebeat安装（elk01）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、Filebeat架构"><span class="toc-number">6.0.1.</span> <span class="toc-text">1、Filebeat架构</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、Filebeat日志收集"><span class="toc-number">7.</span> <span class="toc-text">六、Filebeat日志收集</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、Filebeat标准输入和输出"><span class="toc-number">7.0.1.</span> <span class="toc-text">1、Filebeat标准输入和输出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、-Filebeat-基于Log类型进行输入"><span class="toc-number">7.0.2.</span> <span class="toc-text">2、 Filebeat 基于Log类型进行输入</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-Filebeat-基于Log类型进行输入并且自定义字段"><span class="toc-number">7.0.2.1.</span> <span class="toc-text">2.1 Filebeat 基于Log类型进行输入并且自定义字段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-Filebeat-基于Log类型进行输入并且自定义Tags"><span class="toc-number">7.0.2.2.</span> <span class="toc-text">2.2 Filebeat 基于Log类型进行输入并且自定义Tags</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-offset偏移量概念"><span class="toc-number">7.0.2.3.</span> <span class="toc-text">2.3 offset偏移量概念</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-Filebeat-基于Log类型进行输入实现日志删除"><span class="toc-number">7.0.2.4.</span> <span class="toc-text">2.4 Filebeat 基于Log类型进行输入实现日志删除</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-Filebeat-基于Log类型进行输入实现匹配日志输出"><span class="toc-number">7.0.2.5.</span> <span class="toc-text">2.5 Filebeat 基于Log类型进行输入实现匹配日志输出</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-6-include-lines和exclude-lines优先级"><span class="toc-number">7.0.2.6.</span> <span class="toc-text">2.6 include_lines和exclude_lines优先级</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-7-Nginx-error日志过滤处理实战"><span class="toc-number">7.0.2.7.</span> <span class="toc-text">2.7 Nginx error日志过滤处理实战</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-8-Filebeat输出数据至Elasticsearch集群"><span class="toc-number">7.0.2.8.</span> <span class="toc-text">2.8 Filebeat输出数据至Elasticsearch集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-9-Filebeat输出数据至Elasticsearch集群并自定义单个索引"><span class="toc-number">7.0.2.9.</span> <span class="toc-text">2.9 Filebeat输出数据至Elasticsearch集群并自定义单个索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-10-Filebeat输出数据至Elasticsearch集群并自定义多个索引"><span class="toc-number">7.0.2.10.</span> <span class="toc-text">2.10 Filebeat输出数据至Elasticsearch集群并自定义多个索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-11-Filebeat输出数据至Elasticsearch集群并设定副本分片"><span class="toc-number">7.0.2.11.</span> <span class="toc-text">2.11 Filebeat输出数据至Elasticsearch集群并设定副本分片</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-12-FIlebeat-收集JSON格式的nginx访问日志"><span class="toc-number">7.0.2.12.</span> <span class="toc-text">2.12 FIlebeat 收集JSON格式的nginx访问日志</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七、Logstash-日志收集"><span class="toc-number">8.</span> <span class="toc-text">七、Logstash 日志收集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、Logstash安装"><span class="toc-number">8.1.</span> <span class="toc-text">1、Logstash安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2、Logstash-标准输入输出"><span class="toc-number">8.1.1.</span> <span class="toc-text">2、Logstash 标准输入输出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、Logstash基于File的形式进行input"><span class="toc-number">8.1.2.</span> <span class="toc-text">3、Logstash基于File的形式进行input</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4、Logstash基于Filebeat形式进行input"><span class="toc-number">8.1.3.</span> <span class="toc-text">4、Logstash基于Filebeat形式进行input</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5、Logstash基于ES形式进行output"><span class="toc-number">8.1.4.</span> <span class="toc-text">5、Logstash基于ES形式进行output</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6、Logstash-grok插件使用"><span class="toc-number">8.1.5.</span> <span class="toc-text">6、Logstash grok插件使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-1-Logstash-内置正则使用"><span class="toc-number">8.1.5.1.</span> <span class="toc-text">6.1 Logstash 内置正则使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-Logstash基于内置正则实现日志结构化"><span class="toc-number">8.1.5.2.</span> <span class="toc-text">6.2 Logstash基于内置正则实现日志结构化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-4-Logstash删除指定字段"><span class="toc-number">8.1.5.3.</span> <span class="toc-text">6.4 Logstash删除指定字段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-5-Logstash-添加指定字段"><span class="toc-number">8.1.5.4.</span> <span class="toc-text">6.5 Logstash 添加指定字段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-6-Logstash-自定义Tags"><span class="toc-number">8.1.5.5.</span> <span class="toc-text">6.6 Logstash 自定义Tags</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7、Logstash-geoip插件分析用户IP所属地"><span class="toc-number">8.1.6.</span> <span class="toc-text">7、Logstash geoip插件分析用户IP所属地</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8、Logstash-useragent插件分析用户客户端类型"><span class="toc-number">8.1.7.</span> <span class="toc-text">8、Logstash useragent插件分析用户客户端类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9、Logstash-Filter多if分支"><span class="toc-number">8.1.8.</span> <span class="toc-text">9、Logstash Filter多if分支</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#八、Kibana操作使用"><span class="toc-number">9.</span> <span class="toc-text">八、Kibana操作使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、kibana手动创建索引模板"><span class="toc-number">9.1.</span> <span class="toc-text">1、kibana手动创建索引模板</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#九、kafka简介和使用"><span class="toc-number">10.</span> <span class="toc-text">九、kafka简介和使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、MQ两种模式"><span class="toc-number">10.1.</span> <span class="toc-text">1、MQ两种模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-P2P模式"><span class="toc-number">10.1.1.</span> <span class="toc-text">1.1 P2P模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-1-架构图"><span class="toc-number">10.1.1.1.</span> <span class="toc-text">1.1.1 架构图</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-2-简介"><span class="toc-number">10.1.1.2.</span> <span class="toc-text">1.1.2 简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-3-工作流程"><span class="toc-number">10.1.1.3.</span> <span class="toc-text">1.1.3 工作流程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-发布-订阅模式"><span class="toc-number">10.1.2.</span> <span class="toc-text">1.2 发布&#x2F;订阅模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1-架构图"><span class="toc-number">10.1.2.1.</span> <span class="toc-text">1.2.1 架构图</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2-简介"><span class="toc-number">10.1.2.2.</span> <span class="toc-text">1.2.2 简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-3-工作流程"><span class="toc-number">10.1.2.3.</span> <span class="toc-text">1.2.3 工作流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、kafka相关概念"><span class="toc-number">10.2.</span> <span class="toc-text">2、kafka相关概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-介绍"><span class="toc-number">10.2.1.</span> <span class="toc-text">2.1 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-Kafka相关专业术语"><span class="toc-number">10.2.2.</span> <span class="toc-text">2.2 Kafka相关专业术语</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、Zookeeper使用和配置"><span class="toc-number">10.3.</span> <span class="toc-text">3、Zookeeper使用和配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-简介："><span class="toc-number">10.3.1.</span> <span class="toc-text">3.1 简介：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-zookeeper集群部署：三节点😀"><span class="toc-number">10.3.2.</span> <span class="toc-text">3.2 zookeeper集群部署：三节点😀</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-Zookeeper角色划分"><span class="toc-number">10.3.3.</span> <span class="toc-text">3.3 Zookeeper角色划分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-zookeeper配置内存堆栈"><span class="toc-number">10.3.4.</span> <span class="toc-text">3.4 zookeeper配置内存堆栈</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、kafka集群安装：三节点😀"><span class="toc-number">10.4.</span> <span class="toc-text">4、kafka集群安装：三节点😀</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、Kafka-Topic日常操作"><span class="toc-number">10.5.</span> <span class="toc-text">5、Kafka Topic日常操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-查看Topic相关信息"><span class="toc-number">10.5.1.</span> <span class="toc-text">5.1 查看Topic相关信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-创建Topic"><span class="toc-number">10.5.2.</span> <span class="toc-text">5.2 创建Topic</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6、Filebeat收集日志至Kafka"><span class="toc-number">10.6.</span> <span class="toc-text">6、Filebeat收集日志至Kafka</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7、Logstash收集Kafka-Topic日志"><span class="toc-number">10.7.</span> <span class="toc-text">7、Logstash收集Kafka Topic日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十、Elasticsearch-Restful风格API实战"><span class="toc-number">11.</span> <span class="toc-text">十、Elasticsearch Restful风格API实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、ES集群状态"><span class="toc-number">11.1.</span> <span class="toc-text">1、ES集群状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、Elasticsearch术语"><span class="toc-number">11.2.</span> <span class="toc-text">2、Elasticsearch术语</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1、Elasticsearch分片分配的基本策略"><span class="toc-number">11.2.1.</span> <span class="toc-text">2.1、Elasticsearch分片分配的基本策略</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://l66stbz.github.io/2024/08/28/ELK日志收集平台/1.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">L66</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Photo</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">ELK日志收集平台</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2024-08-28 21:50:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2024-08-28</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2024-08-31 10:30:55"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2024-08-31</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p>[TOC]</p>
<h2 id="1、日志收集所解决的问题"><a href="#1、日志收集所解决的问题" class="headerlink" title="1、日志收集所解决的问题"></a>1、日志收集所解决的问题</h2><ol>
<li>⽣产环境出现问题后，需要查看各种⽇志进⾏分析排错；</li>
<li>日常运维工作，日志文件分散，运维工作繁琐。可以实现日志聚合；</li>
<li>开发⼈员没有登陆服务器的权限。开发人员可以通过web界面查看日志；</li>
<li>面对大量的访问日志，可以统计出各项指标，比如PV UV。<h2 id="2、-Elastic-Stack-组件介绍"><a href="#2、-Elastic-Stack-组件介绍" class="headerlink" title="2、 Elastic Stack 组件介绍"></a>2、 Elastic Stack 组件介绍</h2></li>
</ol>
<ul>
<li>Elasticsearch（简称ES）是一个分布式、<strong>RESTful</strong>风格的开源搜索和数据分析引擎，专为全文搜索、结构化搜索、分析、和数据可视化而设计。支持几乎实时的搜索，并且具有高扩展性，能够处理PB级别的数据。<ul>
<li><strong>Index（索引）</strong>： 索引类似于关系型数据库中的表，它存储着相似结构的数据。在Elasticsearch中，每个索引包含一个或多个文档（Document）。</li>
<li><strong>Document（文档）</strong>： 文档是Elasticsearch的基本数据单位，相当于关系型数据库中的一行记录。文档以JSON格式存储，包含字段和值的对。</li>
<li><strong>Shards（分片）和Replicas（副本）</strong>： Elasticsearch将数据分为多个分片存储，每个索引可以包含一个或多个分片。分片可以提高并行查询的性能。副本是分片的备份，保证了数据的高可用性和容错性。</li>
<li><strong>Cluster（集群）</strong>： Elasticsearch集群由一个或多个节点（Node）组成。每个节点负责存储部分数据，并参与集群中的索引和搜索操作。集群有一个主节点，用于管理集群状态。</li>
<li><strong>Node（节点）</strong>： 节点是Elasticsearch的运行实例，每个节点属于某个集群。节点可以充当主节点、数据节点。</li>
<li><strong>使用场景：</strong><ul>
<li><strong>日志和事件数据分析</strong>： Elasticsearch常用于集中化日志管理和分析，帮助企业在海量日志中快速定位问题。</li>
<li><strong>电商网站的搜索功能</strong>： Elasticsearch被广泛用于电商网站的产品搜索，提供快速、相关性高的搜索结果。</li>
<li><strong>数据存储与检索</strong>： Elasticsearch能有效存储和检索结构化或非结构化数据，适用于大规模数据的管理。</li>
</ul>
</li>
</ul>
</li>
<li><strong>Logstash</strong><ul>
<li>Logstash 是一个开源的数据收集、处理和传输引擎，主要用于实时的数据管道管理。它是 Elastic Stack（ELK Stack：Elasticsearch、Logstash、Kibana）的重要组成部分，负责将各种来源的数据收集起来，进行过滤和格式化处理，并最终将其输出到指定的目标，如 Elasticsearch、文件或其他存储系统。</li>
</ul>
</li>
<li><strong>Kibana</strong><ul>
<li>Kibana 提供强大的数据可视化能力，使用户可以在浏览器中实时查看、搜索和分析存储在 Elasticsearch 中的数据。它提供丰富的可视化选项，如图表、地图和表格，支持构建交互式仪表板。</li>
</ul>
</li>
<li><strong>Filebeat</strong><ul>
<li>Filebeat 是一个轻量级的日志收集和传输工具。它通常用于从各种数据源收集日志，并将这些日志传输到 Logstash 或 Elasticsearch 进行进一步处理和分析。Filebeat 是一个边车代理，安装在需要监控的服务器上，用于高效地读取和转发日志数据。它旨在减少资源消耗，提供可靠的日志传输，并确保在出现故障时不会丢失日志数据。<h2 id="一、安装JAVA环境（所有es节点，logstash节点，kinbana节点）"><a href="#一、安装JAVA环境（所有es节点，logstash节点，kinbana节点）" class="headerlink" title="一、安装JAVA环境（所有es节点，logstash节点，kinbana节点）"></a>一、安装JAVA环境（所有es节点，logstash节点，kinbana节点）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 上传jdk1.8安装包</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># ll jdk-8u381-linux-x64.tar.gz </span></span><br><span class="line">-rw-r--r--. 1 root root 139273048 7月  31 10:23 jdk-8u381-linux-x64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 解压jdk到指定目录</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># tar xf jdk-8u381-linux-x64.tar.gz  -C /usr/local/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建软链接</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># cd /usr/local/</span></span><br><span class="line">[root@elk03 <span class="built_in">local</span>]<span class="comment"># ln -s jdk1.8.0_381/ java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 声明Java环境变量</span></span><br><span class="line">[root@elk03 <span class="built_in">local</span>]<span class="comment"># cat  &gt;&gt; /etc/profile.d/jdk.sh &lt;&lt;-EOF</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/java</span><br><span class="line"><span class="built_in">export</span> PATH=\<span class="variable">$PATH</span>:\<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line">EOF</span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 重新加载配置文件</span></span><br><span class="line">[root@elk03 <span class="built_in">local</span>]<span class="comment"># source /etc/profile.d/jdk.sh </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 测试java</span></span><br><span class="line">[root@elk03 <span class="built_in">local</span>]<span class="comment"># java -version</span></span><br><span class="line">java version <span class="string">"1.8.0_381"</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_381-b09)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.381-b09, mixed mode)</span><br></pre></td></tr></table></figure>
<img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405282051529.png#id=LinjU&originHeight=287&originWidth=1568&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><h2 id="二、-安装ES集群"><a href="#二、-安装ES集群" class="headerlink" title="二、 安装ES集群"></a>二、 安装ES集群</h2><h3 id="1、单节点部署"><a href="#1、单节点部署" class="headerlink" title="1、单节点部署"></a>1、单节点部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 解压es安装包到指定目录</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># tar xf elasticsearch-7.17.11-linux-x86_64.tar.gz  -C /usr/local</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建es软链接</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># cd /usr/local/</span></span><br><span class="line">[root@elk01 <span class="built_in">local</span>]<span class="comment"># ln -s elasticsearch-7.17.11/ es</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 声明ES环境变量</span></span><br><span class="line">[root@elk01 loacl]<span class="comment"># cat &gt;&gt; /etc/profile.d/es.sh &lt;&lt;-EOF</span></span><br><span class="line"><span class="meta">#! /bin/bash</span></span><br><span class="line"><span class="built_in">export</span> ES_HOME=/usr/<span class="built_in">local</span>/es</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:\<span class="variable">$ES_HOME</span>/bin</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 重新加载环境变量</span></span><br><span class="line">[root@elk01 <span class="built_in">local</span>]<span class="comment"># source /etc/profile.d/es.sh </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动es实例</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># elasticsearch</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>此时启动会有报错信息，记住详细看报错信息哟！</strong><code>嘿嘿</code><strong>。报错信息如下：此服务不能以超级管理员的身份运行，需要单独创建es普通用户。</strong><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405282057083.png#id=hPod8&originHeight=524&originWidth=2323&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
</blockquote>
</li>
</ul>
</li>
</ul>
<p><strong>解决方法如下操作：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 创建用于启动ES的用户</span></span><br><span class="line">[root@elk01 <span class="built_in">local</span>]<span class="comment"># useradd es</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看用户是否创建</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># id es</span></span><br><span class="line">uid=1000(es) gid=1000(es) 组=1000(es)</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 修改elasticsearch属主和数组</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># chown  -R es.es /usr/local/elasticsearch-7.17.11/</span></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看是否修改成功</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># ll /usr/local/elasticsearch-7.17.11/</span></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 切换es工作目录</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># cd /usr/local/elasticsearch-7.17.11/config/</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 备份es配置文件</span></span><br><span class="line">[root@elk01 config]<span class="comment"># cp elasticsearch.yml&#123;,.bak&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 修改文件相关参数</span></span><br><span class="line">[root@elk01 config]<span class="comment"># egrep -v  "^(#|$)" elasticsearch.yml</span></span><br><span class="line">···</span><br><span class="line"><span class="comment"># es集群名称</span></span><br><span class="line">cluster.name: study-elk-cluster</span><br><span class="line"><span class="comment"># 节点名称(一般以当前主机名一致)</span></span><br><span class="line">node.name: elk01	</span><br><span class="line"><span class="comment"># 监听地址，，配置IP则知允许基于IP地址进行访问</span></span><br><span class="line">network.host: 0.0.0.0	</span><br><span class="line"><span class="comment"># 自动发现节点IP</span></span><br><span class="line">discovery.seed_hosts: [<span class="string">"192.168.100.160"</span>]	</span><br><span class="line"><span class="comment"># 初始化master节点</span></span><br><span class="line">cluster.initial_master_nodes: [<span class="string">"192.168.100.160"</span>] </span><br><span class="line"><span class="comment"># 添加以下参数关闭geoip数据库的更新,减少对带宽和存储的消耗，禁用自动更新。GeoIP根据IP地址确定地理位置的技术，用于日志分析、用户活动追踪等场景。</span></span><br><span class="line">ingest.geoip.downloader.enabled: <span class="literal">false</span></span><br><span class="line">···</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 测试启动ES</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># su -c "elasticsearch" es</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>虽然es能够正常启动，但是启动日志会出下报错信息，需要我们修改启动的内核参数，第一个为修改系最大的文件描述符，第二个修改系统的虚拟内存。</strong></p>
</blockquote>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405282123794.png#id=Yu4ws&originHeight=300&originWidth=2519&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 修改es需要的limits参数（重新连接会话框才能成功加载参数）</span></span><br><span class="line">[root@elk01 logs]<span class="comment"># cat &gt;&gt;/etc/security/limits.d/elk.conf &lt;&lt;EOF</span></span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 131070</span><br><span class="line">EOF</span><br><span class="line">    <span class="comment"># 参数解释：</span></span><br><span class="line">        soft nofile 65535表示将文件描述符的软限制设置为65535。</span><br><span class="line">        hard nofile 131070表示将文件描述符的硬限制设置为131070。</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看limits参数是否加载</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># ulimit -Sn</span></span><br><span class="line">65535</span><br><span class="line">[root@elk01 ~]<span class="comment"># ulimit -Hn</span></span><br><span class="line">131070</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 修改内核参数</span></span><br><span class="line">[root@elk01 config]<span class="comment"># cat &gt;&gt; /etc/sysctl.d/elk.conf &lt;&lt;'EOF'</span></span><br><span class="line">vm.max_map_count = 262144</span><br><span class="line">EOF</span><br><span class="line">    <span class="comment"># 参数解释</span></span><br><span class="line">        vm.max_map_count = 262144 用于设置单个进程可以拥有的内存映射的最大数量。</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 加载内核参数</span></span><br><span class="line">[root@elk01 config]<span class="comment"># sysctl -f /etc/sysctl.d/elk.conf</span></span><br><span class="line">vm.max_map_count = 262144</span><br><span class="line">[root@elk01 config]<span class="comment"># sysctl -q vm.max_map_count</span></span><br><span class="line">vm.max_map_count = 262144</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 测试启动ES</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># su -c "elasticsearch" es</span></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 或者使用一下的参数实现后台运行</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># su -c "elasticsearch -d" es</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 测试节点</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># curl   192.168.100.160:9200</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"elk01"</span>,  <span class="comment"># 节点的名称,一般以当前主机名命名。</span></span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"study-elk-cluster"</span>,		<span class="comment">#  Elasticsearch集群的名称，多个节点可以组成一个集群，共同提供搜索和存储功能。</span></span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"EyOTgfNNSHOvUsQNLQ9f7Q"</span>, <span class="comment"># 集群的唯一标识符（UUID）。每个Elasticsearch集群都有一个唯一的cluster_uuid，用于在集群内识别和管理节点之间的关系。</span></span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"7.17.11"</span>,  <span class="comment"># Elasticsearch 实例的版本</span></span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,  <span class="comment"># 示这个版本没有特殊的自定义修改或变化。</span></span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"tar"</span>,  <span class="comment"># Elasticsearch 是通过 tar 包安装的。</span></span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"eeedb98c60326ea3d46caef960fb4c77958fb885"</span>,  <span class="comment"># Git提交哈希。</span></span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2023-06-23T05:33:12.261262042Z"</span>, <span class="comment"># 版本的构建日期和时间。</span></span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,  <span class="comment"># 此版本适用于生产</span></span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"8.11.1"</span>,  <span class="comment"># Lucene版本</span></span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>, <span class="comment"># lasticsearch实例能够与运行 6.8.0 及以上版本的其他节点进行通讯。</span></span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span>  <span class="comment"># Elasticsearch兼容的最低索引版本。</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span> <span class="comment">#  Elasticsearch的标语或宣传口号。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>端口解释：</strong></p>
<ul>
<li>*<em>9200 对外暴露端口，使用的HTTP协议， Elasticsearch 的 REST API 服务的默认端口。开发者和应用程序通过 HTTP 协议与 Elasticsearch 进行交互，发送查询、索引文档、管理集群等操作。  *</em></li>
<li>*<em>9300 集群内部通讯端口。使用TCP协议。 用于集群内的节点间同步和协调。节点之间通过这个端口交换数据，包括集群管理信息、索引和搜索操作等。  *</em><h3 id="2、ES-JAVA调优-堆-heap-内存大小"><a href="#2、ES-JAVA调优-堆-heap-内存大小" class="headerlink" title="2、ES JAVA调优 堆(heap)内存大小"></a>2、ES JAVA调优 堆(heap)内存大小</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 查看运行的JAVA程序</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># jps  </span></span><br><span class="line">14917 Jps</span><br><span class="line">14713 Elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看ES堆内存大小</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># jmap -heap 14713(pid)</span></span><br></pre></td></tr></table></figure>
<img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405282346087.png#id=mf04i&originHeight=619&originWidth=1348&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 修改堆内存大小（最大设置为32G，要么内存的一半）</span></span><br><span class="line">[root@elk01 config]<span class="comment"># vim /usr/local/elasticsearch-7.17.11/config/jvm.options</span></span><br><span class="line">···</span><br><span class="line">-Xms256m</span><br><span class="line">-Xmx256m</span><br><span class="line">···</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 删除数据、日志</span></span><br><span class="line">[root@elk01 config]<span class="comment"># rm -rf /usr/local/es/&#123;data,logs&#125;/*</span></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 删除缓存数据</span></span><br><span class="line">[root@elk01 config]<span class="comment"># rm -rf /tmp/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 准备ES启动脚本并启动（加入systemd）</span></span><br><span class="line">[root@elk01 config]<span class="comment"># cat &gt;&gt; /usr/lib/systemd/system/es.service &lt;&lt;EOF</span></span><br><span class="line">[Unit]</span><br><span class="line"><span class="comment"># 描述服务的简短说明，这里描述为 "ELK"。</span></span><br><span class="line">Description=ELK</span><br><span class="line"><span class="comment"># 指定服务的启动顺序。表示该服务在网络目标 (network.target) 之后启动，确保网络服务已启动并可用。</span></span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="comment"># 指定服务的启动类型为 forking，表示服务启动后会产生一个子进程，并且主进程会在启动完成后退出。这通常用于后台运行的守护进程。</span></span><br><span class="line">Type=forking</span><br><span class="line"><span class="comment"># 指定启动服务的命令</span></span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/es/bin/elasticsearch -d</span><br><span class="line"><span class="comment"># 指定服务在退出后不重启。可以根据需要将其更改为 always 或 on-failure，以确保服务在失败后自动重启。</span></span><br><span class="line">Restart=no</span><br><span class="line"><span class="comment"># 指定以 es 用户的身份运行服务。</span></span><br><span class="line">User=es</span><br><span class="line"><span class="comment"># 指定服务所属的组为 es。</span></span><br><span class="line">Group=es</span><br><span class="line"><span class="comment"># 设置进程打开文件的最大数量（文件描述符限制）</span></span><br><span class="line">LimitNOFILE=131070</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="comment"># 指定服务的目标，表示该服务在多用户模式下可用。</span></span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载systemd配置文件</span></span><br><span class="line">[root@elk01 config]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动es</span></span><br><span class="line">[root@elk01 config]<span class="comment"># systemctl restart es</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="3、部署ES集群"><a href="#3、部署ES集群" class="headerlink" title="3、部署ES集群"></a>3、部署ES集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 创建用于启动ES的用户</span></span><br><span class="line">[root@elk01 opt]<span class="comment"># useradd es </span></span><br><span class="line">[root@elk01 opt]<span class="comment"># id es</span></span><br><span class="line">uid=1000(elasticsearch) gid=1000(elasticsearch) 组=1000(elasticsearch)</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建ES数据目录和日志目录存放目录</span></span><br><span class="line">[root@elk01 usr]<span class="comment"># mkdir -p /opt/&#123;data,logs&#125;</span></span><br><span class="line">[root@elk01 usr]<span class="comment"># install -d /opt/&#123;data,logs&#125;/es -o es -g es</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 解压es安装包到指定目录</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># tar xf elasticsearch-7.17.11-linux-x86_64.tar.gz  -C /opt/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 更改目录名</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># cd /opt/ &amp;&amp; mv  elasticsearch-7.17.11  es</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建ES环境变量</span></span><br><span class="line">[root@elk01 opt]<span class="comment"># vim  &gt;&gt; /etc/profile.d/es.sh &lt;&lt;-EOF</span></span><br><span class="line"><span class="meta">#! /bin/bash</span></span><br><span class="line"><span class="built_in">export</span> ES_HOME=/opt/es</span><br><span class="line"><span class="built_in">export</span> PATH=\<span class="variable">$PATH</span>:\<span class="variable">$ES_HOME</span>/bin</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 重新加载环境变量</span></span><br><span class="line">[root@elk01 opt]<span class="comment"># source /etc/profile.d/es.sh </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 修改elasticsearch属主和数组</span></span><br><span class="line">[root@elk01 opt]<span class="comment"># chown -R  es,es  /opt/es</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 修改es需要的limits参数（重新连接会话框才能成功加载参数）</span></span><br><span class="line">[root@elk01 opt]<span class="comment"># cat &gt;&gt; /etc/security/limits.d/elk.conf &lt;&lt;-EOF</span></span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 131070</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看limits参数是否加载</span></span><br><span class="line">[root@elk01 opt]<span class="comment"># ulimit -Sn</span></span><br><span class="line">65535</span><br><span class="line">[root@elk01 opt]<span class="comment"># ulimit -Hn</span></span><br><span class="line">131070</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 修改内核参数</span></span><br><span class="line">[root@elk01 opt]<span class="comment"># cat &gt; /etc/sysctl.d/elk.conf &lt;&lt;EOF</span></span><br><span class="line">vm.max_map_count = 262144</span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 加载内核参数</span></span><br><span class="line">[root@elk01 opt]<span class="comment"># sysctl -f /etc/sysctl.d/elk.conf</span></span><br><span class="line">vm.max_map_count = 262144</span><br><span class="line">[root@elk01 opt]<span class="comment"># sysctl -q vm.max_map_count</span></span><br><span class="line">vm.max_map_count = 262144</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 修改堆内存大小（最大设置为32G，要么内存的一半）</span></span><br><span class="line">[root@elk01 opt]<span class="comment"># vim /opt/elasticsearch-7.17.11/config/jvm.options</span></span><br><span class="line">···</span><br><span class="line">-Xms256m</span><br><span class="line">-Xmx256m</span><br><span class="line">···</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; elk01修改配置文件</span></span><br><span class="line">[root@elk01 opt]<span class="comment"># egrep -v "^(#|$)" /opt/es/config/elasticsearch.yml </span></span><br><span class="line">cluster.name: study-elk-cluster</span><br><span class="line">node.name: elk01</span><br><span class="line">path.data: /opt/data/es	<span class="comment"># 指定数据目录</span></span><br><span class="line">path.logs: /opt/logs/es	<span class="comment"># 指定日志目录</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">discovery.seed_hosts: [<span class="string">"192.168.100.160"</span>,<span class="string">"192.168.100.161"</span>,<span class="string">"192.168.100.162"</span>]</span><br><span class="line">cluster.initial_master_nodes: [<span class="string">"192.168.100.160"</span>,<span class="string">"192.168.100.161"</span>,<span class="string">"192.168.100.162"</span>]</span><br><span class="line">ingest.geoip.downloader.enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; elk02修改配置文件</span></span><br><span class="line">[root@elk02 opt]<span class="comment"># egrep -v "^(#|$)" /opt/es/config/elasticsearch.yml </span></span><br><span class="line">cluster.name: study-elk-cluster</span><br><span class="line">node.name: elk02</span><br><span class="line">path.data: /opt/data/es</span><br><span class="line">path.logs: /opt/logs/es</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">discovery.seed_hosts: [<span class="string">"192.168.100.160"</span>,<span class="string">"192.168.100.161"</span>,<span class="string">"192.168.100.162"</span>]</span><br><span class="line">cluster.initial_master_nodes: [<span class="string">"192.168.100.160"</span>,<span class="string">"192.168.100.161"</span>,<span class="string">"192.168.100.162"</span>]</span><br><span class="line">ingest.geoip.downloader.enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; elk03修改配置文件</span></span><br><span class="line">[root@elk03 opt]<span class="comment"># egrep -v "^#|^$" /opt/es/config/elasticsearch.yml </span></span><br><span class="line">cluster.name: study-elk-cluster</span><br><span class="line">node.name: elk03</span><br><span class="line">path.data: /opt/data/es</span><br><span class="line">path.logs: /opt/logs/es</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">discovery.seed_hosts: [<span class="string">"192.168.100.160"</span>,<span class="string">"192.168.100.161"</span>,<span class="string">"192.168.100.162"</span>]</span><br><span class="line">cluster.initial_master_nodes: [<span class="string">"192.168.100.160"</span>,<span class="string">"192.168.100.161"</span>,<span class="string">"192.168.100.162"</span>]</span><br><span class="line">ingest.geoip.downloader.enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 所有节点添加elk启动脚本</span></span><br><span class="line">[root@elk03 opt]<span class="comment"># cat &gt; /usr/lib/systemd/system/es.service &lt;&lt;EOF</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=ELK</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/opt/es/bin/elasticsearch -d</span><br><span class="line">Restart=no</span><br><span class="line">User=es</span><br><span class="line">Group=es</span><br><span class="line">LimitNOFILE=131070</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 所有节点重新加载并启动</span></span><br><span class="line">[root@elk01 config]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@elk01 config]<span class="comment"># systemctl restart es</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 测试集群</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># curl 192.168.100.160:9200/_cat/nodes</span></span><br><span class="line">192.168.100.160 40 59  8 0.14 0.10 0.06 cdfhilmrstw * elk01</span><br><span class="line">192.168.100.161 54 30 11 0.55 0.29 0.11 cdfhilmrstw - elk02</span><br><span class="line">192.168.100.162 48 28  8 0.29 0.16 0.06 cdfhilmrstw - elk03</span><br><span class="line">  <span class="comment"># 参数解释：</span></span><br><span class="line">    第一列：每个节点的IP地址；</span><br><span class="line">    第二列：每个节点的CPU使用率；</span><br><span class="line">    第三列：每个节点的内存的使用率；</span><br><span class="line">    第四列：每个节点的活跃分片数量；</span><br><span class="line">    第五列：每个节点的1分钟、5分钟、15分钟平均负载；</span><br><span class="line">    第六列：每个节点在集群中的角色；</span><br><span class="line">    第七列：*代表主节点；主节点负责管理集群的元数据、分片分配和集群状态等任务。</span><br><span class="line">    第八列：节点的名称</span><br></pre></td></tr></table></figure>


<p>三、Kibana安装（elk03节点）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 安装kibana</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># yum localinstall -y kibana-7.17.11-x86_64.rpm </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 备份配置文件</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># cd /etc/kibana/</span></span><br><span class="line">[root@elk03 kibana]<span class="comment"># cp kibana.yml kibana.yml.bak</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 修改kibana配置文件</span></span><br><span class="line">[root@elk03 kibana]<span class="comment"># egrep -v "^(#|$)" kibana.yml </span></span><br><span class="line"><span class="comment"># 服务端口</span></span><br><span class="line">server.port: 5601</span><br><span class="line"><span class="comment"># 主机地址或者主机名</span></span><br><span class="line">server.host: <span class="string">"0.0.0.0"</span></span><br><span class="line"><span class="comment"># 服务名称</span></span><br><span class="line">server.name: <span class="string">"study-elk-kibana"</span></span><br><span class="line"><span class="comment"># ES主机组地址</span></span><br><span class="line">elasticsearch.hosts: [<span class="string">"http://192.168.100.160:9200"</span>,<span class="string">"http://192.168.100.161:9200"</span>,<span class="string">"http://192.168.100.162:9200"</span>]</span><br><span class="line"><span class="comment"># 修改语言</span></span><br><span class="line">i18n.locale: <span class="string">"zh-CN"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 启动Kibana</span></span><br><span class="line">[root@elk03 kibana]<span class="comment"># systemctl enable --now kibana</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 游览器IP+5601访问</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405291424194.png#id=mXN3G&originHeight=1368&originWidth=2544&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<h2 id="四、Logstash安装（elk02）"><a href="#四、Logstash安装（elk02）" class="headerlink" title="四、Logstash安装（elk02）"></a>四、Logstash安装（elk02）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 安装Logstash</span></span><br><span class="line">[root@elk02 ~]<span class="comment"># yum localinstall -y logstash-7.17.11-x86_64.rpm </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建软连接</span></span><br><span class="line">[root@elk02 <span class="built_in">local</span>]<span class="comment"># ln -s /usr/share/logstash/bin/logstash   /usr/bin/logstash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 编写测试文件</span></span><br><span class="line">[root@elk02 ~]<span class="comment"># mkdir conf-logstash</span></span><br><span class="line">[root@elk02 ~]<span class="comment"># cat  conf-logstash/01-stdin-to-stdout.conf </span></span><br><span class="line">input &#123;</span><br><span class="line"> stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">output&#123;</span><br><span class="line"> stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 测试Logstash</span></span><br><span class="line">[root@elk02 ~]<span class="comment"># logstash -f ~/conf-logstash/01-stdin-to-stdout.conf</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/40379882/1724775298040-1170b872-9cec-4b44-8a9f-5f4336aad57a.png#averageHue=%23070706&clientId=u75f1b712-9c51-4&from=paste&height=294&id=uf9f627e0&originHeight=294&originWidth=1095&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21705&status=done&style=none&taskId=ud3c9e175-6ee9-419e-8bd5-8122d076e6e&title=&width=1095" alt="image.png"></p>
<h2 id="五、Filebeat安装（elk01）"><a href="#五、Filebeat安装（elk01）" class="headerlink" title="五、Filebeat安装（elk01）"></a>五、Filebeat安装（elk01）</h2><p>帮助文档：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/index.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/7.17/index.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 安装Filebeat</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># yum localinstall -y filebeat-7.17.11-x86_64.rpm </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 测试Filebeat</span></span><br><span class="line">[root@elk01 opt]<span class="comment"># cd filebeat</span></span><br><span class="line">[root@elk01 filebeat]<span class="comment"># mkdir filebeat-config</span></span><br><span class="line">[root@elk01 filebeat]<span class="comment"># cp filebeat.yml  filebeat-config/01-test.yml</span></span><br><span class="line">[root@elk01 filebeat]<span class="comment"># cat filebeat-config/01-test.yml</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: stdin</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">output.console:</span><br><span class="line">  pretty: <span class="literal">true</span>    <span class="comment"># 启动美观格式输出</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Filebeat实例</span></span><br><span class="line">[root@elk01 filebeat]<span class="comment"># filebeat -e -c /opt/filebeat/filebeat-config/01-test.yml</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405291142027.png#from=url&id=FZw9q&originHeight=1186&originWidth=1471&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt></p>
<h4 id="1、Filebeat架构"><a href="#1、Filebeat架构" class="headerlink" title="1、Filebeat架构"></a>1、Filebeat架构</h4><p>架构图：<br>    Input（数据源）收集方式：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/configuration-filebeat-options.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/7.17/configuration-filebeat-options.html</a><br>    Output（输出地）推送方式：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/configuring-output.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/7.17/configuring-output.html</a><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405291516016.png#id=NuwUn&originHeight=658&originWidth=1714&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<h2 id="六、Filebeat日志收集"><a href="#六、Filebeat日志收集" class="headerlink" title="六、Filebeat日志收集"></a>六、Filebeat日志收集</h2><p><code>Input</code>方式：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-input-stdin.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-input-stdin.html</a></p>
<h4 id="1、Filebeat标准输入和输出"><a href="#1、Filebeat标准输入和输出" class="headerlink" title="1、Filebeat标准输入和输出"></a>1、Filebeat标准输入和输出</h4><p>​    标准输入官方文档：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-input-stdin.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-input-stdin.html</a><br>​    标准输出官方文档：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/console-output.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/7.17/console-output.html</a><br>​    <strong>简介</strong>：使用终端输入从标准输入读取事件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Filebeat配置文件测试目录</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># mkdir filebeat-config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建配置文件</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim filebeat-config/01-stdin-on-stdout.yml </span></span><br><span class="line"><span class="comment"># 指定输入类型</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">  <span class="comment"># 终端标准输入</span></span><br><span class="line">- <span class="built_in">type</span>: stdin</span><br><span class="line"><span class="comment"># 标准输出类型：终端输出</span></span><br><span class="line"></span><br><span class="line">output.console:</span><br><span class="line">  <span class="comment">#如果设置为 true，则写入 stdout 的事件将采用良好的格式。默认值为 false。</span></span><br><span class="line">  pretty: <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat  -e -c /root/filebeat-config/01-stdin-on-stdout.yml</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405292047924.png#from=url&id=lfzKX&originHeight=1267&originWidth=1816&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt></p>
<h4 id="2、-Filebeat-基于Log类型进行输入"><a href="#2、-Filebeat-基于Log类型进行输入" class="headerlink" title="2、 Filebeat 基于Log类型进行输入"></a>2、 Filebeat 基于Log类型进行输入</h4><p>​    <code>Log</code>方式类型输入：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-input-log.html#input-paths" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-input-log.html#input-paths</a><br>​    <strong>简介</strong>： <code>Log类型</code>输入将日志文件发送到输出。使用输入从日志文件中读取行。此类型<code>[ 7.16.0 ]</code>版本以后废弃，推荐使用<code>filestream input</code>类型</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 编写Log类型日志输入测试文件</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim filebeat-config/02-log-on-stdout.yml </span></span><br><span class="line"><span class="comment"># 指定输入类型</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line"><span class="comment"># 日志输入类型</span></span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  <span class="comment"># 日志存放路径</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/messages</span><br><span class="line">    - /var/<span class="built_in">log</span>/*.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 设置标准终端输出至屏幕</span></span><br><span class="line">output.console:</span><br><span class="line">  <span class="comment">#如果设置为 true，则写入stdout的事件将采用良好的格式。默认值为 false。</span></span><br><span class="line">  pretty: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 测试</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat  -e -c /root/filebeat-config/02-log-on-stdout.yml</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405292111651.png#id=xCb24&originHeight=1048&originWidth=2017&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<h5 id="2-1-Filebeat-基于Log类型进行输入并且自定义字段"><a href="#2-1-Filebeat-基于Log类型进行输入并且自定义字段" class="headerlink" title="2.1 Filebeat 基于Log类型进行输入并且自定义字段"></a><strong>2.1 Filebeat 基于Log类型进行输入并且自定义字段</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01 ~]<span class="comment"># vim  filebeat-config/02-log-on-stdout.yml </span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/messages</span><br><span class="line">  <span class="comment"># 开启自定义字段</span></span><br><span class="line">  fields:</span><br><span class="line">    <span class="comment"># 添加自定义字段</span></span><br><span class="line">    log_type: system</span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line">  <span class="comment"># 开启自定义字段</span></span><br><span class="line">  fields:</span><br><span class="line">    <span class="comment"># 开启自定义字段</span></span><br><span class="line">    log_type: nginx_access</span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br><span class="line">output.console:</span><br><span class="line">  pretty: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 清除偏移量</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 启动Filebeat实例</span></span><br><span class="line">[root@elk01 filebeat]<span class="comment"># filebeat  -e -c /root/filebeat-config/02-log-on-stdout.yml</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405292301452.png#id=f6HAq&originHeight=691&originWidth=1962&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<blockquote>
<p>注意：<br>    如果fields_under_root设置为true，则自定义字段将作为顶级字段存储在输出文档中，而不是分组在字段子字典下。如果自定义字段名称与Filebeat添加的其他字段名称冲突，则自定义字段将覆盖其他字段。效果图如下：<br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405292336305.png#from=url&id=Qq88e&originHeight=757&originWidth=1828&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt></p>
</blockquote>
<h5 id="2-2-Filebeat-基于Log类型进行输入并且自定义Tags"><a href="#2-2-Filebeat-基于Log类型进行输入并且自定义Tags" class="headerlink" title="2.2 Filebeat 基于Log类型进行输入并且自定义Tags"></a><strong>2.2 Filebeat 基于Log类型进行输入并且自定义Tags</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01 ~]<span class="comment"># vim  filebeat-config/02-log-on-stdout.yml </span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/messages</span><br><span class="line">  <span class="comment"># 对当前的输入日志文件，指定独有的标签</span></span><br><span class="line">  tags: [<span class="string">"system logs"</span>,<span class="string">""</span>,<span class="string">""</span>]</span><br><span class="line">  fields:</span><br><span class="line">    log_type: system</span><br><span class="line"></span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line">  <span class="comment"># 对当前的输入日志文件，指定独有的标签 </span></span><br><span class="line">  tags: [<span class="string">"nginx access_log"</span>]</span><br><span class="line">  fields:</span><br><span class="line">    log_type: nginx_access</span><br><span class="line"></span><br><span class="line">output.console:</span><br><span class="line">  pretty: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除偏移量</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># &gt; /var/lib/filebeat/registry/filebeat/log.json </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Filebeat实例</span></span><br><span class="line">[root@elk01 filebeat]<span class="comment"># filebeat  -e -c /root/filebeat-config/02-log-on-stdout.yml</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405292322333.png#id=UMxF5&originHeight=1077&originWidth=2002&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<blockquote>
<p>对于Tags的设定，将Filebeat收集到的日志转发至ES集群时，可以针对不同的Tag设置不同的索引，方便查阅。</p>
</blockquote>
<h5 id="2-3-offset偏移量概念"><a href="#2-3-offset偏移量概念" class="headerlink" title="2.3 offset偏移量概念"></a>2.3 offset偏移量概念</h5><p><strong>简介</strong>：偏移量（offset）在 Filebeat 中指的是文件读取位置的标记，用于追踪文件中的读取进度。<br>在某些情况下，可能需要手动操作偏移量。例如：</p>
<ul>
<li>假如想要<code>重新读取</code>一个<code>日志文件</code>，可以删除对应的注册表条目或者编辑偏移量值。注意：请确保 Filebeat 暂停运行期间进行这些操作以防止冲突。</li>
</ul>
<p><code>RPM方式</code>安装的Filebeat offset存放路径：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换目录</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># cd  /var/lib/filebeat/registry/filebeat/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看文件</span></span><br><span class="line">[root@elk01 filebeat]<span class="comment"># ls</span></span><br><span class="line">log.json  meta.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除偏移量文件，启动Filebeat重新读取日志文件</span></span><br><span class="line">[root@elk01 registry]<span class="comment"># &gt; log.json</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>log.json</code>为偏移量存放文件。清空偏移量后，再次启动Filebeat会<code>重新读取日志文件</code>。</p>
</blockquote>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405292210601.png#id=Q39yO&originHeight=135&originWidth=2296&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><strong>思考题：为什么Filebeat需要设置这个偏移量？</strong></p>
<h5 id="2-4-Filebeat-基于Log类型进行输入实现日志删除"><a href="#2-4-Filebeat-基于Log类型进行输入实现日志删除" class="headerlink" title="2.4 Filebeat 基于Log类型进行输入实现日志删除"></a>2.4 Filebeat 基于Log类型进行输入实现日志删除</h5><p>支持正则表达式：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/regexp-support.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/7.17/regexp-support.html</a><br>    <strong>简介</strong>：<code>exclude_lines</code>与要Filebeat排除的行匹配的正则表达式列表。Filebeat将删除列表中与正则表达式匹配的所有行。默认情况下，不会删除任何行。空行将被忽略。如果还指定了多行设置，则在通过exclude_lines过滤行之前，每条多行消息都将合并为一行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编写测试日志文件</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># cat &gt;&gt; /tmp/test.log &lt;&lt; EOF</span></span><br><span class="line">hi cloud</span><br><span class="line">hello world</span><br><span class="line">Hello cloud</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写Filebeat配置文件</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim filebeat-config/03-log-exclude-stdin.yml </span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">  tags: [<span class="string">"test"</span>]</span><br><span class="line">  fields:</span><br><span class="line">    log_type: <span class="built_in">test</span></span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 删除以hello开头的行，注意区分大小写</span></span><br><span class="line">  exclude_lines: [<span class="string">'^hello'</span>,<span class="string">'^haha'</span>,<span class="string">'^lala'</span>]</span><br><span class="line"></span><br><span class="line">output.console:</span><br><span class="line">  pretty: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Filebeat实例</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat  -e -c /root/filebeat-config/03-log-exclude-stdin.yml</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405292358366.png#from=url&id=lsydL&originHeight=1264&originWidth=1980&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt><br><strong>查看offset偏移量</strong><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405292359570.png#id=B1zCR&originHeight=144&originWidth=2299&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><strong>查看文件字符</strong><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405292359075.png#id=DvN9D&originHeight=100&originWidth=1249&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<blockquote>
<p>此参数是在该日志文件阅读完成以后，在进行过滤删除，故在offset文件中还是有所体现。</p>
</blockquote>
<h5 id="2-5-Filebeat-基于Log类型进行输入实现匹配日志输出"><a href="#2-5-Filebeat-基于Log类型进行输入实现匹配日志输出" class="headerlink" title="2.5 Filebeat 基于Log类型进行输入实现匹配日志输出"></a>2.5 Filebeat 基于Log类型进行输入实现匹配日志输出</h5><p>支持正则表达式：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/regexp-support.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/7.17/regexp-support.html</a><br><strong>简介</strong>：<code>include_lines</code>希望Filebeat包含的行相匹配的正则表达式列表。Filebeat仅导出与列表中正则表达式匹配的行。默认情况下，将导出所有行。空行将被忽略。如果还指定了多行设置，则在通过include_lines过滤行之前，每条多行消息将合并为一行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 准备测试日志文件</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># cat &gt;&gt;/tmp/test02.log  &lt;&lt;EOF</span></span><br><span class="line">ERR haha</span><br><span class="line">WARN haha</span><br><span class="line">info haha</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写Filebeat测试文件</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim filebeat-config/04-log-include-stdin.yml </span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test02.log</span><br><span class="line">  tags: [<span class="string">"test"</span>]</span><br><span class="line">  fields:</span><br><span class="line">    log_type: <span class="built_in">test</span></span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 只过滤出以ERR WARN的行，区分大小写</span></span><br><span class="line">  include_lines: [<span class="string">'^ERR'</span>,<span class="string">'^WARN'</span>]</span><br><span class="line"></span><br><span class="line">output.console:</span><br><span class="line">  pretty: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Filebeat实例</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat -e -c  /root/filebeat-config/04-log-include-stdin.yml</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300017494.png#from=url&id=tK5b7&originHeight=850&originWidth=1818&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt></p>
<h5 id="2-6-include-lines和exclude-lines优先级"><a href="#2-6-include-lines和exclude-lines优先级" class="headerlink" title="2.6 include_lines和exclude_lines优先级"></a>2.6 include_lines和exclude_lines优先级</h5><p>​    如果同时定义了<code>include_lines</code>和<code>exclude_lines</code>，则Filebeat首先执行<code>include_lines</code>，然后执行<code>exclude_line</code>。定义这两个选项的顺序无关紧要。<code>include_lines</code>选项将始终在<code>exclude_lines</code>选项之前执行，即使<code>exclude_line</code>出现在配置文件中的<code>include_lines</code>之前也是如此。</p>
<h5 id="2-7-Nginx-error日志过滤处理实战"><a href="#2-7-Nginx-error日志过滤处理实战" class="headerlink" title="2.7 Nginx error日志过滤处理实战"></a>2.7 Nginx error日志过滤处理实战</h5><p><strong>简介</strong>：在公司中，对于应用的错误日志一般只关心包含<code>error</code>等相关内容的行，其它的我们都需要对其进行过滤处理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 编写测试日志文件</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim  /var/log/nginx/error.log </span></span><br><span class="line">2024/05/30 01:55:13 [notice] 967<span class="comment">#967: worker process 976 exited with code 0</span></span><br><span class="line">2024/05/30 01:55:13 [notice] 967<span class="comment">#967: signal 29 (SIGIO) received</span></span><br><span class="line">2024/05/30 01:55:13 [notice] 967<span class="comment">#967: signal 17 (SIGCHLD) received from 977</span></span><br><span class="line">2024/05/30 01:55:13 [notice] 967<span class="comment">#967: worker process 977 exited with code 0</span></span><br><span class="line">2024/05/30 01:55:13 [notice] 967<span class="comment">#967: signal 17 (SIGCHLD) received from 975</span></span><br><span class="line">2024/05/30 01:55:13 [notice] 967<span class="comment">#967: worker process 975 exited with code 0</span></span><br><span class="line">2024/05/30 01:55:13 [notice] 967<span class="comment">#967: exit</span></span><br><span class="line">2024/05/30 01:55:33 [emerg] 2359<span class="comment">#2359: unexpected "&#125;" in /etc/nginx/nginx.conf:11</span></span><br><span class="line">2024/05/30 01:55:16 [emerg] 2384<span class="comment">#2384: "access_log" directive is not allowed here in /etc/nginx/nginx.conf:22</span></span><br><span class="line">2024/05/30 01:55:41 [notice] 2396<span class="comment">#2396: using the "epoll" event method</span></span><br><span class="line">2024/05/30 01:55:41 [notice] 2396<span class="comment">#2396: nginx/1.24.0</span></span><br><span class="line">2024/05/30 01:55:41 [notice] 2396<span class="comment">#2396: built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) </span></span><br><span class="line">2024/05/30 01:55:41 [notice] 2396<span class="comment">#2396: OS: Linux 3.10.0-1160.el7.x86_64</span></span><br><span class="line">2024/05/30 01:55:41 [notice] 2396<span class="comment">#2396: getrlimit(RLIMIT_NOFILE): 1024:4096</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 编写Filebeat测试文件</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim filebeat-config/05-log-nginx-error-stdin.yml </span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/error.log</span><br><span class="line">  tags: [<span class="string">"nginx_error"</span>]</span><br><span class="line">  fields:</span><br><span class="line">    log_type: nginx_error</span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br><span class="line">  include_lines: [<span class="string">'\[emerg\]'</span>]</span><br><span class="line"></span><br><span class="line">output.console:</span><br><span class="line">  pretty: <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 启动Filebeat实例</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat -e -c /root/filebeat-config/05-log-nginx-error-stdin.yml</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300034705.png#id=PKtHd&originHeight=621&originWidth=2215&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<h5 id="2-8-Filebeat输出数据至Elasticsearch集群"><a href="#2-8-Filebeat输出数据至Elasticsearch集群" class="headerlink" title="2.8 Filebeat输出数据至Elasticsearch集群"></a>2.8 Filebeat输出数据至Elasticsearch集群</h5><p>官方链接：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/elasticsearch-output.html#elasticsearch-output" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/7.17/elasticsearch-output.html#elasticsearch-output</a><br>    简介：Elasticsearch输出使用Elasticsearch <code>HTTP API</code>将事件直接发送到Elasticearch。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编写Filebeat配置文件</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim filebeat-config/06-log-nginx-access-es.yml </span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line">  tags: [<span class="string">"nginx_access"</span>]</span><br><span class="line">  fields:</span><br><span class="line">    log_type: nginx_access</span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出至ES集群</span></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  <span class="comment"># ES集群地址</span></span><br><span class="line">  hosts: [<span class="string">"http://192.168.174.140:9200"</span>,<span class="string">"http://192.168.174.141:9200"</span>,<span class="string">"http://192.168.174.142:9200"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Filebeat实例</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat  -e -c /root/filebeat-config/06-log-nginx-access-es.yml</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300051042.png#id=b1B1L&originHeight=457&originWidth=2308&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><strong>Kibana查看ES数据</strong><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300053155.png#id=M9HFQ&originHeight=1417&originWidth=2488&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300053167.png#id=J99r5&originHeight=1417&originWidth=2488&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300054359.png#id=i3BKi&originHeight=1417&originWidth=2488&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300056067.png" alt></p>
<blockquote>
<p>通过索引模式来匹配索引</p>
</blockquote>
<img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300059360.png">
![](https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300059590.png#id=b38Ds&originHeight=1417&originWidth=2488&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none)



<h5 id="2-9-Filebeat输出数据至Elasticsearch集群并自定义单个索引"><a href="#2-9-Filebeat输出数据至Elasticsearch集群并自定义单个索引" class="headerlink" title="2.9 Filebeat输出数据至Elasticsearch集群并自定义单个索引"></a>2.9 Filebeat输出数据至Elasticsearch集群并自定义单个索引</h5><p>官网：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/elasticsearch-output.html#index-option-es" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/7.17/elasticsearch-output.html#index-option-es</a><br>    <strong>简介</strong>：使用每日索引时要将事件写入的索引名称。默认值为“filebeat-%｛[agent.version]｝-%｛+yyyy.MM.dd｝”，例如“filebeat-7.17.21-2024-05-22”。<code>在公司中一般会根据日志的类型设置不同的索引</code>。但是如果需要自定以索引，需要把索引的生命周期管理给禁用掉<code>setup.ilm.enabled: false</code>，否则自定以索引无法生效。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编写Filebeat测试文件</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim filebeat-config/07-log-nginx-access-es.yml </span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line">  tags: [<span class="string">"nginx_access"</span>]</span><br><span class="line">  fields:</span><br><span class="line">    log_type: nginx_access</span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [<span class="string">"http://192.168.174.140:9200"</span>,<span class="string">"http://192.168.174.141:9200"</span>,<span class="string">"http://192.168.174.142:9200"</span>]</span><br><span class="line">  index: <span class="string">"web-nginx-access-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line"><span class="comment"># 禁用索引生命周期管理</span></span><br><span class="line">setup.ilm.enabled: <span class="literal">false</span></span><br><span class="line"><span class="comment"># 设置索引模板的名称</span></span><br><span class="line">setup.template.name: <span class="string">"web"</span></span><br><span class="line"><span class="comment"># 设置索引模板的匹配模式 </span></span><br><span class="line">setup.template.pattern: <span class="string">"web*"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Filebeat实例</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat -e -c  /root/filebeat-config/07-log-nginx-access-es.yml</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>参数解释：</strong><br>setup.ilm.enabled: false        #  禁用了 Filebeat 的 索引生命周期管理， ILM 是 Elasticsearch 提供的一种功能，用于自动管理索引的生命周期。通过 ILM，管理员可以定义索引的创建、滚动（如每天创建一个新索引）、迁移（如将数据从热节点迁移到冷节点）、归档和删除等操作。<br>setup.template.name: “web”    #  指定了 Filebeat创建的索引模板的名称。索引模板定义了 Elasticsearch 中新创建的索引的默认设置和映射。每当一个新索引与指定的模板模式匹配时，Elasticsearch 会应用该模板中的设置和映射规则。<br>setup.template.pattern: web #  定义索引模板的 匹配模式。  web：表示 Filebeat创建的所有索引名称中，只要符合 web的模式，都会使用名为 web的模板。 是通配符，表示任意字符。</p>
</blockquote>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300145654.png#id=GlOsK&originHeight=186&originWidth=2311&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><strong>kibana操作和查看</strong><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300145138.png#id=G65HQ&originHeight=1417&originWidth=2488&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300146998.png#id=c4WDn&originHeight=1417&originWidth=2488&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300146229.png#id=XsxCy&originHeight=1417&originWidth=2488&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300146120.png#id=kIljc&originHeight=1417&originWidth=2488&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300147625.png#id=Bux5a&originHeight=1417&originWidth=2488&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300147139.png#id=W7lQm&originHeight=1417&originWidth=2488&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300148550.png#id=gJChe&originHeight=1417&originWidth=2488&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300149819.png#id=kOa4s&originHeight=1417&originWidth=2488&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300149995.png#id=DjuYD&originHeight=1417&originWidth=2488&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<h5 id="2-10-Filebeat输出数据至Elasticsearch集群并自定义多个索引"><a href="#2-10-Filebeat输出数据至Elasticsearch集群并自定义多个索引" class="headerlink" title="2.10 Filebeat输出数据至Elasticsearch集群并自定义多个索引"></a>2.10 Filebeat输出数据至Elasticsearch集群并自定义多个索引</h5><p>官网：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/elasticsearch-output.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/7.17/elasticsearch-output.html</a><br><strong>简介</strong>：每个规则都指定用于与该规则匹配的事件的索引。在发布过程中，Filebeat使用数组中的第一个匹配规则。规则可以包含条件、基于字符串的字段格式和名称映射。如果缺少索引设置或没有匹配的规则，则使用索引设置。与索引类似，定义自定义索引将禁用索引生命周期管理（ILM）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 编写Filebeat配置文件</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim filebeat-config/08-log-nginx-log-es.yml </span></span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/.<span class="built_in">log</span></span><br><span class="line">  tags: [<span class="string">"nginx_access"</span>]</span><br><span class="line">  fields:</span><br><span class="line">    log_type: nginx_access</span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/error.log</span><br><span class="line">  tags: [<span class="string">"nginx_error"</span>]</span><br><span class="line">  fields:</span><br><span class="line">    log_type: nginx_error</span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br><span class="line">  include_lines: [<span class="string">'\[emerg\]'</span>]</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [<span class="string">"http://192.168.174.140:9200"</span>,<span class="string">"http://192.168.174.141:9200"</span>,<span class="string">"http://192.168.174.142:9200"</span>] </span><br><span class="line">  indices:</span><br><span class="line">    <span class="comment"># 索引名称</span></span><br><span class="line">    - index: <span class="string">"web-nginx-access-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">      <span class="comment"># 匹配标签</span></span><br><span class="line">      when.contains:</span><br><span class="line">        tags: <span class="string">"nginx_access"</span></span><br><span class="line">    <span class="comment"># 索引名称</span></span><br><span class="line">    - index: <span class="string">"web-nginx-error-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">      <span class="comment"># 匹配标签</span></span><br><span class="line">      when.contains:</span><br><span class="line">        tags: <span class="string">"nginx_error"</span></span><br><span class="line"><span class="comment"># 禁索引命周期管理</span></span><br><span class="line">setup.ilm.enabled: <span class="literal">false</span></span><br><span class="line"><span class="comment"># 设置索引模板的名称</span></span><br><span class="line">setup.template.name: <span class="string">"web"</span></span><br><span class="line"><span class="comment"># 设置索引模板的匹配模式 </span></span><br><span class="line">setup.template.pattern: <span class="string">"web*"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Filebeat实例</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat -e -c /root/filebeat-config/08-log-nginx-log-es.yml</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300740915.png#id=JynSZ&originHeight=93&originWidth=2309&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><strong>kibana操作和查看</strong><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300741244.png#id=kqKes&originHeight=1339&originWidth=2558&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300741426.png#id=nzAhr&originHeight=1399&originWidth=2557&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300741233.png#id=mgB03&originHeight=1389&originWidth=2556&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" style="zoom:67%;"><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300743134.png#id=PIKA3&originHeight=1106&originWidth=2552&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405300743612.png#id=vqoCm&originHeight=856&originWidth=2556&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<blockquote>
<p>注意：日志是以索引的方式写入的！</p>
</blockquote>
<h5 id="2-11-Filebeat输出数据至Elasticsearch集群并设定副本分片"><a href="#2-11-Filebeat输出数据至Elasticsearch集群并设定副本分片" class="headerlink" title="2.11 Filebeat输出数据至Elasticsearch集群并设定副本分片"></a>2.11 Filebeat输出数据至Elasticsearch集群并设定副本分片</h5><p>官网：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/configuration-template.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/7.17/configuration-template.html</a><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405302048641.png#id=QwD2a&originHeight=846&originWidth=1361&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><strong>简介</strong>：</p>
<ul>
<li><code>index.number_of_shards: 3</code>：主分片（primary shard）是将数据分割成较小部分以便分布存储和基础单位。设置主分片数为3意味着每个索引将分成3个主分片。主分片的数量在索引创建后无法更改。</li>
<li><code>index.number_of_replicas: 1</code>：副本分片（replica shard）是主分片的副本，用于提供高可用性和故障恢复能力。如果主分片所在的节点故障，副本分片可以作为备份继续提供数据服务。设置副本分片数为1意味着每个主分片将有1个副本分片。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编写Filebeat测试文件</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim filebeat-config/09-log-nginx-log-shard-es.yml </span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line">  tags: [<span class="string">"nginx_access"</span>]</span><br><span class="line">  fields:</span><br><span class="line">    log_type: nginx_access</span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/error.log</span><br><span class="line">  tags: [<span class="string">"nginx_error"</span>]</span><br><span class="line">  fields:</span><br><span class="line">    log_type: nginx_error</span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br><span class="line">  include_lines: [<span class="string">'\[emerg\]'</span>]</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [<span class="string">"http://192.168.174.140:9200"</span>,<span class="string">"http://192.168.174.141:9200"</span>,<span class="string">"http://192.168.174.142:9200"</span>] </span><br><span class="line">  indices:</span><br><span class="line">    <span class="comment"># 索引名称</span></span><br><span class="line">    - index: <span class="string">"web-nginx-access-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">      <span class="comment"># 匹配标签</span></span><br><span class="line">      when.contains:</span><br><span class="line">        tags: <span class="string">"nginx_access"</span></span><br><span class="line">    <span class="comment"># 索引名称</span></span><br><span class="line">    - index: <span class="string">"web-nginx-error-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">      <span class="comment"># 匹配标签</span></span><br><span class="line">      when.contains:</span><br><span class="line">        tags: <span class="string">"nginx_error"</span></span><br><span class="line"><span class="comment"># 禁索引命周期管理</span></span><br><span class="line">setup.ilm.enabled: <span class="literal">false</span></span><br><span class="line"><span class="comment"># 设置索引模板的名称</span></span><br><span class="line">setup.template.name: <span class="string">"web"</span></span><br><span class="line"><span class="comment"># 设置索引模板的匹配模式 </span></span><br><span class="line">setup.template.pattern: <span class="string">"web*"</span></span><br><span class="line"><span class="comment"># 配置索引模板</span></span><br><span class="line">setup.template.settings:</span><br><span class="line">  <span class="comment"># 设置分片数量</span></span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">  <span class="comment"># 设置副本数量，要求小于集群的数量</span></span><br><span class="line">  index.number_of_replicas: 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Filebeat实例</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat -e -c /root/filebeat-config/09-log-nginx-error-shard-es.yml</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意：三分片一副本，表示每个主分片都会有一个副本分片，分片数量一旦确定，不能修改(缩容/扩容)。会导致数据无法查找。副本分片可以扩容。</strong></p>
</blockquote>
</li>
</ul>
<p><code>记得把原有的模板给删除掉，否则分片和副本数量无法修改成功</code><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405302104084.png#id=olh8D&originHeight=1530&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405302104604.png#id=VZdWu&originHeight=1530&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<h5 id="2-12-FIlebeat-收集JSON格式的nginx访问日志"><a href="#2-12-FIlebeat-收集JSON格式的nginx访问日志" class="headerlink" title="2.12 FIlebeat 收集JSON格式的nginx访问日志"></a>2.12 FIlebeat 收集JSON格式的nginx访问日志</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装nginx</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim /etc/yum.repos.d/nginx.repo</span></span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=<span class="literal">true</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># yum install -y nginx</span></span><br><span class="line"><span class="comment"># 启动nginx</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># systemctl enable --now nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改nginx访问日志格式</span></span><br><span class="line">[root@elk-01 ~]<span class="comment"># vim /etc/nginx/nginx.conf </span></span><br><span class="line">···</span><br><span class="line">   log_format  test_nginx_json <span class="string">'&#123;"@timestamp":"$time_iso8601",'</span></span><br><span class="line">                                <span class="string">'"host":"$server_addr",'</span></span><br><span class="line">                                <span class="string">'"clientip":"$remote_addr",'</span></span><br><span class="line">                                <span class="string">'"SendBytes":$body_bytes_sent,'</span></span><br><span class="line">                                <span class="string">'"responsetime":$request_time,'</span></span><br><span class="line"> </span><br><span class="line">   <span class="string">'"upstreamtime":"$upstream_response_time",'</span></span><br><span class="line">                                <span class="string">'"upstreamhost":"$upstream_addr",'</span></span><br><span class="line">                                <span class="string">'"http_host":"$host",'</span></span><br><span class="line">                                <span class="string">'"uri":"$uri",'</span></span><br><span class="line">                                <span class="string">'"domain":"$host",'</span></span><br><span class="line">                                <span class="string">'"xff":"$http_x_forwarded_for",'</span></span><br><span class="line">                                <span class="string">'"referer":"$http_referer",'</span></span><br><span class="line">                                <span class="string">'"tcp_xff":"$proxy_protocol_addr",'</span></span><br><span class="line">                                <span class="string">'"http_user_agent":"$http_user_agent",'</span></span><br><span class="line">                                <span class="string">'"status":"$status"&#125;'</span>;</span><br><span class="line">      access_log  /var/<span class="built_in">log</span>/nginx/access.log  test_nginx_json;</span><br><span class="line">···</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查语法格式</span></span><br><span class="line">[root@elk-01 ~]<span class="comment"># nginx -t</span></span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启nginx</span></span><br><span class="line">[root@elk-01 ~]<span class="comment"># systemctl reload nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># curl localhost</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># cat /var/log/nginx/access.log</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405302119292.png#id=RmNGX&originHeight=137&originWidth=2271&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改Filebeat配置(识别json格式日志，生成相关字段)</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim filebeat-config/10-log-nginx-log-shard-json-es.yml </span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/access.log*</span><br><span class="line">  tags: [<span class="string">"access"</span>]</span><br><span class="line"><span class="comment"># 启动json格式  </span></span><br><span class="line">  json.keys_under_root: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [<span class="string">"http://192.168.174.140:9200"</span>,<span class="string">"http://192.168.174.141:9200"</span>,<span class="string">"http://192.168.174.142:9200"</span>]</span><br><span class="line">  index: <span class="string">"web-nginx-access-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line"><span class="comment"># 禁索引命周期管理</span></span><br><span class="line">setup.ilm.enabled: <span class="literal">false</span></span><br><span class="line"><span class="comment"># 设置索引模板的名称</span></span><br><span class="line">setup.template.name: <span class="string">"web"</span></span><br><span class="line"><span class="comment"># 设置索引模板的匹配模式 </span></span><br><span class="line">setup.template.pattern: <span class="string">"web*"</span></span><br><span class="line"><span class="comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span></span><br><span class="line">setup.template.overwrite: <span class="literal">true</span></span><br><span class="line"><span class="comment"># 配置索引模板</span></span><br><span class="line">setup.template.settings:</span><br><span class="line"><span class="comment"># 设置分片数量</span></span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line"><span class="comment"># 设置副本数量，要求⼩于集群的数量</span></span><br><span class="line">  index.number_of_replicas: 1</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除filebeat的指针偏移，用于从第一行重新读取日志文件</span></span><br><span class="line">[root@elk-01 <span class="built_in">log</span>]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清楚以前的ES nginx索引，防止出现脏数据</span></span><br><span class="line">略</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启filebeat</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat -e -c ~/filebeat-config/10-log-nginx-log-shard-json-es.yml</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405302132161.png#id=FYhqo&originHeight=1530&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<h2 id="七、Logstash-日志收集"><a href="#七、Logstash-日志收集" class="headerlink" title="七、Logstash 日志收集"></a>七、Logstash 日志收集</h2><p>官网：<a href="https://www.elastic.co/guide/en/logstash/7.17/" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/7.17/</a><br>简介：Logstash是一个具有实时流水线功能的开源数据收集引擎。Logstash可以动态地统一来自不同来源的数据，并将数据规范化为您选择的目的地。为各种高级下游分析和可视化用例清理和民主化您的所有数据。<br>虽然Logstash最初推动了日志收集的创新，但其功能远远超出了该用例。任何类型的事件都可以通过广泛的输入、过滤和输出插件进行丰富和转换。</p>
<h3 id="1、Logstash安装"><a href="#1、Logstash安装" class="headerlink" title="1、Logstash安装"></a>1、Logstash安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># yum install -y logstash-7.17.11-x86_64.rpm </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 声明软连接</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># ln -s /usr/share/logstash/bin/logstash   /sbin/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Logstash 测试文件目录</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># mkdir logstash-config</span></span><br></pre></td></tr></table></figure>
<h4 id="2、Logstash-标准输入输出"><a href="#2、Logstash-标准输入输出" class="headerlink" title="2、Logstash 标准输入输出"></a>2、Logstash 标准输入输出</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编写Logstash配置文件</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># cd logstash-config/</span></span><br><span class="line">[root@elk03 logstash-config]<span class="comment"># vim 01_test.conf</span></span><br><span class="line">input &#123;</span><br><span class="line">  stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查配置文件语法</span></span><br><span class="line">[root@elk03 logstash-config]<span class="comment"># logstash  -tf ~/logstash-config/01_test.conf</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405302310091.png#id=WRB0E&originHeight=392&originWidth=2283&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Logstash</span></span><br><span class="line">[root@elk03 logstash-config]<span class="comment"># logstash  -f ~/logstash-config/01_test.conf</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405302312127.png#id=qkBSN&originHeight=266&originWidth=1027&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<h4 id="3、Logstash基于File的形式进行input"><a href="#3、Logstash基于File的形式进行input" class="headerlink" title="3、Logstash基于File的形式进行input"></a>3、Logstash基于File的形式进行input</h4><p>官网：<a href="https://www.elastic.co/guide/en/logstash/7.17/plugins-inputs-file.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/7.17/plugins-inputs-file.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编写配置文件</span></span><br><span class="line">[root@elk03 logstash-config]<span class="comment"># vim 02-file-input.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">  <span class="comment"># 指定日志文件收集的路径</span></span><br><span class="line">  path =&gt; [<span class="string">"/tmp/*.txt"</span>]</span><br><span class="line">  <span class="comment"># 从日志文件的第一行进行读取，只会在第一次启动时从头读取</span></span><br><span class="line">  start_position =&gt; <span class="string">"beginning"</span> </span><br><span class="line">  <span class="comment"># 从日志文件的尾行读取日志，且偏移指针文件对原日志文件偏移量未记录</span></span><br><span class="line">  <span class="comment"># start_position =&gt; "end" </span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 准备测试日志文件</span></span><br><span class="line">[root@elk01 stduy-logstash-config]<span class="comment"># ech0 1111 &gt; /tmp/1.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Logstash实例</span></span><br><span class="line">[root@elk01 stduy-logstash-config]<span class="comment"># logstash -f /root/stduy-logstash-config/02_input_file.conf</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405302324437.png#id=PA09v&originHeight=887&originWidth=2284&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看偏移量</span></span><br><span class="line">[root@elk03 logstash-config]<span class="comment"># cat /usr/share/logstash/data/plugins/inputs/file/.sincedb_820ddbbd098cfece4b56f4fcbf67a9bb</span></span><br><span class="line">16789540 0 64768 4 1717082577.147625 /tmp/1.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志文件</span></span><br><span class="line">[root@elk03 logstash-config]<span class="comment"># ll -i /tmp/1.txt </span></span><br><span class="line">16789540 -rw-r--r-- 1 root root 4 5月  30 23:20 /tmp/1.txt</span><br></pre></td></tr></table></figure>

<h4 id="4、Logstash基于Filebeat形式进行input"><a href="#4、Logstash基于Filebeat形式进行input" class="headerlink" title="4、Logstash基于Filebeat形式进行input"></a>4、Logstash基于Filebeat形式进行input</h4><p>Filebeat output Logstash官网：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/logstash-output.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/7.17/logstash-output.html</a><br>Logstash input Fliebeat官网：<a href="https://www.elastic.co/guide/en/logstash/7.17/plugins-inputs-beats.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/7.17/plugins-inputs-beats.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改Filebeat配置文件</span></span><br><span class="line">[root@elk01 filebeat-config]<span class="comment"># vim /root/filebeat-config/output-logstash.yml </span></span><br><span class="line"></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">  tags: [<span class="string">"test"</span>]</span><br><span class="line">  fields:</span><br><span class="line">    log_type: <span class="built_in">test</span></span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">output.logstash:</span><br><span class="line">  <span class="comment"># Logstash主机地址</span></span><br><span class="line">  hosts: [<span class="string">"192.168.174.142:5044"</span>]</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Filebeat实例</span></span><br><span class="line">[root@elk01 <span class="built_in">test</span>]<span class="comment"># filebeat -e -c /root/filebeat-conifg/output-logstash.yml</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改Logstash配置文件</span></span><br><span class="line">[root@elk01 stduy-logstash-config]<span class="comment"># vim input-beats.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    <span class="comment"># 通讯端口号，默认5044</span></span><br><span class="line">    port =&gt; 5044</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Logstash</span></span><br><span class="line">[root@elk01 logstash-config]<span class="comment"># logstash -rf /root/logstash-config/input-beats.conf</span></span><br></pre></td></tr></table></figure>

<h4 id="5、Logstash基于ES形式进行output"><a href="#5、Logstash基于ES形式进行output" class="headerlink" title="5、Logstash基于ES形式进行output"></a>5、Logstash基于ES形式进行output</h4><p>官网：<a href="https://www.elastic.co/guide/en/logstash/7.17/plugins-outputs-elasticsearch.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/7.17/plugins-outputs-elasticsearch.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改Logstash配置文件</span></span><br><span class="line">[root@elk03 logstash-config]<span class="comment"># cat 08_output_es.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    <span class="comment"># 通讯端口号，默认5044</span></span><br><span class="line">    port =&gt; 5044</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    <span class="comment"># ES集群IP</span></span><br><span class="line">    hosts =&gt; [<span class="string">"192.168.174.140:9200"</span>,<span class="string">"192.168.174.141:9200"</span>,<span class="string">"192.168.174.142:9200"</span>] </span><br><span class="line">    <span class="comment"># 索引模式名称</span></span><br><span class="line">    index =&gt; <span class="string">"test-log-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Logstash</span></span><br><span class="line">[root@elk03 logstash-config]<span class="comment"># logstash -f /root/stduy-logstash-config/08_output_es.conf</span></span><br></pre></td></tr></table></figure>

<h4 id="6、Logstash-grok插件使用"><a href="#6、Logstash-grok插件使用" class="headerlink" title="6、Logstash grok插件使用"></a>6、Logstash grok插件使用</h4><p>官网： <a href="https://www.elastic.co/guide/en/logstash/7.17/plugins-filters-grok.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/7.17/plugins-filters-grok.html</a><br>简介：解析任意文本并对其进行结构化。Grok 是将非结构化日志数据解析为结构化和可查询内容的好方法。该工具非常适合系统日志，apache和其他Web服务器日志，mysql 日志，以及通常为人类编写的任何日志格式。</p>
<h5 id="6-1-Logstash-内置正则使用"><a href="#6-1-Logstash-内置正则使用" class="headerlink" title="6.1 Logstash 内置正则使用"></a>6.1 Logstash 内置正则使用</h5><p>简介：将非结构化的日志格式通过Grok内置的正则转化为结构化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 日志格式</span></span><br><span class="line">192.168.174.1 - - [01/Jun/2024:10:37:16 +0800] <span class="string">"GET / HTTP/1.1"</span> 304 0 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36 Edg/122.0.0.0"</span> <span class="string">"-"</span></span><br><span class="line">192.168.174.1 - - [01/Jun/2024:10:37:16 +0800] <span class="string">"GET / HTTP/1.1"</span> 304 0 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36 Edg/122.0.0.0"</span> <span class="string">"-"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写Filebeat配置文件</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim filebeat-out-logstash.yml</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line">  tags: [<span class="string">"access"</span>]</span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [<span class="string">"192.168.174.142:5044"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除偏移量</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line"><span class="comment"># 启动Filebeat实例             </span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat  -e -c ~/filebeat-out-logstash.yml </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写Logstash配置文件</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># vim filter_grok.yml </span></span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 5044</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123;</span><br><span class="line">      <span class="string">"message"</span> =&gt; <span class="string">"%&#123;HTTPD_COMMONLOG&#125;"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">"192.168.174.140:9200"</span>,<span class="string">"192.168.174.141:9200"</span>,<span class="string">"192.168.174.142:9200"</span>] </span><br><span class="line">    index =&gt; <span class="string">"test-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Logstash</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># logstash  -rf ~/filter_grok.yml</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202406011048944.png#id=sObcG&originHeight=510&originWidth=2279&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<h5 id="6-2-Logstash基于内置正则实现日志结构化"><a href="#6-2-Logstash基于内置正则实现日志结构化" class="headerlink" title="6.2 Logstash基于内置正则实现日志结构化"></a>6.2 Logstash基于内置正则实现日志结构化</h5><p>官网： <a href="https://www.elastic.co/guide/en/logstash/7.17/plugins-filters-grok.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/7.17/plugins-filters-grok.html</a><br>Logstash内置变量：<a href="https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/legacy/httpd" target="_blank" rel="noopener">https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/legacy/httpd</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试日志准备</span></span><br><span class="line">55.3.244.1 GET /index.html 15824 0.043</span><br><span class="line">    <span class="comment"># 参数说明</span></span><br><span class="line">        55.3.244.1 <span class="comment"># 客户端IP</span></span><br><span class="line">        GET		   <span class="comment"># 请求方式</span></span><br><span class="line">        /index.html	<span class="comment"># 请求路径</span></span><br><span class="line">        15824		<span class="comment"># 发送字节大小</span></span><br><span class="line">        0.043		<span class="comment"># 相应时常</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Logstash 配置文件编写</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># vim stdin_grok_stdout.conf</span></span><br><span class="line">input &#123;</span><br><span class="line">  stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123; <span class="string">"message"</span> =&gt; <span class="string">"%&#123;IP:client_ip&#125; %&#123;WORD:Request_method&#125; %&#123;URIPATHPARAM:request_uri&#125; %&#123;NUMBER:bytes&#125; %&#123;NUMBER:response_time&#125;"</span> &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Logstash实例</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># logstash  -rf ~/stdin_grok_stdout.conf</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202406011104673.png#id=pHhH3&originHeight=511&originWidth=1485&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<blockquote>
<p>提示：<br>    %{IP:client} 变量解释： IP为内置变量，client为字段名称或者叫标识符。可以自行修改,例如：%{IP:req-client}</p>
</blockquote>
<h5 id="6-4-Logstash删除指定字段"><a href="#6-4-Logstash删除指定字段" class="headerlink" title="6.4 Logstash删除指定字段"></a>6.4 Logstash删除指定字段</h5><p>简介：如果此筛选器成功，请从此事件中删除任意字段。</p>
<p><code>未删除字段终端打印如下</code>：<br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202406011154600.png#id=TRqxM&originHeight=1276&originWidth=2285&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Filebeat配置文件编写</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim filebeat-out-logstash.yml</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line">  tags: [<span class="string">"access"</span>]</span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [<span class="string">"192.168.174.142:5044"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除偏移量</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Filebeat实例</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat  -e -c ~/filebeat-out-logstash.yml </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Logstash配置文件编写</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># vim filter_grok.yml </span></span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 5044</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123;</span><br><span class="line">      <span class="string">"message"</span> =&gt; <span class="string">"%&#123;HTTPD_COMMONLOG&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment"># You can also remove multiple fields at once: </span></span><br><span class="line">   remove_field =&gt; [ <span class="string">"type"</span>,<span class="string">"offset"</span>,<span class="string">"ecs"</span>,<span class="string">"input"</span>,<span class="string">"@version"</span>,<span class="string">"log"</span>,<span class="string">"agent"</span>,<span class="string">"tags"</span> ]</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line"></span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">"192.168.174.140:9200"</span>,<span class="string">"192.168.174.141:9200"</span>,<span class="string">"192.168.174.142:9200"</span>]</span><br><span class="line">    index =&gt; <span class="string">"test-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Logstash实例</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># logstash -rf ~/filter_grok.yml</span></span><br></pre></td></tr></table></figure>
<p>删除指定字段后终端数据显示如下：<br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202406011210897.png#id=A8WhB&originHeight=751&originWidth=2283&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<h5 id="6-5-Logstash-添加指定字段"><a href="#6-5-Logstash-添加指定字段" class="headerlink" title="6.5 Logstash 添加指定字段"></a>6.5 Logstash 添加指定字段</h5><p>简介：如果此筛选成功，则向此事件添加任意字段。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Filebeat配置文件编写</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim filebeat-out-logstash.yml</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line">  tags: [<span class="string">"access"</span>]</span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [<span class="string">"192.168.174.142:5044"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除偏移量</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Filebeat实例</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat  -e -c ~/filebeat-out-logstash.yml </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Logstash配置文件编写</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># vim filter_grok.yml </span></span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 5044</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123;</span><br><span class="line">      <span class="string">"message"</span> =&gt; <span class="string">"%&#123;HTTPD_COMMONLOG&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment"># You can also remove multiple fields at once: </span></span><br><span class="line">   remove_field =&gt; [ <span class="string">"type"</span>,<span class="string">"offset"</span>,<span class="string">"ecs"</span>,<span class="string">"input"</span>,<span class="string">"@version"</span>,<span class="string">"log"</span>,<span class="string">"agent"</span>,<span class="string">"tags"</span> ]</span><br><span class="line">    <span class="comment"># You can also add multiple fields at once:</span></span><br><span class="line">   add_field =&gt; &#123; </span><br><span class="line">     <span class="string">"host-name"</span> =&gt; <span class="string">"%&#123;host&#125;"</span></span><br><span class="line">     <span class="string">"service"</span> =&gt; <span class="string">"ELK stack"</span></span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line"></span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">"192.168.174.140:9200"</span>,<span class="string">"192.168.174.141:9200"</span>,<span class="string">"192.168.174.142:9200"</span>]</span><br><span class="line">    index =&gt; <span class="string">"test-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Logstash实例</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># logstash -rf ~/filter_grok.yml</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202406011249952.png#id=UaKvc&originHeight=812&originWidth=2289&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<h5 id="6-6-Logstash-自定义Tags"><a href="#6-6-Logstash-自定义Tags" class="headerlink" title="6.6 Logstash 自定义Tags"></a>6.6 Logstash 自定义Tags</h5><p>简介：如果此筛选成功，请向事件添加任意标记。 标记可以是动态的，并使用语法包含事件的某些部分。<code>%{field}</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Filebeat配置文件编写</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim filebeat-out-logstash.yml</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line">  tags: [<span class="string">"access"</span>]</span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [<span class="string">"192.168.174.142:5044"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除偏移量</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Filebeat实例</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat  -e -c ~/filebeat-out-logstash.yml </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Logstash配置文件编写</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># vim filter_grok.yml </span></span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 5044</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123;</span><br><span class="line">      <span class="string">"message"</span> =&gt; <span class="string">"%&#123;HTTPD_COMMONLOG&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment"># You can also remove multiple fields at once: </span></span><br><span class="line">   remove_field =&gt; [ <span class="string">"type"</span>,<span class="string">"offset"</span>,<span class="string">"ecs"</span>,<span class="string">"input"</span>,<span class="string">"@version"</span>,<span class="string">"log"</span>,<span class="string">"agent"</span>,<span class="string">"tags"</span> ]</span><br><span class="line">    <span class="comment"># You can also add multiple fields at once:</span></span><br><span class="line">   add_field =&gt; &#123; </span><br><span class="line">     <span class="string">"host-name"</span> =&gt; <span class="string">"%&#123;host&#125;"</span></span><br><span class="line">     <span class="string">"service"</span> =&gt; <span class="string">"ELK stack"</span></span><br><span class="line">     &#125;</span><br><span class="line">   <span class="comment"># You can also add multiple tags at once:</span></span><br><span class="line">   add_tag =&gt; [ <span class="string">"Filebeat"</span>, <span class="string">"Logstash"</span>,<span class="string">"Nginx"</span>,<span class="string">"Tomcat"</span>,<span class="string">"Kibana"</span>]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line"></span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">"192.168.174.140:9200"</span>,<span class="string">"192.168.174.141:9200"</span>,<span class="string">"192.168.174.142:9200"</span>]</span><br><span class="line">    index =&gt; <span class="string">"test-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Logstash实例</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># logstash -rf ~/filter_grok.yml</span></span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202406011255129.png#id=mVQ7M&originHeight=1125&originWidth=2286&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<h4 id="7、Logstash-geoip插件分析用户IP所属地"><a href="#7、Logstash-geoip插件分析用户IP所属地" class="headerlink" title="7、Logstash geoip插件分析用户IP所属地"></a>7、Logstash geoip插件分析用户IP所属地</h4><p>官方：<a href="https://www.elastic.co/guide/en/logstash/7.17/plugins-filters-geoip.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/7.17/plugins-filters-geoip.html</a><br>简介：GeoIP 过滤器添加有关 IP 地址地理位置的信息， 基于 MaxMind GeoLite2 数据库的数据。 MaxMind GeoLite2 数据库：开源IP地址定位数据库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Filebeat配置文件编写</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim filebeat-out-logstash.yml</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line">  tags: [<span class="string">"access"</span>]</span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [<span class="string">"192.168.174.142:5044"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除偏移量</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Filebeat实例</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat  -e -c ~/filebeat-out-logstash.yml </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Logstash配置文件编写</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># vim filter_grok.yml </span></span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 5044</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123;</span><br><span class="line">      <span class="string">"message"</span> =&gt; <span class="string">"%&#123;HTTPD_COMMONLOG&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment"># You can also remove multiple fields at once: </span></span><br><span class="line">   remove_field =&gt; [ <span class="string">"type"</span>,<span class="string">"offset"</span>,<span class="string">"ecs"</span>,<span class="string">"input"</span>,<span class="string">"@version"</span>,<span class="string">"log"</span>,<span class="string">"agent"</span>,<span class="string">"tags"</span> ]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># 指定geoip插件</span></span><br><span class="line">  geoip &#123;</span><br><span class="line">      <span class="comment"># 配置客户端IP字段名称</span></span><br><span class="line">      <span class="built_in">source</span> =&gt; <span class="string">"clientip"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line"></span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">"192.168.174.140:9200"</span>,<span class="string">"192.168.174.141:9200"</span>,<span class="string">"192.168.174.142:9200"</span>]</span><br><span class="line">    index =&gt; <span class="string">"test-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Logstash实例</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># logstash -rf ~/filter_grok.yml</span></span><br></pre></td></tr></table></figure>

<h4 id="8、Logstash-useragent插件分析用户客户端类型"><a href="#8、Logstash-useragent插件分析用户客户端类型" class="headerlink" title="8、Logstash useragent插件分析用户客户端类型"></a>8、Logstash useragent插件分析用户客户端类型</h4><p>​    官网：<a href="https://www.elastic.co/guide/en/logstash/7.17/plugins-filters-useragent.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/7.17/plugins-filters-useragent.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Filebeat配置文件编写</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim filebeat-out-logstash.yml</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line">  tags: [<span class="string">"access"</span>]</span><br><span class="line">  json.keys_under_root: <span class="literal">true</span>  </span><br><span class="line"></span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [<span class="string">"192.168.174.142:5044"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除偏移量</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Filebeat实例</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat  -e -c ~/filebeat-out-logstash.yml </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Logstash配置文件编写</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># vim filter_grok.yml </span></span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 5044</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123; </span><br><span class="line">   remove_field =&gt; [ <span class="string">"type"</span>,<span class="string">"offset"</span>,<span class="string">"ecs"</span>,<span class="string">"input"</span>,<span class="string">"@version"</span>,<span class="string">"log"</span>,<span class="string">"agent"</span>,<span class="string">"tags"</span> ]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># 指定geoip插件</span></span><br><span class="line">  geoip &#123;</span><br><span class="line">      <span class="comment"># 配置客户端IP字段名称</span></span><br><span class="line">      <span class="built_in">source</span> =&gt; <span class="string">"clientip"</span></span><br><span class="line">  &#125;</span><br><span class="line">  useragent &#123;</span><br><span class="line">    <span class="built_in">source</span> =&gt; <span class="string">"http_user_agent"</span></span><br><span class="line">    target =&gt; <span class="string">"test_user_agent"</span></span><br><span class="line">    remove_field =&gt; [ <span class="string">"agent"</span>,<span class="string">"@version"</span>,<span class="string">"tags"</span>,<span class="string">"ecs"</span>,<span class="string">"log"</span>,<span class="string">"offset"</span>,<span class="string">"type"</span> ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line"></span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">"192.168.174.140:9200"</span>,<span class="string">"192.168.174.141:9200"</span>,<span class="string">"192.168.174.142:9200"</span>]</span><br><span class="line">    index =&gt; <span class="string">"test-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Logstash实例</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># logstash -rf ~/filter_grok.yml</span></span><br></pre></td></tr></table></figure>

<h4 id="9、Logstash-Filter多if分支"><a href="#9、Logstash-Filter多if分支" class="headerlink" title="9、Logstash Filter多if分支"></a>9、Logstash Filter多if分支</h4><p>官网：<a href="https://www.elastic.co/guide/en/logstash/7.17/event-dependent-configuration.html#metadata" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/7.17/event-dependent-configuration.html#metadata</a><br>简介： 针对不同的日志类型。filter去做不同的处理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Filebeat配置文件</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># vim  filebeat-out-logstash.yml </span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line">  fields:</span><br><span class="line">    log_type: nginx_access</span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br><span class="line">  json.keys_under_root: <span class="literal">true</span>   </span><br><span class="line"></span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/error.log</span><br><span class="line">  fields:</span><br><span class="line">    log_type: nginx_error</span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/messages</span><br><span class="line">  fields:</span><br><span class="line">    log_type: system_log</span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [<span class="string">"192.168.174.142:5044"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除偏移量</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Filebeat实例</span></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat  -e -c ~/filebeat-out-logstash.yml </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Logstash 配置文件准备</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># vim filter_grok.yml </span></span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 5044</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  mutate &#123;</span><br><span class="line">    add_field =&gt; &#123;</span><br><span class="line">      <span class="string">"name"</span> =&gt; <span class="string">"ELK stack"</span> </span><br><span class="line">    &#125;</span><br><span class="line">    remove_field =&gt; [<span class="string">"agent"</span>,<span class="string">"ephemeral_id"</span>,<span class="string">"ecs"</span>,<span class="string">"@version"</span>,<span class="string">"tags"</span>,<span class="string">"input"</span>,<span class="string">"log"</span>,<span class="string">"offest"</span>]  </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> [log_type] == <span class="string">"nginx_access"</span> &#123;</span><br><span class="line">     geoip &#123;</span><br><span class="line">       <span class="built_in">source</span> =&gt; <span class="string">"clientip"</span></span><br><span class="line">     &#125;</span><br><span class="line">     useragent &#123;</span><br><span class="line">       <span class="built_in">source</span> =&gt; <span class="string">"http_user_agent"</span> </span><br><span class="line">       target =&gt; <span class="string">"study_user_agent"</span></span><br><span class="line">     &#125;</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [log_type] == <span class="string">"nginx_access"</span> &#123;  </span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [<span class="string">"192.168.174.140:9200"</span>,<span class="string">"192.168.174.141:9200"</span>,<span class="string">"192.168.174.142:9200"</span>] </span><br><span class="line">      index =&gt; <span class="string">"web-access-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">    &#125; </span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> [log_type] == <span class="string">"nginx_error"</span> &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">          hosts =&gt; [<span class="string">"192.168.174.140:9200"</span>,<span class="string">"192.168.174.141:9200"</span>,<span class="string">"192.168.174.142:9200"</span>]</span><br><span class="line">          index =&gt; <span class="string">"web-error-%&#123;+yyyy.MM.dd&#125;"</span>   </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;  <span class="keyword">else</span> <span class="keyword">if</span> [log_type] == <span class="string">"system_log"</span> &#123;</span><br><span class="line">       elasticsearch &#123;</span><br><span class="line">         hosts =&gt; [<span class="string">"192.168.174.140:9200"</span>,<span class="string">"192.168.174.141:9200"</span>,<span class="string">"192.168.174.142:9200"</span>]</span><br><span class="line">         index =&gt; <span class="string">"system-log-%&#123;+yyyy.MM.dd&#125;"</span>     </span><br><span class="line">    &#125; </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Logstash</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># logstash  -rf ~/filter_grok.yml</span></span><br></pre></td></tr></table></figure>


<h2 id="八、Kibana操作使用"><a href="#八、Kibana操作使用" class="headerlink" title="八、Kibana操作使用"></a>八、Kibana操作使用</h2><h3 id="1、kibana手动创建索引模板"><a href="#1、kibana手动创建索引模板" class="headerlink" title="1、kibana手动创建索引模板"></a>1、kibana手动创建索引模板</h3><p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405310044720.png#id=TjLJ0&originHeight=1260&originWidth=2507&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405310044170.png#id=Ty1KL&originHeight=1037&originWidth=2100&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405310045784.png#id=PjKWz&originHeight=1244&originWidth=1917&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405310047016.png#id=a7ORh&originHeight=1252&originWidth=2011&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">"number_of_replicas"</span>:1,</span><br><span class="line"><span class="string">"number_of_shards"</span>:3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202405310049148.png#id=CosFV&originHeight=1000&originWidth=2096&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<h2 id="九、kafka简介和使用"><a href="#九、kafka简介和使用" class="headerlink" title="九、kafka简介和使用"></a>九、kafka简介和使用</h2><h3 id="1、MQ两种模式"><a href="#1、MQ两种模式" class="headerlink" title="1、MQ两种模式"></a>1、MQ两种模式</h3><h4 id="1-1-P2P模式"><a href="#1-1-P2P模式" class="headerlink" title="1.1 P2P模式"></a>1.1 P2P模式</h4><h5 id="1-1-1-架构图"><a href="#1-1-1-架构图" class="headerlink" title="1.1.1 架构图"></a>1.1.1 架构图</h5><p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202406020000698.png" alt></p>
<h5 id="1-1-2-简介"><a href="#1-1-2-简介" class="headerlink" title="1.1.2 简介"></a>1.1.2 简介</h5><p>​    在消息队列（MQ）系统中，==点对点模式==（Point-to-Point Model）是最基本的消息通信模式之一。在这种模式下，消息生产者发送消息到一个队列（Queue），而消息消费者从这个队列中接收和处理消息。每条消息只能被一个消费者消费一次，这与发布/订阅模式（Pub/Sub Model）中的多播机制不同。</p>
<h5 id="1-1-3-工作流程"><a href="#1-1-3-工作流程" class="headerlink" title="1.1.3 工作流程"></a>1.1.3 工作流程</h5><ol>
<li><strong>生产者发送消息</strong>：生产者创建一条消息，并将其发送到指定的<strong>队列</strong>（Queue）。</li>
<li><strong>队列暂存消息</strong>：队列接收到消息并<strong>存储</strong>，等待消费者来接收。</li>
<li><strong>消费者接收消息</strong>：消费者从<strong>队列</strong>中<strong>检索</strong>消息进行处理。如果有多个消费者，每条消息只会被其中一个消费者接收。</li>
<li><strong>消息确认</strong>：消费者处理完消息后，向队列发送确认，表示消息已经成功处理。MQ<strong>删除消费数据</strong>。<strong>如果消费者没有确认消息，消息可能会被重新投递到队列中供其他消费者处理。</strong></li>
</ol>
<h4 id="1-2-发布-订阅模式"><a href="#1-2-发布-订阅模式" class="headerlink" title="1.2 发布/订阅模式"></a>1.2 发布/订阅模式</h4><h5 id="1-2-1-架构图"><a href="#1-2-1-架构图" class="headerlink" title="1.2.1 架构图"></a>1.2.1 架构图</h5><p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202406020008444.png#id=wvuow&originHeight=609&originWidth=1648&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<h5 id="1-2-2-简介"><a href="#1-2-2-简介" class="headerlink" title="1.2.2 简介"></a>1.2.2 简介</h5><p>​    在消息队列（MQ）系统中，发布-订阅模式（Publish-Subscribe Model，简称Pub/Sub）是一种常见的消息通信模式。在这种模式下，消息生产者（发布者）将消息发布到一个主题（Topic），而消息消费者（订阅者）则订阅该主题，从而接收发布者发布的消息。与点对点模式不同，发布到主题的<strong>每条消息可以被多个订阅者接收和处理</strong>。</p>
<h5 id="1-2-3-工作流程"><a href="#1-2-3-工作流程" class="headerlink" title="1.2.3 工作流程"></a>1.2.3 工作流程</h5><ol>
<li><strong>发布者发布消息</strong>：发布者创建一条消息，并将其发布到指定的主题。</li>
<li><strong>主题广播消息</strong>：主题接收到消息，并将其广播给所有订阅了该主题的订阅者。</li>
<li><strong>订阅者接收消息</strong>：订阅者接收或者拉取主题广播的消息并进行处理。</li>
</ol>
<ul>
<li><strong>Pull方式</strong><ul>
<li><strong>优点</strong>：消费者根据自身消费数据的能力去队列中拉取数据。</li>
<li><strong>缺点</strong>：消费者需要长期打开一个进程来监视队列是否有数据产生。</li>
</ul>
</li>
<li><strong>Push方式</strong><ul>
<li><strong>优点</strong>：消息队列主动推送数据，例如：<strong>公众号话题推送，APP更新推送</strong>。</li>
<li><strong>缺点</strong>：消息队列自身需要维护一张订阅者名单。<strong>当订阅者过多时，特别消耗资源。</strong></li>
</ul>
</li>
</ul>
<h3 id="2、kafka相关概念"><a href="#2、kafka相关概念" class="headerlink" title="2、kafka相关概念"></a>2、kafka相关概念</h3><p>​    <strong>官网</strong>：<a href="https://kafka.apache.org/" target="_blank" rel="noopener">https://kafka.apache.org/</a></p>
<h4 id="2-1-介绍"><a href="#2-1-介绍" class="headerlink" title="2.1 介绍"></a>2.1 介绍</h4><p>​    ==Apache Kafka==是一个开源的<strong>分布式</strong>事件流平台，由数以千计的公司提供高性能数据管道、流分析、 数据集成和任务关键型应用程序。</p>
<ul>
<li><p><strong>高吞吐量</strong>：使用延迟低至2ms的机器集群以网络有限的吞吐量传递消息。</p>
</li>
<li><p><strong>可伸缩</strong>：将生产集群扩展到1000个代理、每天数万亿条消息、PB的数据和数十万个分区。弹性扩展和收缩存储和处理。</p>
</li>
<li><p><strong>永久存储器</strong>：将数据流安全地存储在分布式、持久、容错的集群中。</p>
</li>
<li><p><strong>高可用性</strong>：在可用性区域上高效地扩展集群，或者跨地理区域连接单独的集群。</p>
<h4 id="2-2-Kafka相关专业术语"><a href="#2-2-Kafka相关专业术语" class="headerlink" title="2.2 Kafka相关专业术语"></a>2.2 Kafka相关专业术语</h4></li>
<li><p><strong>主题（Topic）</strong>：主题是Kafka中用于对消息进行分类的逻辑分组，每个主题可以看作是消息的分类器。主题是多订阅者模式，即一个主题可以有多个消费者订阅。</p>
</li>
<li><p><strong>分区（Partition）</strong>：每个主题被分成一个或多个分区。分区是消息存储的基本单元。分区内的消息是有序的，但不同分区之间无序。每个分区可以分布在不同的Kafka服务器上，从而实现水平扩展。</p>
<ul>
<li><strong>leader partition</strong> 负责对kafka集群的读写操作，和客户端进行交互</li>
<li><strong>follower partition</strong> 负责去leader partition 同步数据，不可以和客户端进行交互</li>
</ul>
</li>
<li><p><strong>偏移量（Offset）</strong>：偏移量是分区中每条消息的唯一标识符。它是一个递增的整数，记录了消息在分区中的位置。消费者使用偏移量来跟踪读取消息的位置。</p>
</li>
<li><p><strong>生产者（Producer）</strong>：生产者是负责向Kafka主题发布消息的客户端应用程序。生产者将消息发送到指定的主题和分区。</p>
</li>
<li><p><strong>消费者（Consumer）</strong>：消费者是负责从Kafka主题读取消息的客户端应用程序。消费者通过订阅一个或多个主题来读取消息，并使用偏移量来跟踪读取进度。</p>
</li>
<li><p><strong>消费者组（Consumer Group）</strong>：消费者组是一组消费者实例，共同消费一个或多个主题的消息。</p>
</li>
<li><p><strong>代理（Broker）</strong>：代理是Kafka集群中的一个服务器节点，负责存储和传输消息数据。一个Kafka集群由多个代理组成，每个代理可以处理多个分区。</p>
</li>
<li><p><strong>复制（Replication）</strong>：Kafka中的复制机制将分区数据复制到多个代理上，以确保数据的高可用性和容错性。每个分区有一个领导副本（Leader）和若干个跟随副本（Follower）。所有的读写操作都由领导副本处理，跟随副本只需同步领导副本的数据。但是Leader和Follwer都属于副本。创建时不能副本数不能为0。</p>
</li>
</ul>
<h3 id="3、Zookeeper使用和配置"><a href="#3、Zookeeper使用和配置" class="headerlink" title="3、Zookeeper使用和配置"></a>3、Zookeeper使用和配置</h3><p>官网链接：<a href="https://dlcdn.apache.org/zookeeper/" target="_blank" rel="noopener">https://dlcdn.apache.org/zookeeper/</a></p>
<p>下载链接：<a href="https://dlcdn.apache.org/zookeeper/zookeeper-3.8.4/apache-zookeeper-3.8.4-bin.tar.gz" target="_blank" rel="noopener">https://dlcdn.apache.org/zookeeper/zookeeper-3.8.4/apache-zookeeper-3.8.4-bin.tar.gz</a></p>
<h4 id="3-1-简介："><a href="#3-1-简介：" class="headerlink" title="3.1 简介："></a>3.1 简介：</h4><p>​    Zookeeper 是 Apache 旗下的一个开源<strong>分布式协调服务</strong>，用于管理和协调分布式应用程序中的各种服务和组件。它提供了一系列高效且可靠的分布式数据一致性和协调机制。</p>
<h4 id="3-2-zookeeper集群部署：三节点😀"><a href="#3-2-zookeeper集群部署：三节点😀" class="headerlink" title="3.2 zookeeper集群部署：三节点😀"></a>3.2 zookeeper集群部署：<code>三节点</code>😀</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 解压安装包到指定目录</span></span><br><span class="line">$ tar xf apache-zookeeper-3.8.2-bin.tar.gz  -C /opt/ &amp;&amp; <span class="built_in">cd</span> /opt/</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 更改目录名称</span></span><br><span class="line">$ mv apache-zookeeper-3.8.2-bin/   zookeeper</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 配置zk环境变量</span></span><br><span class="line">$ cat &gt;&gt; /etc/profile.d/zookeeper.sh &lt;&lt;-EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">export</span> ZK_HOME=/opt/zookeeper</span><br><span class="line"><span class="built_in">export</span> PATH=\<span class="variable">$PATH</span>:\<span class="variable">$ZK_HOME</span>/bin</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 重新加载环境变量 </span></span><br><span class="line">$ <span class="built_in">source</span> /etc/profile.d/zookeeper.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建zk数据存放目录</span></span><br><span class="line">$ mkdir -p /opt/data/zk</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 修改zk的配置文件(三节点)</span></span><br><span class="line">$ cp /opt/zookeeper/conf/zoo_sample.cfg  /opt/zookeeper/conf/zoo.cfg</span><br><span class="line"></span><br><span class="line">$ egrep -v <span class="string">"^(#|$)"</span> /opt/zookeeper/conf/zoo.cfg </span><br><span class="line">	<span class="comment"># Zookeeper的心跳间隔时间。服务器和客户端会通过心跳包维持连接状态。</span></span><br><span class="line">tickTime=2000</span><br><span class="line">	<span class="comment"># 从节点最多可以等待10 个tickTime（即 10 * 2000 毫秒 = 20 秒）来与领导者同步数据状态。否则它将被认为是不可用的。</span></span><br><span class="line">initLimit=10</span><br><span class="line">	<span class="comment"># 定义Zookeeper领导者和从节点之间的心跳和同步请求的最大允许延迟时间。领导者与从节点之间的响应时间如果超过了这个限制，从节点将被认为失去同步状态。（即 5 * 2000 毫秒 = 10 秒）。</span></span><br><span class="line">syncLimit=5</span><br><span class="line">	<span class="comment"># 定义zk数据目录</span></span><br><span class="line">dataDir=/opt/data/zk</span><br><span class="line">	<span class="comment"># 定义Zookeeper集群的客户端连接端口</span></span><br><span class="line">clientPort=2181</span><br><span class="line">server.140=192.168.174.140:2888:3888</span><br><span class="line">server.141=192.168.174.141:2888:3888</span><br><span class="line">server.142=192.168.174.142:2888:3888</span><br><span class="line">    <span class="comment"># 参数解释：</span></span><br><span class="line">            <span class="comment"># dataDir		zk数据目录</span></span><br><span class="line">            <span class="comment"># clientPort	端口号</span></span><br><span class="line">            <span class="comment"># server.140	zk节点唯一标识</span></span><br><span class="line">            <span class="comment"># 192.168.100.160	zk节点主机地址</span></span><br><span class="line">            <span class="comment"># 2888				集群内部通讯端口</span></span><br><span class="line">            <span class="comment"># 3888				leader选举端口</span></span><br><span class="line">            </span><br><span class="line"><span class="comment"># 创建ID文件(位置存放在zk的数据存放路径下)</span></span><br><span class="line">        101节点</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"140"</span> &gt; /opt/data/zk/myid</span><br><span class="line">        102节点</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"141"</span> &gt; /opt/data/zk/myid</span><br><span class="line">        103节点</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"142"</span> &gt; /opt/data/zk/myid</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 所有节点启动zk</span></span><br><span class="line">$ zkServer.sh start</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看zk状态</span></span><br><span class="line">$ zkServer.sh status</span><br></pre></td></tr></table></figure>
<p><strong>myid文件</strong>：在Zookeeper集群中，<strong>myid</strong>文件是每个Zookeeper服务器节点的重要配置文件之一，用于唯一标识集群中的每个服务器。</p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202406020109804.png" alt></p>
<h4 id="3-3-Zookeeper角色划分"><a href="#3-3-Zookeeper角色划分" class="headerlink" title="3.3 Zookeeper角色划分"></a>3.3 Zookeeper角色划分</h4><p>在Zookeeper集群中，不同的服务器节点可以承担不同的角色，以确保集群的高可用性、数据一致性和故障恢复能力。主要角色包括：==<strong>server.140=192.168.174.140:2888:3888:角色</strong>==</p>
<ol>
<li><p><strong>领导者（Leader）</strong></p>
<ul>
<li><p>处理所有写操作（如创建、更新、删除节点）并确保数据的一致性。</p>
</li>
<li><p>管理并协调集群中其他节点的活动。</p>
</li>
<li><p>负责为客户端请求生成唯一的事务ID（zxid）。</p>
</li>
<li><p>在集群启动或领导者失效时，会进行领导者选举，选出新的领导者。</p>
</li>
<li><p>定期发送心跳给跟随者，确保自己处于活动状态。</p>
</li>
</ul>
</li>
<li><p><strong>跟随者（Follower）</strong></p>
<ul>
<li>处理所有读取操作（如读取节点数据）。</li>
<li>接收并转发客户端的写请求给领导者进行处理。</li>
<li>将领导者的事务日志同步到本地，确保数据一致性。</li>
<li>参与领导者选举。</li>
<li>与领导者保持同步，接收并应用领导者的事务。</li>
</ul>
</li>
<li><p><strong>观察者（Observer）</strong></p>
<ul>
<li>处理读取操作，减轻领导者和跟随者的负担。</li>
<li>不参与领导者选举和事务投票，只同步领导者的事务日志。</li>
<li>提高集群的读取扩展能力，适合需要高读取吞吐量的场景。</li>
</ul>
</li>
<li><p><strong>客户端（Client）</strong></p>
<ul>
<li>连接到集群中的任一节点进行读取或写入操作。</li>
<li>自动处理节点故障并重新连接到其他可用节点。</li>
<li>通过客户端API与Zookeeper集群进行交互。<h4 id="3-4-zookeeper配置内存堆栈"><a href="#3-4-zookeeper配置内存堆栈" class="headerlink" title="3.4 zookeeper配置内存堆栈"></a>3.4 zookeeper配置内存堆栈</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 查看zk进程</span></span><br><span class="line">$ jps</span><br><span class="line">1367 Elasticsearch</span><br><span class="line">5400 QuorumPeerMain</span><br><span class="line">5593 Jps</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看zk的堆栈大小</span></span><br><span class="line">$ jmap -heap 5400</span><br></pre></td></tr></table></figure>
<img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202406020135738.png" alt></li>
</ul>
</li>
</ol>
<p><strong>zookeeper默认堆内存大小为1GB，一般设置为2GB或者4GB</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 调节zookeeper推内存大小为256MB</span></span><br><span class="line">$ vim /opt/zookeeper/conf/java.env</span><br><span class="line"><span class="meta">#! /bin/bash </span></span><br><span class="line"> <span class="comment"># 指定JDK安装路径 </span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/java </span><br><span class="line"> <span class="comment"># 指定zookeeper的堆内存大小 </span></span><br><span class="line"><span class="built_in">export</span> JVMFLAGS=<span class="string">"-Xms256m -Xmx256m <span class="variable">$JVMFLAGS</span>"</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 同步文件</span></span><br><span class="line">$ scp /opt/zookeeper/conf/java.env  elk02:/opt/zookeeper/conf/</span><br><span class="line">$ scp /opt/zookeeper/conf/java.env  elk03:/opt/zookeeper/conf/</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 所有节点重启zk</span></span><br><span class="line">$ zkServer.sh restart</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 验证堆内存</span></span><br><span class="line">$ jmap -heap `jps | grep QuorumPeerMain | awk <span class="string">'&#123;print $1&#125;'</span>`</span><br></pre></td></tr></table></figure>

<h3 id="4、kafka集群安装：三节点😀"><a href="#4、kafka集群安装：三节点😀" class="headerlink" title="4、kafka集群安装：三节点😀"></a>4、kafka集群安装：<code>三节点</code>😀</h3><p>​    下载链接：<a href="https://kafka.apache.org/downloads" target="_blank" rel="noopener">https://kafka.apache.org/downloads</a><br>​    官网：<a href="https://kafka.apache.org/" target="_blank" rel="noopener">https://kafka.apache.org/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 解压安装包到指定目录</span></span><br><span class="line">$ tar xf kafka_2.13-3.2.1.tgz  -C /opt/ &amp;&amp;  <span class="built_in">cd</span> /opt/</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 修改目录名称</span></span><br><span class="line">$ mv kafka_2.13-3.2.1/  kafka</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 配置kafka环境变量</span></span><br><span class="line">$ cat &gt;&gt; /etc/profile.d/kafka.sh &lt;&lt;-EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">export</span> KAFKA_HOME=/opt/kafka</span><br><span class="line"><span class="built_in">export</span> PATH=\<span class="variable">$PATH</span>:\<span class="variable">$KAFKA_HOME</span>/bin</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 重新加载环境变量</span></span><br><span class="line">$ <span class="built_in">source</span> /etc/profile.d/kafka.sh </span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建数据目录</span></span><br><span class="line">$ mkdir /opt/data/kafka -p</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 修改kafka配置文件</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 1.kafka101节点配置文件</span></span><br><span class="line">$ egrep -v <span class="string">"^(#|$)"</span> kafka/config/server.properties</span><br><span class="line">broker.id=140</span><br><span class="line">log.dirs=/opt/data/kafka/</span><br><span class="line">zookeeper.connect=192.168.174.140:2181,192.168.174.141:2181,192.168.174.142:2181/kafka</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 2.kafka102节点配置文件</span></span><br><span class="line">$ egrep -v <span class="string">"^(#|$)"</span> kafka/config/server.properties  </span><br><span class="line">broker.id=141</span><br><span class="line">log.dirs=/opt/data/kafka/</span><br><span class="line">zookeeper.connect=192.168.174.140:2181,192.168.174.141:2181,192.168.174.142:2181/kafka	<span class="comment"># /kafka为zk中的znode</span></span><br><span class="line"> </span><br><span class="line"> 	<span class="comment"># 3.kafka103节点配置文件</span></span><br><span class="line">$ egrep -v <span class="string">"^(#|$)"</span> kafka/config/server.properties  </span><br><span class="line">broker.id=142</span><br><span class="line">log.dirs=/opt/data/kafka/</span><br><span class="line">zookeeper.connect=192.168.174.140:2181,192.168.174.141:2181,192.168.174.142:2181/kafka</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 所有节点启动kafka</span></span><br><span class="line">$ kafka-server-start.sh -daemon /opt/kafka/config/server.properties </span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; zk节点查看kafka注册信息</span></span><br><span class="line">$ zkCli.sh ls /kafka/brokers/ids | grep  <span class="string">"^\["</span></span><br><span class="line">[140, 141, 142]</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; kafka停止脚本</span></span><br><span class="line">$ kafka-server-stop.sh</span><br></pre></td></tr></table></figure>



<h3 id="5、Kafka-Topic日常操作"><a href="#5、Kafka-Topic日常操作" class="headerlink" title="5、Kafka Topic日常操作"></a>5、Kafka Topic日常操作</h3><h4 id="5-1-查看Topic相关信息"><a href="#5-1-查看Topic相关信息" class="headerlink" title="5.1 查看Topic相关信息"></a>5.1 查看Topic相关信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 查看集群中所有Topic</span></span><br><span class="line">$ kafka-topics.sh   --bootstrap-server  192.168.174.140:9092,192.168.174.141:9092,192.168.174.142:9092  --list</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看所有Topic详细信息</span></span><br><span class="line">$ kafka-topics.sh   --bootstrap-server  192.168.174.140:9092,192.168.174.141:9092,192.168.174.142:9092  --describe</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看某个Topic信息</span></span><br><span class="line">$ kafka-topics.sh   --bootstrap-server  192.168.174.140:9092,192.168.174.141:9092,192.168.174.142:9092  --describe  --topic  Topice名称</span><br></pre></td></tr></table></figure>


<h4 id="5-2-创建Topic"><a href="#5-2-创建Topic" class="headerlink" title="5.2 创建Topic"></a>5.2 创建Topic</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 创建test-elk Topic</span></span><br><span class="line">$ kafka-topics.sh   --bootstrap-server  192.168.174.140:9092 --create --topic <span class="built_in">test</span>-elk</span><br><span class="line">Created topic <span class="built_in">test</span>-elk.</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建Topic，并指定副本数量</span></span><br><span class="line">$ kafka-topics.sh   --bootstrap-server  192.168.174.140:9092 --create --topic <span class="built_in">test</span>-elk-02  --partitions 10 --replication-factor 1</span><br><span class="line">Created topic <span class="built_in">test</span>-elk.</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Topic的详细信息</span></span><br><span class="line">$ kafka-topics.sh   --bootstrap-server  192.168.174.140:9092  --describe --topic <span class="built_in">test</span>-elk-02</span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202406020407871.png#id=PAr2v&originHeight=504&originWidth=2263&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 创建Topic，并指定副本数量</span></span><br><span class="line">$ kafka-topics.sh   --bootstrap-server  192.168.174.140:9092 --create --topic <span class="built_in">test</span>-elk-03  --partitions 10 --replication-factor 2</span><br><span class="line"></span><br><span class="line">$ kafka-topics.sh   --bootstrap-server  192.168.174.140:9092  --describe --topic <span class="built_in">test</span>-elk-03</span><br></pre></td></tr></table></figure>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202406020410226.png#id=xl6sS&originHeight=504&originWidth=2282&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none" alt="     "></p>
<p><strong>注意：副本数量不能大于Broker的数量</strong></p>
<h3 id="6、Filebeat收集日志至Kafka"><a href="#6、Filebeat收集日志至Kafka" class="headerlink" title="6、Filebeat收集日志至Kafka"></a>6、Filebeat收集日志至Kafka</h3><p>官网：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.17/kafka-output.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/7.17/kafka-output.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01 ~]<span class="comment"># cat filbeat-out-kafka.yml </span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line">  fields:</span><br><span class="line">    log_type: nginx_access</span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br><span class="line">  json.keys_under_root: <span class="literal">true</span>   </span><br><span class="line"></span><br><span class="line"><span class="comment">#- type: log</span></span><br><span class="line"><span class="comment">#  paths:</span></span><br><span class="line"><span class="comment">#    - /var/log/nginx/error.log</span></span><br><span class="line"><span class="comment">#  fields:</span></span><br><span class="line"><span class="comment">#    log_type: nginx_error</span></span><br><span class="line"><span class="comment">#  fields_under_root: true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output.kafka:</span><br><span class="line">  <span class="comment"># initial brokers for reading cluster metadata</span></span><br><span class="line">  hosts: [<span class="string">"192.168.174.140:9092"</span>, <span class="string">"192.168.174.141:9092"</span>, <span class="string">"192.168.174.142:9092"</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># message topic selection + partitioning</span></span><br><span class="line">  topic: <span class="string">"test-kafka-topic"</span></span><br><span class="line"></span><br><span class="line">[root@elk01 ~]<span class="comment"># filebeat  -e -c ~/filbeat-out-kafka.yml </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kafka测试拉取数据</span></span><br><span class="line">[root@elk03 opt]<span class="comment"># kafka-console-consumer.sh   --topic test-kafka-topic  --bootstrap-server 192.168.174.140:9092,192.168.174.141:9092,192.168.174.142:9092  --from-beginning</span></span><br></pre></td></tr></table></figure>


<h3 id="7、Logstash收集Kafka-Topic日志"><a href="#7、Logstash收集Kafka-Topic日志" class="headerlink" title="7、Logstash收集Kafka Topic日志"></a>7、Logstash收集Kafka Topic日志</h3><p>官网：<a href="https://www.elastic.co/guide/en/logstash/7.17/plugins-inputs-kafka.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/7.17/plugins-inputs-kafka.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    bootstrap_servers =&gt; <span class="string">"192.168.174.140:9092,192.168.174.141:9092,192.168.174.142:9092"</span>  <span class="comment"># Kafka集群IP</span></span><br><span class="line">    topics =&gt; [<span class="string">"test-kafka-topic"</span>]     <span class="comment"># 指定Topic进行消费数据</span></span><br><span class="line">    group_id =&gt; <span class="string">"test-kafka"</span>     <span class="comment"># 指定消费者组</span></span><br><span class="line">    codec =&gt; json &#123;                      <span class="comment"># 指定消费的数据是JSON格式。</span></span><br><span class="line">             charset =&gt; <span class="string">"UTF-8"</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  mutate &#123;</span><br><span class="line">    add_field =&gt; &#123;</span><br><span class="line">      <span class="string">"name"</span> =&gt; <span class="string">"ELK stack"</span> </span><br><span class="line">    &#125;</span><br><span class="line">    remove_field =&gt; [<span class="string">"agent"</span>,<span class="string">"ephemeral_id"</span>,<span class="string">"ecs"</span>,<span class="string">"@version"</span>,<span class="string">"tags"</span>,<span class="string">"input"</span>,<span class="string">"log"</span>,<span class="string">"offest"</span>]  </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> [log_type] == <span class="string">"nginx_access"</span> &#123;</span><br><span class="line">     geoip &#123;</span><br><span class="line">       <span class="built_in">source</span> =&gt; <span class="string">"clientip"</span></span><br><span class="line">     &#125;</span><br><span class="line">     useragent &#123;</span><br><span class="line">       <span class="built_in">source</span> =&gt; <span class="string">"http_user_agent"</span> </span><br><span class="line">       target =&gt; <span class="string">"study_user_agent"</span></span><br><span class="line">     &#125;</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#将下面解开注释即可将数据存入es集群中，分类添加索引到kibana界面上然后呈现数据</span></span><br><span class="line"><span class="comment">#  if [log_type] == "nginx_access" &#123;  </span></span><br><span class="line"><span class="comment">#    elasticsearch &#123;</span></span><br><span class="line"><span class="comment">#      hosts =&gt; ["192.168.174.140:9200","192.168.174.141:9200","192.168.174.142:9200"] </span></span><br><span class="line"><span class="comment">#      index =&gt; "web-access-%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line"><span class="comment">#    &#125; </span></span><br><span class="line"><span class="comment">#  &#125; else if [log_type] == "nginx_error" &#123;</span></span><br><span class="line"><span class="comment">#        elasticsearch &#123;</span></span><br><span class="line"><span class="comment">#          hosts =&gt; ["192.168.174.140:9200","192.168.174.141:9200","192.168.174.142:9200"]</span></span><br><span class="line"><span class="comment">#          index =&gt; "web-error-%&#123;+yyyy.MM.dd&#125;"   </span></span><br><span class="line"><span class="comment">#    &#125;</span></span><br><span class="line"><span class="comment">#  &#125;  else if [log_type] == "system_log" &#123;</span></span><br><span class="line"><span class="comment">#       elasticsearch &#123;</span></span><br><span class="line"><span class="comment">#         hosts =&gt; ["192.168.174.140:9200","192.168.174.141:9200","192.168.174.142:9200"]</span></span><br><span class="line"><span class="comment">#         index =&gt; "system-log-%&#123;+yyyy.MM.dd&#125;"     </span></span><br><span class="line"><span class="comment">#    &#125; </span></span><br><span class="line"><span class="comment">#   &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Logstash实例</span></span><br><span class="line">[root@elk03 ~]<span class="comment"># logstash  -rf ~/filter_grok.yml</span></span><br></pre></td></tr></table></figure>

<h2 id="十、Elasticsearch-Restful风格API实战"><a href="#十、Elasticsearch-Restful风格API实战" class="headerlink" title="十、Elasticsearch Restful风格API实战"></a>十、Elasticsearch Restful风格API实战</h2><h3 id="1、ES集群状态"><a href="#1、ES集群状态" class="headerlink" title="1、ES集群状态"></a>1、ES集群状态</h3><ol>
<li>绿色（Green）</li>
</ol>
<ul>
<li><strong>含义</strong>：集群健康状态正常，所有的主分片和副本分片都已分配。</li>
<li><strong>解释</strong>：绿色状态表示集群中的所有数据都可以访问，所有分片（包括主分片和副本分片）都分配到集群中的节点上。</li>
<li><strong>示例</strong>：假设集群有3个主分片，每个主分片有1个副本分片，那么绿色状态下这6个分片都已成功分配且正常运行。</li>
</ul>
<ol start="2">
<li>黄色（Yellow）</li>
</ol>
<ul>
<li><strong>含义</strong>：集群健康状态部分正常，所有的主分片都已分配，但有一个或多个副本分片未分配。</li>
<li><strong>解释</strong>：黄色状态表示集群中的所有主分片都可以访问，但一些副本分片由于某种原因（例如节点故障或资源不足）未能分配。这意味着数据是安全的，但没有高可用性，因为如果某个节点失败，它可能会导致数据无法访问。</li>
<li><strong>示例</strong>：假设集群有3个主分片和每个主分片1个副本分片，如果有3个主分片和2个副本分片已分配，但1个副本分片未能分配，则集群为黄色状态。</li>
</ul>
<ol start="3">
<li>红色（Red）</li>
</ol>
<ul>
<li><strong>含义</strong>：集群健康状态不正常，有一个或多个主分片未分配。</li>
<li><strong>解释</strong>：红色状态表示集群中有一些数据不可访问，因为主分片未能分配。此时，可能存在数据丢失的风险，需要立即采取措施来修复问题。</li>
<li><strong>示例</strong>：假设集群有3个主分片和每个主分片1个副本分片，如果有2个主分片和所有副本分片未能分配，则集群为红色状态。</li>
</ul>
<h3 id="2、Elasticsearch术语"><a href="#2、Elasticsearch术语" class="headerlink" title="2、Elasticsearch术语"></a>2、Elasticsearch术语</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Document</span><br><span class="line">    文档，用户存储在ES的数据，ES最小单元，文档不可被拆分。文档使用JSON的对象存储类型。</span><br><span class="line">    </span><br><span class="line">filed</span><br><span class="line">    相当于数据表的字段，对文档数据根据不同属性进行分类标识。</span><br><span class="line">    </span><br><span class="line">index</span><br><span class="line">    索引，一个索引就是拥有相似特征文档的集合。</span><br><span class="line">    </span><br><span class="line">shard</span><br><span class="line">    分片，存储数据的地方，每个底层对应的使一个Lucene库，一个索引至少有一个或多个分片。</span><br><span class="line">    </span><br><span class="line">replica</span><br><span class="line">    副本，一个分片可以有0个或者多个副本。作用是对数据进行备份，一旦副本数量不为0，就会引入主分片（primary shard）和副本分片（replica shard）的概念。</span><br><span class="line">        主分片（primary shard）</span><br><span class="line">            实现数据的读写操作。</span><br><span class="line">        副本分片（replica shard）</span><br><span class="line">            可以实现数据的读操作，需要主分片同步数据，当主分片挂掉时，副本分片会变为主分片。</span><br><span class="line">        </span><br><span class="line">Allocation</span><br><span class="line">    分配。将分片分配给某个节点的过程，包括主分片和副本分片。如果副本分片，还包含从主分片复制数据的过程，此过程由Master节点调度完成。</span><br></pre></td></tr></table></figure>
<h4 id="2-1、Elasticsearch分片分配的基本策略"><a href="#2-1、Elasticsearch分片分配的基本策略" class="headerlink" title="2.1、Elasticsearch分片分配的基本策略"></a>2.1、Elasticsearch分片分配的基本策略</h4><p>​    ES使用数据分片（shard）来提高服务的可用性，将数据分散保存在不同的节点上以降低当单个节点发生故障时对数据完整性的影响，同时使用副本（repiica）来保证数据的完整性。关于分片的默认分配策略，在7.x之前，默认5个primary shard，每个primary shard默认分配一个replica，即5主1副，而7.x之后，默认1主1副ES在分配单个索引的分片时会将每个分片尽可能分配到更多的节点上。但是，实际情况取决于集群拥有的分片和索引的数量以及它们的大小，不一定总是能均匀地分布。</p>
<p>​    Paimary只能在索引创建时配置数量，而replica可以在任何时间分配，并且primary支持读和写操作，而replica只支持客户端的读取操作，数据由es自动管理，从primary同步。ES不允许Primary和它的Replica放在同一个节点中，并且同一个节点不接受完全相同的两个Replica,同一个节点允许多个索引的分片同时存在。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">L66</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://l66stbz.github.io/2024/08/28/ELK%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0/">https://l66stbz.github.io/2024/08/28/ELK%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://l66stbz.github.io" target="_blank">L66</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/ELK/">ELK</a></div><div class="post_share"><div class="social-share" data-image="https://l66stbz.github.io/2024/09/09/若依项目动静分离/若依项目动静分离项目实现/6.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2024/09/02/IPtables/iptables/"><img class="prev_cover" src="https://l66stbz.github.io/2024/09/02/IPtables/iptables/1.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">IPtables</div></div></a></div><div class="next-post pull_right"><a href="/2024/08/27/Zabbix%E5%91%8A%E8%AD%A6%E5%AA%92%E4%BB%8B/"><img class="next_cover" src="https://l66stbz.github.io/2024/08/27/Zabbix告警媒介/1.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Zabbix告警媒介</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2024/05/23/基础测试脚本题/" title="基础测试脚本题"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/05/23/基础测试脚本题/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-05-23</div><div class="relatedPosts_title">基础测试脚本题</div></div></a></div><div class="relatedPosts_item"><a href="/2024/05/15/2024.05随记/" title="2024.05随记"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/05/15/2024.05随记/66.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-05-15</div><div class="relatedPosts_title">2024.05随记</div></div></a></div><div class="relatedPosts_item"><a href="/2024/07/31/Linux内核升级/" title="Linux内核升级"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/07/31/Linux内核升级/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-07-31</div><div class="relatedPosts_title">Linux内核升级</div></div></a></div><div class="relatedPosts_item"><a href="/2024/07/27/Mysql高可用-MHA/" title="Mysql高可用-MHA"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/07/27/Mysql高可用-MHA/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-07-27</div><div class="relatedPosts_title">Mysql高可用-MHA</div></div></a></div><div class="relatedPosts_item"><a href="/2024/08/16/RabbitMQ消息队列/" title="RabbitMQ消息队列"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/08/16/RabbitMQ消息队列/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-08-16</div><div class="relatedPosts_title">RabbitMQ消息队列</div></div></a></div><div class="relatedPosts_item"><a href="/2024/05/21/Keepalived/" title="Keepalived"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/05/21/Keepalived/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-05-21</div><div class="relatedPosts_title">Keepalived</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By L66</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/js/third-party/click_heart.js"></script></body></html>