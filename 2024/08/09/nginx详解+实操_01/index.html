<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>nginx详解+实操_01 | L66</title><meta name="description" content="[TOC] 1、HTTP 介绍：1.1 简介​    HTTP协议是超文本传输协议,是用于从万维网（WWW:World Wide Web ）服务器传输超文本到本地浏览器的传送协议。HTTP是一个基于TCP&#x2F;IP通信协议来传递数据（HTML 文件, 图片文件, 查询结果等）。 1.2 HTTP 工作原理​        HTTP（超文本传输协议）是应用层协议。它是整个数据通信的基础，基于请求&#x2F;响应模"><meta name="keywords" content="Linux,Nginx"><meta name="author" content="L66"><meta name="copyright" content="L66"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/3.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="nginx详解+实操_01"><meta name="twitter:description" content="[TOC] 1、HTTP 介绍：1.1 简介​    HTTP协议是超文本传输协议,是用于从万维网（WWW:World Wide Web ）服务器传输超文本到本地浏览器的传送协议。HTTP是一个基于TCP&#x2F;IP通信协议来传递数据（HTML 文件, 图片文件, 查询结果等）。 1.2 HTTP 工作原理​        HTTP（超文本传输协议）是应用层协议。它是整个数据通信的基础，基于请求&#x2F;响应模"><meta name="twitter:image" content="https://l66stbz.github.io/2024/08/09/nginx详解+实操_01/1.png"><meta property="og:type" content="article"><meta property="og:title" content="nginx详解+实操_01"><meta property="og:url" content="https://l66stbz.github.io/2024/08/09/nginx%E8%AF%A6%E8%A7%A3+%E5%AE%9E%E6%93%8D_01/"><meta property="og:site_name" content="L66"><meta property="og:description" content="[TOC] 1、HTTP 介绍：1.1 简介​    HTTP协议是超文本传输协议,是用于从万维网（WWW:World Wide Web ）服务器传输超文本到本地浏览器的传送协议。HTTP是一个基于TCP&#x2F;IP通信协议来传递数据（HTML 文件, 图片文件, 查询结果等）。 1.2 HTTP 工作原理​        HTTP（超文本传输协议）是应用层协议。它是整个数据通信的基础，基于请求&#x2F;响应模"><meta property="og:image" content="https://l66stbz.github.io/2024/08/09/nginx详解+实操_01/1.png"><meta property="article:published_time" content="2024-08-09T13:50:00.000Z"><meta property="article:modified_time" content="2024-08-10T10:29:52.440Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://l66stbz.github.io/2024/08/09/nginx%E8%AF%A6%E8%A7%A3+%E5%AE%9E%E6%93%8D_01/"><link rel="prev" title="nginx详解+实操_02" href="https://l66stbz.github.io/2024/08/09/nginx%E8%AF%A6%E8%A7%A3+%E5%AE%9E%E6%93%8D_02/"><link rel="next" title="Tomcat运维实战" href="https://l66stbz.github.io/2024/08/08/Tomcat%E8%BF%90%E7%BB%B4%E5%AE%9E%E6%88%98/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="APlayer.min.css"><div id="aplayer"></div><script src="https://cdn.jsdelivr.net/gh/radium-bit/res@master/live2d/autoload.js" async></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js" async></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="L66" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/2.jpg" onerror="onerror=null;src='/img/2.jpg'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">39</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">28</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Photo</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、HTTP-介绍："><span class="toc-number">1.</span> <span class="toc-text">1、HTTP 介绍：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-简介"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-HTTP-工作原理"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 HTTP 工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-常见的web服务器"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 常见的web服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-HTTP注意事项："><span class="toc-number">1.4.</span> <span class="toc-text">1.4 HTTP注意事项：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-HTTP-消息结构"><span class="toc-number">1.5.</span> <span class="toc-text">1.5 HTTP 消息结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-客户端请求消息"><span class="toc-number">1.6.</span> <span class="toc-text">1.6 客户端请求消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-服务器响应消息"><span class="toc-number">1.7.</span> <span class="toc-text">1.7 服务器响应消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-8-描述HTTP-的工作过程"><span class="toc-number">1.8.</span> <span class="toc-text">1.8  描述HTTP 的工作过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-9-HTTP-请求方法"><span class="toc-number">1.9.</span> <span class="toc-text">1.9 HTTP 请求方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-10-HTTP-状态码"><span class="toc-number">1.10.</span> <span class="toc-text">1.10 HTTP 状态码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、Nginx-服务"><span class="toc-number">2.</span> <span class="toc-text">2、Nginx 服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Nginx-介绍"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 Nginx 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-为什么选择-Nginx"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 为什么选择 Nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-IO多路复用"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 IO多路复用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-I-O-multiplexing【多并发】"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1 I&#x2F;O multiplexing【多并发】</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-异步，非阻塞"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2  异步，非阻塞</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、Nginx安装部署和配置管理"><span class="toc-number">3.</span> <span class="toc-text">3、Nginx安装部署和配置管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Nginx部署-Yum安装方式"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 Nginx部署-Yum安装方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Nginx-编译安装"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 Nginx 编译安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-NGINX配置文件详解"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 NGINX配置文件详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-Nginx-日志文件详解"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 Nginx 日志文件详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-使用-limit-rate-限制客户端传输数据的速度"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 使用 limit_rate 限制客户端传输数据的速度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-Nginx-虚拟主机配置"><span class="toc-number">3.6.</span> <span class="toc-text">3.6 Nginx 虚拟主机配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-基于域名的虚拟主机"><span class="toc-number">3.6.1.</span> <span class="toc-text">1. 基于域名的虚拟主机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-基于ip的虚拟主机"><span class="toc-number">3.6.2.</span> <span class="toc-text">2. 基于ip的虚拟主机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-基于端口的虚拟主机"><span class="toc-number">3.6.3.</span> <span class="toc-text">3. 基于端口的虚拟主机</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4、Nginx-proxy-代理"><span class="toc-number">4.</span> <span class="toc-text">4、Nginx proxy 代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-反向代理产生背景"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 反向代理产生背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-反向代理服务的实现"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 反向代理服务的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-正向代理和反向代理的区别"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 正向代理和反向代理的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-常用的集群软件"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 常用的集群软件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-Nginx-proxy模块配置"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 Nginx proxy模块配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-1-Nginx-proxy代理模块"><span class="toc-number">4.5.1.</span> <span class="toc-text">4.5.1 Nginx proxy代理模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-2-代理配置"><span class="toc-number">4.5.2.</span> <span class="toc-text">4.5.2 代理配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-3-服务端配置"><span class="toc-number">4.5.3.</span> <span class="toc-text">4.5.3 服务端配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-4-测试访问"><span class="toc-number">4.5.4.</span> <span class="toc-text">4.5.4 测试访问</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5、Nginx-负载均衡"><span class="toc-number">5.</span> <span class="toc-text">5、Nginx 负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-负载均衡作用"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 负载均衡作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-Nginx-负载均衡模块"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 Nginx 负载均衡模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-Nginx-upstream-配置"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 Nginx upstream 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1-Nginx负载均衡策略"><span class="toc-number">5.3.1.</span> <span class="toc-text">5.3.1 Nginx负载均衡策略</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#轮询策略"><span class="toc-number">5.3.1.1.</span> <span class="toc-text">轮询策略</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ip-hash"><span class="toc-number">5.3.1.2.</span> <span class="toc-text">ip_hash</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#URL-Hash"><span class="toc-number">5.3.1.3.</span> <span class="toc-text">URL Hash</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#最少连接"><span class="toc-number">5.3.1.4.</span> <span class="toc-text">最少连接</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#fair"><span class="toc-number">5.3.1.5.</span> <span class="toc-text">fair</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6、Nginx会话保持"><span class="toc-number">6.</span> <span class="toc-text">6、Nginx会话保持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-什么是会话保持"><span class="toc-number">6.0.1.</span> <span class="toc-text">6.1 什么是会话保持</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-什么是Cookie和Session"><span class="toc-number">6.0.2.</span> <span class="toc-text">6.2 什么是Cookie和Session</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-Nginx实现回话保持的手段"><span class="toc-number">6.0.3.</span> <span class="toc-text">6.3 Nginx实现回话保持的手段</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7、Nginx动静分离"><span class="toc-number">7.</span> <span class="toc-text">7、Nginx动静分离</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-介绍"><span class="toc-number">7.1.</span> <span class="toc-text">7.1 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-环境准备"><span class="toc-number">7.2.</span> <span class="toc-text">7.2 环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-1-代理服务器配置"><span class="toc-number">7.2.1.</span> <span class="toc-text">7.2.1 代理服务器配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-2-静态资源服务器配置"><span class="toc-number">7.2.2.</span> <span class="toc-text">7.2.2 静态资源服务器配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-3-动态资源服务器配置"><span class="toc-number">7.2.3.</span> <span class="toc-text">7.2.3 动态资源服务器配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8、Nginx防盗链"><span class="toc-number">8.</span> <span class="toc-text">8、Nginx防盗链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-介绍-1"><span class="toc-number">8.1.</span> <span class="toc-text">7.1 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-Nginx防盗链配置"><span class="toc-number">8.2.</span> <span class="toc-text">7.2 Nginx防盗链配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9、Nginx重定向"><span class="toc-number">9.</span> <span class="toc-text">9、Nginx重定向</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-Nginx-rewrite介绍"><span class="toc-number">9.1.</span> <span class="toc-text">9.1 Nginx rewrite介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-Rewrite-相关指令"><span class="toc-number">9.2.</span> <span class="toc-text">9.2  Rewrite 相关指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#9-2-1-if语句"><span class="toc-number">9.2.1.</span> <span class="toc-text">9.2.1 if语句</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-2-2-Rewrite-flag标记位"><span class="toc-number">9.2.2.</span> <span class="toc-text">9.2.2 Rewrite flag标记位</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-2-3-Rewrite-常见案例"><span class="toc-number">9.2.3.</span> <span class="toc-text">9.2.3 Rewrite 常见案例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-2-4-set指令使用"><span class="toc-number">9.2.4.</span> <span class="toc-text">9.2.4 set指令使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-2-5-return指令使用"><span class="toc-number">9.2.5.</span> <span class="toc-text">9.2.5 return指令使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10、Nginx-Location-指令详解"><span class="toc-number">10.</span> <span class="toc-text">10、Nginx Location 指令详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-Location-区块"><span class="toc-number">10.1.</span> <span class="toc-text">10.1 Location 区块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-location-前缀含义"><span class="toc-number">10.2.</span> <span class="toc-text">10.2 location 前缀含义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#10-2-1-location-配置示例"><span class="toc-number">10.2.1.</span> <span class="toc-text">10.2.1 location 配置示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-2-2-location-查找顺序、优先级"><span class="toc-number">10.2.2.</span> <span class="toc-text">10.2.2 location 查找顺序、优先级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-2-3-root-和alias-指令区别"><span class="toc-number">10.2.3.</span> <span class="toc-text">10.2.3  root 和alias 指令区别</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://l66stbz.github.io/2024/08/09/nginx详解+实操_01/1.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">L66</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Photo</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">nginx详解+实操_01</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2024-08-09 21:50:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2024-08-09</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2024-08-10 18:29:52"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2024-08-10</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p>[TOC]</p>
<h2 id="1、HTTP-介绍："><a href="#1、HTTP-介绍：" class="headerlink" title="1、HTTP 介绍："></a>1、HTTP 介绍：</h2><h3 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h3><p>​    HTTP协议是超文本传输协议,是用于从万维网（WWW:World Wide Web ）服务器传输超文本到本地浏览器的传送协议。HTTP是一个基于TCP/IP通信协议来传递数据（HTML 文件, 图片文件, 查询结果等）。</p>
<h3 id="1-2-HTTP-工作原理"><a href="#1-2-HTTP-工作原理" class="headerlink" title="1.2 HTTP 工作原理"></a>1.2 HTTP 工作原理</h3><p>​        HTTP（超文本传输协议）是应用层协议。它是整个数据通信的基础，基于请求/响应模式，客户端与服务器之间通过互相发送报文来通信，工作流程如下：</p>
<ol>
<li><strong>建立连接</strong>: 客户端（通常是Web浏览器）和服务器之间首先需要建立<code>一个TCP连接</code>。这是因为HTTP协议通常承载于TCP协议之上，确保<code>数据</code>的<code>可靠传输</code>。</li>
<li><strong>发送请求</strong>: 客户端向服务器发送一个HTTP请求，这个请求包含请求行、请求头和请求体。请求行包括请求方法（如GET或POST），所请求资源的URL以及HTTP协议版本。请求头包含附加信息，比如用户代理、Cookie等。如果是POST请求，请求体中还会包含提交的数据。</li>
<li><strong>服务器响应</strong>: 服务器接收到请求后，根据请求内容和服务器上的资源生成HTTP响应。响应同样由三部分组成：状态行、响应头和响应体。状态行包括HTTP状态码和原因短语，响应头包含服务器类型、内容类型等附加信息，响应体则携带着实际返回给客户端的数据，例如HTML页面或图片等。</li>
<li><strong>传输数据</strong>: 服务器将响应通过之前建立的TCP连接发送回客户端。客户端收到响应后，浏览器会根据返回的内容类型渲染出相应的页面或者处理其他类型的数据。</li>
<li><strong>断开连接</strong>: 数据传输完成后，客户端和服务器关闭TCP连接并释放相关资源。由于HTTP是无状态的，每次通信都是独立的，不会默认保存之前的请求或响应信息。如果需要跟踪用户的状态，通常会使用Cookie或会话机制来实现。</li>
</ol>
<h3 id="1-3-常见的web服务器"><a href="#1-3-常见的web服务器" class="headerlink" title="1.3 常见的web服务器"></a>1.3 常见的web服务器</h3><ol>
<li><p><strong>Apache HTTP Server</strong>：也被称为阿帕奇服务器，它是最广泛使用的Web服务器之一。作为一个开源项目，Apache可以运行在各种操作系统上，包括Unix、Windows和Linux。它以稳定性、可扩展性和安全性著称，在处理大量请求时表现出色。</p>
</li>
<li><p><strong>Nginx</strong>：Nginx是一个高性能的HTTP和反向代理服务器，它以处理高并发连接而闻名。Nginx消耗的资源较少，因此在负载较高的情况下仍能保持较低的内存和CPU使用率。</p>
</li>
<li><p><strong>Tomcat</strong>：虽然Apache Tomcat主要是作为Java 容器，但它也可以作为独立的Web服务器使用，尤其适合需要动态生成内容的Web应用。</p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/1561893004169.png" alt="1561893004169"></p>
</li>
</ol>
<p><strong>HTTPD和NGINX的区别</strong></p>
<ol>
<li><p><strong>处理客户端请求</strong>：<strong>Apache采用同步多进程模型，为每个请求创建一个新线程。</strong>这意味着在高并发场景下，Apache会为每个连接分配一个独立的进程或线程，这可能会导致资源使用量随着并发数的增加而线性增长。Nginx则采用异步非阻塞方式，使用事件驱动架构在一个线程中处理多个请求。这种模型使得Nginx在处理大量并发连接时更为高效，尤其是在静态内容服务和反向代理方面。</p>
</li>
<li><p><strong>性能和稳定性</strong>：Nginx因其轻量级和高效的事件驱动架构，在性能上通常优于Apache。它特别适用于需要处理高并发请求的场景。而Apache在低至中等流量的环境中表现良好，其模块化设计和丰富的功能使得它在稳定性和模块化方面有一定的优势。</p>
</li>
</ol>
<h3 id="1-4-HTTP注意事项："><a href="#1-4-HTTP注意事项：" class="headerlink" title="1.4 HTTP注意事项："></a><strong>1.4 HTTP注意事项：</strong></h3><ol>
<li><p><strong><code>无连接性</code></strong>：HTTP通常是一种无连接协议，这意味着每次连接只处理一个请求。一旦服务器处理完客户端的请求并且客户端接收到响应，连接就会断开。这种机制有助于节省传输时间，但同时也意味着每次新的请求都需要建立新的连接。</p>
</li>
<li><p><strong><code>无状态性</code></strong>：HTTP协议是无状态协议。无状态是指协议对于事务处理没有记忆能力。缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能导致每次连接传送的数据量增大。另一方面，在服务器不需要先前信息时它的应答就较快。</p>
</li>
<li><p><strong><code>缓存控制</code></strong>：为了提高加载速度和减少带宽消耗，HTTP提供了缓存机制。</p>
</li>
<li><p><strong><code>持久连接</code></strong>：虽然HTTP/1.1默认是持久连接（也称为HTTP Keep-Alive），但这需要Web服务器和客户端的支持。持久连接可以减少TCP连接的建立和关闭所带来的开销，提高传输效率。</p>
</li>
</ol>
<h3 id="1-5-HTTP-消息结构"><a href="#1-5-HTTP-消息结构" class="headerlink" title="1.5 HTTP 消息结构"></a>1.5 HTTP 消息结构</h3><p>HTTP是基于客户端/服务端（C/S）的架构模型，通过一个可靠的链接来交换信息，是一个无状态的请求/响应协议。</p>
<p><strong>一个HTTP”客户端”是一个应用程序（Web浏览器或其他任何客户端），通过连接到服务器达到向服务器发送一个或多个HTTP的请求的目的。</strong></p>
<p><strong>一个HTTP”服务器”同样也是一个应用程序（通常是一个Web服务，如Nginx、Apache Web服务器），通过接收客户端的请求并向客户端发送HTTP响应数据。</strong></p>
<p><strong>HTTP使用统一资源标识符（Uniform Resource Identifiers, URI）来传输数据和建立连接。用来标识互联网上某一资源的地址，通常用于访问网页、文件、图片等。</strong></p>
<ul>
<li><p><strong>协议</strong>：例如，<code>http://</code> 或 <code>https://</code>。</p>
<p><strong>域名</strong>：例如，<code>www.tabke.love</code>。</p>
<p><strong>路径</strong>：指向具体的资源，例如，<code>/tanke/tanke.html</code>。</p>
<p><strong>查询参数</strong>（可选）：用于传递附加信息，例如，<code>?id=123&amp;name=test</code>。</p>
</li>
</ul>
<p><a href="https://www.kengni.com:80/tanke.html?id=123&amp;name=test" target="_blank" rel="noopener">https://www.kengni.com:80/tanke.html?id=123&amp;name=test</a></p>
<h3 id="1-6-客户端请求消息"><a href="#1-6-客户端请求消息" class="headerlink" title="1.6 客户端请求消息"></a>1.6 客户端请求消息</h3><p>客户端发送一个HTTP请求到服务器的请求消息包括以下格式：请求行（request line）、请求头部（header）、空行和请求数据四个部分组成，下图给出了请求报文的一般格式。</p>
<p>(<a href="https://www.baidu.com/s?ie=UTF-8&amp;wd=QQ%E9%9F%B3%E4%B9%90" target="_blank" rel="noopener">https://www.baidu.com/s?ie=UTF-8&amp;wd=QQ%E9%9F%B3%E4%B9%90</a>,此链接可看请求头的内容)</p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/1561893148999.png" alt="1561893148999"></p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202408012146420.png" alt="img"></p>
<blockquote>
<ul>
<li>GET /wzt/favicon.ico HTTP/1.1：表示请求方法为GET，请求的资源路径为/wzt/favicon.ico，使用的HTTP协议版本为1.1。</li>
<li>Accept: image/avif,image/webp,image/apng,image/svg+xml,image/<em>,</em>/*;q=0.8：表示客户端接受的图像类型和质量。</li>
<li>Accept-Encoding: gzip, deflate：表示客户端接受的压缩格式。</li>
<li>Accept-Language: zh-CN,zh;q=0.9：表示客户端接受的语言和优先级。</li>
<li>Connection: keep-alive：表示客户端希望保持连接，以便进行后续请求。</li>
<li>Cookie: _ga_C569W2WCN6=GS1.1.1712754252.1.0.1712754252.0.0.0; …：表示客户端发送的Cookie信息，用于服务器识别用户。</li>
<li>Host: <a href="http://www.mobiletrain.org：表示请求的目标主机名为www.mobiletrain.org。">www.mobiletrain.org：表示请求的目标主机名为www.mobiletrain.org。</a></li>
<li>Referer: <a href="http://www.mobiletrain.org/?pinzhuanbdtg=biaoti：表示请求的来源页面URL。" target="_blank" rel="noopener">http://www.mobiletrain.org/?pinzhuanbdtg=biaoti：表示请求的来源页面URL。</a> </li>
<li>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36：表示客户端的浏览器信息和操作系统信息。</li>
</ul>
</blockquote>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/image-20240411151326745.png" alt="image-20240411151326745"></p>
<blockquote>
<p>这段响应信息是HTTP协议的一部分，它包含了服务器对客户端请求的响应。以下是各个字段的含义：</p>
<ul>
<li>HTTP/1.1 200 OK：这是HTTP协议的版本和状态码，表示请求成功。</li>
<li>Server: nginx：服务器使用的是nginx。</li>
<li>Date: Wed, 10 Apr 2024 13:04:29 GMT：响应生成的时间。</li>
<li>Content-Type: image/x-icon：响应的内容类型是图像，具体格式为.ico。</li>
<li>ETag: “63478391-47e”：ETag是用于缓存控制的标识符。</li>
<li>Access-Control-Allow-Origin: *：允许任何来源访问该资源。</li>
<li>Accept-Ranges: bytes：服务器接受字节范围请求。</li>
<li>X-Cache-Lookup: Cache Miss：表示请求的资源未在缓存中找到。</li>
<li>Last-Modified: Thu, 13 Oct 2022 03:18:41 GMT：资源的最后修改时间。</li>
<li>Content-Length: 1150：响应内容的长度，单位为字节。</li>
<li>X-NWS-LOG-UUID: 3120119176189980775：这可能是一个自定义的头部字段，用于日志记录。</li>
<li>Connection: keep-alive：表示客户端和服务器之间的连接将保持活动状态，以便进行后续请求。</li>
</ul>
</blockquote>
<h3 id="1-7-服务器响应消息"><a href="#1-7-服务器响应消息" class="headerlink" title="1.7 服务器响应消息"></a>1.7 服务器响应消息</h3><p>HTTP响应也由四个部分组成，分别是：状态行、消息报头、空行和响应正文。</p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/1561893177737.png" alt="1561893177737"></p>
<p>*<em>实例 *</em></p>
<p>下面实例是一点典型的使用GET来传递数据的实例：</p>
<p>客户端请求：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Connected to www.testpm.cn (47.244.247.240) port 80 (#0)</span><br><span class="line">&gt; GET /hello.txt HTTP/1.1   # 请求方式与版本协议。</span><br><span class="line">&gt; User-Agent: curl/7.29.0   #用什么客户端访问</span><br><span class="line">&gt; Host: www.testpm.cn  #主机名，域名。主机和端口号，</span><br><span class="line">&gt; Accept: */*  #匹配什么文件类型，“*” 是通用匹配。匹配所有类型</span><br></pre></td></tr></table></figure>

<p>服务端响应:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt; HTTP/1.1 200 OK       #请求返回的状态码</span><br><span class="line">&lt; Server: nginx/1.16.0  #请求的服务和版本号</span><br><span class="line">&lt; Date: Thu, 04 Jul 2019 08:19:40 GMT</span><br><span class="line">&lt; Content-Type: text/plain #文本类型，有html，plain:普通文本</span><br><span class="line">&lt; Content-Length: 12</span><br><span class="line">&lt; Last-Modified: Thu, 04 Jul 2019 08:13:25 GMT</span><br><span class="line">&lt; Connection: keep-alive  #是否支持长连接</span><br><span class="line">&lt; ETag: "5d1db525-c"  #标识，每次访问如果与最开始的一样返回304否则校验不一致返回200</span><br><span class="line">&lt; Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>



<h3 id="1-8-描述HTTP-的工作过程"><a href="#1-8-描述HTTP-的工作过程" class="headerlink" title="1.8  描述HTTP 的工作过程"></a><strong>1.8  描述HTTP 的工作过程</strong></h3><p>HTTP协议的工作过程可以通过一个简单的例子来解释，例如，当你在浏览器中输入一个URL（例如：<a href="http://www.qf.com/test/index.html?name=qf&amp;age=18）并按下回车键时，背后发生了什么？" target="_blank" rel="noopener">www.qf.com/test/index.html?name=qf&amp;age=18）并按下回车键时，背后发生了什么？</a></p>
<ol>
<li>浏览器首先会解析你输入的URL，确定你要访问的是哪个网站，以及具体的页面路径。在这个例子中，你要访问的网站是<a href="http://www.qf.com。" target="_blank" rel="noopener">www.qf.com。</a></li>
<li>浏览器会向DNS服务器发送一个请求，要求解析<a href="http://www.qf.com的IP地址。DNS服务器会返回对应的IP地址。" target="_blank" rel="noopener">www.qf.com的IP地址。DNS服务器会返回对应的IP地址。</a></li>
<li>浏览器会向这个IP地址发送一个HTTP GET请求。这个请求包含了一些信息，例如你的浏览器类型，你接受的语言等。</li>
<li>服务器收到这个HTTP请求后，会解析这个请求，确定你要获取的是哪个页面。然后，服务器会从硬盘中找到这个页面，然后返回一个HTTP响应。这个响应包含了页面的内容，以及一些元信息，例如页面的类型，编码方式等。</li>
<li>浏览器收到HTTP响应后，会解析这个响应，然后将页面的内容显示在浏览器中。</li>
</ol>
<h3 id="1-9-HTTP-请求方法"><a href="#1-9-HTTP-请求方法" class="headerlink" title="1.9 HTTP 请求方法"></a>1.9 <code>HTTP 请求方法</code></h3><p>根据HTTP标准，HTTP请求可以使用多种请求方法。</p>
<p>HTTP1.0定义了三种请求方法： GET, POST 和 HEAD方法。 </p>
<p>HTTP1.1新增了五种请求方法：OPTIONS, PUT, DELETE, TRACE 和 CONNECT 方法。</p>
<p>重点方法：</p>
<p><code>GET</code>：用于向服务器请求获取某个资源。（获取一个index.html页面）</p>
<p><code>POST</code>：用于向服务器提交数据，通常用于表单提交、文件上传等场景。（会产生新的数据）</p>
<p><code>PUT</code>：用于向服务器更新或保存某个资源，通常用于上传文件、更新数据等场景。（覆盖/更新文件、图片等，不会产生新的数据）</p>
<p><code>DELETE</code>：用于向服务器删除某个资源，通常用于删除文件、删除数据等场景。</p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/1561896279402.png" alt="1561896279402"></p>
<p><strong>GET</strong>和<strong>POST</strong>是HTTP协议中两种常见的请求方法，它们的工作细节如下：</p>
<p><strong><code>GET请求</code>是最常见的请求方法，通常用于获取资源。</strong></p>
<p>​    GET请求的参数会附加在URL之后，通过问号（?）分隔，参数之间用&amp;符号连接。例如，<code>http://www.qf.com/index.html?name=John&amp;age=22</code>。这种方式的缺点是传输数据的大小有限制（因为浏览器对URL的长度有限制），并且不适合传输敏感信息（如密码），因为参数会直接暴露在URL中。</p>
<p><strong><code>POST请求</code>通常用于提交数据。</strong></p>
<p>​    POST请求将参数放在HTTP请求的主体中(HTTP的请求主体（Request Body）是HTTP请求消息的一部分，用于在客户端向服务器发送请求时附带额外的数据。这些数据可以是文本、JSON、XML或其他格式，具体取决于请求的类型和客户端与服务器之间的约定。)，而不是URL中。POST请求没有对传输数据的大小进行限制，而且可以传输任何类型的数据，包括二进制数据。因此，POST请求通常用于提交表单数据。</p>
<p>下面是一个GET请求和POST请求的例子：</p>
<p>GET请求示例：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/index.html?name=maoxiansheng&amp;age=18</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: www.qf.com</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br></pre></td></tr></table></figure>

<p>POST请求示例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /api/users HTTP/1.1  </span><br><span class="line"><span class="attribute">Host</span>: www.qf  </span><br><span class="line"><span class="attribute">Content-Type</span>: application/json  </span><br><span class="line"><span class="attribute">Content-Length</span>: 45  </span><br><span class="line">  </span><br><span class="line">&#123;  </span><br><span class="line">  "name": "qianfeng",  </span><br><span class="line">  "email": "qianfeng@1000phone.com"  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在GET请求示例中，参数<code>name=John&amp;age=22</code>附加在URL之后。在POST请求示例中，参数<code>&quot;name&quot;: &quot;qianfeng&quot;,  
  &quot;email&quot;: &quot;qianfeng@1000phone.com&quot;</code>放在HTTP请求的主体中。</p>
<p>需要注意的是，虽然POST请求在传输大量或敏感数据时更安全，但无论是GET还是POST，都不能提供真正的安全性。为了保护数据的安全，应该使用<code>HTTPS协议</code>，它可以对传输的数据进行加密。</p>
<h3 id="1-10-HTTP-状态码"><a href="#1-10-HTTP-状态码" class="headerlink" title="1.10 HTTP 状态码"></a><strong>1.10 HTTP 状态码</strong></h3><p>当浏览者访问一个网页时，浏览者的浏览器会向网页所在服务器发出请求。当浏览器接收并显示网页前，此网页所在的服务器会返回一个包含HTTP状态码的信息头（server header）用以响应浏览器的请求。</p>
<p>HTTP状态码的英文为<code>HTTP Status Code</code>。</p>
<p>下面是常见的HTTP状态码：</p>
<ul>
<li>200 - 请求成功，表示成功处理了请求的状态代码。</li>
</ul>
<ul>
<li><p>301 - 表示被请求的资源已永久移动到新的位置。当服务器返回301状态码时，它会告诉客户端（如浏览器）请求的资源已被永久移动到另一个URL，客户端在接收到301响应后，应该使用新的URL发起后续的请求。</p>
<p>比如建设一个网站后，将网站的url变换了，重新申请一个域名，但是希望之前的用户访问之前url仍然可以访问到，就可以做一个重定向新的url下面。比如京东最早域名<a href="http://www.360buy.com名重定向到现在www.jd.com" target="_blank" rel="noopener">www.360buy.com名重定向到现在www.jd.com</a></p>
</li>
</ul>
<ul>
<li>302  - 302状态码表示临时重定向。当服务器收到请求时，如果资源暂时不可用或已经移动到其他位置，服务器会返回一个HTTP 302状态码，客户端会自动发送一个新的请求到这个新的URL地址，以获取所需的资源。</li>
</ul>
<ul>
<li><p><code>404</code>- 表示客户端请求的资源在服务器上不存在或无法找到。当浏览器或客户端尝试访问一个网页或资源，但服务器无法找到与请求URL对应的文件或页面时，就会返回这个错误。</p>
<p>HTTP 404错误可能由以下原因引起：</p>
<ol>
<li><strong>URL错误</strong>：输入的URL可能有误，比如拼写错误、大小写错误、路径错误或者参数错误等。</li>
<li><strong>页面被删除或移动</strong>：请求的页面可能已经被删除，或者移动到了其他位置，而URL没有相应地更新。</li>
<li><strong>服务器配置问题</strong>：服务器的配置可能存在问题，导致无法正确解析URL或找到相应的资源。</li>
<li><strong>资源不存在</strong>：请求的资源（如文件、图片等）可能从未在服务器上创建或已被删除。</li>
</ol>
</li>
</ul>
<ul>
<li><p><code>403</code> - 表示服务器理解了客户端的请求，但是拒绝执行此请求。这通常意味着客户端没有访问所请求资源的权限。HTTP 403错误可能由多种原因引起，包括：</p>
<ol>
<li><strong>权限不足</strong>：服务器可能要求客户端提供有效的身份验证凭据，以便确定其是否具有访问请求资源的权限。如果客户端没有提供正确的凭据或凭据无效，服务器将返回403状态码。</li>
<li><strong>IP地址限制</strong>：服务器可能根据IP地址对访问进行限制。如果客户端的IP地址被服务器列入黑名单或没有被列入白名单，服务器将返回403状态码。</li>
<li><strong>文件权限设置</strong>：服务器上的文件或目录可能设置了访问权限，如果客户端没有足够的权限访问这些文件或目录，服务器将返回403状态码。</li>
</ol>
</li>
</ul>
<ul>
<li><p><code>503</code>-错误表示服务不可用，这通常意味着服务器暂时无法处理请求。</p>
<ol>
<li><strong>服务器过载</strong>：当服务器接收到的请求过多，超过了其处理能力时，就可能导致服务器过载。这可能是由于服务器硬件性能不足、网络带宽不足或应用程序代码存在问题等原因引起的。</li>
<li><strong>服务器维护</strong>：服务器可能需要定期进行维护和升级，以保持其稳定性和性能。在这种情况下，服务器可能会暂时关闭，以便进行必要的更新和修复。</li>
<li><strong>错误的服务器配置</strong>：Web服务器或应用服务器配置错误也可能导致HTTP 503错误。这包括代理服务器的配置错误或应用程序池的错误配置等。</li>
</ol>
</li>
</ul>
<ul>
<li><p><code>504</code>-也称为“网关超时”（Gateway Timeout）错误，通常发生在作为网关或代理的服务器没有从上游服务器（如另一个代理服务器或Web服务器）收到及时的响应时。这通常意味着代理服务器等待上游服务器的响应时间过长，超出了设定的等待时间阈值。</p>
<ol>
<li><strong>上游服务器过载</strong>：上游服务器可能由于处理过多的请求或资源不足而无法及时响应代理服务器的请求。</li>
<li><strong>网络延迟或故障</strong>：代理服务器与上游服务器之间的网络连接可能存在问题，导致请求和响应的传输延迟或失败。</li>
<li><strong>上游服务器配置错误</strong>：上游服务器的配置可能存在问题，导致它无法正确处理代理服务器的请求。</li>
</ol>
</li>
</ul>
<p><strong>HTTP状态码分类</strong></p>
<p>HTTP状态码由三个十进制数字组成，第一个十进制数字定义了状态码的类型，后两个数字没有分类的作用。HTTP状态码共分为5种类型：</p>
<ul>
<li><strong>1xx（信息性状态码）</strong> : 这类状态码表示请求已被服务器接收，需要客户端继续操作。</li>
<li><strong>2xx（成功状态码）</strong> : 这类状态码表示服务器已成功处理了请求。</li>
<li><strong>3xx（重定向状态码）</strong> : 这类状态码表示需要客户端采取进一步的操作才能完成请求。例如，301 Moved Permanently表示被请求的资源已永久移动到新位置，302 Found表示请求的资源现在临时从不同的URI响应请求。</li>
<li><strong>4xx（客户端错误状态码）</strong> : 这类状态码表示客户端似乎发生了错误，妨碍了服务器的处理。</li>
<li><strong>5xx（服务器错误状态码）</strong> : 这类状态码表示服务器在尝试处理请求时发生了错误。</li>
</ul>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/1561896413177.png" alt="1561896413177"></p>
<p>HTTP状态码列表:</p>
<table>
<thead>
<tr>
<th>状态码</th>
<th>状态码英文名称</th>
<th>中文描述</th>
</tr>
</thead>
<tbody><tr>
<td>100</td>
<td>Continue</td>
<td>继续。客户端应继续其请求</td>
</tr>
<tr>
<td>101</td>
<td>Switching Protocols</td>
<td>切换协议。服务器根据客户端的请求切换协议。只能切换到更高级的协议，例如，切换到HTTP的新版本协议</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>200</td>
<td>OK</td>
<td>请求成功。一般用于GET与POST请求</td>
</tr>
<tr>
<td>201</td>
<td>Created</td>
<td>已创建。成功请求并创建了新的资源</td>
</tr>
<tr>
<td>202</td>
<td>Accepted</td>
<td>已接受。已经接受请求，但未处理完成</td>
</tr>
<tr>
<td>203</td>
<td>Non-Authoritative Information</td>
<td>非授权信息。请求成功。但返回的meta信息不在原始的服务器，而是一个副本</td>
</tr>
<tr>
<td>204</td>
<td>No Content</td>
<td>无内容。服务器成功处理，但未返回内容。在未更新网页的情况下，可确保浏览器继续显示当前文档</td>
</tr>
<tr>
<td>205</td>
<td>Reset Content</td>
<td>重置内容。服务器处理成功，用户终端（例如：浏览器）应重置文档视图。可通过此返回码清除浏览器的表单域</td>
</tr>
<tr>
<td>206</td>
<td>Partial Content</td>
<td>部分内容。服务器成功处理了部分GET请求</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>300</td>
<td>Multiple Choices</td>
<td>多种选择。请求的资源可包括多个位置，相应可返回一个资源特征与地址的列表用于用户终端（例如：浏览器）选择</td>
</tr>
<tr>
<td>301</td>
<td>Moved Permanently</td>
<td>永久移动。请求的资源已被永久的移动到新URI，返回信息会包括新的URI，浏览器会自动定向到新URI。今后任何新的请求都应使用新的URI代替</td>
</tr>
<tr>
<td>302</td>
<td>Found</td>
<td>临时移动。与301类似。但资源只是临时被移动。客户端应继续使用原有URI</td>
</tr>
<tr>
<td>303</td>
<td>See Other</td>
<td>查看其它地址。与301类似。使用GET和POST请求查看</td>
</tr>
<tr>
<td>304</td>
<td>Not Modified</td>
<td>未修改。所请求的资源未修改，服务器返回此状态码时，不会返回任何资源。客户端通常会缓存访问过的资源，通过提供一个头信息指出客户端希望只返回在指定日期之后修改的资源</td>
</tr>
<tr>
<td>305</td>
<td>Use Proxy</td>
<td>使用代理。所请求的资源必须通过代理访问</td>
</tr>
<tr>
<td>306</td>
<td>Unused</td>
<td>已经被废弃的HTTP状态码</td>
</tr>
<tr>
<td>307</td>
<td>Temporary Redirect</td>
<td>临时重定向。与302类似。使用GET请求重定向</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>400</td>
<td>Bad Request</td>
<td>客户端请求的语法错误，服务器无法理解</td>
</tr>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>请求要求用户的身份认证</td>
</tr>
<tr>
<td>402</td>
<td>Payment Required</td>
<td>保留，将来使用</td>
</tr>
<tr>
<td>403</td>
<td>Forbidden</td>
<td>服务器理解请求客户端的请求，但是拒绝执行此请求</td>
</tr>
<tr>
<td>404</td>
<td>Not Found</td>
<td>服务器无法根据客户端的请求找到资源（网页）。通过此代码，网站设计人员可设置”您所请求的资源无法找到”的个性页面</td>
</tr>
<tr>
<td>405</td>
<td>Method Not Allowed</td>
<td>客户端请求中的方法被禁止</td>
</tr>
<tr>
<td>406</td>
<td>Not Acceptable</td>
<td>服务器无法根据客户端请求的内容特性完成请求</td>
</tr>
<tr>
<td>407</td>
<td>Proxy Authentication Required</td>
<td>请求要求代理的身份认证，与401类似，但请求者应当使用代理进行授权</td>
</tr>
<tr>
<td>408</td>
<td>Request Time-out</td>
<td>服务器等待客户端发送的请求时间过长，超时</td>
</tr>
<tr>
<td>409</td>
<td>Conflict</td>
<td>服务器完成客户端的PUT请求是可能返回此代码，服务器处理请求时发生了冲突</td>
</tr>
<tr>
<td>410</td>
<td>Gone</td>
<td>客户端请求的资源已经不存在。410不同于404，如果资源以前有现在被永久删除了可使用410代码，网站设计人员可通过301代码指定资源的新位置</td>
</tr>
<tr>
<td>411</td>
<td>Length Required</td>
<td>服务器无法处理客户端发送的不带Content-Length的请求信息</td>
</tr>
<tr>
<td>412</td>
<td>Precondition Failed</td>
<td>客户端请求信息的先决条件错误</td>
</tr>
<tr>
<td>413</td>
<td>Request Entity Too Large</td>
<td>由于请求的实体过大，服务器无法处理，因此拒绝请求。为防止客户端的连续请求，服务器可能会关闭连接。如果只是服务器暂时无法处理，则会包含一个Retry-After的响应信息</td>
</tr>
<tr>
<td>414</td>
<td>Request-URI Too Large</td>
<td>请求的URI过长（URI通常为网址），服务器无法处理</td>
</tr>
<tr>
<td>415</td>
<td>Unsupported Media Type</td>
<td>服务器无法处理请求附带的媒体格式</td>
</tr>
<tr>
<td>416</td>
<td>Requested range not satisfiable</td>
<td>客户端请求的范围无效</td>
</tr>
<tr>
<td>417</td>
<td>Expectation Failed</td>
<td>服务器无法满足Expect的请求头信息</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>500</td>
<td>Internal Server Error</td>
<td>服务器内部错误，无法完成请求</td>
</tr>
<tr>
<td>501</td>
<td>Not Implemented</td>
<td>服务器不支持请求的功能，无法完成请求</td>
</tr>
<tr>
<td>502</td>
<td>Bad Gateway</td>
<td>作为网关或者代理工作的服务器尝试执行请求时，从远程服务器接收到了一个无效的响应</td>
</tr>
<tr>
<td>503</td>
<td>Service Unavailable</td>
<td>由于超载或系统维护，服务器暂时的无法处理客户端的请求。延时的长度可包含在服务器的Retry-After头信息中</td>
</tr>
<tr>
<td>504</td>
<td>Gateway Time-out</td>
<td>充当网关或代理的服务器，未及时从远端服务器获取请求</td>
</tr>
<tr>
<td>505</td>
<td>HTTP Version not supported</td>
<td>服务器不支持请求的HTTP协议的版本，无法完成处理</td>
</tr>
</tbody></table>
<h2 id="2、Nginx-服务"><a href="#2、Nginx-服务" class="headerlink" title="2、Nginx 服务"></a>2、Nginx 服务</h2><h3 id="2-1-Nginx-介绍"><a href="#2-1-Nginx-介绍" class="headerlink" title="2.1 Nginx 介绍"></a>2.1 Nginx 介绍</h3><p> <em>Nginx</em> (engine x) 是一个高性能的 HTTP 和<code>反向代理</code>服务，也是一个IMAP/POP3/SMTP服务。因它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而闻名。  </p>
<p>Nginx是一款<code>轻量级</code>的<code>Web 服务器</code>/<code>反向代理</code>服务器及电子邮件（IMAP/POP3）代理服务器，并在一个BSD-like 协议下发行。其特点是占有内存少，并发能力强，事实上nginx的并发能力确实在同类型的网页服务器中表现较好。</p>
<p>在高连接并发的情况下，Nginx是Apache服务器不错的替代品。</p>
<p><strong>创始人伊戈尔·赛索耶夫</strong></p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/1561897072438.png" alt="1561897072438"></p>
<h3 id="2-2-为什么选择-Nginx"><a href="#2-2-为什么选择-Nginx" class="headerlink" title="2.2 为什么选择 Nginx"></a>2.2 为什么选择 Nginx</h3><p>Nginx（engine x）是一个高性能的HTTP和反向代理web服务器，同时也提供了IMAP/POP3/SMTP服务。它最初由伊戈尔·赛索耶夫为俄罗斯访问量第二的Rambler.ru站点开发，自发布以来，因其稳定性、丰富的功能集、简单的配置文件和低系统资源消耗而广受好评。</p>
<p>Nginx的特点包括：</p>
<ol>
<li><strong>高性能</strong>：Nginx使用<code>事件驱动</code>模型，可以同时处理大量的并发连接，而且在高负载和大流量情况下仍然能够保持良好的性能。</li>
<li><strong>轻量级</strong>：Nginx的代码量较少，占用的内存也较少，使其可以在资源受限的系统中运行，并且在高负载下也不易崩溃。</li>
<li><strong>可扩展性</strong>：Nginx支持众多的第三方模块，可以根据需要进行自定义开发，实现更多的功能。</li>
<li><strong>高度可靠性</strong>：Nginx是基于稳定的、成熟的事件驱动架构开发的，能够有效地避免因代码错误或第三方库问题导致的崩溃，从而保证了服务的高可靠性。</li>
<li><strong>热部署</strong>：Nginx支持在不停止服务的情况下更新配置文件和软件升级，为用户提供了极大的便利。</li>
</ol>
<p>在功能方面，Nginx具有：</p>
<ol>
<li><strong>HTTP代理与反向代理</strong>：作为web服务器，Nginx最常用的功能之一是反向代理。它可以根据不同的正则匹配，采取不同的转发策略，并且能够对返回结果进行错误页跳转、异常判断等。如果被分发的服务器存在异常，Nginx可以将请求重新转发给另一台服务器。</li>
<li><strong>负载均衡</strong>：Nginx提供了多种负载均衡策略，如轮询、加权轮询和ip hash等，以优化请求的分配和处理方式，从而平均分配后端服务器的负载，提高系统的可用性和可靠性。</li>
<li><strong>Web缓存</strong>：Nginx支持对不同的文件做不同的缓存处理。</li>
</ol>
<h3 id="2-3-IO多路复用"><a href="#2-3-IO多路复用" class="headerlink" title="2.3 IO多路复用"></a>2.3 IO多路复用</h3><h4 id="2-3-1-I-O-multiplexing【多并发】"><a href="#2-3-1-I-O-multiplexing【多并发】" class="headerlink" title="2.3.1 I/O multiplexing【多并发】"></a>2.3.1 I/O multiplexing【多并发】</h4><ul>
<li>第一种方法就是最传统的多线程并发模型 (每进来一个新的I/O流会分配一个新的进程管理。)</li>
</ul>
<p>多进程并发模型是一种传统的服务器架构模式，它的核心思想是利用操作系统的<code>多进程机制</code>来实现并发处理多个客户端请求。在这种模型中，主进程负责监听客户端的连接请求，一旦接收到新的请求，主进程会通过fork()操作创建一个子进程（线程）来独立处理这个请求。这样，父进程可以继续回到监听状态，等待其他客户端的连接。每个子进程处理完一个请求后就会退出，释放资源。这种模型的优点是可以快速响应客户请求，尤其是在客户与服务器交互频繁的场景下。</p>
<p>然而，这种模型也存在一些缺点：</p>
<ul>
<li><strong>资源消耗</strong>：进程是操作系统资源分配的基本单位，每个进程都需要占用一定的内存和CPU资源。在高并发环境下，如果创建大量进程，会导致服务器资源消耗过快，增加服务器负载。</li>
</ul>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/1561897144109.png" alt="1561897144109"></p>
<ul>
<li>第二种方法就是<code>I/O多路复用</code>(单个线程，通过记录跟踪每个I/O流(sock)的状态，来同时管理多个I/O流 。)I/O multiplexing 这里面的 multiplexing 指的其实是在单个线程通过记录跟踪每一个Sock(I/O流)的状态来同时管理多个I/O流。发明它的原因，是尽量多的提高服务器的吞吐能力。<code>I/O多路复用是一种高效处理多个I/O流的技术，它允许单个线程通过记录和跟踪每个流的状态来同时管理多个I/O流，而不是为每个流创建单独的线程。这样做可以提高服务器应用程序的性能，尤其是在需要处理成千上万并发连接的情况下。</code></li>
</ul>
<p><code>在同一个线程里面， 通过拨开关的方式，来同时传输多个I/O流。</code>这句话描述的是一种单线程中管理多个I/O流的方法，其中“拨开关”的比喻可能是指通过在多个I/O流之间切换来实现并发处理的方式。这里的“拨开关”可以理解为线程在多个I/O流之间快速切换，检查哪个流准备好进行读或写操作。当一个流准备好时，线程就与之交互（读取数据或发送数据），然后迅速切换到下一个流。这种快速的切换给人的感觉就像是在“拨动开关”，在一个流和另一个流之间来回切换</p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/1561897166658.png" alt="1561897166658"></p>
<p> <strong>一个请求到来了，nginx使用epoll接收请求的过程是怎样的?</strong></p>
<ol>
<li><strong>建立监听</strong>：Nginx通过epoll创建一个事件监听的集合，这个集合能够同时监控多个网络连接的文件描述符。</li>
<li><strong>事件注册</strong>：对于每一个进入的连接，Nginx会将其文件描述符注册到epoll中，以便对这些连接进行事件监听。</li>
<li><strong>事件检测</strong>：epoll机制允许Nginx高效地检测哪些注册的连接有活动（比如数据可读或可写），而不需要像传统的轮询那样检查每个连接。</li>
<li><strong>事件处理</strong>：一旦某个连接上有数据到来，epoll通知Nginx，然后Nginx可以立即响应该连接，处理传入的数据，例如读取HTTP请求。</li>
<li><strong>动态调整</strong>：epoll能够动态地添加或移除所监听的文件描述符，这使得Nginx在处理大量并发连接时非常灵活和高效。</li>
<li><strong>资源优化</strong>：由于不是所有连接在任何时刻都是活跃的，epoll只关注那些真正有事件发生的连接，从而节省了系统资源，提高了性能。</li>
<li><strong>非阻塞I/O</strong>：Nginx利用epoll实现非阻塞I/O操作，这意味着内核在没有数据可读时不会将进程置于等待状态，而是让其继续执行其他任务。</li>
</ol>
<h4 id="2-3-2-异步，非阻塞"><a href="#2-3-2-异步，非阻塞" class="headerlink" title="2.3.2  异步，非阻塞"></a>2.3.2  异步，非阻塞</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]<span class="comment"># ps -aux | grep nginx</span></span><br></pre></td></tr></table></figure>

<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202408021413024.png" alt="img"></p>
<p> <strong>1个master进程，2个work进程</strong></p>
<p>master进程只负责监听用户的请求，但并不处理请求。work进程才处理请求。</p>
<p>​     每进来一个request，会有一个worker进程去处理。但不是<code>全程的处理</code>，处理到什么程度呢？处理到可能<code>发生阻塞</code>的地方，比如向后端服务器转发request，并等待请求返回。那么，这个处理的worker不会这么一直等着，他会在发送完请求后，注册一个事件：“如果upstream返回了，告诉我一声，我再接着干”。于是他就休息去了。这就是异步。此时，如果再有request 进来，他就可以很快再按这种方式处理。这就是<code>非阻塞</code>和<code>IO多路复用</code>。而一旦上游服务器返回了，就会触发这个事件，worker进程才会来接手，这个request才会接着往下走。这就是<code>异步回调</code>。</p>
<h2 id="3、Nginx安装部署和配置管理"><a href="#3、Nginx安装部署和配置管理" class="headerlink" title="3、Nginx安装部署和配置管理"></a>3、Nginx安装部署和配置管理</h2><h3 id="3-1-Nginx部署-Yum安装方式"><a href="#3-1-Nginx部署-Yum安装方式" class="headerlink" title="3.1 Nginx部署-Yum安装方式"></a>3.1 Nginx部署-Yum安装方式</h3><p>访问nginx的官方网站：<a href="http://www.nginx.org/" target="_blank" rel="noopener">http://www.nginx.org/</a></p>
<p>Nginx版本类型</p>
<ul>
<li>Mainline version：  主线版，即开发版</li>
</ul>
<ul>
<li><code>Stable version：最新稳定版，生产环境上建议使用的版本</code></li>
</ul>
<ul>
<li>Legacy versions：    遗留的老版本的稳定版</li>
</ul>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202408021414109.png" alt="img"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 编写nginx yum源文件（稳定版）</span></span><br><span class="line">[root@nginx-server ~]# vim /etc/yum.repos.d/nginx.repo </span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 缓存元数据</span></span><br><span class="line">[root@nginx-server ~]# yum makecache fast</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 安装nginx服务</span></span><br><span class="line">[root@nginx-server ~]# yum install nginx -y</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 查看nginx相关信息</span></span><br><span class="line">[root@nginx-server ~]# nginx -V</span><br></pre></td></tr></table></figure>

<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202408021415977.png" alt="img"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 查看NGINX版本信息</span></span><br><span class="line">[root@nginx-server ~]# nginx -v</span><br><span class="line">nginx version: nginx/1.24.0</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 关闭安全策略</span></span><br><span class="line">[root@nginx-server ~]# setenforce 0</span><br><span class="line">[root@nginx-server ~]# sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 关闭防火墙</span></span><br><span class="line">[root@nginx-server ~]# systemctl disable  --now firewalld</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 启动nginx并设置开机启动</span></span><br><span class="line">[root@nginx-server ~]# systemctl enable --now  nginx </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 查看nginx启动状态</span></span><br><span class="line">[root@nginx-server ~]# systemctl status nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 查看nginx进程</span></span><br><span class="line">[root@nginx-server ~]# ps -aux | grep nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 查看nginx端口</span></span><br><span class="line">[root@nginx-server ~]# ss -tunlp | grep -w 80</span><br></pre></td></tr></table></figure>

<p><strong>浏览器输入ip访问:</strong></p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/1561536791743.png" alt="1561536791743"></p>
<h3 id="3-2-Nginx-编译安装"><a href="#3-2-Nginx-编译安装" class="headerlink" title="3.2 Nginx 编译安装"></a>3.2 Nginx 编译安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 安装gcc</span></span><br><span class="line">[root@nginx-server ~]# yum -y install gcc gcc-c++</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 安装pcre软件包（使nginx支持http rewrite模块）</span></span><br><span class="line">[root@nginx-server ~]# yum install -y pcre pcre-devel</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 安装openssl-devel（使nginx支持ssl）</span></span><br><span class="line">[root@nginx-server ~]# yum install -y openssl openssl-devel</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 安装zlib</span></span><br><span class="line">[root@nginx-server ~]# yum install -y zlib zlib-devel</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 创建用户nginx</span></span><br><span class="line">[root@nginx-server ~]# useradd -s /sbin/nologin nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 下载安装包</span></span><br><span class="line">[root@nginx-server ~]# wget http://nginx.org/download/nginx-1.24.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 解压安装包</span></span><br><span class="line">[root@nginx-server ~]# tar xzf nginx-1.24.0.tar.gz -C /usr/local/  &amp;&amp; cd /usr/local/nginx-1.24.0/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 预备编译,指定相关参数</span></span><br><span class="line">[root@nginx-server nginx-1.24.0]#  ./configure --prefix=/usr/local/nginx --group=nginx --user=nginx --sbin-path=/usr/local/nginx/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/tmp/nginx/client_body --http-proxy-temp-path=/tmp/nginx/proxy --http-fastcgi-temp-path=/tmp/nginx/fastcgi --pid-path=/var/run/nginx.pid --lock-path=/var/lock/nginx --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-http_realip_module --with-stream</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 编译安装</span></span><br><span class="line">[root@nginx-server nginx-1.24.0]# make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p><code>自动化安装NGINX脚本(生产勿用，需要修改其中的相关配置信息)</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; NGINX自动化安装脚本</span></span><br><span class="line">$ vim install_nginx.sh </span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="function"><span class="title">ck_ok</span></span> () &#123;</span><br><span class="line"> <span class="keyword">if</span> [ $? -ne 0 ]</span><br><span class="line">  <span class="keyword">then</span> </span><br><span class="line">     <span class="built_in">echo</span> <span class="string">"error."</span></span><br><span class="line">     <span class="built_in">exit</span> 1</span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭防火墙及selinux</span></span><br><span class="line"><span class="function"><span class="title">disable</span></span> () &#123;</span><br><span class="line">systemctl <span class="built_in">disable</span> --now firewalld &amp;&gt;/dev/null</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">repos_bak</span></span> () &#123;</span><br><span class="line">mkdir /etc/yum.repos.d/repo.bak</span><br><span class="line">cp -r  /etc/yum.repos.d/*.repo  /etc/yum.repos.d/repo.bak/</span><br><span class="line">ck_ok</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更换国内源</span></span><br><span class="line"><span class="function"><span class="title">install_repos</span></span> () &#123;</span><br><span class="line">sed -e <span class="string">'s|^mirrorlist=|#mirrorlist=|g'</span> \</span><br><span class="line">    -e <span class="string">'s|^#baseurl=http://mirror.centos.org/centos|baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos|g'</span> \</span><br><span class="line">    -i.bak \</span><br><span class="line">    /etc/yum.repos.d/CentOS-*.repo</span><br><span class="line">ck_ok</span><br><span class="line">yum install -y epel-release </span><br><span class="line">sed -e <span class="string">'s!^metalink=!#metalink=!g'</span> \</span><br><span class="line">    -e <span class="string">'s!^#baseurl=!baseurl=!g'</span> \</span><br><span class="line">    -e <span class="string">'s!https\?://download\.fedoraproject\.org/pub/epel!https://mirrors.tuna.tsinghua.edu.cn/epel!g'</span> \</span><br><span class="line">    -e <span class="string">'s!https\?://download\.example/pub/epel!https://mirrors.tuna.tsinghua.edu.cn/epel!g'</span> \</span><br><span class="line">    -i /etc/yum.repos.d/epel&#123;,-testing&#125;.repo</span><br><span class="line">yum makecache fast </span><br><span class="line">yum install -y gcc gcc-c++  pcre pcre-devel openssl openssl-devel zlib zlib-devel  wget</span><br><span class="line">ck_ok</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">disable</span></span><br><span class="line"></span><br><span class="line">repos_bak</span><br><span class="line"></span><br><span class="line">install_repos</span><br><span class="line"><span class="comment"># 创建nginx启动用户</span></span><br><span class="line">useradd -s /sbin/nologin  nginx</span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">"请输入您所要安装的NGINX版本："</span> tags</span><br><span class="line">wget http://nginx.org/download/nginx-<span class="variable">$&#123;tags&#125;</span>.tar.gz</span><br><span class="line">ck_ok </span><br><span class="line"></span><br><span class="line">tar xzf nginx-<span class="variable">$&#123;tags&#125;</span>.tar.gz -C /usr/<span class="built_in">local</span>/  &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/nginx-<span class="variable">$&#123;tags&#125;</span>/</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx --group=nginx --user=nginx --sbin-path=/usr/<span class="built_in">local</span>/nginx/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/<span class="built_in">log</span>/nginx/error.log --http-log-path=/var/<span class="built_in">log</span>/nginx/access.log --http-client-body-temp-path=/tmp/nginx/client_body --http-proxy-temp-path=/tmp/nginx/proxy --http-fastcgi-temp-path=/tmp/nginx/fastcgi --pid-path=/var/run/nginx.pid --lock-path=/var/lock/nginx --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-http_realip_module --with-stream</span><br><span class="line">ck_ok</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"编译安装完成"</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; nginx systemd 启动脚本</span></span><br><span class="line">$ cat &gt; /lib/systemd/system/nginx.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=nginx - high performance web server</span><br><span class="line">Documentation=http://nginx.org/en/docs/</span><br><span class="line">After=network-online.target remote-fs.target nss-lookup.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/var/run/nginx.pid</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/nginx/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class="line">ExecReload=/bin/sh -c <span class="string">"/bin/kill -s HUP \$(/bin/cat /var/run/nginx.pid)"</span></span><br><span class="line">ExecStop=/bin/sh -c <span class="string">"/bin/kill -s TERM \$(/bin/cat /var/run/nginx.pid)"</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ systemctl unmask nginx.service</span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl <span class="built_in">enable</span> nginx</span><br><span class="line">$ systemctl start nginx</span><br></pre></td></tr></table></figure>



<p><strong>Nginx 编译参数</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看 nginx 安装的模块</span></span><br><span class="line">[root@localhost ~]# /usr/local/nginx/sbin/nginx -V</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 模块参数具体功能</span></span><br><span class="line">--with-cc-opt='-g -O2 -fPIE -fstack-protector    //设置额外的参数将被添加到CFLAGS变量。（FreeBSD或者ubuntu使用）</span><br><span class="line">--param=ssp-buffer-size=4 -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2' </span><br><span class="line">--with-ld-opt='-Wl,-Bsymbolic-functions -fPIE -pie -Wl,-z,relro -Wl,-z,now' </span><br><span class="line"></span><br><span class="line">--prefix=/usr/local/nginx                        //指向安装目录</span><br><span class="line">--conf-path=/etc/nginx/nginx.conf                //指定配置文件</span><br><span class="line">--http-log-path=/var/log/nginx/access.log        //指定访问日志</span><br><span class="line">--error-log-path=/var/log/nginx/error.log        //指定错误日志</span><br><span class="line">--lock-path=/var/lock/nginx.lock                 //指定lock文件</span><br><span class="line">--pid-path=/run/nginx.pid                        //指定pid文件</span><br><span class="line"></span><br><span class="line">--http-client-body-temp-path=/var/lib/nginx/body    //设定http客户端请求临时文件路径</span><br><span class="line">--http-fastcgi-temp-path=/var/lib/nginx/fastcgi     //设定http fastcgi临时文件路径</span><br><span class="line">--http-proxy-temp-path=/var/lib/nginx/proxy         //设定http代理临时文件路径</span><br><span class="line">--http-scgi-temp-path=/var/lib/nginx/scgi           //设定http scgi临时文件路径</span><br><span class="line">--http-uwsgi-temp-path=/var/lib/nginx/uwsgi         //设定http uwsgi临时文件路径</span><br><span class="line"></span><br><span class="line">--with-debug                                        //启用debug日志</span><br><span class="line">--with-pcre-jit                                     //编译PCRE包含“just-in-time compilation”</span><br><span class="line">--with-ipv6                                         //启用ipv6支持</span><br><span class="line">--with-http_ssl_module                              //启用ssl支持</span><br><span class="line">--with-http_stub_status_module                      //获取nginx自上次启动以来的状态</span><br><span class="line">--with-http_realip_module                 //允许从请求标头更改客户端的IP地址值，默认为关</span><br><span class="line">--with-http_auth_request_module           //实现基于一个子请求的结果的客户端授权。如果该子请求返回的2xx响应代码，所述接入是允许的。如果它返回401或403中，访问被拒绝与相应的错误代码。由子请求返回的任何其他响应代码被认为是一个错误。</span><br><span class="line">--with-http_addition_module               //作为一个输出过滤器，支持不完全缓冲，分部分响应请求</span><br><span class="line">--with-http_dav_module                    //增加PUT,DELETE,MKCOL：创建集合,COPY和MOVE方法 默认关闭，需编译开启</span><br><span class="line">--with-http_geoip_module                  //使用预编译的MaxMind数据库解析客户端IP地址，得到变量值</span><br><span class="line">--with-http_gunzip_module                 //它为不支持“gzip”编码方法的客户端解压具有“Content-Encoding: gzip”头的响应。</span><br><span class="line">--with-http_gzip_static_module            //在线实时压缩输出数据流</span><br><span class="line">--with-http_image_filter_module           //传输JPEG/GIF/PNG 图片的一个过滤器）（默认为不启用。gd库要用到）</span><br><span class="line">--with-http_spdy_module                   //SPDY可以缩短网页的加载时间</span><br><span class="line">--with-http_sub_module                    //允许用一些其他文本替换nginx响应中的一些文本</span><br><span class="line">--with-http_xslt_module                   //过滤转换XML请求</span><br><span class="line">--with-mail                               //启用POP3/IMAP4/SMTP代理模块支持</span><br><span class="line">--with-mail_ssl_module                    //启用ngx_mail_ssl_module支持启用外部模块支持</span><br></pre></td></tr></table></figure>





<h3 id="3-3-NGINX配置文件详解"><a href="#3-3-NGINX配置文件详解" class="headerlink" title="3.3 NGINX配置文件详解"></a>3.3 NGINX配置文件详解</h3><ol>
<li><strong>全局模块</strong></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">user  nobody;</span></span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">error_log  logs/error.log;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">pid        logs/nginx.pid;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>user nobody;</code>：指定 Nginx 进程运行的用户。</li>
<li><code>worker_processes 1;</code>：指定 Nginx 启动的工作进程数。通常设置为 CPU 核心数。</li>
<li><code>error_log logs/error.log;</code>：指定错误日志文件的路径和日志级别。</li>
<li><code>pid logs/nginx.pid;</code>：指定存储 Nginx 主进程 PID 的文件路径。</li>
</ul>
<ol start="2">
<li><strong>events模块</strong></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>worker_connections 1024;</code>：每个工作进程允许的最大连接数。设置为 1024。该参数用于设置每个worker进程允许的最大并发连接数。worker_connections参数用于指定每个Nginx worker进程可以同时处理的最大连接数。在这个例子中，worker_connections</li>
<li>设置为1024，表示每个worker进程最多可以同时处理1024个连接。通过设置worker_connections，可以限制每个worker进程的负载，避免因过多的并发连接导致服务器资源耗尽或性能下降。</li>
</ul>
<ol start="3">
<li><strong>HTTP模块</strong></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span><br><span class="line">    #                  '$status $body_bytes_sent "$http_referer" '</span><br><span class="line">    #                  '"$http_user_agent" "$http_x_forwarded_for"';</span><br><span class="line"></span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>include mime.types;</code>：包含 MIME 类型映射文件，告诉 Nginx 如何处理不同类型的文件。</li>
<li><code>default_type application/octet-stream;</code>：默认的 MIME 类型，如果没有其他匹配的类型，使用这个。</li>
<li><code>log_format</code> 和 <code>access_log</code>：指定日志格式和访问日志路径。</li>
<li><code>sendfile on;</code>：启用 sendfile 选项，提高文件传输效率。允许在内核级别直接将文件数据从磁盘传输到网络，而不需要通过用户空间的缓冲区。这样可以减少CPU和内存的开销，提高文件传输的效率。通过将sendfile设置为on，可以启用sendfile选项，从而优化文件传输的性能。这对于大文件传输或者需要快速响应的场景非常有用。</li>
<li><code>tcp_nopush on;</code>：提高网络传输效率。允许在发送HTTP响应时控制数据包的发送方式。当TCP_NOPUSH选项被设置为on时，Nginx会在发送HTTP响应头之后立即发送响应体的数据，而不是等待整个响应体都准备好后再一起发送。这样可以减少延迟，提高传输效率。</li>
<li><code>keepalive_timeout 65;</code>：保持连接超时时间，设置为 65 秒。允许在一个TCP连接上发送多个HTTP请求和响应，而不需要每次都重新建立连接。通过使用keepalive，可以减少TCP连接的建立和关闭次数，从而提高服务器的性能和效率。</li>
<li><code>gzip on;</code>：启用 gzip 压缩。Gzip 压缩可以显著提高网站性能，通过减少传输数据的大小，加快网页加载速度。</li>
</ul>
<ol start="4">
<li><strong>server模块</strong></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">    #</span><br><span class="line">    #location ~ \.php$ &#123;</span><br><span class="line">    #    proxy_pass   http://127.0.0.1;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">    #</span><br><span class="line">    #location ~ \.php$ &#123;</span><br><span class="line">    #    root           html;</span><br><span class="line">    #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">    #    fastcgi_index  index.php;</span><br><span class="line">    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">    #    include        fastcgi_params;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">    # deny access to .htaccess files, if Apache's document root</span><br><span class="line">    # concurs with nginx's one</span><br><span class="line">    #</span><br><span class="line">    #location ~ /\.ht &#123;</span><br><span class="line">    #    deny  all;</span><br><span class="line">    #&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>listen 80;</code>：指定虚拟主机监听的端口，设置为 80（HTTP）。</li>
<li><code>server_name localhost;</code>：指定虚拟主机名称。</li>
<li><code>charset koi8-r;</code>：设置字符集。</li>
<li><code>access_log logs/host.access.log main;</code>：指定访问日志路径和格式。</li>
</ul>
<ol start="5">
<li><strong>location 模块</strong></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    root   html;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>location /</code>：匹配根路径。</li>
<li><code>root html;</code>：指定根目录路径为 <code>html</code> 目录。</li>
<li><code>index index.html index.htm;</code>：指定默认的索引文件。</li>
</ul>
<ol start="6">
<li><strong>错误页面配置</strong></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">error_page   500 502 503 504  /50x.html;</span><br><span class="line">location = /50x.html &#123;</span><br><span class="line">    root   html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>error_page 500 502 503 504 /50x.html;</code>：指定在发生 500、502、503、504 错误时，显示 <code>/50x.html</code> 页面。</li>
<li><code>location = /50x.html</code>：精确匹配 <code>/50x.html</code>，并指定根目录为 <code>html</code>。</li>
</ul>
<ol start="7">
<li><p><strong>代理和 FastCGI 配置</strong></p>
<p>FastCGI 是一种改进的CGI协议，通过优化性能和资源利用率，使得Web服务器能够更有效地处理动态内容的生成和处理，特别是在高流量和高并发的网络环境中表现出色。</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">location ~ \.php$ &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    proxy_pass   http://127.0.0.1;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">location ~ \.php$ &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    root           html;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    fastcgi_index  index.php;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    fastcgi_param  SCRIPT_FILENAME  /scripts<span class="variable">$fastcgi_script_name</span>;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    include        fastcgi_params;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>location ~ \.php$</code>：使用正则表达式匹配以 <code>.php</code> 结尾的请求。</li>
<li><code>proxy_pass http://127.0.0.1;</code>：将匹配到的请求代理到本地端口 <code>80</code> 上。</li>
<li><code>location ~ \.php$</code>：使用正则表达式匹配以 <code>.php</code> 结尾的请求。</li>
<li><code>root html;</code>：设置根目录为 <code>html</code>。表示根目录在 <code>html</code> 文件夹中。</li>
<li><code>fastcgi_pass 127.0.0.1:9000;</code>：将匹配到的请求传递给本地运行的 FastCGI 服务器，该服务器监听在 <code>127.0.0.1</code> 的端口 <code>9000</code> 上。</li>
<li><code>fastcgi_index index.php;</code>：使用 <code>index.php</code> 作为索引文件。</li>
<li><code>fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name;</code>：设置 <code>SCRIPT_FILENAME</code> FastCGI 参数，该参数指定了请求的 PHP 脚本文件的路径。<code>$fastcgi_script_name</code> 是请求的 URI，<code>/scripts</code> 是在服务器根目录中的路径。</li>
<li><code>include fastcgi_params;</code>：包含 FastCGI 参数文件，该文件定义了一组 FastCGI 参数，通常存储在 Nginx 安装目录的 <code>conf</code> 或 <code>conf.d</code> 目录中。</li>
</ul>
<blockquote>
<p>当 Nginx 收到一个以 <code>.php</code> 结尾的请求时，这个请求将被传递给本地的 FastCGI 服务器进行处理。FastCGI 服务器通常是 PHP-FPM（PHP FastCGI Process Manager），它负责处理 PHP 脚本。Nginx 在这里充当一个 FastCGI 客户端，将请求转发给 FastCGI 服务器，然后将服务器的响应返回给客户端。</p>
</blockquote>
<ol start="8">
<li><strong>拒绝访问 .ht 文件</strong></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> deny access to .htaccess files, <span class="keyword">if</span> Apache<span class="string">'s document root</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> concurs with nginx<span class="string">'s one</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">location ~ /\.ht &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    deny  all;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>location ~ /\.ht</code>：匹配 <code>.ht</code> 文件。</li>
<li><code>deny all;</code>：拒绝所有访问。被注释掉了。</li>
</ul>
<ol start="9">
<li><strong>HTTPS 服务器</strong></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> HTTPS server</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    listen       443 ssl;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    server_name  localhost;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">    ssl_certificate      cert.pem;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    ssl_certificate_key  cert.key;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">    ssl_session_cache    shared:SSL:1m;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    ssl_session_timeout  5m;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">    ssl_ciphers  HIGH:!aNULL:!MD5;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    ssl_prefer_server_ciphers  on;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">    location / &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        root   html;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        index  index.html index.htm;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    &#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>listen 443 ssl;</code>：指定服务器监听 443 端口，这是标准的 HTTPS 端口，并启用 SSL 功能。</p>
</li>
<li><p><code>server_name localhost;</code>：指定服务器名称，这里设置为 <code>localhost</code>。</p>
</li>
<li><p><code>ssl_certificate cert.pem;</code>：指定服务器的 SSL 证书文件路径。<code>cert.pem</code> 是证书文件。</p>
</li>
<li><p><code>ssl_certificate_key cert.key;</code>：指定服务器的 SSL 证书私钥文件路径。<code>cert.key</code> 是私钥文件。</p>
</li>
<li><p><code>ssl_session_cache shared:SSL:1m;</code>：启用共享的 SSL 会话缓存，大小为 1MB。这有助于提高 SSL 握手的性能，因为客户端可以重用现有的 SSL 会话。</p>
</li>
<li><p><code>ssl_session_timeout 5m;</code>：设置 SSL 会话超时时间为 5 分钟。</p>
</li>
<li><p><code>ssl_ciphers HIGH:!aNULL:!MD5;</code>：指定允许使用的 SSL 加密套件。<code>HIGH</code> 表示高安全性套件，<code>!aNULL</code> 排除不带认证的套件，<code>!MD5</code> 排除使用 MD5 算法的套件。</p>
</li>
<li><p><code>ssl_prefer_server_ciphers on;</code>：指示服务器优先使用自己的加密套件，而不是客户端的套件顺序。这有助于确保使用强加密。</p>
</li>
</ul>
<p><strong>Nginx配置文件组成部分</strong></p>
<ul>
<li><strong>全局块</strong>：这是配置文件的最顶层，用于定义对整个Nginx服务器生效的参数。例如，可以设置工作进程数、错误日志的位置等。全局块中配置的指令作用于整个Nginx服务器，而不是某个特定的server或location。</li>
<li><strong>events块</strong>：位于全局块下面，用来设置与连接处理相关的参数，比如每个工作进程允许的最大并发连接数等。这个块通常用来调整Nginx如何处理网络连接和请求的传输速率。</li>
<li><strong>http块</strong>：包含了所有与HTTP服务相关的设置，如路由匹配、静态文件服务、反向代理和负载均衡等。在http块内部，可以包含http全局块、多个server块以及每个server块中的多个location块。每个server块代表一个虚拟主机的配置，而location块则用于匹配并处理特定的URL请求。</li>
</ul>
<p><strong>检测nginx配置文件是否正确</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ln -s /usr/local/nginx/sbin/nginx  /sbin/</span><br><span class="line">[root@localhost ~]# nginx -t</span><br></pre></td></tr></table></figure>

<p><strong>通过 nginx 命令控制 nginx 服务</strong></p>
<p>a、常用命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nginx -c /path/nginx.conf  	     # 以特定目录下的配置文件启动nginx:</span><br><span class="line">nginx -s reload            	 	 # 修改配置后重新加载生效</span><br><span class="line">nginx -s stop  				 	 # 快速停止nginx</span><br><span class="line">nginx							 # 快速启动nginx</span><br><span class="line">nginx -t    					 # 测试当前配置文件是否正确</span><br><span class="line">nginx -t -c /path/to/nginx.conf  # 测试特定的nginx配置文件是否正确</span><br></pre></td></tr></table></figure>

<h3 id="3-4-Nginx-日志文件详解"><a href="#3-4-Nginx-日志文件详解" class="headerlink" title="3.4 Nginx 日志文件详解"></a><strong>3.4 Nginx 日志文件详解</strong></h3><p>​    nginx 日志文件分为 <strong>log_format</strong> 和 <strong>access_log</strong> 两部分</p>
<p>​    log_format 定义记录的格式，其语法格式为</p>
<p>​    log_format        样式名称        样式详情</p>
<p>​    配置文件中默认有</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log_format  main  'remote_addr - remote_user [time_local] "request" '</span><br><span class="line">                  'status body_bytes_sent "$http_referer" '</span><br><span class="line">                  '"http_user_agent" "http_x_forwarded_for"';</span><br></pre></td></tr></table></figure>

<ol>
<li><code>log_format</code></li>
</ol>
<ul>
<li><code>log_format</code>：定义日志格式。</li>
<li><code>main</code>：这是日志格式的名称。在 <code>access_log</code> 指令中引用这个日志格式。</li>
</ul>
<ol start="2">
<li><code>remote_addr</code></li>
</ol>
<ul>
<li><code>$remote_addr</code>：记录客户端的 IP 地址。这个字段表示请求是从哪个 IP 地址发出的。</li>
</ul>
<ol start="3">
<li><code>remote_user</code></li>
</ol>
<ul>
<li><code>$remote_user</code>：记录客户端通过 HTTP 基本认证的用户名。如果请求没有进行认证，则这个字段为空。</li>
</ul>
<ol start="4">
<li><code>time_local</code></li>
</ol>
<ul>
<li><code>$time_local</code>：记录请求的本地时间和日期。格式通常为 <code>day/month/year:hour:minute:second timezone</code>（例如：<code>03/Jul/2024:08:33:00 +0800</code>）。</li>
</ul>
<ol start="5">
<li><code>request</code></li>
</ol>
<ul>
<li><code>$request</code>：记录请求行，包含了请求方法、请求 URI 和 HTTP 协议版本。例如：<code>GET /index.html HTTP/1.1</code>。</li>
</ul>
<ol start="6">
<li><code>status</code></li>
</ol>
<ul>
<li><code>$status</code>：记录响应的 HTTP 状态码。</li>
</ul>
<ol start="7">
<li><code>body_bytes_sent</code></li>
</ol>
<ul>
<li><code>$body_bytes_sent</code>：记录发送给客户端的响应主体的字节数，不包括响应头。如果响应没有主体，则这个字段为 <code>0</code>。</li>
</ul>
<ol start="8">
<li><code>$http_referer</code></li>
</ol>
<ul>
<li><code>$http_referer</code>：记录请求的 <code>Referer</code> 头部字段的值。这个字段表示客户端从哪个页面链接到当前请求的页面。</li>
</ul>
<ol start="9">
<li><code>http_user_agent</code></li>
</ol>
<ul>
<li><code>$http_user_agent</code>：记录请求的 <code>User-Agent</code> 头部字段的值。这个字段包含了客户端浏览器的详细信息。</li>
</ul>
<ol start="10">
<li><code>http_x_forwarded_for</code></li>
</ol>
<ul>
<li><code>$http_x_forwarded_for</code>：记录请求的 <code>X-Forwarded-For</code> 头部字段的值。这个字段通常由代理服务器添加，表示原始客户端的 IP 地址。</li>
</ul>
<p><strong>日志示例如下：</strong></p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202408042113210.png" alt="img"></p>
<h3 id="3-5-使用-limit-rate-限制客户端传输数据的速度"><a href="#3-5-使用-limit-rate-限制客户端传输数据的速度" class="headerlink" title="3.5 使用 limit_rate 限制客户端传输数据的速度"></a><strong>3.5 使用 limit_rate 限制客户端传输数据的速度</strong></h3><p>​    限制客户端的下载速度。这个功能对于控制带宽、优化服务器性能以及防止带宽滥用。</p>
<p>在这个例子中，<strong>limit_rate设置为50k</strong>，表示每个客户端连接的最大传输速率为50KB/s。通过设置limit_rate，<strong>可以控制客户端请求的传输速率，避免因单个客户端占用过多带宽而导致其他客户端无法正常访问。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 修改nginx配置文件</span></span><br><span class="line">[root@localhost ~]# vim  /etc/nginx/conf.d/limit_rate.conf</span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name limit.tanke.love;</span><br><span class="line">   location / &#123;</span><br><span class="line">            root   /www/limit;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">            limit_rate  50k;  #对每个连接的限速为2k/s</span><br><span class="line">            # limit_rate_after 1m;  # 下载 1 MB 后开始限速</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 上传测试视频</span></span><br><span class="line">[root@localhost ~]# ll /www/limit/</span><br><span class="line">总用量 156180</span><br><span class="line">-rw-r--r--. 1 root root 159920333 8月   1 22:22 1.mp4</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 准备默认资源文件</span></span><br><span class="line">[root@localhost ~]# echo "limit_rate" &gt; /www/limit/index.html</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 检查语法格式</span></span><br><span class="line">[root@localhost ~]# nginx -t</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 重新加载配置文件</span></span><br><span class="line">[root@localhost ~]# systemctl reload nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 测试限流</span></span><br><span class="line">[root@localhost ~]# curl  http://192.168.174.20/1.mp4  -o /dev/null</span><br></pre></td></tr></table></figure>

<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202408012226732.png" alt="img"></p>
<ul>
<li><p><strong><code>% Total</code></strong>: 文件的总大小。</p>
<p><strong><code>% Received</code></strong>: 已接收的百分比。</p>
<p><strong><code>% Xferd</code></strong>: 已传输的数据量。</p>
<p><strong><code>Average Speed</code></strong>: 平均下载速度。</p>
<p><strong><code>Time Total</code></strong>: 总时间。</p>
<p><strong><code>Time Spent</code></strong>: 已经花费的时间。</p>
<p><strong><code>Time Left</code></strong>: 剩余时间。</p>
<p><strong><code>Current Speed</code></strong>: 当前下载速度。</p>
</li>
</ul>
<blockquote>
<p><code>Current Speed</code> 显示为 52668 bytes/sec（约为 51.43359375 KB/sec），接近设置的 <code>50k</code> 限制。ZZ</p>
</blockquote>
<h3 id="3-6-Nginx-虚拟主机配置"><a href="#3-6-Nginx-虚拟主机配置" class="headerlink" title="3.6 Nginx 虚拟主机配置"></a>3.6 Nginx 虚拟主机配置</h3><p><strong>什么是虚拟主机？</strong><br>虚拟主机是一种特殊的软硬件技术，它可以将网络上的每一台计算机分成多个虚拟主机，每个虚拟主机可以独立对外提供web服务，这样就可以实现一台主机对外提供多个web服务，每个虚拟主机之间是独立的，互不影响。</p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/1561605672295.png" alt="1561605672295"></p>
<p>Nginx 支持三种类型的虚拟主机配置，具体包括<strong>基于域名、基于IP和基于端口的虚拟主机</strong>。</p>
<ol>
<li><strong>基于域名的虚拟主机</strong>：这种类型的虚拟主机使用server_name指令来区分不同的虚拟主机，适用于外部网站的发布。通过域名系统（DNS）解析到同一个IP地址的不同域名可以指向不同的网站内容。</li>
<li><strong>基于IP的虚拟主机</strong>：一块主机绑定多个IP地址，每个IP地址对应一个虚拟主机。这种方式要求服务器有多个IP地址，每个虚拟主机通过不同的IP进行访问。</li>
<li><strong>基于端口的虚拟主机</strong>：通过不同的端口号来区分不同的虚拟主机，适用于需要在同一台物理服务器上运行多个服务的情况。</li>
</ol>
<p>Nginx通过提供虚拟主机的功能，允许用户在单一服务器上部署多个网站或应用，而无需安装多个Nginx实例。</p>
<h4 id="1-基于域名的虚拟主机"><a href="#1-基于域名的虚拟主机" class="headerlink" title="1. 基于域名的虚拟主机"></a><strong>1. 基于域名的虚拟主机</strong></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 修改配置文件</span></span><br><span class="line">[root@localhost ~]# vim /etc/nginx/conf.d/limit_rate.conf </span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name limit.tanke.love;</span><br><span class="line">  location / &#123;</span><br><span class="line">    root /www/limit/;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line">    limit_rate 2k;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name one.tanke.love;</span><br><span class="line">  location / &#123;</span><br><span class="line">    root /www/one;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 创建资源目录和文件</span></span><br><span class="line">[root@localhost ~]# mkdir /www/one</span><br><span class="line">[root@localhost ~]# echo "one" &gt; /www/one/index.html</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 检测nginx配置文件语法</span></span><br><span class="line">[root@localhost ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;&gt;&gt; 热加载nginx</span></span><br><span class="line">[root@localhost ~]# systemctl reload nginx</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：如果修改的是nginx的资源文件，则不需要进行服务重启和热更新。</p>
</blockquote>
<h4 id="2-基于ip的虚拟主机"><a href="#2-基于ip的虚拟主机" class="headerlink" title="2. 基于ip的虚拟主机"></a><strong>2. 基于ip的虚拟主机</strong></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ip a </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:17:f1:af brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.174.20/24 brd 10.0.105.255 scope global dynamic ens33</span><br><span class="line">       valid_lft 81438sec preferred_lft 81438sec</span><br><span class="line">    inet6 fe80::9d26:f3f0:db9c:c9be/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@localhost ~]# ifconfig ens33:1 192.168.174.21/24</span><br><span class="line">[root@localhost ~]# ifconfig</span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.174.20  netmask 255.255.255.0  broadcast 10.0.105.255</span><br><span class="line">        inet6 fe80::9d26:f3f0:db9c:c9be  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:17:f1:af  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 9844  bytes 1052722 (1.0 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 5567  bytes 886269 (865.4 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens33:1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.174.21  netmask 255.255.255.0  broadcast 10.0.105.255</span><br><span class="line">        ether 00:0c:29:17:f1:af  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br><span class="line">2、配置通过ip区分的虚拟机</span><br><span class="line">[root@localhost ~]# vim /etc/nginx/conf.d/ip_server.conf</span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name 192.168.174.20;</span><br><span class="line">  location / &#123;</span><br><span class="line">    root /www/20;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name 192.168.174.21;</span><br><span class="line">  location / &#123;</span><br><span class="line">    root /www/21;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建站点目录和资源文件</span></span><br><span class="line">[root@localhost ~]# mkdir /www/&#123;20,21&#125;</span><br><span class="line">[root@localhost ~]# echo "20" &gt; /www/20/index.html</span><br><span class="line">[root@localhost ~]# echo "21" &gt; /www/21/index.html</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检测nginx配置文件语法</span></span><br><span class="line">[root@localhost ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line"><span class="meta">#</span><span class="bash"> 热加载nginx</span></span><br><span class="line">[root@localhost ~]# systemctl reload nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 访问</span></span><br><span class="line">http://192.168.174.20</span><br><span class="line">http://192.168.174.21</span><br><span class="line"><span class="meta">#</span><span class="bash"> 补充</span></span><br><span class="line">-- 删除绑定的临时ip</span><br><span class="line">[root@localhost ~]# ifconfig ens33:1 192.168.174.21 down</span><br><span class="line">重启一下nginx</span><br><span class="line">[root@localhost ~]# systemctl restart nginx</span><br></pre></td></tr></table></figure>

<h4 id="3-基于端口的虚拟主机"><a href="#3-基于端口的虚拟主机" class="headerlink" title="3. 基于端口的虚拟主机"></a><strong>3. 基于端口的虚拟主机</strong></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/nginx/conf.d/port_server.conf</span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name port.tanke.love;</span><br><span class="line">  location / &#123;</span><br><span class="line">    root /www/port80/;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 81;</span><br><span class="line">  server_name port.tanke.love;</span><br><span class="line">  location / &#123;</span><br><span class="line">    root /www/port81;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建站点目录和资源文件</span></span><br><span class="line">[root@localhost ~]# mkdir /www/&#123;port80,port81&#125;</span><br><span class="line">[root@localhost ~]# echo "port80" &gt; /www/port80/index.html</span><br><span class="line">[root@localhost ~]# echo "port81" &gt; /www/port81/index.html</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新加载配置文件:</span></span><br><span class="line">[root@localhost ~]# nginx -t</span><br><span class="line">[root@localhost ~]# systemctl reload nginx</span><br><span class="line">测试访问:</span><br><span class="line">浏览器输入：http://port.tanke.love</span><br><span class="line">浏览器输入：http://port.tanke.love:81</span><br></pre></td></tr></table></figure>





<h2 id="4、Nginx-proxy-代理"><a href="#4、Nginx-proxy-代理" class="headerlink" title="4、Nginx proxy 代理"></a>4、Nginx proxy 代理</h2><h3 id="4-1-反向代理产生背景"><a href="#4-1-反向代理产生背景" class="headerlink" title="4.1 反向代理产生背景"></a>4.1 反向代理产生背景</h3><p>​    <strong>反向代理产生的背景是<code>互联网的高速发展和用户需求的激增</code></strong>。</p>
<ul>
<li><strong>提高服务器性能</strong>：随着用户数量的增加，单个服务器处理大量请求的能力有限，通过使用反向代理，可以将请求分散到多个服务器上，从而提高整体的处理能力和效率。</li>
<li><strong>负载均衡</strong>：反向代理可以作为负载均衡器，将客户端的请求均匀地分配到后端的<code>相同服务</code>器群中，确保每个服务器的负载处于合理水平，避免某单一服务器过载而影响服务质量。</li>
<li><strong>安全性提升</strong>：反向代理可以隐藏后端服务器的真实IP地址，增加系统的安全性。保护内部网络不受外界直接访问。</li>
<li><strong>缓存静态内容</strong>：反向代理服务器可以缓存静态内容，如图片、CSS和JavaScript文件，这样可以减少对后端服务器的重复请求，加快内容的加载速度。</li>
</ul>
<h3 id="4-2-反向代理服务的实现"><a href="#4-2-反向代理服务的实现" class="headerlink" title="4.2 反向代理服务的实现"></a>4.2 反向代理服务的实现</h3><ol>
<li><strong>配置反向代理服务器</strong>：首先需要设置一个反向代理服务器，可以是Nginx、Apache等常见的Web服务器软件。在服务器上进行相应的配置，指定后端服务器的地址和端口号。</li>
<li><strong>安装和配置后端服务器</strong>：根据具体需求，选择并安装适当的后端服务器软件，如Tomcat、Node.js等。然后对后端服务器进行配置。</li>
<li><strong>配置反向代理规则</strong>：在反向代理服务器上配置转发规则，将客户端的请求转发到正确的后端服务器。这可以通过修改配置文件或使用特定的命令来实现。</li>
</ol>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/1561616855038.png" alt="    1561616855038"></p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/1561616834649.png" alt="1561616834649"></p>
<h3 id="4-3-正向代理和反向代理的区别"><a href="#4-3-正向代理和反向代理的区别" class="headerlink" title="4.3 正向代理和反向代理的区别"></a>4.3 正向代理和反向代理的区别</h3><ol>
<li><strong>代理对象不同</strong>：<code>正向代理的代理对象是客户端，它位于客户端和目标服务器之间，客户端通过代理服务器发送请求到目标服务器，并从目标服务器获取内容。</code>反向代理的代理对象是服务器，它位于客户端和目标服务器之间，客户端的请求直接发送到反向代理服务器，然后由反向代理服务器将请求转发给目标服务器。</li>
<li><strong>使用场景不同</strong>：正向代理通常用于访问被限制或不可访问的内容，或者在内部网络中提供对外访问的方式。反向代理则主要用于实现负载均衡、安全策略、缓存等功能，提高网站性能和可用性。</li>
<li><strong>设置需求不同</strong>：正向代理通常需要客户端进行设置，以使其通过代理服务器进行访问，这通常涉及到在客户端的网络设置中指定代理服务器的IP地址和端口号。反向代理则通常不需要客户端进行任何设置，客户端发出的请求直接发送到反向代理服务器，然后由反向代理服务器转发请求到后端真实服务器。</li>
<li><strong>安全性不同</strong>：正向代理隐藏客户端的IP地址和身份信息，因为请求是通过代理服务器发出的。反向代理隐藏服务器的真实IP地址和身份信息，<code>客户无需知道后端服务的真实地址</code>。因为请求是直接发送到反向代理服务器，然后由反向代理服务器将请求转发给目标服务器。</li>
</ol>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/1561616889383.png" alt="1561616889383"></p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/1561617154985.png" alt="1561617154985"></p>
<p>反向代理中，<code>proxy</code>和<code>server</code>同属一个LAN，反向代理中代理的对象是服务端，proxy和server同属一个LAN，对client透明。</p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/1561617180382.png" alt="1561617180382"></p>
<p>正向代理和反向代理对比示意图，正向代理中代理的对象是客户端，proxy和client同属一个LAN，对server透明；</p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/1561618001304.png" alt="1561618001304"></p>
<h3 id="4-4-常用的集群软件"><a href="#4-4-常用的集群软件" class="headerlink" title="4.4 常用的集群软件"></a>4.4 常用的集群软件</h3><ul>
<li><strong>开源</strong>：LVS，Keepalived，Haproxy，Nginx</li>
<li><strong>商业</strong>：F5</li>
</ul>
<h3 id="4-5-Nginx-proxy模块配置"><a href="#4-5-Nginx-proxy模块配置" class="headerlink" title="4.5 Nginx proxy模块配置"></a>4.5 <code>Nginx proxy模块配置</code></h3><h4 id="4-5-1-Nginx-proxy代理模块"><a href="#4-5-1-Nginx-proxy代理模块" class="headerlink" title="4.5.1 Nginx proxy代理模块"></a>4.5.1 Nginx proxy代理模块</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx_http_proxy_module</span><br></pre></td></tr></table></figure>

<h4 id="4-5-2-代理配置"><a href="#4-5-2-代理配置" class="headerlink" title="4.5.2 代理配置"></a>4.5.2 代理配置</h4><p>​    准备两台nginx主机，一台为代理服务器，一台为后端服务器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; nginx 01代理服务器配置修改</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/nginx/conf.d/pass_server.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen      80;</span><br><span class="line">  server_name limit.tanke.love;</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass http://192.168.174.21:80;</span><br><span class="line">    proxy_redirect default;</span><br><span class="line">    proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    proxy_set_header   X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_set_header   X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_connect_timeout 30;</span><br><span class="line">    proxy_send_timeout 60;</span><br><span class="line">    proxy_read_timeout 60;</span><br><span class="line">    proxy_buffering on;</span><br><span class="line">    proxy_buffer_size 32k;</span><br><span class="line">    proxy_buffers 4 128k;</span><br><span class="line">    proxy_busy_buffers_size 256k;</span><br><span class="line">    proxy_max_temp_file_size 256k;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数解释</span></span><br><span class="line">proxy_pass http://192.168.174.21:80;  <span class="comment"># 代理的真实后端地址；</span></span><br><span class="line"></span><br><span class="line">proxy_set_header	<span class="comment"># proxy_set_header指令来设置代理服务器向后端服务器发送的请求头部信息。在这个例子中，proxy_set_header Host $http_host;表示将客户端请求的Host头部信息（即$http_host变量）设置为代理服务器向后端服务器发送的请求头部信息中的Host字段。</span></span><br><span class="line"></span><br><span class="line">proxy_set_header   X-Real-IP <span class="variable">$remote_addr</span>; <span class="comment"># 使用proxy_set_header指令来设置代理服务器向后端服务器发送的请求头部信息。在这个例子中，proxy_set_header X-Real-IP $remote_addr;表示将客户端的IP地址（即$remote_addr变量）设置为代理服务器向后端服务器发送的请求头部信息中的X-Real-IP字段。</span></span><br><span class="line"></span><br><span class="line">proxy_set_header   X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>; <span class="comment"># 将客户端的IP地址和代理服务器的IP地址一起传递给后端服务器。</span></span><br><span class="line"></span><br><span class="line">proxy_connect_timeout 30; 	<span class="comment"># proxy_connect_timeout指令来设置代理服务器与后端服务器建立连接的超时时间。</span></span><br><span class="line"></span><br><span class="line">proxy_send_timeout 60;		<span class="comment"># proxy_send_timeout指令来设置代理服务器向后端服务器发送请求的超时时间。</span></span><br><span class="line"></span><br><span class="line">proxy_read_timeout 60;		<span class="comment"># proxy_read_timeout指令来设置代理服务器从后端服务器接收响应的超时时间。</span></span><br><span class="line"></span><br><span class="line">proxy_buffering on;			<span class="comment"># proxy_buffering on;表示开启代理服务器的缓冲功能。目的是为了让代理服务器能够缓存从后端服务器接收到的响应数据，从而提高整体的性能和用户体验。通过开启代理服务器的缓冲功能，可以确保代理服务器能够将响应数据缓存起来，从而减少与后端服务器之间的通信次数，提高响应速度。</span></span><br><span class="line"></span><br><span class="line">proxy_buffer_size 32k;		<span class="comment"># proxy_buffer_size指令来设置代理服务器缓冲区的大小。</span></span><br><span class="line"></span><br><span class="line">proxy_buffers 4 128k;		<span class="comment"># 代理服务器的缓冲区数量和每个缓冲区的大小。这个参数决定了Nginx在代理客户端请求时用于缓存后端服务器响应的缓冲区的总数量和每个缓冲区的最大容量。4：这是缓冲区的数量，即Nginx将创建4个缓冲区来存储来自后端服务器的响应数据。128k：这是每个缓冲区的大小，即每个缓冲区可以存储最多128KB的数据。</span></span><br><span class="line"></span><br><span class="line">proxy_busy_buffers_size 256k;	<span class="comment"># 设置代理服务器的繁忙缓冲区大小。这个参数决定了Nginx在处理高负载时，用于缓存后端服务器响应的额外缓冲区的大小。</span></span><br><span class="line"></span><br><span class="line">proxy_max_temp_file_size 256k;	<span class="comment"># 设置代理服务器的最大临时文件大小。</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意事项： buffer 缓冲区</p>
<ul>
<li><strong>并发连接数</strong>：更多的并发连接意味着需要更多的繁忙缓冲区。每个连接可能会使用一个繁忙缓冲区，因此需要根据预期的并发量来设置繁忙缓冲区的数量。</li>
<li><strong>响应大小</strong>：如果后端服务器返回的响应体通常较大，可能需要增加繁忙缓冲区的大小以避免性能问题。同时，如果响应体很小，那么过多的繁忙缓冲区或过大的繁忙缓冲区可能会浪费内存。</li>
<li><strong>内存限制</strong>：Nginx的繁忙缓冲区大小不能无限制地增加，因为服务器的内存是有限的。必须确保繁忙缓冲区的配置不会消耗过多的内存，影响其他进程或服务的性能。</li>
<li><strong>后端服务器性能</strong>：后端服务器的响应速度也会影响繁忙缓冲区大小的设置。如果后端服务器响应迅速，可能不需要很大的繁忙缓冲区；如果响应慢，较大的繁忙缓冲区可以减少Nginx等待数据的时间。</li>
</ul>
</blockquote>
<h4 id="4-5-3-服务端配置"><a href="#4-5-3-服务端配置" class="headerlink" title="4.5.3 服务端配置"></a>4.5.3 服务端配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cat /etc/nginx/conf.d/default.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost; </span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-5-4-测试访问"><a href="#4-5-4-测试访问" class="headerlink" title="4.5.4 测试访问"></a>4.5.4 测试访问</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 访问代理服务器域名</span></span><br><span class="line">游览器访问：limit.tanke.love</span><br></pre></td></tr></table></figure>

<p>服务端查看<code>/var/log/nginx/access.log</code> 访问日志</p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/image-20240328111901587.png" alt="image-20240328111901587"></p>
<blockquote>
<p>192.168.174.20 反向代理服务器地址<br>192.168.174.21 客户端真实地址</p>
</blockquote>
<hr>
<h2 id="5、Nginx-负载均衡"><a href="#5、Nginx-负载均衡" class="headerlink" title="5、Nginx 负载均衡"></a>5、Nginx 负载均衡</h2><h3 id="5-1-负载均衡作用"><a href="#5-1-负载均衡作用" class="headerlink" title="5.1 负载均衡作用"></a>5.1 负载均衡作用</h3><ol>
<li><strong>提高并发处理能力</strong>：通过将网络流量<code>平均分发</code>到多个服务器上，负载均衡器能够提高系统整体的响应速度和并发处理能力。</li>
<li><strong>增强系统的伸缩性</strong>：当需要增加或减少服务器数量时，负载均衡器可以重新分配请求，确保系统可以根据需求进行扩展或缩减。</li>
<li><strong>提升系统的可用性</strong>：负载均衡器会监控各个服务器的状态，自动跳过不可用的服务器，确保请求只被分发给可用的服务器，从而保证服务的连续性。</li>
<li><strong>安全防护功能</strong>：一些负载均衡解决方案提供了安全功能，如黑白名单处理、防火墙以及防御DDoS攻击等。</li>
<li><strong>优化资源使用</strong>：负载均衡技术可以确保没有单个服务器承受过多的负载，从而避免过载，实现资源的最优使用。</li>
<li><strong>最小化响应时间</strong>：通过智能地将请求分配给多个服务器，负载均衡有助于减少用户的等待时间，提供更快的服务响应。</li>
</ol>
<h3 id="5-2-Nginx-负载均衡模块"><a href="#5-2-Nginx-负载均衡模块" class="headerlink" title="5.2 Nginx 负载均衡模块"></a>5.2 Nginx 负载均衡模块</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ngx_http_upstream_module</span><br><span class="line">ngx_http_proxy_module</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>ngx_http_upstream_module</strong>：用于定义负载均衡策略和后端服务器组的模块。<code>upstream</code>指令用于定义后端服务器组，这些服务器组会被Nginx用来进行负载均衡。</li>
<li><strong>ngx_http_proxy_module</strong>：负责将客户端的请求转发到<code>upstream</code>模块定义的后端服务器组。通过<code>proxy_pass</code>指令，Nginx可以将请求发送到指定的服务器组，从而实现负载均衡。</li>
</ul>
<h3 id="5-3-Nginx-upstream-配置"><a href="#5-3-Nginx-upstream-配置" class="headerlink" title="5.3 Nginx upstream 配置"></a>5.3 Nginx upstream 配置</h3><p>​            upstream 配置与http块下，和server块同级。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 代理服务器配置</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/nginx/nginx.conf </span></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    upstream <span class="built_in">test</span> &#123;</span><br><span class="line">       server 192.168.174.21:80;</span><br><span class="line">       server 192.168.174.22:80;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/nginx/conf.d/upstream_server.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">  listen  80;</span><br><span class="line">  server_name upstream.tanke.love;</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass http://<span class="built_in">test</span>;</span><br><span class="line">    proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    proxy_set_header   X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_set_header   X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment"># 后端主机nginx02配置网页资源</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "nginx02" &gt; /usr/share/nginx/html/index.html </span></span><br><span class="line">[root@localhost ~]<span class="comment"># cat /usr/share/nginx/html/index.html </span></span><br><span class="line">nginx02</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后端主机nginx03配置网页资源</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "nginx03" &gt; /usr/share/nginx/html/index.html </span></span><br><span class="line">[root@localhost ~]<span class="comment"># cat /usr/share/nginx/html/index.html </span></span><br><span class="line">nginx03</span><br><span class="line"></span><br><span class="line"><span class="comment"># 代理服务器检查配置文件语法</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nginx -t</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 代理服务器热加载nginx</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload nginx</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问代理服务器</span></span><br><span class="line">http://upstream.tanke.love</span><br></pre></td></tr></table></figure>

<h4 id="5-3-1-Nginx负载均衡策略"><a href="#5-3-1-Nginx负载均衡策略" class="headerlink" title="5.3.1 Nginx负载均衡策略"></a>5.3.1 <code>Nginx负载均衡策略</code></h4><ul>
<li><p><strong><code>轮询（Round Robin）</code></strong>：这是默认的负载均衡策略。在这种策略下，每个请求会按时间顺序逐一分配到不同的后端服务器节点，确保每个节点平均处理请求。</p>
<ul>
<li><strong>优点</strong>：<ul>
<li><strong>简单高效</strong>：轮询策略实现起来相对简单，不需要复杂的算法支持，因此在处理请求时效率较高。</li>
<li><strong>自动故障转移</strong>：如果某个后端服务器宕机或无法响应，Nginx能够自动检测到并将请求转发到其他健康的服务器上，这样可以提高系统的整体可用性。</li>
<li><strong>均匀分配</strong>：在大多数情况下，轮询策略能够保证请求被均匀地分配到各个后端服务器上，从而提高了系统的吞吐量和资源的利用率。</li>
</ul>
</li>
<li><strong>缺点</strong>：<ul>
<li><strong>会话一致性问题</strong>：由于请求可能会被随机分配到不同的服务器上，这可能会导致同一个用户的连续请求落在不同服务器上，从而影响会话的一致性。</li>
<li><strong>缺乏灵活性</strong>：轮询策略不会考虑后端服务器的实际处理能力，也不会根据请求的内容进行优化分配，这可能会导致某些服务器过载而其他服务器却处于空闲状态。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong><code>加权轮询（Weighted Round Robin）</code></strong>：这种策略允许根据服务器的性能为其分配权重，性能更好的服务器可以处理更多的请求。</p>
<ul>
<li><strong>优点</strong>：<ul>
<li><strong>性能优化</strong>：允许性能更强的服务器处理更多的请求，这样可以充分利用资源，提高整体的处理能力。</li>
<li><strong>灵活性</strong>：可以根据实际情况调整服务器的权重，以适应不同的负载需求和服务器性能。</li>
<li><strong>适应性</strong>：在服务器性能差异较大时，能够更好地平衡负载，避免某些服务器过载而其他服务器空闲的情况发生。</li>
</ul>
</li>
<li><strong>缺点</strong>：<ul>
<li><strong>压力集中</strong>：在系统启动初期，高权重的节点可能会承受较大的压力，导致机器负载突然增高，而其他机器则处于低负载状态，这可能会影响服务的平滑性。</li>
<li><strong>复杂性</strong>：相比简单的轮询策略，加权轮询需要更多的配置和管理，增加了系统的复杂性。</li>
<li><strong>会话一致性</strong>：尽管加权轮询考虑了服务器的性能，但仍然可能导致同一用户的请求被分配到不同服务器，影响会话一致性。                             </li>
</ul>
</li>
</ul>
</li>
<li><p><strong><code>最少连接（Least Connections）</code></strong>：在这个策略下，Nginx会将新请求分配给当前连接数最少的服务器，这样可以保证服务器间的负载更加均衡。</p>
<ul>
<li><strong>优点</strong>：<ul>
<li><strong>提高服务器利用率</strong>：在高负载情况下，将请求转发给当前连接数较少的后端服务器，可以更有效地利用服务器资源，避免某些服务器过载。</li>
<li><strong>适应性强</strong>：适用于处理时间不确定或服务器性能差异较大的环境，能够根据实际情况动态调整请求分配，提高整体的处理能力和效率。</li>
<li><strong>减少响应时间</strong>：通过将请求分配给当前连接数较少的服务器，可以减少用户的等待时间，提高服务的响应速度。</li>
</ul>
</li>
<li><strong>缺点</strong>：<ul>
<li><strong>可能导致空闲</strong>：在某些情况下，如果某个服务器的处理能力非常强，可能会导致其他服务器长期处于空闲状态，从而影响其性能和稳定性。</li>
<li><strong>可能不公平</strong>：如果服务器的处理能力不同，仅仅根据连接数来分配请求可能会导致某些服务器承担更多的负载，而其他服务器则相对较少，这在一定程度上违背了负载均衡的公平性原则。                      </li>
</ul>
</li>
</ul>
</li>
<li><p><strong><code>IP Hash</code></strong>：这种策略会根据客户端IP地址的哈希值来选择服务器，这样可以确保同一用户的请求总是被发送到同一台服务器，有助于实现会话保持。</p>
<ul>
<li><strong>优点</strong>：<ul>
<li><strong>会话保持</strong>：根据客户端IP的哈希值来分配请求，确保来自同一IP的请求被发送到相同的后端服务器。这有助于维持客户端与服务器之间的会话状态，特别是对于需要保持登录状态或其他会话信息的应用来说非常重要。</li>
<li><strong>减少响应时间</strong>：由于同一用户的请求被定向到同一台服务器，可以减少因服务器间会话恢复而产生的延迟，提高应用的响应速度。</li>
</ul>
</li>
<li><strong>缺点</strong>：<ul>
<li><strong>无法处理高并发</strong>：当某个客户端的请求量异常增加时，可能会导致该客户端对应的后端服务器负载过高，而其他服务器却处于相对空闲的状态。                                   </li>
</ul>
</li>
</ul>
</li>
<li><p><strong><code>URL Hash</code></strong>：这种策略会根据请求的URL的哈希值来选择服务器，适用于需要根据URL分配请求到特定服务器的场景。</p>
<ul>
<li><p><strong>优点</strong>：</p>
<ul>
<li><strong>会话保持</strong>：确保相同URL的请求始终被分配到同一台后端服务器，有助于保持会话的一致性，特别适用于需要维护用户登录状态等场景。</li>
<li><strong>提高效率</strong>：由于相同URL的请求被定向到同一服务器，这可以减少服务器间状态复制的需要，提高缓存效率，尤其适用于后端服务器使用缓存的场景。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li><strong>服务器动态变化敏感</strong>：如果后端服务器列表发生变化（如增加或减少服务器），可能会导致哈希结果的变化，进而影响到之前已经分配的服务器，这需要在使用中特别注意。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong><code>Fair</code></strong>：根据后端服务器的响应时间进行动态分配请求，实现更合理的负载均衡。nginx本身不支持fair，需要独立安装<code>upstream_fair</code>模块。</p>
<ul>
<li><strong>优点</strong>：<ul>
<li><strong>动态调整</strong>：Fair策略能够动态地根据服务器的实际处理能力来分配请求，这样可以更合理地利用服务器资源，提高整体的处理效率。</li>
<li><strong>适应性强</strong>：对于那些处理能力不一或处理时间不确定的服务器集群，Fair策略能够更好地平衡负载，避免某些服务器过载而其他服务器空闲的情况发生。</li>
</ul>
</li>
<li><strong>缺点</strong>：<ul>
<li><strong>对突发流量敏感</strong>：由于Fair策略是根据服务器当前的响应时间来分配请求，因此对于突发流量的处理可能不够迅速，需要一段时间来调整分配策略。</li>
<li><strong>可能引起资源分配不均</strong>：在服务器性能差异较大的情况下，Fair策略可能会导致性能较好的服务器承担更多的请求，而性能较差的服务器则可能处于较为空闲的状态。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="轮询策略"><a href="#轮询策略" class="headerlink" title="轮询策略"></a><strong>轮询策略</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  upstream <span class="built_in">test</span> &#123;</span><br><span class="line">       server 192.168.174.21:80;</span><br><span class="line">       server 192.168.174.22:80;     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>负载均衡状态配置参数：</p>
<ul>
<li><p><code>down;</code>    表示不在将用户的请求转发到此主机中；</p>
</li>
<li><p><code>backup;</code> 预留的备份机器。当其他所有的非backup机器出现故障时，才会请求backup机器，因此这台机器的压力最轻。</p>
</li>
<li><p><code>max_fails</code>：表示允许的最大失败次数。当一个后端服务器在 <code>fail_timeout</code> 时间内连续失败这么多次后，Nginx 会将该服务器标记为不可用，不再向其转发请求。默认值为 1。</p>
</li>
<li><p><code>fail_timeout</code>：表示失败检查的时间间隔。在这个时间段内，如果一个后端服务器的失败次数达到了 <code>max_fails</code>，那么 Nginx 会将其标记为不可用。默认值为 10s。 </p>
</li>
<li><pre><code class="bash"><span class="comment"># down</span>
http {
    upstream backend {
        server 192.168.174.21 down;
        server 192.168.174.22;
    }
    ...
}

<span class="comment"># backup;</span>
http {
    upstream backend {
        server 192.168.174.21 backup;
        server 192.168.174.22;
    }
    ...
}

<span class="comment"># max_fails  fail_timeout</span>
http {
    upstream backend {
        server 192.168.174.21 max_fails=3 fail_timeout=30s;
        server 192.168.174.22 max_fails=3 fail_timeout=30s;
    }
    ...
}
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### **加权轮询**</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;bash</span><br><span class="line">http &#123;</span><br><span class="line">  upstream backend &#123;</span><br><span class="line">      server 192.168.174.21 weight&#x3D;2;</span><br><span class="line">      server 192.168.174.22 weight&#x3D;1;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
</li>
</ul>
<h5 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a><strong>ip_hash</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  upstream backend &#123;</span><br><span class="line">	  ip_hash;</span><br><span class="line">      server 192.168.174.21; </span><br><span class="line">      server 192.168.174.22;   </span><br><span class="line">  &#125;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="URL-Hash"><a href="#URL-Hash" class="headerlink" title="URL Hash"></a><strong>URL Hash</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  upstream backend &#123;</span><br><span class="line">	  <span class="built_in">hash</span> <span class="variable">$request_uri</span>;</span><br><span class="line">      server 192.168.174.21; </span><br><span class="line">      server 192.168.174.22;   </span><br><span class="line">  &#125;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="最少连接"><a href="#最少连接" class="headerlink" title="最少连接"></a><strong>最少连接</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  upstream backend&#123;</span><br><span class="line">	  least_conn;</span><br><span class="line">	  server 192.168.174.21;</span><br><span class="line">	  server 192.168.174.22;</span><br><span class="line">  &#125;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="fair"><a href="#fair" class="headerlink" title="fair"></a><strong>fair</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    upstream backend &#123;</span><br><span class="line">        fair;</span><br><span class="line">        server 192.168.174.21;</span><br><span class="line">        server 192.168.174.21;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 参考链接：<a href="https://github.com/gnosek/nginx-upstream-fair" target="_blank" rel="noopener">https://github.com/gnosek/nginx-upstream-fair</a></p>
<h2 id="6、Nginx会话保持"><a href="#6、Nginx会话保持" class="headerlink" title="6、Nginx会话保持"></a>6、Nginx会话保持</h2><h4 id="6-1-什么是会话保持"><a href="#6-1-什么是会话保持" class="headerlink" title="6.1 什么是会话保持"></a>6.1 什么是会话保持</h4><p>会话保持是一种在<strong>负载均衡环境中维持客户端和服务器之间的交互状态的机制</strong>。</p>
<p>会话保持的目的是确保来自同一用户的连续请求被分配到同一台服务器上处理，从而保持用户会话的连续性。这对于维护用户登录状态等敏感信息至关重要。以下是一些关键点：</p>
<ol>
<li><strong>识别关联性</strong>：会话保持可以识别客户端与服务器之间交互过程的关联性。</li>
<li><strong>Web开发技术</strong>：在Web开发中，会话保持通常通过Session和Cookie机制来实现。</li>
<li><strong>Session与Cookie</strong>：Session是一种服务器端的会话管理机制，而Cookie是客户端的一种缓存机制，两者都可以用于跟踪用户会话。</li>
<li><strong>粘滞会话（Sticky Sessions）</strong>：会话保持有时也称为粘滞会话，它确保一系列相关联的访问请求会被分配到同一台服务器上处理。</li>
</ol>
<h4 id="6-2-什么是Cookie和Session"><a href="#6-2-什么是Cookie和Session" class="headerlink" title="6.2 什么是Cookie和Session"></a>6.2 什么是Cookie和Session</h4><p><strong>Cookie和Session都是用于跟踪和管理网站用户状态的技术，但它们的存储位置和使用方式有所不同</strong>。</p>
<p><strong><code>Cookie</code></strong> 是一种存储在用户浏览器中的小型文本文件，它可以用来记录用户信息，如登录状态、网站偏好设置等。当用户访问一个网站时，服务器会向用户的浏览器发送Cookie，浏览器会保存这些信息。下次用户再次访问该网站时，浏览器会将这些Cookie信息发送回服务器，服务器通过这些信息来识别用户并生成个性化的内容。</p>
<p><strong><code>Session</code></strong> 则是在服务器端记录用户信息的一种机制。当用户访问服务器时，服务器会创建一个新的Session，并将其唯一标识（如ID）存储在Cookie中，然后发送给客户端浏览器。这样，每次用户与服务器交互时，服务器都可以通过这个Session标识来识别用户，并获取与之相关的信息，如登录状态或购物车内容等。</p>
<h4 id="6-3-Nginx实现回话保持的手段"><a href="#6-3-Nginx实现回话保持的手段" class="headerlink" title="6.3 Nginx实现回话保持的手段"></a>6.3 Nginx实现回话保持的手段</h4><ol>
<li><strong>基于客户端IP地址的会话保持</strong>：</li>
</ol>
<ul>
<li><p><strong>ip_hash</strong>：这种方法使用源地址哈希算法，确保来自同一客户端的请求总是被发送到相同的后端服务器。这有助于保持客户端与服务器之间的会话状态，特别是对于需要维持登录状态或其他会话信息的应用来说非常重要。然而，这种方法的缺点是如果后端服务器宕机，会话信息可能会丢失，同时如果多个客户端处于同一局域网内，可能会导致负载不均衡。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  upstream backend &#123;</span><br><span class="line">	  ip_hash;</span><br><span class="line">      server 192.168.174.21; </span><br><span class="line">      server 192.168.174.22;   </span><br><span class="line">  &#125;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ol start="2">
<li><strong>基于后端存储的会话保持</strong>：（了解）</li>
</ol>
<ul>
<li>可以通过数据库、Redis或Memcached等后端存储服务来实现Session的复制和同步。这种方法不依赖于Nginx本身，而是通过后端存储服务的会话同步机制来保持用户会话状态。</li>
</ul>
<p>我们知道一个请求在经过一个服务器处理时，服务器会保存相关的会话信息，比如session，但是该请求如果第一个服务器没处理完，通过nginx轮询到第二个服务器上，那么这个服务器是没有会话信息的。</p>
<p>最典型的一个例子：用户第一次进入一个系统是需要进行登录身份验证的，首先将请求跳转到Tomcat1服务器进行处理，登录信息是保存在Tomcat1 上的，这时候需要进行别的操作，那么可能会将请求轮询到第二个Tomcat2上，那么由于Tomcat2 没有保存会话信息，会以为该用户没有登录，然后继续登录一次，如果有多个服务器，每次第一次访问都要进行登录，这显然是很影响用户体验的。</p>
<p>这里产生的一个问题也就是集群环境下的 <code>session 共享</code>，如何解决这个问题？</p>
<ul>
<li>选择一个中间件，将登录信息保存在一个中间件上，这个中间件可以为Redis这样的数据库。那么第一次登录，我们将session 信息保存在 Redis 中，跳转到第二个服务器时，我们可以先去Redis上查询是否有登录信息，如果有，就能直接进行登录之后的操作了，而不用进行重复登录。</li>
</ul>
<h2 id="7、Nginx动静分离"><a href="#7、Nginx动静分离" class="headerlink" title="7、Nginx动静分离"></a>7、Nginx动静分离</h2><h3 id="7-1-介绍"><a href="#7-1-介绍" class="headerlink" title="7.1 介绍"></a>7.1 介绍</h3><p><strong>Nginx 动静分离是指将动态和静态资源请求分开处理，以提高网站性能和稳定性</strong>。</p>
<p>Nginx作为一个高性能的Web服务器，可以有效地处理静态资源，如HTML、JavaScript、CSS和图片等文件，而将动态资源请求，通常是指需要后端服务器处理的请求，如PHP、Java等，交给专门的应用服务器处理，如Tomcat。</p>
<ul>
<li><strong>提高响应速度</strong>：Nginx对静态资源的处理非常高效，可以快速响应客户端的请求，减少页面加载时间。</li>
<li><strong>减轻后端压力</strong>：动态资源请求通常涉及到数据库操作，将这些请求交给专门的应用服务器处理，可以避免Nginx承担过多的计算任务，从而保证动态内容的生成和处理更加专注和高效。</li>
<li><strong>提升网站稳定性</strong>：动静分离可以有效分散服务器负载，避免单点故障，提高整个网站的稳定性和可靠性。</li>
<li><strong>优化资源利用</strong>：通过合理配置Nginx，可以实现客户端缓存，减少不必要的数据传输，节省带宽。</li>
</ul>
<p><img src="https://pics4.baidu.com/feed/b21bb051f8198618fd6fec9e2c438b7f8bd4e63f.jpeg@f_auto?token=52352fb4457ef3d37e57d4271f7865de" alt="img"></p>
<h3 id="7-2-环境准备"><a href="#7-2-环境准备" class="headerlink" title="7.2 环境准备"></a>7.2 环境准备</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.174.20 <span class="comment"># 反向代理服务器</span></span><br><span class="line">192.168.174.21 <span class="comment"># 处理静态资源服务器</span></span><br><span class="line">192.168.174.22 <span class="comment"># 处理动态请求服务器</span></span><br></pre></td></tr></table></figure>

<h4 id="7-2-1-代理服务器配置"><a href="#7-2-1-代理服务器配置" class="headerlink" title="7.2.1 代理服务器配置"></a>7.2.1 代理服务器配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 修改配置文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim  /etc/nginx/conf.d/upstream.conf </span></span><br><span class="line">upstream static &#123;</span><br><span class="line">        server 192.168.174.21:80;</span><br><span class="line">&#125;</span><br><span class="line">upstream phpserver &#123;</span><br><span class="line">        server 192.168.174.22:80;</span><br><span class="line">&#125;</span><br><span class="line">     server &#123;</span><br><span class="line">        listen      80;</span><br><span class="line">        server_name     localhost;</span><br><span class="line">        <span class="comment">#动态资源加载</span></span><br><span class="line">        location ~ \.(php|jsp)$ &#123;</span><br><span class="line">            proxy_pass http://phpserver;</span><br><span class="line">            proxy_set_header Host <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">            proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        <span class="comment">#静态资源加载</span></span><br><span class="line">        location ~* .*\.(html|gif|jpg|png|bmp|swf|css|js)$ &#123;</span><br><span class="line">            proxy_pass http://static;</span><br><span class="line">            proxy_set_header Host <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">            proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 检查语法格式</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nginx -t</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 重新加载配置文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload nginx</span></span><br></pre></td></tr></table></figure>

<h4 id="7-2-2-静态资源服务器配置"><a href="#7-2-2-静态资源服务器配置" class="headerlink" title="7.2.2 静态资源服务器配置"></a>7.2.2 静态资源服务器配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 修改配置文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/nginx/conf.d/static.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name     localhost;</span><br><span class="line"></span><br><span class="line">        location ~* \.(html|jpg|png|js|css|gif|bmp|jpeg)$ &#123;</span><br><span class="line">        root /home/www/nginx;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 检查语法格式</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nginx -t</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 重新加载配置文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建站点目录</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mkdir -p /home/www/nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建站点文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "jingtai" &gt; /home/www/nginx/index.html    //模拟静态资源</span></span><br></pre></td></tr></table></figure>

<h4 id="7-2-3-动态资源服务器配置"><a href="#7-2-3-动态资源服务器配置" class="headerlink" title="7.2.3 动态资源服务器配置"></a>7.2.3 动态资源服务器配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 安装 PHP 所需的epel源</span></span><br><span class="line">[root@localhost ~]<span class="comment"># rpm -Uvh https://mirror.webtatic.com/yum/el7/epel-release.rpm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 安装 PHP 安装源</span></span><br><span class="line">[root@localhost ~]<span class="comment"># rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 安装PHP</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum install php71w-xsl php71w php71w-ldap php71w-cli php71w-common php71w-devel php71w-gd php71w-pdo php71w-mysql php71w-mbstring php71w-bcmath php71w-mcrypt   php71w-fpm -y</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 启动PHP服务</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl enable --now php-fpm   #不启动的话会报502错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 备份 nginx 配置文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cp /etc/nginx/conf.d/default.conf   /etc/nginx/conf.d/default.conf.old</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 修改配置</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/nginx/conf.d/default.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">        listen      80;</span><br><span class="line">        server_name     localhost;</span><br><span class="line">        location ~* \.php$ &#123;</span><br><span class="line">            root           /home/nginx/html;   <span class="comment"># 指定网站目录</span></span><br><span class="line">            fastcgi_pass   127.0.0.1:9000;     <span class="comment"># 指定访问地址</span></span><br><span class="line">            fastcgi_index  index.php;		   <span class="comment"># 指定默认文件</span></span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;   <span class="comment"># 站点根目录，取决于root配置项</span></span><br><span class="line">            include        fastcgi_params;   <span class="comment"># 包含nginx常量定义</span></span><br><span class="line">        		&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 检查语法</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nginx -t</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 重新加载配置文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建站点目录</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mdkir -p /home/nginx/html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建站点文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "dongtai" &gt; /home/nginx/html/index.php   //模拟动态资源</span></span><br></pre></td></tr></table></figure>



<h2 id="8、Nginx防盗链"><a href="#8、Nginx防盗链" class="headerlink" title="8、Nginx防盗链"></a>8、Nginx防盗链</h2><h3 id="7-1-介绍-1"><a href="#7-1-介绍-1" class="headerlink" title="7.1 介绍"></a>7.1 介绍</h3><p>​    Nginx可以通过<strong>配置实现防盗链</strong>，以保护网站资源不被未经授权的使用。两个网站 A 和 B， B网站引用了A网站上的图片，这种行为就叫做盗链。 防盗链，就是要防止B引用A的图片。以下是一些常用的方法：</p>
<p><strong>使用refer模块</strong>：这是Nginx中一个用于检查HTTP请求头中的Referer字段的模块。通过配置valid_referers指令，可以指定允许访问资源的合法来源域名或URL模式。如果请求的Referer头部与这些模式匹配，则认为请求是合法的，否则拒绝访问。这种方法相对简单，但可能受到伪造Referer头的影响。</p>
<p><strong>Nginx防盗链模块</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx_http_referer_module</span><br></pre></td></tr></table></figure>

<p><strong>如何区分哪些是不正常的用户？</strong></p>
<pre><code>HTTP Referer是Header的一部分，当浏览器向Web服务器发送请求的时候，一般会带上Referer，告诉服务器我是从哪个页面链接过来的，服务器借此可以获得一些信息用于处理，例如防止未经允许的网站盗链图片、文件等。因此HTTP Referer头信息是可以通过程序来伪装生成的，所以通过Referer信息防盗链并非100%可靠，但是，它能够限制大部分的盗链情况。</code></pre><h3 id="7-2-Nginx防盗链配置"><a href="#7-2-Nginx防盗链配置" class="headerlink" title="7.2 Nginx防盗链配置"></a>7.2 Nginx防盗链配置</h3><p><strong>环境准备：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.174.20 <span class="comment">#受害者(被盗链者)</span></span><br><span class="line">192.168.174.21 <span class="comment">#违法者(盗链者)</span></span><br><span class="line">192.168.174.22 <span class="comment">#旁观者(客户端)</span></span><br></pre></td></tr></table></figure>

<p><strong>简单了解Nginx默认access日志格式</strong></p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/image-20240328212852810.png" alt="image-20240328212852810"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">192.168.174.1	<span class="comment"># 客户端地址</span></span><br><span class="line">-</span><br><span class="line">-  				<span class="comment"># 访问用户</span></span><br><span class="line">[28/Mar/2024:21:28:07 +0800]	<span class="comment"># 访问时间</span></span><br><span class="line"><span class="string">"GET / HTTP/1.1"</span> 		<span class="comment"># 请求方法，请求路径，协议版本</span></span><br><span class="line">200		<span class="comment"># 状态码</span></span><br><span class="line">7806	<span class="comment"># 访问字节大小</span></span><br><span class="line"><span class="string">"-"</span>		<span class="comment"># 是否从其他链接跳转，链接地址</span></span><br><span class="line"><span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36"</span> <span class="comment"># 客户端访问方式</span></span><br><span class="line"><span class="string">"-"</span>		<span class="comment"># 反向代理地址</span></span><br></pre></td></tr></table></figure>

<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/image-20240328213256174.png" alt="image-20240328213256174"></p>
<blockquote>
<p>上图红色方框中，显示上一级链接地址。如果存在则显示，无则显示<code>&quot;-&quot;</code></p>
</blockquote>
<p><strong>受害者环境准备</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">192.168.174.20 <span class="comment">#受害者(被盗链者)</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/nginx/conf.d/referers_nginx.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen    80;</span><br><span class="line">   server_name   localhost;</span><br><span class="line">   location / &#123;</span><br><span class="line">      root /usr/share/nginx/html;</span><br><span class="line">      index qf.png;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># nginx -t</span></span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload nginx</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>浏览器访问<a href="http://192.168.174.20" target="_blank" rel="noopener">http://192.168.174.20</a></p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/image-20240328213615308.png" alt="image-20240328213615308"></p>
</blockquote>
<p><strong>非法者环境准备</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">192.168.174.21 <span class="comment">#违法者(盗链者)</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/nginx/conf.d/referers_nginx.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">  listen   80;</span><br><span class="line">  server_name   localhost;</span><br><span class="line">  location / &#123;</span><br><span class="line">    root /usr/share/nginx/html;</span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /usr/share/nginx/html/index.html </span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;qf.com&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body style=<span class="string">"background-color:red;"</span>&gt;</span><br><span class="line">    &lt;img src=<span class="string">"http://192.168.174.20/qf.png"</span>/&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># nginx -t</span></span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload nginx</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>游览器访问<a href="http://192.168.174.21" target="_blank" rel="noopener">http://192.168.174.21</a><br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/image-20240328214339171.png" alt="image-20240328214339171"></p>
</blockquote>
<p><strong>查看被盗链主机的访问日志</strong></p>
<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/image-20240328214448292.png" alt="image-20240328214448292"></p>
<blockquote>
<p>“<a href="http://192.168.174.21/&quot;" target="_blank" rel="noopener">http://192.168.174.21/&quot;</a> 盗链者地址</p>
</blockquote>
<p><strong>禁用盗链IP/URL，受盗链主机配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-server ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line"><span class="comment"># 日志格式添加"$http_referer"</span></span><br><span class="line">log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                         <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                         <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"><span class="comment"># valid_referers 使用方式                         </span></span><br><span class="line">Syntax: 	valid_referers none | blocked | server_names | string ...;</span><br><span class="line">Default: 	—</span><br><span class="line">Context: server, location</span><br><span class="line"></span><br><span class="line"><span class="comment"># none : 允许没有http_referer的请求访问资源；</span></span><br><span class="line"><span class="comment"># blocked : 允许不是http://开头的，不带协议的请求访问资源；</span></span><br><span class="line"><span class="comment"># server_names : 只允许指定ip/域名来的请求访问资源（白名单）。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/nginx/conf.d/referers_nginx.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">   listen    80;</span><br><span class="line">   server_name   localhost;</span><br><span class="line">   location / &#123;</span><br><span class="line">      root /usr/share/nginx/html;</span><br><span class="line">      index qf.png;</span><br><span class="line">      valid_referers none blocked www.jd.com;  <span class="comment"># 允许www.jd.com 允许访问</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">        <span class="built_in">return</span> 403;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># none允许空值访问，客户端直接访问。所以加不加ip都可以访问，如果把none擦除，就不能访问了</span></span><br><span class="line">valid_referers none blocked www.jd.com 192.168.174.21; 添加到白名单盗链者就可以继续访问到图片。</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># nginx -t</span></span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload nginx</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>盗链者再次访问图片<br><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/image-20240328220321210.png" alt="image-20240328220321210"></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">在其中一台机器测试:</span><br><span class="line">测试不带http_refer：</span><br><span class="line">[root@localhost ~]<span class="comment"># curl -I "http://192.168.174.20"</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.24.0</span><br><span class="line">Date: Thu, 28 Mar 2024 14:08:14 GMT</span><br><span class="line">Content-Type: image/png</span><br><span class="line">Content-Length: 7806</span><br><span class="line">Last-Modified: Thu, 28 Mar 2024 13:24:12 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">"66056f7c-1e7e"</span></span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">测试带非法http_refer:</span><br><span class="line">[root@localhost ~]<span class="comment"># curl -e http://www.baidu.com -I "http://192.168.174.20"</span></span><br><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">Server: nginx/1.24.0</span><br><span class="line">Date: Thu, 28 Mar 2024 14:08:30 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 153</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">测试带合法的http_refer:</span><br><span class="line">[root@localhost ~]<span class="comment">#  curl -e http://www.jd.com -I "http://192.168.174.20"</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.24.0</span><br><span class="line">Date: Thu, 28 Mar 2024 14:09:17 GMT</span><br><span class="line">Content-Type: image/png</span><br><span class="line">Content-Length: 7806</span><br><span class="line">Last-Modified: Thu, 28 Mar 2024 13:24:12 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">"66056f7c-1e7e"</span></span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># curl -e http://192.168.174.22 -I "http://192.168.174.20"</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.24.0</span><br><span class="line">Date: Thu, 28 Mar 2024 14:09:34 GMT</span><br><span class="line">Content-Type: image/png</span><br><span class="line">Content-Length: 7806</span><br><span class="line">Last-Modified: Thu, 28 Mar 2024 13:24:12 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">"66056f7c-1e7e"</span></span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/image-20240328221027750.png" alt="image-20240328221027750"></p>
<h2 id="9、Nginx重定向"><a href="#9、Nginx重定向" class="headerlink" title="9、Nginx重定向"></a>9、Nginx重定向</h2><h3 id="9-1-Nginx-rewrite介绍"><a href="#9-1-Nginx-rewrite介绍" class="headerlink" title="9.1 Nginx rewrite介绍"></a>9.1 Nginx rewrite介绍</h3><p>Rewrite对称URL Rewrite，即URL重写，就是把传入Web的请求重定向到其他URL的过程。</p>
<ul>
<li>URL Rewrite最常见的应用是URL伪静态化，是将动态页面显示为静态页面方式的一种技术。比如<a href="http://www.123.com/news/index.php?id=123" target="_blank" rel="noopener">http://www.123.com/news/index.php?id=123</a> 使用URLRewrite 转换后可以显示为 <a href="http://www.123.com/news/123.html对于追求完美主义的网站设计师，就算是网页的地址也希望看起来尽量简洁明快。理论上，搜索引擎更喜欢静态页面形式的网页，搜索引擎对静态页面的评分一般要高于动态页面。所以，UrlRewrite可以让我们网站的网页更容易被搜索引擎所收录。" target="_blank" rel="noopener">http://www.123.com/news/123.html对于追求完美主义的网站设计师，就算是网页的地址也希望看起来尽量简洁明快。理论上，搜索引擎更喜欢静态页面形式的网页，搜索引擎对静态页面的评分一般要高于动态页面。所以，UrlRewrite可以让我们网站的网页更容易被搜索引擎所收录。</a></li>
<li>从安全角度上讲，如果在URL中暴露太多的参数，无疑会造成一定量的信息泄漏，可能会被一些黑客利用，对你的系统造成一定的破坏，所以静态化的URL地址可以给我们带来更高的安全性。</li>
<li>实现网站地址跳转，例如用户访问360buy.com，将其跳转到jd.com。例如当用户访问tianyun.com的80端口时，将其跳转到443端口。</li>
</ul>
<h3 id="9-2-Rewrite-相关指令"><a href="#9-2-Rewrite-相关指令" class="headerlink" title="9.2  Rewrite 相关指令"></a>9.2  Rewrite 相关指令</h3><ul>
<li><strong>return指令</strong>：用于返回指定的HTTP状态码，通常与重定向一起使用，例如<code>return 301 $uri</code>会将请求重定向到新的URI。</li>
<li><strong>if语句</strong>：允许根据某些条件执行特定的重写规则。这个指令可以让你根据不同的请求头或请求参数来应用不同的重写规则。</li>
<li><strong>set指令</strong>：用于设置变量，这些变量可以在rewrite规则中被引用，或者在其他地方用于进一步的处理。</li>
<li><strong>rewrite指令</strong>：这是实现URL重写的关键指令，它根据正则表达式部分的内容，将请求重定向到替换（replacement）部分，结尾是标志（flag）。</li>
</ul>
<h4 id="9-2-1-if语句"><a href="#9-2-1-if语句" class="headerlink" title="9.2.1 if语句"></a>9.2.1 if语句</h4><p><strong>应用环境</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server块，location块</span><br></pre></td></tr></table></figure>

<p><strong>语法：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (condition) &#123; … &#125;</span><br><span class="line"><span class="keyword">if</span> 可以支持如下条件判断匹配符号</span><br><span class="line">~ 					正则匹配 (区分大小写)    </span><br><span class="line">~* 				    正则匹配 (不区分大小写)</span><br><span class="line">!~                  正则不匹配 (区分大小写)</span><br><span class="line">!~*		            正则不匹配  (不区分大小写)</span><br><span class="line">-f 和!-f 		    用来判断是否存在文件</span><br><span class="line">-d 和!-d 		    用来判断是否存在目录</span><br><span class="line">-e 和!-e 		    用来判断是否存在文件或目录</span><br><span class="line">-x 和!-x 		    用来判断文件是否可执行</span><br><span class="line"></span><br><span class="line">在匹配过程中可以引用一些Nginx的全局变量</span><br><span class="line"><span class="variable">$args</span>				请求中的参数;</span><br><span class="line"><span class="variable">$document_root</span>	    针对当前请求的根路径设置值;</span><br><span class="line"><span class="variable">$host</span>				请求信息中的<span class="string">"Host"</span>，如果请求中没有Host行，则等于设置的服务器名;</span><br><span class="line"><span class="variable">$limit_rate</span>			对连接速率的限制;</span><br><span class="line"><span class="variable">$request_method</span>		请求的方法，比如<span class="string">"GET"</span>、<span class="string">"POST"</span>等;</span><br><span class="line"><span class="variable">$remote_addr</span>		客户端地址;</span><br><span class="line"><span class="variable">$remote_port</span>		客户端端口号;</span><br><span class="line"><span class="variable">$remote_user</span>		客户端用户名，认证用;</span><br><span class="line"><span class="variable">$request_filename</span>   当前请求的文件路径名（带网站的主目录/usr/<span class="built_in">local</span>/nginx/html/images /a.jpg）</span><br><span class="line"><span class="variable">$request_uri</span>		当前请求的文件路径名（不带网站的主目录/images/a.jpg）</span><br><span class="line"><span class="variable">$query_string</span>		与<span class="variable">$args</span>相同;</span><br><span class="line"><span class="variable">$scheme</span>				用的协议，比如http或者是https</span><br><span class="line"><span class="variable">$server_protocol</span>	请求的协议版本，<span class="string">"HTTP/1.0"</span>或<span class="string">"HTTP/1.1"</span>;</span><br><span class="line"><span class="variable">$server_addr</span> 		服务器地址，如果没有用listen指明服务器地址，使用这个变量将发起一次系统调用以取得地址(造成资源浪费);</span><br><span class="line"><span class="variable">$server_name</span>		请求到达的服务器名;</span><br><span class="line"><span class="variable">$document_uri</span> 		与<span class="variable">$uri</span>一样，URI地址;</span><br><span class="line"><span class="variable">$server_port</span> 		请求到达的服务器端口号;</span><br></pre></td></tr></table></figure>

<h4 id="9-2-2-Rewrite-flag标记位"><a href="#9-2-2-Rewrite-flag标记位" class="headerlink" title="9.2.2 Rewrite flag标记位"></a>9.2.2 Rewrite flag标记位</h4><p>Nginx的rewrite指令支持多种flag，用于控制重写规则的行为。以下是一些常用的flag：</p>
<ol>
<li><strong>last</strong>：表示完成当前的重写规则后，停止处理后续的重写规则,从头再匹配。</li>
<li><strong>break</strong>：表示完全停止处理后续的重写规则。</li>
<li><strong>redirect</strong>：表示将请求重定向到新的URI，并返回HTTP状态码为302。</li>
<li><strong>permanent</strong>：表示将请求永久重定向到新的URI，并返回HTTP状态码为301。</li>
</ol>
<p>这些flag可以根据需要组合使用，以实现不同的URL重写和重定向行为。例如，<code>rewrite ^/old-url/(.*)$ /new-url/$1 permanent;</code>中的<code>permanent</code> flag表示将请求永久重定向到新的URI，并返回HTTP状态码为301。</p>
<p><strong>last和break区别</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/nginx/conf.d/last_break.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    location /<span class="built_in">break</span>/ &#123;</span><br><span class="line">        root /usr/share/nginx/html;</span><br><span class="line">        rewrite .* /<span class="built_in">test</span>/break.html <span class="built_in">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /last/ &#123;</span><br><span class="line">        root /usr/share/nginx/html;</span><br><span class="line">        rewrite .* /<span class="built_in">test</span>/last.html last;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /<span class="built_in">test</span>/ &#123;</span><br><span class="line">        root /usr/share/nginx/html;</span><br><span class="line">        rewrite .* /<span class="built_in">test</span>/test.html <span class="built_in">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@localhost conf.d]<span class="comment"># cd /usr/share/nginx/html/</span></span><br><span class="line">[root@localhost html]<span class="comment"># mkdir test</span></span><br><span class="line">[root@localhost html]<span class="comment"># echo "last" &gt; test/last.html</span></span><br><span class="line">[root@localhost html]<span class="comment"># echo "break" &gt; test/break.html</span></span><br><span class="line">[root@localhost html]<span class="comment"># echo "test" &gt; test/test.html</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>last 标记在本条 rewrite 规则执行完后，会对其所在的 server { … } 标签重新发起请求;</code></p>
</li>
<li><p><code>break 标记则在本条规则匹配完成后，停止匹配，不再做后续的匹配；</code></p>
</li>
</ul>
<p><strong>redirect 和 permanent区别</strong></p>
<p>则是返回的不同方式的重定向，对于客户端来说一般状态下是没有区别的。而对于搜索引擎，相对来说301的重定向更加友好，如果我们把一个地址采用301跳转方式跳转的话，搜索引擎会把老地址的相关信息带到新地址，同时在搜索引擎索引库中彻底废弃掉原先的老地址。使用302重定向时，搜索引擎(特别是google)有时会查看跳转前后哪个网址更直观，然后决定显示哪个，如果它觉的跳转前的URL更好的话，也许地址栏不会更改。</p>
<h4 id="9-2-3-Rewrite-常见案例"><a href="#9-2-3-Rewrite-常见案例" class="headerlink" title="9.2.3 Rewrite 常见案例"></a>9.2.3 Rewrite 常见案例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">192.168.174.20 rewrite.tanke.love</span><br><span class="line"><span class="comment"># 举例一：</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/nginx/conf.d/rewrite_server.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  rewrite.tanke.love;</span><br><span class="line">        location /a &#123;</span><br><span class="line">        root /html;</span><br><span class="line">        index   index.html index.htm;</span><br><span class="line">        rewrite .* /b/index.html permanent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /b &#123;</span><br><span class="line">        root    /html;</span><br><span class="line">        index   index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 创建网站资源路径</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mkdir -p /html/&#123;a,b&#125;</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "a" &gt; /html/a/index.html</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "b" &gt; /html/b/index.html</span></span><br><span class="line"><span class="comment"># 检查配置文件语法是否错误,热加载nginx</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nginx -t</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 游览器访问http://rewrite.tanke.love/a</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>上述案例使用游览器访问<a href="http://rewrite.tanke.love/a后会永久重定向至http://rewrite.tanke.love/b/index.html" target="_blank" rel="noopener">http://rewrite.tanke.love/a后会永久重定向至http://rewrite.tanke.love/b/index.html</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">192.168.174.20 rewrite.tanke.love</span><br><span class="line"><span class="comment"># 举例二：</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/nginx/conf.d/rewrite02_server.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  rewrite.tanke.love;</span><br><span class="line"></span><br><span class="line">    location /2023/a &#123;</span><br><span class="line">        root    /var/www/html;</span><br><span class="line">        index   index.html;</span><br><span class="line">        rewrite ^/2023/(.*)$ /2024/<span class="variable">$1</span> permanent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /2024/a &#123;</span><br><span class="line">        root    /var/www/html;</span><br><span class="line">        index   index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 准备网站资源目录</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mkdir -p /var/www/html/&#123;2023,2024&#125;/a</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "2023" &gt; /var/www/html/2023/a/index.html</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "2024" &gt; /var/www/html/2024/a/index.html</span></span><br><span class="line">[root@localhost ~]<span class="comment"># tree /var/www/</span></span><br><span class="line">/var/www/</span><br><span class="line">└── html</span><br><span class="line">    ├── 2023</span><br><span class="line">    │   └── a</span><br><span class="line">    │       └── index.html</span><br><span class="line">    └── 2024</span><br><span class="line">        └── a</span><br><span class="line">            └── index.html</span><br><span class="line"><span class="comment"># 检查配置文件语法是否错误,热加载nginx</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nginx -t</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload nginx </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 游览器访问http://rewrite.tanke.love/2023/a</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>上述案例：当用户游览器访问<a href="http://rewrite.tanke.love/2023/a时，将永久重定向至http://rewrite.tanke.love/2024/a/index.html" target="_blank" rel="noopener">http://rewrite.tanke.love/2023/a时，将永久重定向至http://rewrite.tanke.love/2024/a/index.html</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">192.168.174.20 rewrite.tanke.love</span><br><span class="line"><span class="comment"># 举例三：</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim rewrite03_server.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen    80;</span><br><span class="line">  server_name rewrite.tanke.love;</span><br><span class="line">  location / &#123;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="variable">$host</span> ~* rewrite.tanke.love ) &#123;</span><br><span class="line">        rewrite .* http://baidu.com permanent;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># nginx -t</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload nginx </span></span><br><span class="line"><span class="comment"># 游览器访问http://rewrite.tanke.love</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>上述案例：当用户访问<a href="http://rewrite.tanke.love/是永久重定向至http://baidu.com" target="_blank" rel="noopener">http://rewrite.tanke.love/是永久重定向至http://baidu.com</a></p>
<p><code>$host</code>为客户端访问的域名。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">192.168.174.20 rewrite.tanke.love</span><br><span class="line"><span class="comment"># 举例四：</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim rewrite04_server.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen    80;</span><br><span class="line">  server_name rewrite.tanke.love;</span><br><span class="line">  location /a &#123;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="variable">$host</span> ~* rewrite.tanke.love ) &#123;</span><br><span class="line">        rewrite .* http://192.168.21<span class="variable">$request_uri</span> permanent;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重定向主机配置文件准备</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/nginx/conf.d/default.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">  listen   80;</span><br><span class="line">  server_name   localhost;</span><br><span class="line">  location /a &#123;</span><br><span class="line">    root /usr/share/nginx/;</span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@localhost ~]<span class="comment"># mkdir /usr/share/nginx/a</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "192.168.172.21" &gt; /usr/share/nginx/a/index.html</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># nginx -t</span></span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload nginx</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>上述案例：当用户访问<a href="http://rewrite.tanke.love/a是永久重定向至http://192.168.174.21/a" target="_blank" rel="noopener">http://rewrite.tanke.love/a是永久重定向至http://192.168.174.21/a</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">192.168.174.20 rewrite.tanke.love</span><br><span class="line"></span><br><span class="line"><span class="comment">#  http://rewrite.tanke.love/login/qf.html ==&gt;  http://rewrite.tanke.love/reg/login.html?user=qf</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/nginx/conf.d/rewrite06_server.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen    80;</span><br><span class="line">   server_name   rewrite.tanke.love;</span><br><span class="line"></span><br><span class="line">   location /login &#123;</span><br><span class="line">       root   /usr/share/nginx/html;</span><br><span class="line">       rewrite ^/login/(.*)\.html$ http://<span class="variable">$host</span>/reg/login.html?user=<span class="variable">$1</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   location /reg &#123;</span><br><span class="line">       root /usr/share/nginx/html;</span><br><span class="line">       index login.html;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@localhost ~]<span class="comment"># mkdir -p /usr/share/nginx/html/reg</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "login" &gt; /usr/share/nginx/html/reg/login.html</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nginx -t</span></span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload nginx</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>定义了两个路径：/login和/reg。</p>
<p>对于/login路径，它设置了根目录为”/usr/share/nginx/html”。它还使用了一个正则表达式重写规则，将URL中的”/login/“后面的内容作为参数传递给”/reg/login.html”页面，并附加在URL中作为查询参数”user”的值。</p>
<p>对于/reg路径，它同样设置了根目录为”/usr/share/nginx/html”，并将默认索引文件设置为”login.html”。</p>
<p>这段配置的作用是将访问/login路径的请求重定向到/reg路径下的”login.html”页面，并将原始路径中的参数传递给该页面。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">192.168.174.20 rewrite.tanke.love</span><br><span class="line"><span class="comment"># 举例7</span></span><br><span class="line"><span class="comment"># http://rewrite.tanke.love/qf/11-22-33/1.html  ==&gt;  http://rewrite.tanke.love/qf/11/22/33/1.html</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/nginx/conf.d/rewrite07_server.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">  listen   80;</span><br><span class="line">  server_name rewrite.tanke.love;</span><br><span class="line">       location /qf &#123;</span><br><span class="line">            rewrite ^/qf/([0-9]+)-([0-9]+)-([0-9]+)(.*)$ /qf/<span class="variable">$1</span>/<span class="variable">$2</span>/<span class="variable">$3</span><span class="variable">$4</span> permanent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /qf/11/22/33 &#123;</span><br><span class="line">                root /html;</span><br><span class="line">                index   1.html;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line"><span class="comment"># 资源文件配置</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mdkir  -p /html/qf/11/22/33/</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "qf" &gt; /html/qf/11/22/33/1.html </span></span><br><span class="line">[root@localhost ~]<span class="comment"># nginx -t</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload nginx</span></span><br><span class="line"><span class="comment"># 游览器访问</span></span><br><span class="line">http://rewrite.tanke.love/qf/11-22-33/1.html</span><br></pre></td></tr></table></figure>

<blockquote>
<p>定义了两个路径：/qf和/qf/11/22/33。</p>
<p>对于/qf路径，它使用了一个正则表达式重写规则，将URL中的”/qf/“后面的内容按照数字进行分组，并将这些数字作为参数传递给新的URL路径。新的URL路径为”/qf/11/22/33”，其中<code>$1、$2、$3</code>分别代表第一组、第二组和第三组的数字，<code>$4</code>表示剩余的字符串。这个重写规则使用了”permanent”标志，表示返回301永久重定向。</p>
<p>对于/qf/11/22/33路径，它设置了根目录为”/html”，并将默认索引文件设置为”1.html”。</p>
<p>这段配置的作用是将访问/qf路径的请求重定向到/qf/11/22/33路径下的”1.html”页面，并根据原始路径中的参数进行URL的重新组织。</p>
</blockquote>
<h4 id="9-2-4-set指令使用"><a href="#9-2-4-set指令使用" class="headerlink" title="9.2.4 set指令使用"></a>9.2.4 set指令使用</h4><p>​    set 指令是用于定义一个变量，并且赋值</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server,location,if</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\System32\drivers\etc\hosts <span class="comment"># win域名解析</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#http://liubei.tanke.love ==&gt; http://rewrite.tanke.love/liubei</span></span><br><span class="line"><span class="comment">#http://guanyu.tanke.love ==&gt; http://rewrite.tanke.love/guanyu</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># mkdir -p /usr/share/nginx/html/&#123;liubei,guanyu&#125;</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "liubei.." &gt; /usr/share/nginx/html/liubei/index.html</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "guanyu.." &gt; /usr/share/nginx/html/guanyu/index.html</span></span><br><span class="line"></span><br><span class="line">编辑配置文件:</span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/nginx/conf.d/set_server.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  rewrite.tanke.love;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">         root   /usr/share/nginx/html;</span><br><span class="line">         index  index.html index.htm;</span><br><span class="line">         <span class="keyword">if</span> ( <span class="variable">$host</span> ~* <span class="string">"^rewrite.tanke.love$"</span> ) &#123;</span><br><span class="line">                <span class="built_in">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> ( <span class="variable">$host</span> ~* <span class="string">"^(.*)\.tanke\.love$"</span> ) &#123;</span><br><span class="line">                <span class="built_in">set</span> <span class="variable">$user</span> <span class="variable">$1</span>;</span><br><span class="line">                rewrite .* http://rewrite.tanke.love/<span class="variable">$user</span> permanent;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    location /liubei &#123;</span><br><span class="line">         root /usr/share/nginx/html;</span><br><span class="line">         index  index.html index.hml;</span><br><span class="line">        &#125;</span><br><span class="line">    location /guanyu &#123;</span><br><span class="line">         root /usr/share/nginx/html;</span><br><span class="line">         index index.html index.hml;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># nginx -t</span></span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload nginx</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>该配置文件定义了一个监听在端口 80 上的服务器，并指定了服务器名称为 “rewrite.tanke.love”。它包含三个 <code>location</code> 块，分别对应不同的路径：</p>
<ul>
<li><code>/</code>：根路径，将请求映射到 <code>/usr/share/nginx/html</code> 目录下的 <code>index.html</code> 或 <code>index.htm</code> 文件。如果请求的主机名是 “rewrite.tanke.love”，则直接返回该文件；否则，如果主机名匹配正则表达式 <code>^(.*)\.tanke\.love$</code>，则将主机名中的第一个部分作为变量 <code>$user</code> 的值，并将请求重定向到 <code>http://rewrite.tanke.love/$user</code>，使用永久重定向（301）。</li>
<li><code>/liubei</code>：将请求映射到 <code>/usr/share/nginx/html</code> 目录下的 <code>index.html</code> 或 <code>index.hml</code> 文件。</li>
<li><code>/guanyu</code>：将请求映射到 <code>/usr/share/nginx/html</code> 目录下的 <code>index.html</code> 或 <code>index.hml</code> 文件。</li>
</ul>
<p>这个配置文件的作用是根据请求的主机名和路径来处理请求，并根据需要进行重定向。</p>
</blockquote>
<h4 id="9-2-5-return指令使用"><a href="#9-2-5-return指令使用" class="headerlink" title="9.2.5 return指令使用"></a>9.2.5 return指令使用</h4><p>​    return 指令用于返回状态码给客户端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 作用域</span></span><br><span class="line">server,location,<span class="keyword">if</span></span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果访问的.sh结尾的文件则返回403操作拒绝错误</span></span><br><span class="line"><span class="comment"># http://rewrite.tanke.love/1.sh   返回403</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/nginx/conf.d/return_server.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  rewrite.tanke.love;</span><br><span class="line">    <span class="comment">#access_log  /var/log/nginx/http_access.log  main;</span></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    location ~* \.sh$ &#123;</span><br><span class="line">        <span class="built_in">return</span> 403;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@localhost ~]<span class="comment"># nginx -t</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl reload nginx</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>定义了一个监听在端口 80 上的服务器，并指定了服务器名称为 “rewrite.tanke.love”。它包含两个 <code>location</code> 块，分别对应不同的路径：</p>
<ul>
<li><code>/</code>：根路径，将请求映射到 <code>/usr/share/nginx/html</code> 目录下的 <code>index.html</code> 或 <code>index.htm</code> 文件。</li>
<li><code>~* \.sh$</code>：匹配以 <code>.sh</code> 结尾的文件名，返回 HTTP 状态码 403（禁止访问）。</li>
</ul>
<p>这个配置文件的作用是处理请求，并根据请求的文件类型进行相应的操作。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https重定向</span></span><br><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  *.vip9999.top vip9999.top;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$host</span> ~* <span class="string">"^www.vip9999.top$|^vip9999.top$"</span> ) &#123;</span><br><span class="line">                <span class="built_in">return</span> 301 https://www.vip9999.top<span class="variable">$request_uri</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$host</span> ~* <span class="string">"^(.*).vip9999.top$"</span> ) &#123;</span><br><span class="line">                <span class="built_in">set</span> <span class="variable">$user</span> <span class="variable">$1</span>;</span><br><span class="line">                <span class="built_in">return</span> 301 https://www.vip9999.top/<span class="variable">$user</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Settings for a TLS enabled server.</span></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       443 ssl;</span><br><span class="line">        server_name  www.vip9999.top;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">                root      /usr/share/nginx/html;</span><br><span class="line">                index     index.php index.html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">            root           /usr/share/nginx/html;</span><br><span class="line">            fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">            fastcgi_index  index.php;</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">            include        fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">        ssl on;</span><br><span class="line">        ssl_certificate cert/214025315060640.pem;</span><br><span class="line">        ssl_certificate_key cert/214025315060640.key;</span><br><span class="line">        ssl_session_cache shared:SSL:1m;</span><br><span class="line">        ssl_session_timeout  10m;</span><br><span class="line">        ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">        ssl_prefer_server_ciphers on;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="10、Nginx-Location-指令详解"><a href="#10、Nginx-Location-指令详解" class="headerlink" title="10、Nginx Location 指令详解"></a>10、Nginx Location 指令详解</h2><p>​    Nginx 的 HTTP 配置主要包括三个区块，结构如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">http &#123; 						<span class="comment"># 这个是协议级别</span></span><br><span class="line">　　include mime.types;</span><br><span class="line">　　default_type application/octet-stream;</span><br><span class="line">　　keepalive_timeout 65;</span><br><span class="line">　　gzip on;</span><br><span class="line">　　　　server &#123;			 <span class="comment"># 这个是服务级别</span></span><br><span class="line">　　　　　　listen 80;</span><br><span class="line">　　　　　　server_name localhost;</span><br><span class="line">　　　　　　　　location / &#123;  <span class="comment"># 这个是请求级别</span></span><br><span class="line">　　　　　　　　　　root html;</span><br><span class="line">　　　　　　　　　　index index.html index.htm;</span><br><span class="line">　　　　　　　　&#125;</span><br><span class="line">　　　　　　&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>协议级别</code>：这部分配置指定了使用的协议为HTTP，并包含了一个名为mime.types的文件，用于定义文件扩展名与MIME类型的映射关系。</li>
<li><code>服务级别</code>：这部分配置指定了监听的端口号为80，服务器名称为localhost。<code>虚拟主机</code>。</li>
<li><code>请求级别</code>：这部分配置指定了根目录为html，默认的索引文件为index.html和index.htm。</li>
</ol>
<h3 id="10-1-Location-区块"><a href="#10-1-Location-区块" class="headerlink" title="10.1 Location 区块"></a>10.1 Location 区块</h3><ul>
<li>location 是在 <code>server</code> 块中配置，根据<code>不同的 URl</code>使用不同的配置，来处理<code>不同的请求</code>。</li>
<li>location 是<code>有顺序</code>的，会被<code>第一个匹配</code>的location 处理。</li>
</ul>
<p>基本语法如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location [=|~|~*|^~|@] pattern&#123;……&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-2-location-前缀含义"><a href="#10-2-location-前缀含义" class="headerlink" title="10.2 location 前缀含义"></a>10.2 location 前缀含义</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">=    表示精确匹配，优先级也是最高的,只有请求的 URI 与指定的字符串完全相等时才会匹配。</span><br><span class="line">^~   表示如果该模式匹配成功，将停止搜索其他匹配项并立即处理该请求。</span><br><span class="line">~    表示区分大小写的正则匹配  </span><br><span class="line">~*   表示不区分大小写的正则匹配</span><br><span class="line">!~   表示区分大小写不匹配的正则</span><br><span class="line">!~*  表示不区分大小写不匹配的正则</span><br><span class="line">/    通用匹配，任何请求都会匹配到</span><br></pre></td></tr></table></figure>

<h4 id="10-2-1-location-配置示例"><a href="#10-2-1-location-配置示例" class="headerlink" title="10.2.1 location 配置示例"></a>10.2.1 location 配置示例</h4><ol>
<li>没有修饰符 <code>/</code>表示：必须以指定模式开始</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mkdir -p /home/www/nginx/abc</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "2.html" &gt;  /home/www/nginx/abc/2.html</span></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  www.tanke.love;</span><br><span class="line"></span><br><span class="line">    location  /abc &#123;</span><br><span class="line">        root    /home/www/nginx;</span><br><span class="line">        index   2.html;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">那么，如下是对的：</span><br><span class="line">http://www.tanke.love/abc</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><code>=</code>表示：必须与指定的模式精确匹配</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># echo "a" &gt; /usr/share/nginx/html/a.html</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "b" &gt; /usr/share/nginx/html/b.html</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  www.tanke.love;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /usr/share/nginx/html;</span><br><span class="line">        index a.html;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location = / &#123;</span><br><span class="line">        root /usr/share/nginx/html;</span><br><span class="line">        index b.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">进行测试：</span><br><span class="line">http://www.tanke.love</span><br><span class="line">http://www.tanke.love/a.html</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><code>~</code> 表示：指定的正则表达式要区分大小写</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mkdir -p /home/www/nginx/&#123;abc,ABC&#125;</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "abc" &gt; /home/www/nginx/abc/2.html </span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo "ABC" &gt; /home/www/nginx/ABC/2.html </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        server_name www.tanke.love;</span><br><span class="line">        location ~ /abc &#123;</span><br><span class="line">                root /home/www/nginx;</span><br><span class="line">                index 2.html index.html;</span><br><span class="line">        &#125;</span><br><span class="line">        location ~ /ABC &#123;</span><br><span class="line">                root /home/www/nginx;</span><br><span class="line">                index 2.html index.html;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">那么：</span><br><span class="line">http://www.tanke.love/abc/</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><code>~*</code> 表示：指定的正则表达式不区分大小写</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        server_name www.tanke.love;</span><br><span class="line">        location ~* /abc &#123;</span><br><span class="line">                root /home/www/nginx;</span><br><span class="line">                index 2.html index.html;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">那么：</span><br><span class="line">http://www.tanke.love/ABC/</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><code>^~</code> ：类似于无修饰符的行为，也是以指定模式开始，不同的是，如果模式匹配，那么就停止搜索其他模式了。</li>
</ol>
<h4 id="10-2-2-location-查找顺序、优先级"><a href="#10-2-2-location-查找顺序、优先级" class="headerlink" title="10.2.2 location 查找顺序、优先级"></a>10.2.2 location 查找顺序、优先级</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">= 大于 ^~  大于 ~|~*|!~|!~* 大于 /</span><br><span class="line">多个location配置的情况下匹配顺序为：首先匹配 =，其次匹配^~, 其次是按正则匹配，最后是交给 / 通用匹配。当有匹配成功时候，停止匹配，按当前匹配规则处理请求。</span><br><span class="line">================================================</span><br><span class="line">(1) =:表示完全匹配;</span><br><span class="line">(2) ^~:匹配URI的前缀，如果一个URI同时满足两个规则的话，匹配最长的规则;</span><br><span class="line">(3) ~:匹配正则表达式，大小写敏感；</span><br><span class="line">(4) ~*:匹配正则表达式，大小写不敏感；</span><br><span class="line">优先级：（1）&gt; (2) &gt; (3) = (4)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">location 区段匹配示例</span><br><span class="line"></span><br><span class="line">location = / &#123;</span><br><span class="line">　　<span class="comment"># 只匹配 / 的查询.</span></span><br><span class="line">　　[ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">location / &#123;</span><br><span class="line">　　<span class="comment"># 匹配任何以 / 开始的查询，但是正则表达式与一些较长的字符串将被首先匹配。</span></span><br><span class="line">　　[ configuration B ]</span><br><span class="line">&#125;</span><br><span class="line">location ^~ /images/ &#123;</span><br><span class="line">　　<span class="comment"># 匹配任何以 /images/ 开始的查询并且停止搜索，不检查正则表达式。</span></span><br><span class="line">　　[ configuration C ]</span><br><span class="line">&#125;</span><br><span class="line">location ~* \.(gif|jpg|jpeg)$ &#123;</span><br><span class="line">　　<span class="comment"># 匹配任何以gif, jpg, or jpeg结尾的文件，但是所有 /images/ 目录的请求将在Configuration C中处理。</span></span><br><span class="line">　　[ configuration D ]</span><br><span class="line">&#125; </span><br><span class="line">各请求的处理如下例：</span><br><span class="line">	/ → configuration A</span><br><span class="line">	/documents/document.html → configuration B</span><br><span class="line">	/images/1.gif → configuration C</span><br><span class="line">	/documents/1.jpg → configuration D</span><br></pre></td></tr></table></figure>

<h4 id="10-2-3-root-和alias-指令区别"><a href="#10-2-3-root-和alias-指令区别" class="headerlink" title="10.2.3  root 和alias 指令区别"></a>10.2.3  root 和alias 指令区别</h4><p>在 Nginx 配置中，<code>location</code> 指令用于定义如何处理不同的 URL 请求。其中 <code>root</code> 和 <code>alias</code> 是两个常用的指令，它们的含义如下：</p>
<ol>
<li><strong>root</strong>：<code>root</code> 指令用于指定请求的根目录。当客户端发起请求时，Nginx 会将请求的 URI 与指定的根目录进行拼接，以确定实际的文件路径。例如，如果 <code>root</code> 设置为 <code>/var/www/html</code>，而客户端请求的是 <code>/index.html</code>，那么 Nginx 将会查找文件 <code>/var/www/html/index.html</code>。</li>
<li><strong>alias</strong>：<code>alias</code> 指令用于指定请求的别名目录。与 <code>root</code> 不同，<code>alias</code> 不会将请求的 URI 与指定的目录进行拼接，而是直接使用指定的目录作为请求的根目录。例如，如果 <code>alias</code> 设置为 <code>/var/www/images</code>，而客户端请求的是 <code>/index.jpg</code>，那么 Nginx 将会查找文件 <code>/var/www/images/index.jpg</code>。</li>
</ol>
<p>需要注意的是，<code>root</code> 和 <code>alias</code> 只能选择其中一个来使用，不能同时使用。通常情况下，建议使用 <code>root</code> 指令来指定请求的根目录，因为它更加直观和简单。</p>
<p>举例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name rewrite.tanke.love;</span><br><span class="line">  location /img &#123;</span><br><span class="line">    <span class="comment"># root /var/www/image;</span></span><br><span class="line">    <span class="comment">#若按照这种配置的话，则访问/img/目录下的文件时，nginx会去/var/www/image/img/目录下找文件</span></span><br><span class="line">    <span class="built_in">alias</span> /var/www/image;</span><br><span class="line">    <span class="comment">#若按照上述配置的话，则访问/img/目录里面的文件时，nginx会自动去/var/www/image/目录找文件</span></span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">访问rewrite.tanke.love/img测试</span><br></pre></td></tr></table></figure>

<ul>
<li><code>alias</code> 是一个目录别名的定义;</li>
<li><code>root</code> 则是最上层目录的定义。</li>
<li>还有一个重要的区别是alias后面必须要用“/”结束，否则会找不到文件的,而root则可有可无。</li>
</ul>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">L66</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://l66stbz.github.io/2024/08/09/nginx%E8%AF%A6%E8%A7%A3+%E5%AE%9E%E6%93%8D_01/">https://l66stbz.github.io/2024/08/09/nginx%E8%AF%A6%E8%A7%A3+%E5%AE%9E%E6%93%8D_01/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://l66stbz.github.io" target="_blank">L66</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/Nginx/">Nginx</a></div><div class="post_share"><div class="social-share" data-image="https://l66stbz.github.io/2024/08/16/RabbitMQ消息队列/1.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2024/08/09/nginx%E8%AF%A6%E8%A7%A3+%E5%AE%9E%E6%93%8D_02/"><img class="prev_cover" src="https://l66stbz.github.io/2024/08/09/nginx详解+实操_02/1.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">nginx详解+实操_02</div></div></a></div><div class="next-post pull_right"><a href="/2024/08/08/Tomcat%E8%BF%90%E7%BB%B4%E5%AE%9E%E6%88%98/"><img class="next_cover" src="https://l66stbz.github.io/2024/08/08/Tomcat运维实战/1.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Tomcat运维实战</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2024/05/18/Zabbix监控Nginx指标/" title="Zabbix监控Nginx指标"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/05/18/Zabbix监控Nginx指标/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-05-18</div><div class="relatedPosts_title">Zabbix监控Nginx指标</div></div></a></div><div class="relatedPosts_item"><a href="/2024/07/05/WEB服务器/" title="WEB服务器"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/07/05/WEB服务器/4.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-07-05</div><div class="relatedPosts_title">WEB服务器</div></div></a></div><div class="relatedPosts_item"><a href="/2024/08/10/nginx详解+实操_04/" title="nginx详解+实操_04"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/08/10/nginx详解+实操_04/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-08-10</div><div class="relatedPosts_title">nginx详解+实操_04</div></div></a></div><div class="relatedPosts_item"><a href="/2024/08/10/nginx详解+实操_03/" title="nginx详解+实操_03"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/08/10/nginx详解+实操_03/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-08-10</div><div class="relatedPosts_title">nginx详解+实操_03</div></div></a></div><div class="relatedPosts_item"><a href="/2024/08/09/nginx详解+实操_02/" title="nginx详解+实操_02"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/08/09/nginx详解+实操_02/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-08-09</div><div class="relatedPosts_title">nginx详解+实操_02</div></div></a></div><div class="relatedPosts_item"><a href="/2024/05/24/自动化脚本/" title="自动化脚本"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/05/24/自动化脚本/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-05-24</div><div class="relatedPosts_title">自动化脚本</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By L66</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/js/third-party/click_heart.js"></script></body></html>