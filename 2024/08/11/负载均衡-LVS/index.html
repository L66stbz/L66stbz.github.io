<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>负载均衡-LVS | L66</title><meta name="description" content="负载均衡集群[TOC] 1、集群是什么？ 集群（cluster）技术可以在付出较低成本的情况下获得在性能、可靠性、灵活性方面的相对较高的收益，其任务调度则是集群系统中的核心技术。 集群组成后，可以利用多个计算机和组合进行海量请求处理（负载均衡），从而获得很高的处理效率，也可以用多个计算机做备份（高可用HA），使得任何一个机器坏了整个系统还是能正常运行。  2、负载均衡集群技术 负载均衡（Load"><meta name="keywords" content="Linux,LVS"><meta name="author" content="L66"><meta name="copyright" content="L66"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/3.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="负载均衡-LVS"><meta name="twitter:description" content="负载均衡集群[TOC] 1、集群是什么？ 集群（cluster）技术可以在付出较低成本的情况下获得在性能、可靠性、灵活性方面的相对较高的收益，其任务调度则是集群系统中的核心技术。 集群组成后，可以利用多个计算机和组合进行海量请求处理（负载均衡），从而获得很高的处理效率，也可以用多个计算机做备份（高可用HA），使得任何一个机器坏了整个系统还是能正常运行。  2、负载均衡集群技术 负载均衡（Load"><meta name="twitter:image" content="https://l66stbz.github.io/2024/08/11/负载均衡-LVS/1.png"><meta property="og:type" content="article"><meta property="og:title" content="负载均衡-LVS"><meta property="og:url" content="https://l66stbz.github.io/2024/08/11/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-LVS/"><meta property="og:site_name" content="L66"><meta property="og:description" content="负载均衡集群[TOC] 1、集群是什么？ 集群（cluster）技术可以在付出较低成本的情况下获得在性能、可靠性、灵活性方面的相对较高的收益，其任务调度则是集群系统中的核心技术。 集群组成后，可以利用多个计算机和组合进行海量请求处理（负载均衡），从而获得很高的处理效率，也可以用多个计算机做备份（高可用HA），使得任何一个机器坏了整个系统还是能正常运行。  2、负载均衡集群技术 负载均衡（Load"><meta property="og:image" content="https://l66stbz.github.io/2024/08/11/负载均衡-LVS/1.png"><meta property="article:published_time" content="2024-08-11T13:50:00.000Z"><meta property="article:modified_time" content="2024-08-17T07:14:40.475Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://l66stbz.github.io/2024/08/11/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-LVS/"><link rel="prev" title="负载均衡+keepalived" href="https://l66stbz.github.io/2024/08/12/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1+keepalived/"><link rel="next" title="nginx详解+实操_04" href="https://l66stbz.github.io/2024/08/10/nginx%E8%AF%A6%E8%A7%A3+%E5%AE%9E%E6%93%8D_04/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="APlayer.min.css"><div id="aplayer"></div><script src="https://cdn.jsdelivr.net/gh/radium-bit/res@master/live2d/autoload.js" async></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js" async></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="L66" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/2.jpg" onerror="onerror=null;src='/img/2.jpg'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">54</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">35</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Photo</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#负载均衡集群"><span class="toc-number">1.</span> <span class="toc-text">负载均衡集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1、集群是什么？"><span class="toc-number">2.</span> <span class="toc-text">1、集群是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、负载均衡集群技术"><span class="toc-number">3.</span> <span class="toc-text">2、负载均衡集群技术</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、负载均衡集群技术的实现"><span class="toc-number">4.</span> <span class="toc-text">3、负载均衡集群技术的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、实现效果如图"><span class="toc-number">5.</span> <span class="toc-text">4、实现效果如图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、负载均衡分类"><span class="toc-number">6.</span> <span class="toc-text">5、负载均衡分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6、四层负载均衡（基于IP-端口的负载均衡）"><span class="toc-number">7.</span> <span class="toc-text">6、四层负载均衡（基于IP+端口的负载均衡）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7、七层的负载均衡（基于虚拟的URL或主机IP的负载均衡"><span class="toc-number">8.</span> <span class="toc-text">7、七层的负载均衡（基于虚拟的URL或主机IP的负载均衡)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8、四层负载与七层负载的区别（面试题）"><span class="toc-number">9.</span> <span class="toc-text">8、四层负载与七层负载的区别（面试题）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9、LVS-实现四层负载均衡项目实战"><span class="toc-number">10.</span> <span class="toc-text">9、LVS 实现四层负载均衡项目实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、LVS-介绍"><span class="toc-number">10.1.</span> <span class="toc-text">1、LVS 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、LVS-不足之处"><span class="toc-number">10.2.</span> <span class="toc-text">2、LVS 不足之处</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、LVS-核心组件和专业术语"><span class="toc-number">10.3.</span> <span class="toc-text">3、LVS 核心组件和专业术语</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1、核心组件"><span class="toc-number">10.3.1.</span> <span class="toc-text">1、核心组件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2、专业术语"><span class="toc-number">10.3.2.</span> <span class="toc-text">2、专业术语</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3、具体图解"><span class="toc-number">10.3.3.</span> <span class="toc-text">3、具体图解</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5、LVS负载均衡四种工作模式"><span class="toc-number">10.4.</span> <span class="toc-text">5、LVS负载均衡四种工作模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5、四者的区别"><span class="toc-number">10.4.1.</span> <span class="toc-text">5、四者的区别</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6、LVS-ipvsadm-命令的使用"><span class="toc-number">10.5.</span> <span class="toc-text">6、LVS ipvsadm 命令的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1、LVS-server安装lvs管理软件"><span class="toc-number">10.5.1.</span> <span class="toc-text">1、LVS-server安装lvs管理软件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2、命令选项"><span class="toc-number">10.5.2.</span> <span class="toc-text">2、命令选项</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7、LVS-负载均衡集群企业级应用实战"><span class="toc-number">10.6.</span> <span class="toc-text">7、LVS 负载均衡集群企业级应用实战</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1、准备虚拟机"><span class="toc-number">10.6.0.1.</span> <span class="toc-text">1、准备虚拟机</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2、LVS-server-安装lvs管理软件"><span class="toc-number">10.6.0.2.</span> <span class="toc-text">2、LVS-server 安装lvs管理软件</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3、LVS-DR-模式"><span class="toc-number">10.6.1.</span> <span class="toc-text">3、LVS&#x2F;DR 模式</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2、LVS-DR模式实施-部署"><span class="toc-number">10.6.1.1.</span> <span class="toc-text">2、LVS&#x2F;DR模式实施(部署)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8、LVS-NAT模式"><span class="toc-number">10.7.</span> <span class="toc-text">8、LVS-NAT模式:</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2、LVS-NAT模式配置"><span class="toc-number">10.7.0.1.</span> <span class="toc-text">2、LVS&#x2F;NAT模式配置</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://l66stbz.github.io/2024/08/11/负载均衡-LVS/1.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">L66</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Photo</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">负载均衡-LVS</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2024-08-11 21:50:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2024-08-11</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2024-08-17 15:14:40"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2024-08-17</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h3 id="负载均衡集群"><a href="#负载均衡集群" class="headerlink" title="负载均衡集群"></a>负载均衡集群</h3><p>[TOC]</p>
<h3 id="1、集群是什么？"><a href="#1、集群是什么？" class="headerlink" title="1、集群是什么？"></a>1、集群是什么？</h3><ul>
<li>集群（cluster）技术可以在付出<code>较低成本</code>的情况下获得在性能、可靠性、灵活性方面的相对较高的收益，其任务调度则是集群系统中的核心技术。</li>
<li>集群组成后，可以利用多个计算机和组合进行海量请求处理（<strong>负载均衡</strong>），从而获得很高的处理效率，也可以用多个计算机做备份（高可用<code>HA</code>），使得任何一个机器坏了整个系统还是能正常运行。</li>
</ul>
<h3 id="2、负载均衡集群技术"><a href="#2、负载均衡集群技术" class="headerlink" title="2、负载均衡集群技术"></a>2、负载均衡集群技术</h3><ul>
<li>负载均衡（Load Balance）：负载均衡集群为企业需求提供了可解决容量问题的有效方案。负载均衡集群使负载可以在计算机集群中<code>尽可能</code>平均地分摊处理。</li>
<li>负载通常包括应用程序<code>处理负载</code>和<code>网络流量负载</code>,每个节点都可以承担一定的处理负载，并且可以实现处理负载在节点之间的动态分配，以实现负载均衡。</li>
</ul>
<h3 id="3、负载均衡集群技术的实现"><a href="#3、负载均衡集群技术的实现" class="headerlink" title="3、负载均衡集群技术的实现"></a>3、负载均衡集群技术的实现</h3><p>负载均衡（Load Balance）</p>
<p>负载均衡技术类型：基于 4 层负载均衡技术和基于 7 层负载均衡技术</p>
<p>负载均衡实现方式：硬件负载均衡设备或者软件负载均衡</p>
<p>硬件负载均衡产品：<code>F5</code></p>
<p>软件负载均衡产品： <strong>LVS</strong>（Linux Virtual Server）、 Haproxy、Nginx</p>
<h3 id="4、实现效果如图"><a href="#4、实现效果如图" class="headerlink" title="4、实现效果如图"></a>4、实现效果如图</h3><p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1562677488047.png" alt="1562677488047"></p>
<h3 id="5、负载均衡分类"><a href="#5、负载均衡分类" class="headerlink" title="5、负载均衡分类"></a>5、负载均衡分类</h3><p>负载均衡根据所采用的设备对象（<strong>软/硬件负载均衡</strong>），应用的OSI网络层次（<strong>网络层次上的负载均衡</strong>），及应用的地理结构（<strong>本地/全局负载均衡</strong>）等来分类。下面着重介绍的是根据应用的 OSI 网络层次来分类的负载均衡类型。</p>
<h3 id="6、四层负载均衡（基于IP-端口的负载均衡）"><a href="#6、四层负载均衡（基于IP-端口的负载均衡）" class="headerlink" title="6、四层负载均衡（基于IP+端口的负载均衡）"></a>6、四层负载均衡（基于IP+端口的负载均衡）</h3><p>四层负载均衡（Layer 4 Load Balancing）是指在网络通信中，负载均衡设备在网络传输的第四层（传输层，即TCP/UDP层）对数据流进行负载均衡操作。它主要通过分析传输层的源IP地址、目标IP地址、源端口、目标端口等信息来实现负载均衡，从而将网络请求分发到多台服务器上。</p>
<p><strong>四层负载均衡的特点如下：</strong></p>
<ol>
<li>基于IP+端口：四层负载均衡是基于IP地址和端口号的负载均衡，通过发布三层的IP地址（虚拟IP）再加上四层的端口号来实现。</li>
<li>处理TCP/UDP协议：四层负载均衡通常用于分发TCP和UDP协议的数据流。</li>
<li>高效转发：由于四层负载均衡工作在传输层，它可以更高效地处理网络流量，减少了应用层（七层）的复杂性。</li>
</ol>
<p>四层负载均衡的应用场景包括：</p>
<ol>
<li>TCP/UDP协议的负载均衡：对于基于TCP或UDP协议的请求，可以使用四层负载均衡来分发流量。</li>
<li>端口映射和转发：四层负载均衡可以实现端口映射和端口转发，将外部请求转发到内部服务器的指定端口。</li>
</ol>
<p>实现四层负载均衡的有：</p>
<ul>
<li>F5：硬件负载均衡器，功能很好，但是成本很高；</li>
<li>LVS：重量级的四层负载均衡软件；</li>
<li>haproxy、Nginx：模拟四层、七层转发，较灵活；</li>
</ul>
<h3 id="7、七层的负载均衡（基于虚拟的URL或主机IP的负载均衡"><a href="#7、七层的负载均衡（基于虚拟的URL或主机IP的负载均衡" class="headerlink" title="7、七层的负载均衡（基于虚拟的URL或主机IP的负载均衡)"></a>7、七层的负载均衡（基于虚拟的URL或主机IP的负载均衡)</h3><ol>
<li><p>所谓七层负载均衡，也称为“内容交换”，</p>
<ol>
<li><p><strong>七层负载均衡是指在网络通信中，负载均衡设备在网络传输的应用层（OSI模型的第七层）对数据流进行负载均衡操作</strong>。它通过对网络流量进行分析和处理，将请求分发到不同的服务器上，以实现负载均衡。</p>
<p>七层负载均衡主要基于应用层协议（如HTTP、HTTPS、SMTP等）进行智能的流量分发，从而提高服务器的性能和可靠性。它可以根据应用层协议的内容（如URL、请求头、请求体等）进行更精细的流量分发，确保将请求分发到最适合处理该请求的服务器上。</p>
<p>七层负载均衡的应用场景包括但不限于Web服务器集群、应用服务器集群。</p>
</li>
<li><p>实现七层负载均衡的软件有：</p>
<ul>
<li><p>haproxy：天生负载均衡技能，全面支持四层，七层代理，会话保持，标记，路径转移；</p>
</li>
<li><p>nginx：只在http协议和mail协议上功能比较好，性能与haproxy差不多；</p>
</li>
</ul>
</li>
</ol>
</li>
</ol>
<h3 id="8、四层负载与七层负载的区别（面试题）"><a href="#8、四层负载与七层负载的区别（面试题）" class="headerlink" title="8、四层负载与七层负载的区别（面试题）"></a>8、四层负载与七层负载的区别（面试题）</h3><p>四层负载均衡和七层负载均衡的主要区别体现在它们工作的网络层次、处理的数据内容以及应用场景上。</p>
<ol>
<li>工作的网络层次：四层负载均衡工作在OSI模型的传输层，即TCP/UDP层，主要基于IP地址和端口号进行负载均衡。而七层负载均衡则工作在OSI模型的应用层，即HTTP、HTTPS、SMTP等应用层协议层，能够基于应用层协议的内容进行更精细的流量分发。</li>
<li>处理的数据内容：四层负载均衡主要处理的是网络传输的IP地址和端口号信息，它可以通过这些信息来决定将请求转发到哪个后端服务器。而七层负载均衡则能够处理应用层协议的内容，如URL、请求头、请求体等，从而根据这些内容进行更精细的流量分发。</li>
<li>应用场景：四层负载均衡通常用于处理基于TCP或UDP协议的请求，而七层负载均衡则更适用于Web服务器集群、应用服务器集群等场景，它能够根据应用层协议的内容进行智能的流量分发，提高服务器的性能和可靠性。</li>
</ol>
<p>此外，两者在以下方面也存在一些差异：</p>
<ol>
<li>转发效率：四层负载均衡的转发效率通常比七层负载均衡高，因为它只需要处理IP地址和端口号信息，不需要解析应用层协议的内容。但是，四层负载均衡在处理复杂应用层协议时可能不如七层负载均衡灵活。</li>
<li>可扩展性：七层负载均衡由于能够处理应用层协议的内容，因此可以更容易地实现一些高级功能，如会话保持、缓存、压缩等。这使得七层负载均衡在构建大规模集群架构时具有更好的可扩展性。</li>
<li>安全性：七层负载均衡可以基于应用层协议的内容进行安全过滤和防护，如https协议等。而四层负载均衡则通常只提供基本的网络安全功能。</li>
</ol>
<h3 id="9、LVS-实现四层负载均衡项目实战"><a href="#9、LVS-实现四层负载均衡项目实战" class="headerlink" title="9、LVS 实现四层负载均衡项目实战"></a>9、LVS 实现四层负载均衡项目实战</h3><h4 id="1、LVS-介绍"><a href="#1、LVS-介绍" class="headerlink" title="1、LVS 介绍"></a>1、LVS 介绍</h4><p>​    官网：<a href="http://www.linuxvirtualserver.org" target="_blank" rel="noopener">www.linuxvirtualserver.org</a></p>
<p>LVS（Linux Virtual Server）是一个开源的负载均衡器，用于实现网络服务的负载均衡和高可用性。它运行在 Linux 操作系统上，并利用操作系统的网络功能和内核支持来实现负载均衡。LVS 提供了一种低成本、高性能的负载均衡解决方案。</p>
<p>以下是 LVS 的一些关键特点和优势：</p>
<ol>
<li><strong>高可用性</strong>：LVS 可以实现网络服务的高可用性，通过将负载分配到多个后端服务器上，并且提供故障转移和冗余机制，以防止单点故障，并确保服务的连续性。工作在网络4层之上仅作分发之用，这个特点也决定了它在负载均衡软件里的性能最强，稳定性最好，对内存和cpu资源消耗极低。</li>
<li><strong>灵活的负载均衡算法</strong>：LVS 支持多种负载均衡算法，包括轮询、加权轮询、最少连接、加权最少连接等。管理员可以根据实际需求选择合适的负载均衡算法，以实现最佳的负载均衡效果。</li>
<li><strong>水平扩展性</strong>：LVS 具有良好的水平扩展性，可以通过添加更多的后端服务器来扩展系统的容量和性能，以应对不断增长的流量和请求。</li>
<li><strong>高性能</strong>：LVS 的设计注重性能，能够处理大规模的并发连接和高负载，保证了服务的响应速度和吞吐量。单台LVS负载均衡器，可支持上万并发连接。</li>
</ol>
<h4 id="2、LVS-不足之处"><a href="#2、LVS-不足之处" class="headerlink" title="2、LVS 不足之处"></a>2、LVS 不足之处</h4><p>​        工作在4层，不支持7层规则修改。</p>
<h4 id="3、LVS-核心组件和专业术语"><a href="#3、LVS-核心组件和专业术语" class="headerlink" title="3、LVS 核心组件和专业术语"></a>3、LVS 核心组件和专业术语</h4><h5 id="1、核心组件"><a href="#1、核心组件" class="headerlink" title="1、核心组件"></a>1、核心组件</h5><p><strong>IPVSadm</strong>：是用于管理和配置 IPVS 的命令行工具。通过 IPVSadm，管理员可以添加、删除、修改虚拟服务器、后端服务器池和负载均衡规则等配置</p>
<p><strong>IPVS</strong> 负责实现基于 IP 的负载均衡功能。IPVS 通过拦截和转发网络数据包来实现负载均衡，根据预定义的负载均衡策略将数据包分发到后端的真实服务器上。IPVS 支持多种负载均衡调度算法，包括轮询、加权轮询、最少连接、加权最少连接等。</p>
<p><strong>LVS模块</strong>：该模块位于Director Server（负载调度器）上，LVS模块的工作类似于一个路由器，它包含完成LVS功能所设定的路由表，通过这些路由表把用户的请求分发给后端的应用服务器（Real Server）。</p>
<p><strong>Ldirectord监控模块</strong>：该模块也安装在负载调度器上，用于监测各个Real Server服务的健康状况。在Real Server不可用时，Ldirectord会将其从LVS路由表中剔除，待Real Server恢复后再重新加入。</p>
<h5 id="2、专业术语"><a href="#2、专业术语" class="headerlink" title="2、专业术语"></a>2、专业术语</h5><ul>
<li><p><strong>VS</strong>：Virtual Server </p>
<p> 虚拟服务器，是LVS的<code>核心概念</code>之一，代表一个虚拟的网络服务。客户端将请求发送到虚拟服务器的IP地址上，然后LVS根据配置将请求转发到后端的真实服务器。</p>
</li>
</ul>
<ul>
<li><p><strong>Director, Balancer</strong>   </p>
<ul>
<li><p><strong>Director</strong>:</p>
<ul>
<li>Director 是 LVS 架构中的中心节点，也称为负载均衡器（Load Balancer）。</li>
</ul>
</li>
<li><p><strong>Balancer</strong> </p>
<ul>
<li>Director 扮演了负载均衡器的角色，因此可以将其称为 Balancer。</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p><strong>RS</strong>：Real Server            </p>
<p>真实服务器，也称为后端服务器或节点，是实际处理客户端请求的服务器。LVS将请求从虚拟服务器转发到真实服务器上。</p>
</li>
</ul>
<ul>
<li><p><strong>CIP</strong>: Client IP<br>在 LVS（Linux Virtual Server）中，CIP 可能指的是 “Client IP”，即客户端 IP。</p>
<p>​                   </p>
</li>
<li><p><strong>VIP</strong>：Director Virtual IP<br>“VIP” 指的是 “Virtual IP”，即虚拟 IP。VIP 是 LVS 架构中的一个重要概念，代表了一个虚拟的网络地址，客户端将请求发送到该地址上，然后 LVS 负责将请求转发到后端的真实服务器上。</p>
</li>
</ul>
<ul>
<li><p><strong>DIP</strong>：Director IP </p>
<p>DIP 是指 LVS 集群中的负载均衡器（Director）的真实 IP 地址，</p>
</li>
</ul>
<ul>
<li><strong>RIP</strong>：Real Server IP<br>在 LVS（Linux Virtual Server）中，”RIP” 通常指的是 “Real Server IP”，即真实服务器的 IP 地址。</li>
</ul>
<h5 id="3、具体图解"><a href="#3、具体图解" class="headerlink" title="3、具体图解"></a>3、具体图解</h5><p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1562677582545.png" alt="1562677582545"></p>
<h4 id="5、LVS负载均衡四种工作模式"><a href="#5、LVS负载均衡四种工作模式" class="headerlink" title="5、LVS负载均衡四种工作模式"></a>5、<strong>LVS负载均衡四种工作模式</strong></h4><p>1、<strong>NAT模式</strong>（LVS-NAT）</p>
<p>LVS（Linux Virtual Server）的 NAT模式是一种负载均衡模式，用于在传入的请求和传出的响应之间进行地址转换，从而实现负载均衡和透明的服务访问。</p>
<p>NAT 模式（即：网络地址映射）其工作原理是：客户端访问LVS时，LVS通过<strong>重写请求报文的目标地址</strong>，且根据预设的调度算法，将请求分派给后端真实服务器，真实服务器接收到请求处理后，发出响应报文也需要通过LVS返回，返回时需要<strong>修改报文的源地址</strong>，然后返回给客户，完成整个负载调度过程</p>
<ul>
<li>DNAT：目标地址转换，改变的是目标地址</li>
<li>SNAT：源地址转换，改变的是源地址</li>
</ul>
<p>NAT 模式就是使用 SNAT 和 DNAT 技术完成报的转发，NAT 方式可支持任何的操作系统，以及私有网络，并且只需一个 Internet IP 地址，非常节省成本，但是整个系统的性能受到限制。因为执行 NAT 每次需要重写数据包，有一定的延迟，另外，大部分应用有 80%的数据是从服务器流向客户机，也就是用户的请求非常短，而服务器的回应非常大，对LVS形成很大压力，容易成为瓶颈。</p>
<ul>
<li>在NAT模式下，当客户端发送请求到虚拟IP地址（VIP）时，LVS调度器会接收这些请求，并根据配置的调度算法选择一个后端真实服务器（RS）。然后，LVS会修改请求数据包的目的IP地址为选定RS的IP地址，并将数据包转发给该RS。响应数据包在返回给客户端之前，也会经过LVS，LVS将其源IP地址修改为VIP后，再发回给客户端。</li>
<li><strong>优点</strong>：NAT模式的配置相对简单，不需要VIP和真实服务器处于同一网段内，因此在某些网络环境下更为灵活。此外，由于所有数据包都经过LVS，可以实现更高层次的流量监控和管理。</li>
</ul>
<p>缺点：</p>
<ol>
<li><strong>性能瓶颈</strong>： NAT 模式需要在负载均衡器上执行地址转换，可能会增加负载均衡器的处理负担，导致性能瓶颈。</li>
</ol>
<p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1564358958845.png" alt="1564358958845"></p>
<blockquote>
<ol>
<li>数据包CIP-&gt;VIP，如果直接将数据包塞给RS，RS会丢弃，因此LVS修改目标地址VIP为RIP（D-NAT），此时数据包变成CIP-&gt;RIP发给RS</li>
<li>RS处理完成后发送数据包RIP-&gt;CIP，这个数据包直接塞给客户端，客户端是不会收的，因为客户端是发给VIP的，但是回来就变成RIP给客户端的了，客户端也会丢弃，因此LVS修改源地址为VIP（S-NAT），此时数据包变成VIP-&gt;CIP发给客户端</li>
</ol>
<p>注意事项：RS应该使用私有地址，DIP和RIP必须在同一个网段内，<strong>RS的网关必须指向DIP</strong>（因为最终给CIP的数据包要扔回给LVS）</p>
</blockquote>
<p> 2、<strong>直接路由(Direct Routing)模式（LVS-DR）</strong><br>    LVS（Linux Virtual Server）的 DR（Direct Routing）模式是一种负载均衡模式，它允许负载均衡器将传入的请求直接转发给后端真实服务器，而无需负载均衡器直接参与数据包的转发。</p>
<p><strong>工作原理</strong>：</p>
<ol>
<li>在DR模式下，LVS和RS都配置有VIP，但是RS的VIP配置在lo（回环）接口上，并且禁止ARP（地址解析协议）响应。</li>
<li>当客户端的请求报文到达LVS后，LVS会修改请求报文的MAC地址为目标RS的MAC地址，并将报文发送给RS。</li>
<li>RS收到请求报文后，会识别出报文中的VIP地址是自己的，于是处理报文， 报文直接返回给客户端，而不是返回给LVS。</li>
<li><strong>主要特点</strong>：<ul>
<li><strong>高性能</strong>：因为RS可以直接响应客户端，不需要经过LVS调度器中转，所以减少了延迟，提高了性能；DR模式无需进行复杂的地址转换配置；</li>
<li><strong>适用范围</strong>：适用于调度器和后端服务器在同一局域网内的场景，这样能够确保MAC地址的修改有效并且后端服务器能正确接收和处理请求。</li>
</ul>
</li>
</ol>
<p><strong>缺点</strong>：</p>
<ol>
<li><p><strong>不适用于非直连网络</strong>：</p>
<p>LVS DR模式的工作原理通过改写请求报文的目标MAC地址，将请求直接发送给真实的服务器（Real Server），而真实服务器响应后的处理结果也直接返回给客户端用户。在这种模式下，负载均衡器（Director）和真实服务器必须位于同一个物理网络中，并且要求负载均衡器与真实服务器都有一块网卡连接到同一物理网段上。</p>
<p>而非直连网络是指两个或多个网络通过路由器或其他网络设备连接，它们之间并不直接相连。在非直连网络中，数据包需要通过路由器进行转发才能到达目标网络。由于LVS DR模式要求负载均衡器和真实服务器在同一物理网络中，因此它无法直接适用于非直连网络。</p>
</li>
</ol>
<p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1564358987844.png" alt="1564358987844"></p>
<p>  3、<strong>IP隧道(Tunnel)模式（LVS-TUN）</strong>  </p>
<p>​    原理：LVS-TUN模式是Linux Virtual Server（LVS）负载均衡技术中的一种工作模式，也被称为IP隧道模式。在这种模式下，LVS调度器（Director）将接收到的客户端请求数据包封装在一个新的IP数据包中，然后转发给后端的应用服务器（Real Server）。Real Server在处理完请求后，直接将响应数据包发送回客户端，无需再次经过LVS调度器。</p>
<p>LVS-TUN模式的工作原理是在原有的IP报文外再次封装一层IP首部，内部IP首部（源地址为CIP，目标IP为VIP），外层IP首部（源地址为DIP，目标IP为RIP）。这样，通过IP隧道技术，可以将目标为一个IP地址的数据报文封装和转发到另一个IP地址，实现跨网段的负载均衡。</p>
<p>​    优点：负载均衡器只负责将请求包分发给后端节点服务器，而RS将应答包直接发给用户，减少了负载均衡器的大量数据流动。<br>​    缺点：隧道模式的RS节点需要合法IP，这种方式需要所有的服务器支持”IP Tunneling”(IP Encapsulation)协议。</p>
<p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1564359021882.png" alt="1564359021882"></p>
<p> 4、FULL-NAT模式（双向转换模式）</p>
<p>原理：LVS（Linux Virtual Server）的双向转换模式通常指的是LVS-FullNAT模式。在这种模式下，LVS（负载均衡器）对进站和出站的数据流量都进行地址转换。具体来说，当客户端发送请求时，LVS会修改请求报文的源地址为目标RS（真实服务器）的IP地址（RIP），并将目标地址修改为LVS的虚拟IP地址（VIP）。当RS处理完请求并返回响应时，LVS会再次修改响应报文的源地址为VIP，目标地址为客户端的IP地址（CIP），然后将响应报文发送给客户端。</p>
<p>通过请求报文的源地址为DIP，目标为RIP来实现转发：对于响应报文而言，修改源地址为VIP，目标地址为CIP来实现转发：</p>
<p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/image-20220210140940567.png" alt="image-20220210140940567"></p>
<h5 id="5、四者的区别"><a href="#5、四者的区别" class="headerlink" title="5、四者的区别"></a><strong>5、四者的区别</strong></h5><p>lvs-nat与lvs-fullnat：请求和响应报文都经由Director</p>
<p>   　　lvs-nat：RIP的网关要指向DIP</p>
<p>  　　 lvs-fullnat：双向转换</p>
<p>lvs-dr与lvs-tun：请求报文要经由Director，但响应报文由RS直接发往Client</p>
<p>  　　 lvs-dr：通过封装新的MAC首部实现，通过MAC网络转发</p>
<p>  　　 lvs-tun：通过在原IP报文外封装新IP头实现转发，支持远距离通信</p>
<h4 id="6、LVS-ipvsadm-命令的使用"><a href="#6、LVS-ipvsadm-命令的使用" class="headerlink" title="6、LVS ipvsadm 命令的使用"></a>6、LVS ipvsadm 命令的使用</h4><h5 id="1、LVS-server安装lvs管理软件"><a href="#1、LVS-server安装lvs管理软件" class="headerlink" title="1、LVS-server安装lvs管理软件"></a>1、LVS-server安装lvs管理软件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ipvsadm</span><br></pre></td></tr></table></figure>

<p>程序包：ipvsadm（LVS管理工具）</p>
<p>主程序：/usr/sbin/ipvsadm</p>
<p>规则保存工具：/usr/sbin/ipvsadm-save  &gt; /path/to/file</p>
<p>配置文件：/etc/sysconfig/ipvsadm-config</p>
<h5 id="2、命令选项"><a href="#2、命令选项" class="headerlink" title="2、命令选项"></a>2、命令选项</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">-A --add-service #在服务器列表中新添加一条新的虚拟服务器记录</span><br><span class="line">-t #表示为tcp服务</span><br><span class="line">-u #表示为udp服务</span><br><span class="line">-s --scheduler #使用的调度算法， rr | wrr | lc | wlc | lblb | lblcr | dh | sh | sed | nq 默认调度算法是 wlc</span><br><span class="line">例：ipvsadm -A -t 192.168.1.2:80 -s wrr</span><br><span class="line"></span><br><span class="line">-a --add-server  #在服务器表中添加一条新的真实主机记录</span><br><span class="line">-t --tcp-service #说明虚拟服务器提供tcp服务</span><br><span class="line">-u --udp-service #说明虚拟服务器提供udp服务</span><br><span class="line">-r --real-server #真实服务器地址</span><br><span class="line">-m --masquerading #指定LVS工作模式为NAT模式</span><br><span class="line">-w --weight #真实服务器的权值</span><br><span class="line">-g --gatewaying #指定LVS工作模式为直接路由器模式（也是LVS默认的模式）</span><br><span class="line">-i --ip #指定LVS的工作模式为隧道模式</span><br><span class="line">-p #会话保持时间，定义流量呗转到同一个realserver的会话存留时间</span><br><span class="line">例：ipvsadm -a -t 192.168.1.2:80 -r 192.168.2.10:80 -m -w 1</span><br><span class="line"></span><br><span class="line">-E -edit-service #编辑内核虚拟服务器表中的一条虚拟服务器记录。</span><br><span class="line">-D -delete-service #删除内核虚拟服务器表中的一条虚拟服务器记录。</span><br><span class="line">-C -clear #清除内核虚拟服务器表中的所有记录。</span><br><span class="line">-R -restore #恢复虚拟服务器规则</span><br><span class="line">-S -save #保存虚拟服务器规则到标准输出，输出为-R 选项可读的格式</span><br><span class="line">-e -edit-server #编辑一条虚拟服务器记录中的某条真实服务器记录</span><br><span class="line">-d -delete-server #删除一条虚拟服务器记录中的某条真实服务器记录</span><br><span class="line">-L|-l –list #显示内核虚拟服务器表</span><br><span class="line"></span><br><span class="line">--numeric, -n：#以数字形式输出地址和端口号</span><br><span class="line">--exact： #扩展信息，精确值 </span><br><span class="line">--connection，-c： #当前IPVS连接输出</span><br><span class="line">--stats： #统计信息</span><br><span class="line">--rate ： #输出速率信息</span><br><span class="line"></span><br><span class="line">参数也可以从/proc/net/ip_vs*映射文件中查看</span><br><span class="line">-Z –zero #虚拟服务表计数器清零（清空当前的连接数量等）</span><br></pre></td></tr></table></figure>

<h4 id="7、LVS-负载均衡集群企业级应用实战"><a href="#7、LVS-负载均衡集群企业级应用实战" class="headerlink" title="7、LVS 负载均衡集群企业级应用实战"></a>7、LVS 负载均衡集群企业级应用实战</h4><h6 id="1、准备虚拟机"><a href="#1、准备虚拟机" class="headerlink" title="1、准备虚拟机"></a>1、准备虚拟机</h6><p> 准备 3 台纯净的虚拟机，两台 web 服务器</p>
<h6 id="2、LVS-server-安装lvs管理软件"><a href="#2、LVS-server-安装lvs管理软件" class="headerlink" title="2、LVS-server 安装lvs管理软件"></a>2、LVS-server 安装lvs管理软件</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs-server ~]# yum -y install ipvsadm</span><br></pre></td></tr></table></figure>

<p>程序包：ipvsadm（LVS管理工具）</p>
<p>主程序：/usr/sbin/ipvsadm</p>
<p>规则保存工具：/usr/sbin/ipvsadm-save &gt; /path/to/file</p>
<p>配置文件：/etc/sysconfig/ipvsadm-config</p>
<h5 id="3、LVS-DR-模式"><a href="#3、LVS-DR-模式" class="headerlink" title="3、LVS/DR 模式"></a>3、LVS/DR 模式</h5><p>实验说明：<br>1.虚拟机网络使用NAT模式<br>2.DR模式要求Director DIP 和 所有RealServer RIP必须在同一个网段及广播域<br>3.所有节点网关均指定真实网关</p>
<p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1568546953134.png" alt="1568546953134">    上图所示：CIP为客户端IP，VIP为负载均衡器虚拟IP，需要和后端提供服务的主机IP地址为一个网段，DIP为负载均衡器的真实主机IP地址。RIP为后端提供服务的主机IP地址。但是在LVS DR模式下，后端主机还需要配置一个VIP，并且绑定在该主机的回环网卡(lo)上，掩码位为32位，用于收到客户端请求后。将数锯直接返回给客户端，无需在经过负载均衡器。</p>
<p><strong>思考：为什么LVS DR模式需要关闭arp广播？</strong></p>
<p>为了避免ARP广播导致的冲突，确保流量能够正确地通过LVS进行负载均衡。</p>
<p><code>ARP</code>广播会产生的问题 当客户端发起访问<code>VIP</code>对应的域名的请求（curl 10.0.0.32）时，根据网络通信原理会产生<code>ARP</code>广播，因为负载均衡器和真实的服务器<code>rs</code>在同一网络并且<code>VIP</code>设置在集群中的每个节点上，此时集群内的真实服务器会尝试回答来自客户端计算机的查找<code>VIP</code>的<code>ARP</code>广播，这就会产生问题，大家都说我是”VIP”。）为了达到负载均衡的目的，在所有<code>real server</code>上要关闭所有<code>arp</code>请求，导致不能响应<code>client</code>发出的<code>arp</code>请求（相当于哑巴），只有<code>lvs</code>可以响应，这样请求就会传到<code>lvs</code>的<code>vip</code>中，这就是为什么要禁止<code>real server</code>的<code>arp</code>请求和响应。因此必须想法办让真实服务器忽略来自客户端计算机的<code>ARP</code>广播请求。</p>
<p><strong>思考：为什么LVS DR模式下需要开启精准IP地址回包</strong></p>
<p>当客户端发送请求到VIP时，调度器会根据负载均衡算法选择一台真实服务器，并将请求转发给该服务器。此时，真实服务器需要能够直接响应客户端的请求，而不需要再次通过调度器进行转发。</p>
<p>为了实现这一点，真实服务器需要开启精准IP地址回包功能。具体来说，当真实服务器处理完客户端的请求后，它会将响应数据包的源IP地址设置为VIP，目标IP地址设置为客户端的IP地址。这样，当数据包返回给客户端时，客户端会认为是直接从VIP接收到的响应，而不是经过某个中间设备（如调度器）转发的。</p>
<p>如果没有开启精准IP地址回包功能，真实服务器可能会将响应数据包的源IP地址设置为自己的真实IP地址，而不是VIP。这样，当数据包返回给客户端时，客户端会认为响应来自一个不同的IP地址，而不是它最初请求的VIP。这可能导致客户端与服务器之间的通信出现问题，例如连接中断或响应错误。</p>
<h6 id="2、LVS-DR模式实施-部署"><a href="#2、LVS-DR模式实施-部署" class="headerlink" title="2、LVS/DR模式实施(部署)"></a>2、LVS/DR模式实施(部署)</h6><p>1、准备工作（集群中所有主机）关闭防火墙和selinux</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> systemctl <span class="built_in">disable</span> --now firewalld</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> setenforce 0</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sed -i <span class="string">'s/SELINUX=enforcing/SELINUX=disabled/g'</span> /etc/selinux/config</span></span><br></pre></td></tr></table></figure>



<p>2、Director分发器配置</p>
<p>配置VIP</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs-server ~]# ip addr add dev ens33 192.168.174.101/32 #设置VIP</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 参数说明</span></span><br><span class="line">	ip addr: 这是用于管理网络接口的命令，用于查看和修改网络接口的配置。</span><br><span class="line">	add: 这是ip addr命令的一个子命令，用于添加一个新的IP地址到指定的网络接口上。</span><br><span class="line">	dev ens33: 这是指定要操作的网络接口的名称。在这个例子中，网络接口的名称是ens33。</span><br><span class="line">	192.168.246.101/32: 这是要添加到网络接口上的IP地址和子网掩码。</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装ipvsadm</span></span><br><span class="line">[root@lvs-server ~]# yum install -y ipvsadm   </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动</span></span><br><span class="line">[root@lvs-server ~]# systemctl enable --now ipvsadm  </span><br><span class="line">注意:启动如果报错: /bin/bash: /etc/sysconfig/ipvsadm: 没有那个文件或目录</span><br><span class="line">需要手动生成文件</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 保存 IPVS 的当前配置</span></span><br><span class="line">[root@lvs-server ~]# ipvsadm --save &gt; /etc/sysconfig/ipvsadm</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 参数说明：</span></span><br><span class="line">	--save: 这是ipvsadm的一个选项，用于将当前的ipvsadm配置保存到一个文件中。这个选项会将当前配置的所有规则和设置写入指定的文件。</span><br><span class="line">	</span><br><span class="line">	/etc/sysconfig/ipvsadm: 这是保存ipvsadm配置的文件路径。/etc/sysconfig目录通常用于存储系统配置文件，而ipvsadm文件则包含了ipvsadm的配置信息。</span><br></pre></td></tr></table></figure>

<p>定义LVS分发策略</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-A：添加VIP</span><br><span class="line">-t：用的是tcp协议</span><br><span class="line">-a：添加的是lo的vip地址</span><br><span class="line">-r：转发到realserverip</span><br><span class="line">-s：算法</span><br><span class="line">-L|-l –list #显示内核虚拟服务器表</span><br><span class="line">--numeric, -n：#以数字形式输出地址和端口号</span><br><span class="line">-g --gatewaying #指定LVS工作模式为直接路由器模式DR（也是LVS默认的模式）</span><br><span class="line">-S -save #保存虚拟服务器规则到标准输出，输出为-R 选项可读的格式</span><br><span class="line">rr：轮循</span><br><span class="line">如果添加ip错了，删除命令如下:</span><br><span class="line"><span class="meta">#</span><span class="bash"> ip addr del 192.168.174.101 dev ens33</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 清除内核虚拟服务器表中的所有记录。</span></span><br><span class="line">[root@lvs-server ~]# ipvsadm -C  </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看目前主机存在的规则</span></span><br><span class="line">[root@lvs-server ~]# ipvsadm -ln</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">[root@lvs-server ~]# ipvsadm -A -t 192.168.174.101:80 -s rr </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加一台后端主机，如果用户的请求到VIP的端口上时，转发至后端提供服务的主机上，并且使用LVS的DR模式。</span></span><br><span class="line">[root-@lvs-server ~]# ipvsadm -a -t 192.168.174.101:80 -r 192.168.174.20 -g </span><br><span class="line"><span class="meta">	#</span><span class="bash"> 参数解释</span></span><br><span class="line">  -a:  "add" 的缩写，表示你想添加一个虚拟服务到 IPVS 表中。</span><br><span class="line">  </span><br><span class="line">  -t 192.168.174.101:80: 这部分指定了虚拟服务的 IP 地址和端口。在这种情况下，IP 地址是 192.168.174.101，端口是 80（HTTP 的默认端口）。这意味着所有发送到 192.168.174.101 的 80 端口的流量都将被 IPVS 截取并分发到一组真实服务器。</span><br><span class="line">  </span><br><span class="line">  -r 192.168.174.40: 这部分指定了一个真实服务器的 IP 地址。在这个例子中，真实服务器的 IP 地址是 192.168.174.20。</span><br><span class="line">  </span><br><span class="line">  -g：表示使用 "gatewaying"（或称为直接路由）方法，并且调度算法是默认的（通常是轮询，但具体取决于 IPVS 的配置）。使用直接路由时，LVS 负载均衡器只是将数据包的目标地址更改为真实服务器的地址，并将数据包直接发送到该服务器。</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">[root@lvs-server ~]# ipvsadm -a -t 192.168.174.101:80 -r 192.168.174.41 -g  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 保存方式，保存到一个文件中</span></span><br><span class="line">[root@lvs-server ~]# ipvsadm -S &gt; /etc/sysconfig/ipvsadm  </span><br><span class="line"><span class="meta">	#</span><span class="bash"> 参数说明</span></span><br><span class="line">	-S：是 --save 的简写形式</span><br><span class="line">	</span><br><span class="line">[root@lvs-server ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  192.168.174.101:80 rr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.174.40:80            Route   1      1          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.174.41:80            Route   1      2          0         </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 参数解释：</span></span><br><span class="line">	TCP 192.168.174.101:80 rr：这是一个虚拟服务器的配置，使用TCP协议，本地地址为192.168.174.101，端口为80，使用轮询（round-robin）调度器</span><br><span class="line">	</span><br><span class="line">	192.168.174.40:80 Route 1 1 0：这是一个真实服务器的配置，使用路由（Route）转发方式，远程地址为192.168.174.40，端口为80，权重为1，活动连接数为1，非活动连接数为0</span><br><span class="line">    192.168.174.41:80 Route 1 2 0：这是另一个真实服务器的配置，与上一个配置类似，远程地址为192.168.174.41，端口为80，权重为1，活动连接数为2，非活动连接数为0。</span><br><span class="line">    </span><br><span class="line">[root@lvs-server ~]# ipvsadm -L -n   </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示统计信息</span></span><br><span class="line">[root@lvs-server ~]# ipvsadm -L -n --stats    </span><br><span class="line"><span class="meta">	#</span><span class="bash"> 参数解释	</span></span><br><span class="line">1. Conns    (connections scheduled)  已经转发过的连接数</span><br><span class="line">2. InPkts   (incoming packets)       包个数</span><br><span class="line">3. OutPkts  (outgoing packets)       出包个数</span><br><span class="line">4. InBytes  (incoming bytes)         入流量（字节）  </span><br><span class="line">5. OutBytes (outgoing bytes)         出流量（字节）</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 看速率</span></span><br><span class="line">[root@lvs-server ~]# ipvsadm -L -n --rate	</span><br><span class="line">1. CPS      (current connection rate)   每秒连接数</span><br><span class="line">2. InPPS    (current in packet rate)    每秒的入包个数</span><br><span class="line">3. OutPPS   (current out packet rate)   每秒的出包个数</span><br><span class="line">4. InBPS    (current in byte rate)      每秒入流量（字节）</span><br><span class="line">5. OutBPS   (current out byte rate)     每秒出流量（字节）</span><br></pre></td></tr></table></figure>



<p>3、所有RS配置</p>
<p>配置好网站服务器，测试所有RS    #为了测试效果，提供不同的页面（以下两台real-server都操作）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@real-server1 ~]# vim /etc/yum.repos.d/nginx.repo</span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 两台机器都安装nginx作为后端服务，按顺序添加不同的主机名以示区分</span></span><br><span class="line">[root@real-server1 ~]# yum install -y nginx</span><br><span class="line">[root@real-server1 ~]# echo "real-server1" &gt;&gt; /usr/share/nginx/html/index.html</span><br><span class="line"></span><br><span class="line">[root@real-server2 ~]# yum install -y nginx</span><br><span class="line">[root@real-server2 ~]# echo "real-server1" &gt;&gt; /usr/share/nginx/html/index.html</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在lo接口上绑定VIP</span></span><br><span class="line">[root@real-server1 ~]# ip addr add dev lo 192.168.174.101/32 </span><br><span class="line"><span class="meta">	#</span><span class="bash"> 参数解释</span></span><br><span class="line">	addr: 这是 ip 命令的一个子命令，用于管理网络接口的地址。</span><br><span class="line">	</span><br><span class="line">	add: 这个参数告诉 ip addr 命令要添加一个地址到指定的网络接口。</span><br><span class="line">	</span><br><span class="line">	dev lo: 这部分指定了要操作的网络接口。在这个例子中，lo 是回环接口（loopback interface）的别名，它通常用于本地通信（例如，ping 127.0.0.1）。</span><br><span class="line">	</span><br><span class="line">	192.168.174.101/32: 这是要添加到 lo 接口的 IP 地址和子网掩码</span><br><span class="line">	</span><br><span class="line">[root@real-server2 ~]# ip addr add dev lo 192.168.174.100/32</span><br><span class="line"></span><br><span class="line"><span class="meta"> #</span><span class="bash"> real-server1 忽略arp广播</span></span><br><span class="line">[root@real-server1 ~]# echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore </span><br><span class="line"><span class="meta">#</span><span class="bash"> real-server1 匹配精确ip地址回包</span></span><br><span class="line">[root@real-server1 ~]# echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> real-server2 忽略arp广播</span></span><br><span class="line">[root@real-server2 ~]# echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore  </span><br><span class="line"><span class="meta">#</span><span class="bash"> real-server2 匹配精确ip地址回包</span></span><br><span class="line">[root@real-server2 ~]# echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动nginx实例</span></span><br><span class="line">[root@real-server1 ~]# systemctl enable --now nginx</span><br><span class="line">[root@real-server2 ~]# systemctl enable --now nginx</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 测试：游览器清楚缓存，<a href="http://192.168.174.101（修改后端nginx服务器的长连接keep-alive）" target="_blank" rel="noopener">http://192.168.174.101（修改后端nginx服务器的长连接keep-alive）</a></p>
</blockquote>
<h4 id="8、LVS-NAT模式"><a href="#8、LVS-NAT模式" class="headerlink" title="8、LVS-NAT模式:"></a>8、LVS-NAT模式:</h4><p><strong>环境准备</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.174.39	lvs-server</span><br><span class="line">192.168.174.40	real-server01</span><br><span class="line">192.168.174.41	real-server02</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意： 此处的环境需要的主机，以自己创建的主机地址为准</p>
</blockquote>
<p><strong>所有主机关闭防火墙和SELIUX</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl <span class="built_in">disable</span> --now firewalld</span><br><span class="line">$ setenforce 0</span><br><span class="line">$ sed -i <span class="string">'s/SELINUX=enforcing/SELINUX=disabled/g'</span> /etc/selinux/config</span><br></pre></td></tr></table></figure>

<p><strong>查看linux已加载的内核模块</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs-server ~]# lsmod | grep ip_vs</span><br></pre></td></tr></table></figure>

<p>加载与卸载<code>ip_vs</code>内核模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 动态加载ip_vs 模块，这个命令只是临时生效，需要添加到开机启动文件里面</span></span><br><span class="line">[root@lvs-server ~]# modprobe ip_vs  </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 过滤模块是否加载成功</span></span><br><span class="line">[root@lvs-server ~]# lsmod | grep ip_vs  </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 动态卸载ip_vs模块</span></span><br><span class="line">[root@lvs-server ~]# modprobe -r ip_vs</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 设置开机启动项</span></span><br><span class="line">[root@lvs-server ~]# echo "modprobe ip_vs" &gt;&gt; /etc/rc.local</span><br><span class="line"><span class="meta">#</span><span class="bash"> 自启脚本添加执行权限</span></span><br><span class="line">[root@lvs-server ~]# chmod +x /etc/rc.local</span><br></pre></td></tr></table></figure>

<blockquote>
<p>添加到开机启动项里面如果不需要这个模块的时候只需要将etc/rc.local里面对应的命令删除掉。但是这样需要重新启动服务器。 可以通过下面的命令立即生效。</p>
</blockquote>
<p><strong>LVS-NAT模式：</strong></p>
<p><img src="https://youngfitfei.oss-cn-beijing.aliyuncs.com/img/1568551568776.png" alt="1568551568776">                                </p>
<p>建议：先在Real Server安装如nginx（两台机器real-server)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 两台后端服务安装nginx服务</span></span><br><span class="line">[root@real-server1 ~]# vim /etc/yum.repos.d/nginx.repo</span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 缓存元数据</span></span><br><span class="line">[root@real-server1 ~]# yum makecache fast</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装nginx web服务</span></span><br><span class="line">[root@real-server1 ~]# yum install -y nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 准备网页文件</span></span><br><span class="line">[root@real-server01 ~]# echo "real-server1" &gt;&gt; /usr/share/nginx/html/index.html</span><br><span class="line">[root@real-server02 ~]# echo "real-server2" &gt;&gt; /usr/share/nginx/html/index.html</span><br><span class="line">	</span><br><span class="line"><span class="meta">#</span><span class="bash"> 两台后端主机启动服务</span></span><br><span class="line">[root@real-server01 ~]# systemctl enable --now nginx</span><br><span class="line">[root@real-server02 ~]# systemctl enable --now nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试网站是否正常访问</span></span><br><span class="line">[root@real-server ~]# curl 主机IP</span><br></pre></td></tr></table></figure>

<h6 id="2、LVS-NAT模式配置"><a href="#2、LVS-NAT模式配置" class="headerlink" title="2、LVS/NAT模式配置"></a>2、LVS/NAT模式配置</h6><ol>
<li>RS配置</li>
</ol>
<p>设置real-server（提供服务主机）所有服务器的默认网关指向Directory的DIP（负载均衡器主机IP）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 如果系统没有route 命令请使用如下命令安装</span></span><br><span class="line">[root@real-server1 ~]# yum install -y net-tools</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> redl-server01 配置</span></span><br><span class="line">[root@real-server1 ~]# route add default gw 192.168.100.39  dev ens33</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 参数说明</span></span><br><span class="line">	default：表示这是一个默认路由，即当数据包的目的地不在本地路由表中时，数据包将发送到这个路由所指定的下一跳地址。</span><br><span class="line">	</span><br><span class="line">	gw 192.168.100.39：指定了网关的地址，也就是数据包的下一跳地址。</span><br><span class="line">	</span><br><span class="line">	dev ens33：指定了数据包应该通过哪个网络接口发送出去。在这个例子中，数据包将通过名为 ens33 的网络接口发送出去。</span><br><span class="line">	</span><br><span class="line"><span class="meta">#</span><span class="bash"> redl-server02 配置</span></span><br><span class="line">[root@real-server2 ~]# route add default gw 192.168.100.39  dev ens33</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看是否添加完成</span></span><br><span class="line">[root@real-server01 ~]# route  -n </span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.174.39  0.0.0.0         UG    0      0        0 ens33</span><br><span class="line">0.0.0.0         192.168.174.2   0.0.0.0         UG    100    0        0 ens33</span><br><span class="line">192.168.174.0   0.0.0.0         255.255.255.0   U     100    0        0 ens33</span><br></pre></td></tr></table></figure>

<blockquote>
<p>提示： 上述代码中的IP地址和网卡名称需要和自己的实际创建的一致，<code>注意修改</code>哟！</p>
</blockquote>
<ol start="2">
<li>Director分发器配置</li>
</ol>
<p>先给LVS服务器新添加一块网卡网络模式设置为桥接模式。会自动生成一个ip，作为VIP。</p>
<img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/image-20240412140045570.png" alt="image-20240412140045570" style="zoom:67%;">

<img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/image-20240412140158353.png" alt="image-20240412140158353" style="zoom:67%;">



<img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/image-20240412140230022.png" alt="image-20240412140230022" style="zoom:67%;">

<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/image-20240413142305761.png" alt="image-20240413142305761"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启路由转发</span></span><br><span class="line">[root@lvs-server ~]# vim /etc/sysctl.conf </span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启转发功能</span></span><br><span class="line">[root@lvs-server ~]# sysctl -p</span><br></pre></td></tr></table></figure>

<p>思考题：为什么LVS NAT模式下需要开始路由转发功能？</p>
<p>主要是因为NAT模式的工作原理决定了数据包需要在负载均衡器上进行地址转换。</p>
<p>在NAT模式下，当客户端发送一个请求到虚拟IP地址（VIP）时，这个请求首先到达LVS服务器。LVS服务器会修改数据包的目标IP地址，将其更改为后端真实服务器（RealServer）的IP地址，并将修改后的数据包转发给RealServer。这个过程涉及到了IP地址的转换，也就是NAT。</p>
<p>当RealServer处理完请求并返回响应时，它并不知道最初的请求是发送给VIP的，因此它会直接将响应发送回请求的源IP地址（即客户端的IP地址）。但是，由于RealServer的IP地址与VIP不同，因此这个响应数据包不能直接路由回客户端。此时，LVS服务器需要再次介入，将响应数据包的源IP地址更改为VIP，并将数据包转发给客户端。</p>
<p>为了实现这个过程，LVS服务器需要开启路由转发功能。这是因为默认情况下，Linux服务器不会转发来自非本地网络的数据包。开启路由转发功能后，LVS服务器就能够接收来自RealServer的响应数据包，并将其转发给客户端了。</p>
<ol start="3">
<li>定义LVS的分发策略（<code>负载均衡器配置</code>）</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装ipvsadm</span></span><br><span class="line">[root@lvs-server ~]# yum install -y ipvsadm</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置ipvs 路由规则存放文件地址，默认无</span></span><br><span class="line">[root@lvs-server ~]# ipvsadm -S &gt; /etc/sysconfig/ipvsadm</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动ipvs,并加入开机自启</span></span><br><span class="line">[root@lvs-server ~]# systemctl enable --now ipvsadm</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在IPVS服务器中添加一个虚拟IP(VIP)，其IP地址为192.168.246.160，使用tcp协议，端口号为80，并使用轮询算法进行负载均衡。</span></span><br><span class="line">[root@lvs-server ~]# ipvsadm -A -t 192.168.43.202:80 -s rr </span><br><span class="line"><span class="meta">	#</span><span class="bash"> 参数解释：</span></span><br><span class="line">		-A：添加一个新的虚拟服务。</span><br><span class="line"> 		192.168.43.202:80：指定虚拟服务(VIP)的 IP 地址和端口号。</span><br><span class="line">		-t：使用tcp协议。</span><br><span class="line">		-s rr：指定调度算法为轮询（round-robin）。</span><br><span class="line">		</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加一台后端主机，如果用户的请求到VIP的端口上时，转发至后端提供服务的主机上，并且使用LVS的NAT模式。</span></span><br><span class="line">[root@lvs-server ~]# ipvsadm -a -t 192.168.43.202:80 -r 192.168.174.40 -m  </span><br><span class="line">[root@lvs-server ~]# ipvsadm -a -t 192.168.43.202:80 -r 192.168.174.41 -m  </span><br><span class="line"><span class="meta">#</span><span class="bash"> 保存配置</span></span><br><span class="line">[root@lvs-server ~]# ipvsadm -S &gt; /etc/sysconfig/ipvsadm  </span><br><span class="line"></span><br><span class="line">[root@lvs-server ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  192.168.50.128:80 rr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.246.161:80           Masq    1      1          3         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.246.162:80           Masq    1      1          3         </span></span><br><span class="line">[root@lvs-server ~]# ipvsadm -L -n --stats			      // 显示统计信息</span><br><span class="line">[root@lvs-server ~]# ipvsadm -L -n --rate				//看速率</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>测试游览器访问：<a href="http://192.168.43.202" target="_blank" rel="noopener">http://192.168.43.202</a></li>
</ol>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">L66</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://l66stbz.github.io/2024/08/11/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-LVS/">https://l66stbz.github.io/2024/08/11/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-LVS/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://l66stbz.github.io" target="_blank">L66</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/LVS/">LVS</a></div><div class="post_share"><div class="social-share" data-image="https://l66stbz.github.io/2024/09/09/若依项目动静分离/若依项目动静分离项目实现/6.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2024/08/12/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1+keepalived/"><img class="prev_cover" src="https://l66stbz.github.io/2024/08/12/负载均衡+keepalived/1.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">负载均衡+keepalived</div></div></a></div><div class="next-post pull_right"><a href="/2024/08/10/nginx%E8%AF%A6%E8%A7%A3+%E5%AE%9E%E6%93%8D_04/"><img class="next_cover" src="https://l66stbz.github.io/2024/08/10/nginx详解+实操_04/1.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">nginx详解+实操_04</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2024/08/13/LVS-NAT-Keepalived/" title="LVS-NAT-Keepalived"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/08/13/LVS-NAT-Keepalived/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-08-13</div><div class="relatedPosts_title">LVS-NAT-Keepalived</div></div></a></div><div class="relatedPosts_item"><a href="/2024/05/24/自动化脚本/" title="自动化脚本"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/05/24/自动化脚本/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-05-24</div><div class="relatedPosts_title">自动化脚本</div></div></a></div><div class="relatedPosts_item"><a href="/2024/08/12/负载均衡+keepalived/" title="负载均衡+keepalived"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/08/12/负载均衡+keepalived/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-08-12</div><div class="relatedPosts_title">负载均衡+keepalived</div></div></a></div><div class="relatedPosts_item"><a href="/2024/05/23/基础测试脚本题/" title="基础测试脚本题"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/05/23/基础测试脚本题/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-05-23</div><div class="relatedPosts_title">基础测试脚本题</div></div></a></div><div class="relatedPosts_item"><a href="/2024/08/16/RabbitMQ消息队列/" title="RabbitMQ消息队列"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/08/16/RabbitMQ消息队列/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-08-16</div><div class="relatedPosts_title">RabbitMQ消息队列</div></div></a></div><div class="relatedPosts_item"><a href="/2024/05/21/Keepalived/" title="Keepalived"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/05/21/Keepalived/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-05-21</div><div class="relatedPosts_title">Keepalived</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By L66</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/js/third-party/click_heart.js"></script></body></html>