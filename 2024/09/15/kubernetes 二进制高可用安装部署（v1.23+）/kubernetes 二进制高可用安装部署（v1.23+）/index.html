<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>kubernetes 二进制高可用安装部署（v1.23+） | L66</title><meta name="description" content="kubernetes 二进制高可用安装部署（v1.23+）[TOC] 一丶高可用集群划分1. 集群规划   配置信息 备注    系统版本 CentOS 7.9   Docker版本 20.10.x   Pod网段 172.16.0.0&#x2F;16   Service网段 10.96.0.0&#x2F;16   ⚠️ 宿主机网段、K8s Service网段、Pod网段不能重复    role ipaddress"><meta name="keywords" content="Linux,Kubernetes"><meta name="author" content="L66"><meta name="copyright" content="L66"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/3.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="kubernetes 二进制高可用安装部署（v1.23+）"><meta name="twitter:description" content="kubernetes 二进制高可用安装部署（v1.23+）[TOC] 一丶高可用集群划分1. 集群规划   配置信息 备注    系统版本 CentOS 7.9   Docker版本 20.10.x   Pod网段 172.16.0.0&#x2F;16   Service网段 10.96.0.0&#x2F;16   ⚠️ 宿主机网段、K8s Service网段、Pod网段不能重复    role ipaddress"><meta name="twitter:image" content="https://l66stbz.github.io/2024/09/15/kubernetes 二进制高可用安装部署（v1.23+）/kubernetes 二进制高可用安装部署（v1.23+）/1.png"><meta property="og:type" content="article"><meta property="og:title" content="kubernetes 二进制高可用安装部署（v1.23+）"><meta property="og:url" content="https://l66stbz.github.io/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/"><meta property="og:site_name" content="L66"><meta property="og:description" content="kubernetes 二进制高可用安装部署（v1.23+）[TOC] 一丶高可用集群划分1. 集群规划   配置信息 备注    系统版本 CentOS 7.9   Docker版本 20.10.x   Pod网段 172.16.0.0&#x2F;16   Service网段 10.96.0.0&#x2F;16   ⚠️ 宿主机网段、K8s Service网段、Pod网段不能重复    role ipaddress"><meta property="og:image" content="https://l66stbz.github.io/2024/09/15/kubernetes 二进制高可用安装部署（v1.23+）/kubernetes 二进制高可用安装部署（v1.23+）/1.png"><meta property="article:published_time" content="2024-09-15T13:50:00.000Z"><meta property="article:modified_time" content="2024-09-26T12:43:00.327Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://l66stbz.github.io/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/"><link rel="prev" title="Kubernetes基础资源调度" href="https://l66stbz.github.io/2024/09/16/Kubernetes%E5%9F%BA%E7%A1%80%E8%B5%84%E6%BA%90%E8%B0%83%E5%BA%A6/03-Kubernetes%E5%9F%BA%E7%A1%80%E8%B5%84%E6%BA%90%E8%B0%83%E5%BA%A6/"><link rel="next" title="Kubernetes容器编排工具部署（adm）" href="https://l66stbz.github.io/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="APlayer.min.css"><div id="aplayer"></div><script src="https://cdn.jsdelivr.net/gh/radium-bit/res@master/live2d/autoload.js" async></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js" async></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="L66" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/2.jpg" onerror="onerror=null;src='/img/2.jpg'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">68</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">37</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/photo/"><i class="fa-fw fa fa-film"></i><span> Photo</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes-二进制高可用安装部署（v1-23-）"><span class="toc-number">1.</span> <span class="toc-text">kubernetes 二进制高可用安装部署（v1.23+）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一丶高可用集群划分"><span class="toc-number">1.1.</span> <span class="toc-text">一丶高可用集群划分</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-集群规划"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">1. 集群规划</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-配置所有节点的hosts文件（Master-and-Node）"><span class="toc-number">1.1.0.2.</span> <span class="toc-text">2.配置所有节点的hosts文件（Master and Node）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-安装YUM源（Master-and-Node）"><span class="toc-number">1.1.0.3.</span> <span class="toc-text">3.安装YUM源（Master and Node）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-关闭系统中不需要的服务-（Master-and-Node）"><span class="toc-number">1.1.0.4.</span> <span class="toc-text">4.关闭系统中不需要的服务 （Master and Node）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-同步时间区（Master-and-Node）"><span class="toc-number">1.1.0.5.</span> <span class="toc-text">5.同步时间区（Master and Node）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-所有节点配置limit（Master-and-Node）"><span class="toc-number">1.1.0.6.</span> <span class="toc-text">6.所有节点配置limit（Master and Node）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-节点之间进行免密（方便后期文件传输）（Master01）"><span class="toc-number">1.1.0.7.</span> <span class="toc-text">7.节点之间进行免密（方便后期文件传输）（Master01）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-下载需要文件（Master01）"><span class="toc-number">1.1.0.8.</span> <span class="toc-text">8. 下载需要文件（Master01）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-内核升级（kubernetes官方认证kernel-v4-19）（Master-and-Node）"><span class="toc-number">1.1.0.9.</span> <span class="toc-text">9.内核升级（kubernetes官方认证kernel v4.19）（Master and Node）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-节点安装ipvs（Master-and-Node）"><span class="toc-number">1.1.0.10.</span> <span class="toc-text">10.节点安装ipvs（Master and Node）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-配置k8s集群中必须的内核参数-Master-and-Node"><span class="toc-number">1.1.0.11.</span> <span class="toc-text">11. 配置k8s集群中必须的内核参数(Master and Node)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-重启服务器"><span class="toc-number">1.1.0.12.</span> <span class="toc-text">12.重启服务器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二丶基本组件安装"><span class="toc-number">1.2.</span> <span class="toc-text">二丶基本组件安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-安装Rumtime（Master-and-Node）"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">1.安装Rumtime（Master and Node）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Kubernetes组件及etcd安装-Master01"><span class="toc-number">1.2.0.2.</span> <span class="toc-text">2.Kubernetes组件及etcd安装(Master01)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-创建cni的目录（Master-and-Node）"><span class="toc-number">1.2.0.3.</span> <span class="toc-text">3.创建cni的目录（Master and Node）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三丶生成证书"><span class="toc-number">1.3.</span> <span class="toc-text">三丶生成证书</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-下载kubernetes证书（Master01）"><span class="toc-number">1.3.0.1.</span> <span class="toc-text">1.下载kubernetes证书（Master01）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-生成etcd的证书"><span class="toc-number">1.3.0.2.</span> <span class="toc-text">2.生成etcd的证书</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-Master01执行"><span class="toc-number">1.3.0.2.0.1.</span> <span class="toc-text">(1)Master01执行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-生成kubernetes组件证书（Master01）"><span class="toc-number">1.3.0.3.</span> <span class="toc-text">3.生成kubernetes组件证书（Master01）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-生成根证书，然后根据根证书生成其他组件证书。"><span class="toc-number">1.3.0.3.0.1.</span> <span class="toc-text">(1)生成根证书，然后根据根证书生成其他组件证书。</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-生成apiserver证书"><span class="toc-number">1.3.0.3.0.2.</span> <span class="toc-text">(2)生成apiserver证书</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-生成controller-manage的证书-资源控制器-（Master01）"><span class="toc-number">1.3.0.4.</span> <span class="toc-text">4.生成controller-manage的证书(资源控制器)（Master01）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-生成kube-scheduler证书（Master01）"><span class="toc-number">1.3.0.5.</span> <span class="toc-text">5.生成kube-scheduler证书（Master01）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-生成管理员证书，生成管理员权限（Master01）"><span class="toc-number">1.3.0.6.</span> <span class="toc-text">6. 生成管理员证书，生成管理员权限（Master01）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-生成密钥对（Master01）"><span class="toc-number">1.3.0.7.</span> <span class="toc-text">7.生成密钥对（Master01）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四丶etcd组件配置"><span class="toc-number">1.4.</span> <span class="toc-text">四丶etcd组件配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Master01配置"><span class="toc-number">1.4.0.1.</span> <span class="toc-text">(1)Master01配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Master02配置"><span class="toc-number">1.4.0.2.</span> <span class="toc-text">(2)Master02配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Master03配置"><span class="toc-number">1.4.0.3.</span> <span class="toc-text">(3)Master03配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-三台master创建service文件"><span class="toc-number">1.4.0.4.</span> <span class="toc-text">(4)三台master创建service文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-三台Master节点创建etcd的证书目录"><span class="toc-number">1.4.0.5.</span> <span class="toc-text">(5)三台Master节点创建etcd的证书目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-三台Master节点查看etcd状态"><span class="toc-number">1.4.0.6.</span> <span class="toc-text">(6)三台Master节点查看etcd状态</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五丶二进制集群高可用配置（三台Master节点；haproxy和keepalived）"><span class="toc-number">1.5.</span> <span class="toc-text">五丶二进制集群高可用配置（三台Master节点；haproxy和keepalived）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-三台Master节点安装haproxy和keepalived"><span class="toc-number">1.5.0.1.</span> <span class="toc-text">1.三台Master节点安装haproxy和keepalived</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-三台Master节点配置haproxy"><span class="toc-number">1.5.0.2.</span> <span class="toc-text">2.三台Master节点配置haproxy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-三台Master配置keepalived"><span class="toc-number">1.5.0.3.</span> <span class="toc-text">3. 三台Master配置keepalived</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#（1）Master01"><span class="toc-number">1.5.0.3.0.1.</span> <span class="toc-text">（1）Master01</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#（2）Master02"><span class="toc-number">1.5.0.3.0.2.</span> <span class="toc-text">（2）Master02</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#（3）Master03"><span class="toc-number">1.5.0.3.0.3.</span> <span class="toc-text">（3）Master03</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-健康检查配置脚本（三台Master节点）"><span class="toc-number">1.5.0.4.</span> <span class="toc-text">4.健康检查配置脚本（三台Master节点）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-启动haproxy和keepalived，并检查VIP-三台Master"><span class="toc-number">1.5.0.5.</span> <span class="toc-text">5.启动haproxy和keepalived，并检查VIP(三台Master)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六丶Kubernetes-Master节点组件安装"><span class="toc-number">1.6.</span> <span class="toc-text">六丶Kubernetes Master节点组件安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-所有节点创建配置文件目录（Master-and-Node）-service文件目录，kebernetes配置文件所在目录"><span class="toc-number">1.6.0.1.</span> <span class="toc-text">1. 所有节点创建配置文件目录（Master and Node）(service文件目录，kebernetes配置文件所在目录)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-apiserver配置"><span class="toc-number">1.6.0.2.</span> <span class="toc-text">2.apiserver配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-Master01"><span class="toc-number">1.6.0.2.0.1.</span> <span class="toc-text">(1)Master01</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-Master02"><span class="toc-number">1.6.0.2.0.2.</span> <span class="toc-text">(2)Master02</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-Master03"><span class="toc-number">1.6.0.2.0.3.</span> <span class="toc-text">(3)Master03</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-所有Master节点启动apiserver"><span class="toc-number">1.6.0.2.0.4.</span> <span class="toc-text">(4)所有Master节点启动apiserver</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-kube-controller-manager配置（三台Master）"><span class="toc-number">1.6.0.3.</span> <span class="toc-text">3. kube-controller-manager配置（三台Master）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-三台Master配置（同时执行，配置相同）"><span class="toc-number">1.6.0.3.0.1.</span> <span class="toc-text">(1)三台Master配置（同时执行，配置相同）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-三台Master节点启动kube-controller-manager"><span class="toc-number">1.6.0.3.0.2.</span> <span class="toc-text">(2)三台Master节点启动kube-controller-manager</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-Master节点配置-kube-scheduler（三台Master节点）"><span class="toc-number">1.6.0.4.</span> <span class="toc-text">4. Master节点配置 kube-scheduler（三台Master节点）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七丶TLS-Bootstrapping配置（Master01）"><span class="toc-number">1.7.</span> <span class="toc-text">七丶TLS Bootstrapping配置（Master01）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Node节点配置"><span class="toc-number">1.8.</span> <span class="toc-text">1.Node节点配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-传输其他节点所需要的证书（聚合证书，根证书，bootstrap证书）"><span class="toc-number">1.8.1.</span> <span class="toc-text">(1)传输其他节点所需要的证书（聚合证书，根证书，bootstrap证书）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-kubelet配置-Master-and-Node"><span class="toc-number">1.8.2.</span> <span class="toc-text">(2)kubelet配置(Master and Node)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-kubelet配置文件编写-master-and-node"><span class="toc-number">1.8.3.</span> <span class="toc-text">(3)kubelet配置文件编写(master and node)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-kube-proxy配置（Master01）"><span class="toc-number">1.9.</span> <span class="toc-text">2.kube-proxy配置（Master01）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-kube-proxy配置创建"><span class="toc-number">1.9.0.0.0.1.</span> <span class="toc-text">(1)kube-proxy配置创建</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-所有节点添加kube-proxy的配置和service文件（Master-and-Node）"><span class="toc-number">1.9.0.0.0.2.</span> <span class="toc-text">(2)所有节点添加kube-proxy的配置和service文件（Master and Node）</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#八丶安装Calico（Master01）"><span class="toc-number">1.10.</span> <span class="toc-text">八丶安装Calico（Master01）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#九丶安装CoreDNS"><span class="toc-number">1.11.</span> <span class="toc-text">九丶安装CoreDNS</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-安装官方推荐版本"><span class="toc-number">1.11.0.0.0.1.</span> <span class="toc-text">(1)安装官方推荐版本</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-或者安装最新版"><span class="toc-number">1.11.0.0.0.2.</span> <span class="toc-text">(2)或者安装最新版</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十丶安装Metrics-Server"><span class="toc-number">1.12.</span> <span class="toc-text">十丶安装Metrics Server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十一丶Dashboard"><span class="toc-number">1.13.</span> <span class="toc-text">十一丶Dashboard</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十二丶集群验证"><span class="toc-number">1.14.</span> <span class="toc-text">十二丶集群验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十三、kube-master的组件状态"><span class="toc-number">1.15.</span> <span class="toc-text">十三、kube-master的组件状态</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://l66stbz.github.io/2024/09/15/kubernetes 二进制高可用安装部署（v1.23+）/kubernetes 二进制高可用安装部署（v1.23+）/1.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">L66</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/photo/"><i class="fa-fw fa fa-film"></i><span> Photo</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">kubernetes 二进制高可用安装部署（v1.23+）</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2024-09-15 21:50:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2024-09-15</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2024-09-26 20:43:00"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2024-09-26</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="kubernetes-二进制高可用安装部署（v1-23-）"><a href="#kubernetes-二进制高可用安装部署（v1-23-）" class="headerlink" title="kubernetes 二进制高可用安装部署（v1.23+）"></a>kubernetes 二进制高可用安装部署（v1.23+）</h1><p>[TOC]</p>
<h2 id="一丶高可用集群划分"><a href="#一丶高可用集群划分" class="headerlink" title="一丶高可用集群划分"></a><strong>一丶高可用集群划分</strong></h2><h4 id="1-集群规划"><a href="#1-集群规划" class="headerlink" title="1. 集群规划"></a>1. 集群规划</h4><table>
<thead>
<tr>
<th>配置信息</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>系统版本</td>
<td>CentOS 7.9</td>
</tr>
<tr>
<td>Docker版本</td>
<td>20.10.x</td>
</tr>
<tr>
<td>Pod网段</td>
<td>172.16.0.0/16</td>
</tr>
<tr>
<td>Service网段</td>
<td>10.96.0.0/16</td>
</tr>
</tbody></table>
<p>⚠️ <strong><em>宿主机网段、K8s Service网段、Pod网段不能重复</em></strong></p>
<table>
<thead>
<tr>
<th>role</th>
<th>ipaddress</th>
<th>configure</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master-lb   (VIP )</td>
<td>192.168.174.66</td>
<td></td>
</tr>
<tr>
<td>k8s-master-01（etcd haproxy keepalived)</td>
<td>192.168.174.30</td>
<td>4 core, 4Gb; 50GBS, CentOS 7.9</td>
</tr>
<tr>
<td>k8s-master-02（etcd haproxy keepalived)</td>
<td>192.168.174.31</td>
<td>4 core, 4Gb; 50GBS, CentOS 7.9</td>
</tr>
<tr>
<td>k8s-master-03（etcd haproxy keepalived)</td>
<td>192.168.174.32</td>
<td>4 core, 4Gb; 50GBS, CentOS 7.9</td>
</tr>
<tr>
<td>k8s-worker-01</td>
<td>192.168.174.40</td>
<td>4 core, 16Gb; 100GBS, CentOS 7.9</td>
</tr>
<tr>
<td>k8s-worker-02</td>
<td>192.168.174.41</td>
<td>4 core, 16Gb; 100GBS, CentOS 7.9</td>
</tr>
</tbody></table>
<p><strong>⚠️Master节点的IP地址尽量不要和Node节点一个网段，方便后期因为业务增长Node节点需要扩充（如master节点192.168.100.10段，node节点192.168.100.20段）</strong></p>
<h4 id="2-配置所有节点的hosts文件（Master-and-Node）"><a href="#2-配置所有节点的hosts文件（Master-and-Node）" class="headerlink" title="2.配置所有节点的hosts文件（Master and Node）"></a>2.配置所有节点的hosts文件（Master and Node）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://gitee.com/BRWYZ/kubernetes_install.git</span><br><span class="line"></span><br><span class="line">$ cat &lt;&lt;-EOF &gt;&gt;/etc/hosts</span><br><span class="line">192.168.174.66     k8s-lb</span><br><span class="line">192.168.174.30     k8s-master01</span><br><span class="line">192.168.174.31     k8s-master02</span><br><span class="line">192.168.174.32     k8s-master03</span><br><span class="line">192.168.174.40     k8s-node01</span><br><span class="line">192.168.174.41     k8s-node02</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="3-安装YUM源（Master-and-Node）"><a href="#3-安装YUM源（Master-and-Node）" class="headerlink" title="3.安装YUM源（Master and Node）"></a>3.安装YUM源（Master and Node）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 下载阿里云的YUM源</span></span><br><span class="line">$ sed -e <span class="string">'s|^mirrorlist=|#mirrorlist=|g'</span> \</span><br><span class="line">    -e <span class="string">'s|^#baseurl=http://mirror.centos.org/centos|baseurl=https://mirrors.ustc.edu.cn/centos|g'</span> \</span><br><span class="line">    -i.bak \</span><br><span class="line">    /etc/yum.repos.d/CentOS-Base.repo</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 安装插件</span></span><br><span class="line">$ yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 安装Docker源并修改安装地址</span></span><br><span class="line">$ yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 安装epel源</span></span><br><span class="line">$ yum -y install epel-release</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 安装工具</span></span><br><span class="line">$ yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git install ipvsadm ipset sysstat conntrack libseccomp  -y</span><br></pre></td></tr></table></figure>

<h4 id="4-关闭系统中不需要的服务-（Master-and-Node）"><a href="#4-关闭系统中不需要的服务-（Master-and-Node）" class="headerlink" title="4.关闭系统中不需要的服务 （Master and Node）"></a>4.关闭系统中不需要的服务 （Master and Node）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 关闭防火墙</span></span><br><span class="line">systemctl <span class="built_in">disable</span> --now firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 关闭安全策略</span></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/sysconfig/selinux</span><br><span class="line">sed -i <span class="string">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 关闭dnsmasq（关闭失败报错正常）</span></span><br><span class="line">systemctl <span class="built_in">disable</span> --now dnsmasq</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 关闭NetworkManager</span></span><br><span class="line">systemctl <span class="built_in">disable</span> --now NetworkManager</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 关闭swap分区</span></span><br><span class="line">swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</span><br><span class="line">sed -ri <span class="string">'/^[^#]*swap/s@^@#@'</span> /etc/fstab</span><br></pre></td></tr></table></figure>

<h4 id="5-同步时间区（Master-and-Node）"><a href="#5-同步时间区（Master-and-Node）" class="headerlink" title="5.同步时间区（Master and Node）"></a>5.同步时间区（Master and Node）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 下载同步时间服务,etcd集群同步需要</span></span><br><span class="line">$ yum install -y ntpdate</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 每五分钟执行一次</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"*/5 * * * *        ntpdate -b ntp.aliyun.com"</span> &gt;&gt;/var/spool/cron/root</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 修改地区</span></span><br><span class="line">$ ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'Asia/Shanghai'</span> &gt;/etc/timezone</span><br></pre></td></tr></table></figure>

<h4 id="6-所有节点配置limit（Master-and-Node）"><a href="#6-所有节点配置limit（Master-and-Node）" class="headerlink" title="6.所有节点配置limit（Master and Node）"></a>6.所有节点配置limit（Master and Node）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 修改limit</span></span><br><span class="line"><span class="built_in">ulimit</span> -SHn 65535</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 加入开机自启</span></span><br><span class="line">cat &lt;&lt;-EOF &gt;&gt;/etc/security/limits.conf</span><br><span class="line">* soft nofile 655360</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft nproc 655350</span><br><span class="line">* hard nproc 655350</span><br><span class="line">* soft memlock unlimited</span><br><span class="line">* hard memlock unlimited</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="7-节点之间进行免密（方便后期文件传输）（Master01）"><a href="#7-节点之间进行免密（方便后期文件传输）（Master01）" class="headerlink" title="7.节点之间进行免密（方便后期文件传输）（Master01）"></a>7.节点之间进行免密（方便后期文件传输）（Master01）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 生成公钥和私钥</span></span><br><span class="line">$ ssh-keygen -t rsa</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 传送公钥</span></span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> k8s-master02 k8s-master03 k8s-node01 k8s-node02;<span class="keyword">do</span> ssh-copy-id -i .ssh/id_rsa.pub <span class="variable">$i</span>;<span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h4 id="8-下载需要文件（Master01）"><a href="#8-下载需要文件（Master01）" class="headerlink" title="8. 下载需要文件（Master01）"></a>8. 下载需要文件（Master01）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/</span><br><span class="line">$ git <span class="built_in">clone</span> git@gitee.com:BRWYZ/kubernetes_install.git</span><br><span class="line">$ <span class="built_in">cd</span> kubernetes_install</span><br></pre></td></tr></table></figure>

<h4 id="9-内核升级（kubernetes官方认证kernel-v4-19）（Master-and-Node）"><a href="#9-内核升级（kubernetes官方认证kernel-v4-19）（Master-and-Node）" class="headerlink" title="9.内核升级（kubernetes官方认证kernel v4.19）（Master and Node）"></a>9.内核升级（kubernetes官方认证kernel v4.19）（Master and Node）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 升级rpm包除内核外</span></span><br><span class="line">$ yum update -y --exclude=kernel*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 传输内核包</span></span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> k8s-master02 k8s-master03 k8s-node01 k8s-node02;<span class="keyword">do</span> scp kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm <span class="variable">$i</span>:/root/ ; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 所有节点安装内核包</span></span><br><span class="line">$ yum localinstall -y kernel-ml*</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 所有节点更改内核启动顺序</span></span><br><span class="line">$ grub2-set-default  0 &amp;&amp; grub2-mkconfig -o /etc/grub2.cfg</span><br><span class="line">$ grubby --args=<span class="string">"user_namespace.enable=1"</span> --update-kernel=<span class="string">"<span class="variable">$(grubby --default-kernel)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看内核版本是否改变</span></span><br><span class="line">$ grubby --default-kernel </span><br><span class="line"> /boot/vmlinuz-4.19.12-1.el7.elrepo.x86_64</span><br></pre></td></tr></table></figure>

<h4 id="10-节点安装ipvs（Master-and-Node）"><a href="#10-节点安装ipvs（Master-and-Node）" class="headerlink" title="10.节点安装ipvs（Master and Node）"></a>10.节点安装ipvs（Master and Node）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 各个节点配置ipvs模块，内核4.19+版本nf_conntrack_ipv4已经改为nf_conntrack，4.18以下使用nf_conntrack_ipv4。</span></span><br><span class="line">$ modprobe -- ip_vs</span><br><span class="line">  modprobe -- ip_vs_rr</span><br><span class="line">  modprobe -- ip_vs_wrr</span><br><span class="line">  modprobe -- ip_vs_sh</span><br><span class="line">  modprobe -- nf_conntrack</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 添加到开机自启</span></span><br><span class="line">$ cat &lt;&lt;-EOF &gt;&gt;/etc/modules-load.d/ipvs.conf</span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_lc</span><br><span class="line">ip_vs_wlc</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_lblc</span><br><span class="line">ip_vs_lblcr</span><br><span class="line">ip_vs_dh</span><br><span class="line">ip_vs_sh</span><br><span class="line">ip_vs_fo</span><br><span class="line">ip_vs_nq</span><br><span class="line">ip_vs_sed</span><br><span class="line">ip_vs_ftp</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br><span class="line">ip_tables</span><br><span class="line">ip_set</span><br><span class="line">xt_set</span><br><span class="line">ipt_set</span><br><span class="line">ipt_rpfilter</span><br><span class="line">ipt_REJECT</span><br><span class="line">ipip</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 启动服务(启动报错忽略)</span></span><br><span class="line">$ systemctl <span class="built_in">enable</span> --now systemd-modules-load.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看是否加载</span></span><br><span class="line">$ lsmod | grep -e ip_vs -e nf_conntrack</span><br><span class="line">nf_conntrack_ipv4      16384  23 </span><br><span class="line">nf_defrag_ipv4         16384  1 nf_conntrack_ipv4</span><br><span class="line">nf_conntrack          135168  10 xt_conntrack,nf_conntrack_ipv6,nf_conntrack_ipv4,nf_nat,nf_nat_ipv6,ipt_MASQUERADE,nf_nat_ipv4,xt_nat,nf_conntrack_netlink,ip_vs</span><br></pre></td></tr></table></figure>

<h4 id="11-配置k8s集群中必须的内核参数-Master-and-Node"><a href="#11-配置k8s集群中必须的内核参数-Master-and-Node" class="headerlink" title="11. 配置k8s集群中必须的内核参数(Master and Node)"></a>11. 配置k8s集群中必须的内核参数(Master and Node)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line">net.ipv4.conf.all.route_localnet = 1</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_watches=89100</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">net.ipv4.tcp_keepalive_time = 600</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.tcp_keepalive_intvl =15</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 36000</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_max_orphans = 327680</span><br><span class="line">net.ipv4.tcp_orphan_retries = 3</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line">net.ipv4.ip_conntrack_max = 65536</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line">net.ipv4.tcp_timestamps = 0</span><br><span class="line">net.core.somaxconn = 16384</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 加载参数</span></span><br><span class="line">$ sysctl --system</span><br></pre></td></tr></table></figure>

<h4 id="12-重启服务器"><a href="#12-重启服务器" class="headerlink" title="12.重启服务器"></a>12.重启服务器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ reboot</span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看内核是否加载</span></span><br><span class="line">$ lsmod | grep --color=auto -e ip_vs -e nf_conntrack</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># lsmod | grep --color=auto -e ip_vs -e nf_conntrack</span></span><br><span class="line">ip_vs_ftp              16384  0 </span><br><span class="line">nf_nat                 32768  1 ip_vs_ftp</span><br><span class="line">ip_vs_sed              16384  0 </span><br><span class="line">ip_vs_nq               16384  0 </span><br><span class="line">ip_vs_fo               16384  0 </span><br><span class="line">ip_vs_sh               16384  0 </span><br><span class="line">ip_vs_dh               16384  0 </span><br><span class="line">ip_vs_lblcr            16384  0 </span><br><span class="line">ip_vs_lblc             16384  0 </span><br><span class="line">ip_vs_wrr              16384  0 </span><br><span class="line">ip_vs_rr               16384  0 </span><br><span class="line">ip_vs_wlc              16384  0 </span><br><span class="line">ip_vs_lc               16384  0 </span><br><span class="line">ip_vs                 151552  24 ip_vs_wlc,ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_fo,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed,ip_vs_ftp</span><br><span class="line">nf_conntrack          143360  2 nf_nat,ip_vs</span><br><span class="line">nf_defrag_ipv6         20480  1 nf_conntrack</span><br><span class="line">nf_defrag_ipv4         16384  1 nf_conntrack</span><br><span class="line">libcrc32c              16384  4 nf_conntrack,nf_nat,xfs,ip_vs</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二丶基本组件安装"><a href="#二丶基本组件安装" class="headerlink" title="二丶基本组件安装"></a><strong>二丶基本组件安装</strong></h2><h4 id="1-安装Rumtime（Master-and-Node）"><a href="#1-安装Rumtime（Master-and-Node）" class="headerlink" title="1.安装Rumtime（Master and Node）"></a>1.安装Rumtime（Master and Node）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 查看docker版本</span></span><br><span class="line">$ yum list docker-ce.x86_64 --showduplicates | sort -r</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 所有节点安装docker-ce-20.10</span></span><br><span class="line">$ yum install docker-ce-20.10.* docker-ce-cli-20.10.* containerd.io -y</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 新版Kubelet建议使用systemd，Docker的CgroupDriver也改成systemd</span></span><br><span class="line">$ mkdir /etc/docker</span><br><span class="line">$ cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 重新加载配置文件并启动docker</span></span><br><span class="line">$ systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> --now docker</span><br></pre></td></tr></table></figure>



<h4 id="2-Kubernetes组件及etcd安装-Master01"><a href="#2-Kubernetes组件及etcd安装-Master01" class="headerlink" title="2.Kubernetes组件及etcd安装(Master01)"></a>2.Kubernetes组件及etcd安装(Master01)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 下载kubernetes组件包</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># wget https://dl.k8s.io/v1.23.17/kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 下载etcd的安装包</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># wget https://github.com/etcd-io/etcd/releases/download/v3.5.6/etcd-v3.5.6-linux-amd64.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 解压kubernetes安装包并安装文件</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># ls /usr/local/bin/</span></span><br><span class="line">kube-apiserver  kube-controller-manager  kubectl  kubelet  kube-proxy  kube-scheduler</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 解压etcd安装包并安装文件</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># tar -zxvf etcd-v3.5.6-linux-amd64.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.5.6-linux-amd64/etcd&#123;,ctl&#125;</span></span><br><span class="line">etcd-v3.5.6-linux-amd64/etcdctl</span><br><span class="line">etcd-v3.5.6-linux-amd64/etcd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看kubelet和etcd版本信息</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubelet --version</span></span><br><span class="line">Kubernetes v1.23.16</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># etcd --version</span></span><br><span class="line">etcd Version: 3.5.6</span><br><span class="line">Git SHA: cecbe35ce</span><br><span class="line">Go Version: go1.16.15</span><br><span class="line">Go OS/Arch: linux/amd64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 将文件传输给其他节点</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># MasterNodes='k8s-master02 k8s-master03'</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># WorkNodes='k8s-node01 k8s-node02'</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># for NODE in $MasterNodes; do echo $NODE; scp /usr/local/bin/kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125; $NODE:/usr/local/bin/; scp /usr/local/bin/etcd* $NODE:/usr/local/bin/; done</span></span><br><span class="line">k8s-master02</span><br><span class="line">kubelet                                                              100%  114MB  22.7MB/s   00:05    </span><br><span class="line">kubectl                                                              100%   43MB  30.6MB/s   00:01    </span><br><span class="line">kube-apiserver                                                       100%  120MB  30.0MB/s   00:04    </span><br><span class="line">kube-controller-manager                                              100%  111MB  30.1MB/s   00:03    </span><br><span class="line">kube-scheduler                                                       100%   46MB  21.1MB/s   00:02    </span><br><span class="line">kube-proxy                                                           100%   41MB  25.6MB/s   00:01    </span><br><span class="line">etcd                                                                 100%   23MB  32.0MB/s   00:00    </span><br><span class="line">etcdctl                                                              100%   17MB  32.8MB/s   00:00    </span><br><span class="line">k8s-master03</span><br><span class="line">kubelet                                                              100%  114MB  25.0MB/s   00:04    </span><br><span class="line">kubectl                                                              100%   43MB  24.1MB/s   00:01    </span><br><span class="line">kube-apiserver                                                       100%  120MB  33.6MB/s   00:03    </span><br><span class="line">kube-controller-manager                                              100%  111MB  31.3MB/s   00:03    </span><br><span class="line">kube-scheduler                                                       100%   46MB  22.9MB/s   00:02    </span><br><span class="line">kube-proxy                                                           100%   41MB  24.3MB/s   00:01    </span><br><span class="line">etcd                                                                 100%   23MB  22.6MB/s   00:01    </span><br><span class="line">etcdctl                                                              100%   17MB  26.3MB/s   00:00    </span><br><span class="line"></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># for NODE in $WorkNodes; do  scp /usr/local/bin/kube&#123;let,-proxy&#125; $NODE:/usr/local/bin/; done</span></span><br><span class="line">kubelet                                                              100%  114MB  33.6MB/s   00:03    </span><br><span class="line">kube-proxy                                                           100%   41MB  40.7MB/s   00:01    </span><br><span class="line">kubelet                                                              100%  114MB  29.6MB/s   00:03    </span><br><span class="line">kube-proxy                                                           100%   41MB  37.3MB/s   00:01</span><br></pre></td></tr></table></figure>

<h4 id="3-创建cni的目录（Master-and-Node）"><a href="#3-创建cni的目录（Master-and-Node）" class="headerlink" title="3.创建cni的目录（Master and Node）"></a>3.创建cni的目录（Master and Node）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 创建目录(calion需要用到)</span></span><br><span class="line">$ mkdir -p /opt/cni/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; Master01切换分支</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/kubernetes_install &amp;&amp;  git checkout v1.23+</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三丶生成证书"><a href="#三丶生成证书" class="headerlink" title="三丶生成证书"></a>三丶生成证书</h2><h4 id="1-下载kubernetes证书（Master01）"><a href="#1-下载kubernetes证书（Master01）" class="headerlink" title="1.下载kubernetes证书（Master01）"></a>1.下载kubernetes证书（Master01）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 下载证书</span></span><br><span class="line">$ wget <span class="string">"https://pkg.cfssl.org/R1.2/cfssl_linux-amd64"</span> -O /usr/<span class="built_in">local</span>/bin/cfssl</span><br><span class="line"></span><br><span class="line">$ wget <span class="string">"https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64"</span> -O /usr/<span class="built_in">local</span>/bin/cfssljson</span><br><span class="line"></span><br><span class="line">https://github.com/cloudflare/cfssl/releases/download/1.2.0/cfssl_linux-amd64</span><br><span class="line"></span><br><span class="line">https://github.com/cloudflare/cfssl/releases/download/1.2.0/cfssljson_linux-amd64</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 添加执行权限</span></span><br><span class="line">$ chmod +x /usr/<span class="built_in">local</span>/bin/cfssl /usr/<span class="built_in">local</span>/bin/cfssljson</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># mv cfssl_linux-amd64 /usr/local/bin/cfssl</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson</span></span><br></pre></td></tr></table></figure>

<h4 id="2-生成etcd的证书"><a href="#2-生成etcd的证书" class="headerlink" title="2.生成etcd的证书"></a>2.生成etcd的证书</h4><p><strong>集群内部的通讯，ipaserver连接etcd的证书，类似于传统的公钥私钥的解密加密</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 所有master节点创建etcd的证书目录</span></span><br><span class="line">$ mkdir /etc/etcd/ssl -p</span><br><span class="line">$ ll /etc/etcd/ssl/</span><br><span class="line">总用量 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建kubernetes放置证书目录，全部节点master节点以及node节点</span></span><br><span class="line">$ mkdir -p /etc/kubernetes/pki</span><br><span class="line">$ ll /etc/kubernetes/pki/</span><br><span class="line">总用量 0</span><br></pre></td></tr></table></figure>

<h6 id="1-Master01执行"><a href="#1-Master01执行" class="headerlink" title="(1)Master01执行"></a>(1)Master01执行</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 切换工作目录</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># cd /root/kubernetes_install/pki/</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># ls</span></span><br><span class="line">admin-csr.json      ca-csr.json       front-proxy-ca-csr.json      kube-proxy-csr.json</span><br><span class="line">apiserver-csr.json  etcd-ca-csr.json  front-proxy-client-csr.json  manager-csr.json</span><br><span class="line">ca-config.json      etcd-csr.json     kubelet-csr.json             scheduler-csr.json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 生成etcd CA证书和CA证书的key，根证书</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca</span></span><br><span class="line">2024/06/16 00:58:35 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2024/06/16 00:58:35 [INFO] generate received request</span><br><span class="line">2024/06/16 00:58:35 [INFO] received CSR</span><br><span class="line">2024/06/16 00:58:35 [INFO] generating key: rsa-2048</span><br><span class="line">2024/06/16 00:58:36 [INFO] encoded CSR</span><br><span class="line">2024/06/16 00:58:36 [INFO] signed certificate with serial number 667846601631781419691753527881959005353534436105</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 生成客户端密钥</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># cfssl gencert \</span></span><br><span class="line">    -ca=/etc/etcd/ssl/etcd-ca.pem \</span><br><span class="line">    -ca-key=/etc/etcd/ssl/etcd-ca-key.pem \</span><br><span class="line">    -config=ca-config.json \</span><br><span class="line">    -hostname=127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.174.30,192.168.174.31,192.168.174.32 \</span><br><span class="line">    -profile=kubernetes \</span><br><span class="line">    etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd</span><br><span class="line">2024/06/16 01:03:08 [INFO] generate received request</span><br><span class="line">2024/06/16 01:03:08 [INFO] received CSR</span><br><span class="line">2024/06/16 01:03:08 [INFO] generating key: rsa-2048</span><br><span class="line">2024/06/16 01:03:09 [INFO] encoded CSR</span><br><span class="line">2024/06/16 01:03:09 [INFO] signed certificate with serial number 169670736440422945332067825308657235294205909760</span><br><span class="line"></span><br><span class="line">⚠️: 如果etcd没有部署在kubernetes的Master节点上，注意修改主机名和IP地址，如果将来需要增加etcd节点，可以提前滞留几个IP地址，方便后期使用</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看生成的证书</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># ls /etc/etcd/ssl/</span></span><br><span class="line">etcd-ca.csr  etcd-ca-key.pem  etcd-ca.pem  etcd.csr  etcd-key.pem  etcd.pem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 将etcd的证书传输给其他Master节点</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># MasterNodes='k8s-master02 k8s-master03'</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># WorkNodes='k8s-node01 k8s-node02'</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># echo $MasterNodes $WorkNodes</span></span><br><span class="line">k8s-master02 k8s-master03 k8s-node01 k8s-node02</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$MasterNodes</span>; <span class="keyword">do</span></span><br><span class="line">     ssh <span class="variable">$NODE</span> <span class="string">"mkdir -p /etc/etcd/ssl"</span></span><br><span class="line">     <span class="keyword">for</span> FILE <span class="keyword">in</span> etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem; <span class="keyword">do</span></span><br><span class="line">       scp /etc/etcd/ssl/<span class="variable">$&#123;FILE&#125;</span> <span class="variable">$NODE</span>:/etc/etcd/ssl/<span class="variable">$&#123;FILE&#125;</span></span><br><span class="line">     <span class="keyword">done</span></span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line"> </span><br><span class="line">etcd-ca-key.pem                                                      100% 1675   793.9KB/s   00:00    </span><br><span class="line">etcd-ca.pem                                                          100% 1367   889.8KB/s   00:00    </span><br><span class="line">etcd-key.pem                                                         100% 1675   802.4KB/s   00:00    </span><br><span class="line">etcd.pem                                                             100% 1509     1.0MB/s   00:00    </span><br><span class="line">etcd-ca-key.pem                                                      100% 1675   740.1KB/s   00:00    </span><br><span class="line">etcd-ca.pem                                                          100% 1367   878.3KB/s   00:00    </span><br><span class="line">etcd-key.pem                                                         100% 1675   565.2KB/s   00:00    </span><br><span class="line">etcd.pem                                                             100% 1509     1.1MB/s   00:00</span><br></pre></td></tr></table></figure>

<h4 id="3-生成kubernetes组件证书（Master01）"><a href="#3-生成kubernetes组件证书（Master01）" class="headerlink" title="3.生成kubernetes组件证书（Master01）"></a>3.生成kubernetes组件证书（Master01）</h4><h6 id="1-生成根证书，然后根据根证书生成其他组件证书。"><a href="#1-生成根证书，然后根据根证书生成其他组件证书。" class="headerlink" title="(1)生成根证书，然后根据根证书生成其他组件证书。"></a>(1)生成根证书，然后根据根证书生成其他组件证书。</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 切换目录</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># cd /root/kubernetes_install/pki</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 生成根证书（统一证书，其他组件的证书都是围绕这个根证书生成了，方便管理，（ca证书））</span></span><br><span class="line">$ cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line"> 	[root@k8s-master01 pki]<span class="comment"># cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca</span></span><br><span class="line">2022/12/05 10:34:00 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2022/12/05 10:34:00 [INFO] generate received request</span><br><span class="line">2022/12/05 10:34:00 [INFO] received CSR</span><br><span class="line">2022/12/05 10:34:00 [INFO] generating key: rsa-2048</span><br><span class="line">2022/12/05 10:34:02 [INFO] encoded CSR</span><br><span class="line">2022/12/05 10:34:02 [INFO] signed certificate with serial number 9045593708449349597042729397661311913120732807</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看证书是否生成</span></span><br><span class="line">$ ls /etc/kubernetes/pki/</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">   [root@k8s-master01 pki]<span class="comment"># ls /etc/kubernetes/pki/</span></span><br><span class="line">ca.csr  ca-key.pem  ca.pem</span><br></pre></td></tr></table></figure>

<h6 id="2-生成apiserver证书"><a href="#2-生成apiserver证书" class="headerlink" title="(2)生成apiserver证书"></a>(2)生成apiserver证书</h6><p>​    <strong>⚠️：10.96.0.1 是k8s service的网段的第一个IP地址，如果说需要更改k8s service网段，那就需要更改10.96.0.1，如果不是高可用集群，<code>192.168.174.66</code>为<code>kube-Master01</code>的IP（修改前请注意网段的掩码位，去掩码计算器计算，查找第一个网段ip，<code>192.168.174.30,192.168.174.31,192.168.174.32为master节点IP</code>）</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 生成证书</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># cfssl gencert -ca=/etc/kubernetes/pki/ca.pem   -ca-key=/etc/kubernetes/pki/ca-key.pem   -config=ca-config.json   -hostname=10.96.0.1,192.168.174.66,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.174.30,192.168.174.31,192.168.174.32  -profile=kubernetes   apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver</span></span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">2024/06/16 01:14:35 [INFO] generate received request</span><br><span class="line">2024/06/16 01:14:35 [INFO] received CSR</span><br><span class="line">2024/06/16 01:14:35 [INFO] generating key: rsa-2048</span><br><span class="line">2024/06/16 01:14:35 [INFO] encoded CSR</span><br><span class="line">2024/06/16 01:14:35 [INFO] signed certificate with serial number 664912171212661285532228936561112324599278915308</span><br><span class="line"><span class="comment"># ⚠️：10.96.0.1 service网段第一个IP地址(10.96.0.0/12)</span></span><br><span class="line"><span class="comment"># ⚠️: 192.168.174.66 keepalived的VIP</span></span><br><span class="line"><span class="comment"># ⚠️: 192.168.174.30 Master01的IP</span></span><br><span class="line"><span class="comment"># ⚠️: 192.168.174.31 Master02的IP</span></span><br><span class="line"><span class="comment"># ⚠️: 192.168.174.32 Master03的IP</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看证书</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># ls /etc/kubernetes/pki/</span></span><br><span class="line">apiserver.csr  apiserver-key.pem  apiserver.pem  ca.csr  ca-key.pem  ca.pem</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 生成apiserver的聚合证书（权限，让第三方组件和kube-apiserver进行通信拿去数据）</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca  </span></span><br><span class="line">	<span class="comment"># 返回结果：</span></span><br><span class="line">2024/06/16 01:17:04 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2024/06/16 01:17:04 [INFO] generate received request</span><br><span class="line">2024/06/16 01:17:04 [INFO] received CSR</span><br><span class="line">2024/06/16 01:17:04 [INFO] generating key: rsa-2048</span><br><span class="line">2024/06/16 01:17:04 [INFO] encoded CSR</span><br><span class="line">2024/06/16 01:17:04 [INFO] signed certificate with serial number 32033324620397301196702805402027812417677313761</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># cfssl gencert   -ca=/etc/kubernetes/pki/front-proxy-ca.pem   -ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem   -config=ca-config.json   -profile=kubernetes   front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client</span></span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">2024/06/16 01:17:32 [INFO] generate received request</span><br><span class="line">2024/06/16 01:17:32 [INFO] received CSR</span><br><span class="line">2024/06/16 01:17:32 [INFO] generating key: rsa-2048</span><br><span class="line">2024/06/16 01:17:32 [INFO] encoded CSR</span><br><span class="line">2024/06/16 01:17:32 [INFO] signed certificate with serial number 82900029194521146603431036490159053268222994590</span><br><span class="line">2024/06/16 01:17:32 [WARNING] This certificate lacks a <span class="string">"hosts"</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (<span class="string">"Information Requirements"</span>).</span><br><span class="line"><span class="comment"># ⚠️: 日志会有警告，忽略不管</span></span><br></pre></td></tr></table></figure>

<h4 id="4-生成controller-manage的证书-资源控制器-（Master01）"><a href="#4-生成controller-manage的证书-资源控制器-（Master01）" class="headerlink" title="4.生成controller-manage的证书(资源控制器)（Master01）"></a>4.生成controller-manage的证书(资源控制器)（Master01）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]<span class="comment"># cfssl gencert \</span></span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">2024/06/16 01:18:12 [INFO] generate received request</span><br><span class="line">2024/06/16 01:18:12 [INFO] received CSR</span><br><span class="line">2024/06/16 01:18:12 [INFO] generating key: rsa-2048</span><br><span class="line">2024/06/16 01:18:13 [INFO] encoded CSR</span><br><span class="line">2024/06/16 01:18:13 [INFO] signed certificate with serial number 118932812530777434694501978675305584566356613164</span><br><span class="line">2024/06/16 01:18:13 [WARNING] This certificate lacks a <span class="string">"hosts"</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (<span class="string">"Information Requirements"</span>).</span><br><span class="line"></span><br><span class="line"><span class="comment"># ⚠️:注意，如果不是高可用集群，192.168.174.66:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 生成kubeconfig文件，用于和kube-apiserver进行通讯，这样controller-manager就会有自己的权限</span></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">     --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">     --embed-certs=<span class="literal">true</span> \</span><br><span class="line">     --server=https://192.168.174.66:8443 \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">Cluster <span class="string">"kubernetes"</span> <span class="built_in">set</span>.</span><br><span class="line">    </span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 设置一个环境项，一个上下文</span></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-context system:kube-controller-manager@kubernetes \</span><br><span class="line">    --cluster=kubernetes \</span><br><span class="line">    --user=system:kube-controller-manager \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">    Context <span class="string">"system:kube-controller-manager@kubernetes"</span> created.</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; set-credentials 设置一个用户项</span></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-credentials system:kube-controller-manager \</span><br><span class="line">     --client-certificate=/etc/kubernetes/pki/controller-manager.pem \</span><br><span class="line">     --client-key=/etc/kubernetes/pki/controller-manager-key.pem \</span><br><span class="line">     --embed-certs=<span class="literal">true</span> \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">	User <span class="string">"system:kube-controller-manager"</span> <span class="built_in">set</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 使用某个环境当做默认环境</span></span><br><span class="line">$ kubectl config use-context system:kube-controller-manager@kubernetes \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">	Switched to context <span class="string">"system:kube-controller-manager@kubernetes"</span>.</span><br></pre></td></tr></table></figure>

<h4 id="5-生成kube-scheduler证书（Master01）"><a href="#5-生成kube-scheduler证书（Master01）" class="headerlink" title="5.生成kube-scheduler证书（Master01）"></a>5.生成kube-scheduler证书（Master01）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">2024/06/16 01:27:38 [INFO] generate received request</span><br><span class="line">2024/06/16 01:27:38 [INFO] received CSR</span><br><span class="line">2024/06/16 01:27:38 [INFO] generating key: rsa-2048</span><br><span class="line">2024/06/16 01:27:39 [INFO] encoded CSR</span><br><span class="line">2024/06/16 01:27:39 [INFO] signed certificate with serial number 50664639108365158483981871397139307380658841542</span><br><span class="line">2024/06/16 01:27:39 [WARNING] This certificate lacks a <span class="string">"hosts"</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (<span class="string">"Information Requirements"</span>).</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ⚠️:注意，如果不是高可用集群，192.168.174.66:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; set-cluster：设置一个集群项</span></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">     --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">     --embed-certs=<span class="literal">true</span> \</span><br><span class="line">     --server=https://192.168.174.66:8443 \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">   Cluster <span class="string">"kubernetes"</span> <span class="built_in">set</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 设置一个环境项，一个上下文</span></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-credentials system:kube-scheduler \</span><br><span class="line">     --client-certificate=/etc/kubernetes/pki/scheduler.pem \</span><br><span class="line">     --client-key=/etc/kubernetes/pki/scheduler-key.pem \</span><br><span class="line">     --embed-certs=<span class="literal">true</span> \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">	User <span class="string">"system:kube-scheduler"</span> <span class="built_in">set</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; set-credentials 设置一个用户项</span></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-context system:kube-scheduler@kubernetes \</span><br><span class="line">     --cluster=kubernetes \</span><br><span class="line">     --user=system:kube-scheduler \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">	Context <span class="string">"system:kube-scheduler@kubernetes"</span> created.</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 使用某个环境当做默认环境</span></span><br><span class="line">$ kubectl config use-context system:kube-scheduler@kubernetes \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">	Switched to context <span class="string">"system:kube-scheduler@kubernetes"</span>.</span><br></pre></td></tr></table></figure>

<h4 id="6-生成管理员证书，生成管理员权限（Master01）"><a href="#6-生成管理员证书，生成管理员权限（Master01）" class="headerlink" title="6. 生成管理员证书，生成管理员权限（Master01）"></a>6. 生成管理员证书，生成管理员权限（Master01）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 生成管理员证书</span></span><br><span class="line">$ cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">2024/06/16 01:29:55 [INFO] generate received request</span><br><span class="line">2024/06/16 01:29:55 [INFO] received CSR</span><br><span class="line">2024/06/16 01:29:55 [INFO] generating key: rsa-2048</span><br><span class="line">2024/06/16 01:29:56 [INFO] encoded CSR</span><br><span class="line">2024/06/16 01:29:56 [INFO] signed certificate with serial number 440866322981709851504705917810067389855632400057</span><br><span class="line">2024/06/16 01:29:56 [WARNING] This certificate lacks a <span class="string">"hosts"</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (<span class="string">"Information Requirements"</span>).</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line"><span class="comment"># ⚠️:注意，如果不是高可用集群，192.168.174.66:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-cluster kubernetes     --certificate-authority=/etc/kubernetes/pki/ca.pem     --embed-certs=<span class="literal">true</span>     --server=https://192.168.174.66:8443     --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line">	<span class="comment"># 执行结果</span></span><br><span class="line">Cluster <span class="string">"kubernetes"</span> <span class="built_in">set</span>.</span><br><span class="line"></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-credentials kubernetes-admin     --client-certificate=/etc/kubernetes/pki/admin.pem     --client-key=/etc/kubernetes/pki/admin-key.pem     --embed-certs=<span class="literal">true</span>     --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">User <span class="string">"kubernetes-admin"</span> <span class="built_in">set</span>.</span><br><span class="line"></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-context kubernetes-admin@kubernetes     --cluster=kubernetes     --user=kubernetes-admin     --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">Context <span class="string">"kubernetes-admin@kubernetes"</span> created.</span><br><span class="line"></span><br><span class="line">$ kubectl config use-context kubernetes-admin@kubernetes     --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">	Switched to context <span class="string">"kubernetes-admin@kubernetes"</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看管理员证书</span></span><br><span class="line">$ ls /etc/kubernetes/</span><br><span class="line">执行结果：</span><br><span class="line">	[root@k8s-master01 pki]<span class="comment"># ls /etc/kubernetes/</span></span><br><span class="line">admin.kubeconfig  controller-manager.kubeconfig  pki  scheduler.kubeconfig</span><br></pre></td></tr></table></figure>

<h4 id="7-生成密钥对（Master01）"><a href="#7-生成密钥对（Master01）" class="headerlink" title="7.生成密钥对（Master01）"></a>7.生成密钥对（Master01）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 生成私钥</span></span><br><span class="line">$ openssl genrsa -out /etc/kubernetes/pki/sa.key 2048</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">...+++</span><br><span class="line">....................................................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line"><span class="comment"># 这个密钥通常用于 Kubernetes 集群中的服务帐户（Service Account）签名，确保服务帐户令牌的安全性。</span></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 生成公钥</span></span><br><span class="line">$ openssl rsa -<span class="keyword">in</span> /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">writing RSA key</span><br><span class="line"><span class="comment"># 在 Kubernetes 中，公钥用于验证服务帐户令牌的签名，确保令牌的真实性和完整性。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 把证书传输到其他master节点</span></span><br><span class="line">$ <span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-master02 k8s-master03; <span class="keyword">do</span> </span><br><span class="line"><span class="keyword">for</span> FILE <span class="keyword">in</span> $(ls /etc/kubernetes/pki | grep -v etcd); <span class="keyword">do</span> </span><br><span class="line">scp /etc/kubernetes/pki/<span class="variable">$&#123;FILE&#125;</span> <span class="variable">$NODE</span>:/etc/kubernetes/pki/<span class="variable">$&#123;FILE&#125;</span>;</span><br><span class="line"><span class="keyword">done</span>; </span><br><span class="line"><span class="keyword">for</span> FILE <span class="keyword">in</span> admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig; <span class="keyword">do</span> </span><br><span class="line">scp /etc/kubernetes/<span class="variable">$&#123;FILE&#125;</span> <span class="variable">$NODE</span>:/etc/kubernetes/<span class="variable">$&#123;FILE&#125;</span>;</span><br><span class="line"><span class="keyword">done</span>;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">admin.csr                                  100% 1025     1.1MB/s   00:00    </span><br><span class="line">admin-key.pem                              100% 1675   819.8KB/s   00:00    </span><br><span class="line">admin.pem                                  100% 1444   672.3KB/s   00:00    </span><br><span class="line">apiserver.csr                              100% 1029   697.6KB/s   00:00    </span><br><span class="line">apiserver-key.pem                          100% 1679     1.9MB/s   00:00    </span><br><span class="line">apiserver.pem                              100% 1692   875.7KB/s   00:00    </span><br><span class="line">ca.csr                                     100% 1025   211.1KB/s   00:00    </span><br><span class="line">ca-key.pem                                 100% 1675   526.1KB/s   00:00    </span><br><span class="line">ca.pem                                     100% 1411     1.3MB/s   00:00    </span><br><span class="line">controller-manager.csr                     100% 1082     1.5MB/s   00:00    </span><br><span class="line">controller-manager-key.pem                 100% 1679   594.2KB/s   00:00    </span><br><span class="line">controller-manager.pem                     100% 1501   767.7KB/s   00:00    </span><br><span class="line">front-proxy-ca.csr                         100%  891   255.3KB/s   00:00    </span><br><span class="line">front-proxy-ca-key.pem                     100% 1679   626.4KB/s   00:00    </span><br><span class="line">front-proxy-ca.pem                         100% 1143   898.6KB/s   00:00    </span><br><span class="line">front-proxy-client.csr                     100%  903   363.8KB/s   00:00    </span><br><span class="line">front-proxy-client-key.pem                 100% 1675     1.2MB/s   00:00    </span><br><span class="line">front-proxy-client.pem                     100% 1188   692.6KB/s   00:00    </span><br><span class="line">sa.key                                     100% 1675     1.8MB/s   00:00    </span><br><span class="line">sa.pub                                     100%  451   313.4KB/s   00:00    </span><br><span class="line">scheduler.csr                              100% 1058     1.3MB/s   00:00    </span><br><span class="line">scheduler-key.pem                          100% 1679   640.1KB/s   00:00    </span><br><span class="line">scheduler.pem                              100% 1476     1.4MB/s   00:00    </span><br><span class="line">admin.kubeconfig                           100% 6451     2.5MB/s   00:00    </span><br><span class="line">controller-manager.kubeconfig              100% 6587     7.2MB/s   00:00    </span><br><span class="line">scheduler.kubeconfig                       100% 6515     3.3MB/s   00:00    </span><br><span class="line">          </span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看证书</span></span><br><span class="line">$ ls /etc/kubernetes/pki/</span><br><span class="line">admin.csr      apiserver.csr      ca.csr      controller-manager.csr      front-proxy-ca.csr      front-proxy-client.csr      sa.key         scheduler-key.pem</span><br><span class="line">admin-key.pem  apiserver-key.pem  ca-key.pem  controller-manager-key.pem  front-proxy-ca-key.pem  front-proxy-client-key.pem  sa.pub         scheduler.pem</span><br><span class="line">admin.pem      apiserver.pem      ca.pem      controller-manager.pem      front-proxy-ca.pem      front-proxy-client.pem      scheduler.csr</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看所有节点证书数量</span></span><br><span class="line">$ ls /etc/kubernetes/pki/ |wc -l</span><br><span class="line"> 23</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四丶etcd组件配置"><a href="#四丶etcd组件配置" class="headerlink" title="四丶etcd组件配置"></a>四丶etcd组件配置</h2><p><strong>由于二进制部署kubernetes集群是以Linux中<code>守护进程</code>的方式启动，需要配置service文件；etcd配置大致相同，注意修改每个Master节点的etcd配置的主机名和IP地址</strong></p>
<h4 id="1-Master01配置"><a href="#1-Master01配置" class="headerlink" title="(1)Master01配置"></a>(1)Master01配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/etcd/etcd.config.yml</span><br><span class="line"></span><br><span class="line">name: <span class="string">'k8s-master01'</span></span><br><span class="line">data-dir: /var/lib/etcd</span><br><span class="line">wal-dir: /var/lib/etcd/wal</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: <span class="string">'https://192.168.174.30:2380'</span></span><br><span class="line">listen-client-urls: <span class="string">'https://192.168.174.30:2379,http://127.0.0.1:2379'</span></span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: <span class="string">'https://192.168.174.30:2380'</span><span class="comment">#集群通讯</span></span><br><span class="line">advertise-client-urls: <span class="string">'https://192.168.174.30:2379'</span><span class="comment">#客户端连接</span></span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: <span class="string">'proxy'</span></span><br><span class="line">discovery-proxy:</span><br><span class="line">discovery-srv:</span><br><span class="line">initial-cluster: <span class="string">'k8s-master01=https://192.168.174.30:2380,k8s-master02=https://192.168.174.31:2380,k8s-master03=https://192.168.174.32:2380'</span></span><br><span class="line">initial-cluster-token: <span class="string">'etcd-k8s-cluster'</span></span><br><span class="line">initial-cluster-state: <span class="string">'new'</span></span><br><span class="line">strict-reconfig-check: <span class="literal">false</span></span><br><span class="line"><span class="built_in">enable</span>-v2: <span class="literal">true</span></span><br><span class="line"><span class="built_in">enable</span>-pprof: <span class="literal">true</span></span><br><span class="line">proxy: <span class="string">'off'</span></span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd.pem'</span></span><br><span class="line">  key-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></span><br><span class="line">  client-cert-auth: <span class="literal">true</span></span><br><span class="line">  trusted-ca-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></span><br><span class="line">  auto-tls: <span class="literal">true</span></span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd.pem'</span></span><br><span class="line">  key-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></span><br><span class="line">  peer-client-cert-auth: <span class="literal">true</span></span><br><span class="line">  trusted-ca-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></span><br><span class="line">  auto-tls: <span class="literal">true</span></span><br><span class="line">debug: <span class="literal">false</span></span><br><span class="line"><span class="built_in">log</span>-package-levels:</span><br><span class="line"><span class="built_in">log</span>-outputs: [default]</span><br><span class="line">force-new-cluster: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h4 id="2-Master02配置"><a href="#2-Master02配置" class="headerlink" title="(2)Master02配置"></a>(2)Master02配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/etcd/etcd.config.yml</span><br><span class="line"></span><br><span class="line">name: <span class="string">'k8s-master02'</span></span><br><span class="line">data-dir: /var/lib/etcd</span><br><span class="line">wal-dir: /var/lib/etcd/wal</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: <span class="string">'https://192.168.174.31:2380'</span></span><br><span class="line">listen-client-urls: <span class="string">'https://192.168.174.31:2379,http://127.0.0.1:2379'</span></span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: <span class="string">'https://192.168.174.31:2380'</span></span><br><span class="line">advertise-client-urls: <span class="string">'https://192.168.174.31:2379'</span></span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: <span class="string">'proxy'</span></span><br><span class="line">discovery-proxy:</span><br><span class="line">discovery-srv:</span><br><span class="line">initial-cluster: <span class="string">'k8s-master01=https://192.168.174.30:2380,k8s-master02=https://192.168.174.31:2380,k8s-master03=https://192.168.174.32:2380'</span></span><br><span class="line">initial-cluster-token: <span class="string">'etcd-k8s-cluster'</span></span><br><span class="line">initial-cluster-state: <span class="string">'new'</span></span><br><span class="line">strict-reconfig-check: <span class="literal">false</span></span><br><span class="line"><span class="built_in">enable</span>-v2: <span class="literal">true</span></span><br><span class="line"><span class="built_in">enable</span>-pprof: <span class="literal">true</span></span><br><span class="line">proxy: <span class="string">'off'</span></span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd.pem'</span></span><br><span class="line">  key-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></span><br><span class="line">  client-cert-auth: <span class="literal">true</span></span><br><span class="line">  trusted-ca-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></span><br><span class="line">  auto-tls: <span class="literal">true</span></span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd.pem'</span></span><br><span class="line">  key-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></span><br><span class="line">  peer-client-cert-auth: <span class="literal">true</span></span><br><span class="line">  trusted-ca-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></span><br><span class="line">  auto-tls: <span class="literal">true</span></span><br><span class="line">debug: <span class="literal">false</span></span><br><span class="line"><span class="built_in">log</span>-package-levels:</span><br><span class="line"><span class="built_in">log</span>-outputs: [default]</span><br><span class="line">force-new-cluster: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h4 id="3-Master03配置"><a href="#3-Master03配置" class="headerlink" title="(3)Master03配置"></a>(3)Master03配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/etcd/etcd.config.yml</span><br><span class="line"></span><br><span class="line">name: <span class="string">'k8s-master03'</span></span><br><span class="line">data-dir: /var/lib/etcd</span><br><span class="line">wal-dir: /var/lib/etcd/wal</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: <span class="string">'https://192.168.174.32:2380'</span></span><br><span class="line">listen-client-urls: <span class="string">'https://192.168.174.32:2379,http://127.0.0.1:2379'</span></span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: <span class="string">'https://192.168.174.32:2380'</span></span><br><span class="line">advertise-client-urls: <span class="string">'https://192.168.174.32:2379'</span></span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: <span class="string">'proxy'</span></span><br><span class="line">discovery-proxy:</span><br><span class="line">discovery-srv:</span><br><span class="line">initial-cluster: <span class="string">'k8s-master01=https://192.168.174.30:2380,k8s-master02=https://192.168.174.31:2380,k8s-master03=https://192.168.174.32:2380'</span></span><br><span class="line">initial-cluster-token: <span class="string">'etcd-k8s-cluster'</span></span><br><span class="line">initial-cluster-state: <span class="string">'new'</span></span><br><span class="line">strict-reconfig-check: <span class="literal">false</span></span><br><span class="line"><span class="built_in">enable</span>-v2: <span class="literal">true</span></span><br><span class="line"><span class="built_in">enable</span>-pprof: <span class="literal">true</span></span><br><span class="line">proxy: <span class="string">'off'</span></span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd.pem'</span></span><br><span class="line">  key-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></span><br><span class="line">  client-cert-auth: <span class="literal">true</span></span><br><span class="line">  trusted-ca-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></span><br><span class="line">  auto-tls: <span class="literal">true</span></span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd.pem'</span></span><br><span class="line">  key-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></span><br><span class="line">  peer-client-cert-auth: <span class="literal">true</span></span><br><span class="line">  trusted-ca-file: <span class="string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></span><br><span class="line">  auto-tls: <span class="literal">true</span></span><br><span class="line">debug: <span class="literal">false</span></span><br><span class="line"><span class="built_in">log</span>-package-levels:</span><br><span class="line"><span class="built_in">log</span>-outputs: [default]</span><br><span class="line">force-new-cluster: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h4 id="4-三台master创建service文件"><a href="#4-三台master创建service文件" class="headerlink" title="(4)三台master创建service文件"></a>(4)三台master创建service文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ vim /usr/lib/systemd/system/etcd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Service</span><br><span class="line">Documentation=https://coreos.com/etcd/docs/latest/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/etcd --config-file=/etc/etcd/etcd.config.yml</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">Alias=etcd3.service</span><br></pre></td></tr></table></figure>

<h4 id="5-三台Master节点创建etcd的证书目录"><a href="#5-三台Master节点创建etcd的证书目录" class="headerlink" title="(5)三台Master节点创建etcd的证书目录"></a>(5)三台Master节点创建etcd的证书目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /etc/kubernetes/pki/etcd</span><br><span class="line">$ ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/</span><br><span class="line">$ systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> --now etcd</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">Created symlink from /etc/systemd/system/etcd3.service to /usr/lib/systemd/system/etcd.service.</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/etcd.service to /usr/lib/systemd/system/etcd.service.</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看日志，查看节点是否有报错</span></span><br><span class="line">$ tail -f /var/<span class="built_in">log</span>/messages</span><br><span class="line">执行结果：<span class="comment"># 全部是info，则为正常</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/2.png" alt="image-20240618104757337"></p>
<h4 id="6-三台Master节点查看etcd状态"><a href="#6-三台Master节点查看etcd状态" class="headerlink" title="(6)三台Master节点查看etcd状态"></a>(6)三台Master节点查看etcd状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line"></span><br><span class="line">$ etcdctl --endpoints=<span class="string">"192.168.174.30:2379,192.168.174.31:2379,192.168.174.32:2379"</span> --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/3.png" alt="image-20240618104927074"></p>
<blockquote>
<p>看到IS LEADER出现两个false一个true，只有一个主节点，两个从节点，主节点负责写，从节点负责读；当主节点宕机，会选取其他从节点作为主节点。<strong>三节点的etcd集群只能宕机一个</strong></p>
</blockquote>
<h2 id="五丶二进制集群高可用配置（三台Master节点；haproxy和keepalived）"><a href="#五丶二进制集群高可用配置（三台Master节点；haproxy和keepalived）" class="headerlink" title="五丶二进制集群高可用配置（三台Master节点；haproxy和keepalived）"></a>五丶二进制集群高可用配置（三台Master节点；haproxy和keepalived）</h2><p>⚠️: haproxy配置文件中端口需和签发证书时候的端口号一致（此处是8443）</p>
<h4 id="1-三台Master节点安装haproxy和keepalived"><a href="#1-三台Master节点安装haproxy和keepalived" class="headerlink" title="1.三台Master节点安装haproxy和keepalived"></a>1.三台Master节点安装haproxy和keepalived</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y haproxy keepalived</span><br></pre></td></tr></table></figure>

<h4 id="2-三台Master节点配置haproxy"><a href="#2-三台Master节点配置haproxy" class="headerlink" title="2.三台Master节点配置haproxy"></a>2.三台Master节点配置haproxy</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/haproxy/haproxy.cfg </span><br><span class="line"></span><br><span class="line">global</span><br><span class="line">  maxconn  2000</span><br><span class="line">  <span class="built_in">ulimit</span>-n  16384</span><br><span class="line">  <span class="built_in">log</span>  127.0.0.1 local0 err</span><br><span class="line">  stats timeout 30s</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  <span class="built_in">log</span> global</span><br><span class="line">  mode  http</span><br><span class="line">  option  httplog</span><br><span class="line">  timeout connect 5000</span><br><span class="line">  timeout client  50000</span><br><span class="line">  timeout server  50000</span><br><span class="line">  timeout http-request 15s</span><br><span class="line">  timeout http-keep-alive 15s</span><br><span class="line"></span><br><span class="line">frontend k8s-master</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:8443</span><br><span class="line">  <span class="built_in">bind</span> 127.0.0.1:8443</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  tcp-request inspect-delay 5s</span><br><span class="line">  default_backend k8s-master</span><br><span class="line"></span><br><span class="line">backend k8s-master</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  option tcp-check</span><br><span class="line">  balance roundrobin</span><br><span class="line">  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line">  server k8s-master01    192.168.174.30:6443  check</span><br><span class="line">  server k8s-master02    192.168.174.31:6443  check</span><br><span class="line">  server k8s-master03    192.168.174.32:6443  check</span><br></pre></td></tr></table></figure>



<h4 id="3-三台Master配置keepalived"><a href="#3-三台Master配置keepalived" class="headerlink" title="3. 三台Master配置keepalived"></a>3. 三台Master配置keepalived</h4><p><strong>配置keepalived是注意网卡名称，IP地址，VIP</strong></p>
<h6 id="（1）Master01"><a href="#（1）Master01" class="headerlink" title="（1）Master01"></a>（1）Master01</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script <span class="string">"/etc/keepalived/check_apiserver.sh"</span></span><br><span class="line">    interval 5 </span><br><span class="line">    weight -5</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    mcast_src_ip 192.168.174.30</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 101</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.174.66</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_apiserver </span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure>

<h6 id="（2）Master02"><a href="#（2）Master02" class="headerlink" title="（2）Master02"></a>（2）Master02</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script <span class="string">"/etc/keepalived/check_apiserver.sh"</span></span><br><span class="line">    interval 5 </span><br><span class="line">    weight -5</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    mcast_src_ip 192.168.174.31</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.174.66</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_apiserver </span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure>

<h6 id="（3）Master03"><a href="#（3）Master03" class="headerlink" title="（3）Master03"></a>（3）Master03</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script <span class="string">"/etc/keepalived/check_apiserver.sh"</span></span><br><span class="line">    interval 5</span><br><span class="line">    weight -5</span><br><span class="line">    fall 2  </span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    mcast_src_ip 192.168.174.32</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.174.66</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_apiserver </span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-健康检查配置脚本（三台Master节点）"><a href="#4-健康检查配置脚本（三台Master节点）" class="headerlink" title="4.健康检查配置脚本（三台Master节点）"></a>4.健康检查配置脚本（三台Master节点）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/keepalived/check_apiserver.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">err=0</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> $(seq 1 3)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    check_code=$(pgrep haproxy)</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$check_code</span> == <span class="string">""</span> ]]; <span class="keyword">then</span></span><br><span class="line">        err=$(expr <span class="variable">$err</span> + 1)</span><br><span class="line">        sleep 1</span><br><span class="line">        <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        err=0</span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$err</span> != <span class="string">"0"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"systemctl stop keepalived"</span></span><br><span class="line">    /usr/bin/systemctl stop keepalived</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h4 id="5-启动haproxy和keepalived，并检查VIP-三台Master"><a href="#5-启动haproxy和keepalived，并检查VIP-三台Master" class="headerlink" title="5.启动haproxy和keepalived，并检查VIP(三台Master)"></a>5.启动haproxy和keepalived，并检查VIP(三台Master)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ chmod +x /etc/keepalived/check_apiserver.sh</span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl <span class="built_in">enable</span> --now haproxy keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 所有测试VIP</span></span><br><span class="line">$ ping 192.168.174.66</span><br><span class="line">PING 192.168.174.66 (192.168.174.66) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.174.66: icmp_seq=1 ttl=64 time=1.39 ms</span><br><span class="line">64 bytes from 192.168.174.66: icmp_seq=2 ttl=64 time=2.46 ms</span><br><span class="line">64 bytes from 192.168.174.66: icmp_seq=3 ttl=64 time=1.68 ms</span><br><span class="line">64 bytes from 192.168.174.66: icmp_seq=4 ttl=64 time=1.08 ms</span><br><span class="line"></span><br><span class="line">$ telnet 192.168.174.66 8443</span><br><span class="line">执行结果：（^成功）</span><br><span class="line">	Trying 192.168.174.66...</span><br><span class="line">Connected to 192.168.174.66.</span><br><span class="line">Escape character is <span class="string">'^]'</span>.</span><br><span class="line">Connection closed by foreign host.</span><br><span class="line"><span class="comment">#⚠️: 如果ping不通且telnet没有出现 ^]，则认为VIP不可以，不可在继续往下执行，需要排查keepalived的问题，比如防火墙和selinux，haproxy和keepalived的状态，监听端口等</span></span><br><span class="line">所有节点查看防火墙状态必须为<span class="built_in">disable</span>和inactive：systemctl status firewalld</span><br><span class="line">所有节点查看selinux状态，必须为<span class="built_in">disable</span>：getenforce</span><br><span class="line">master节点查看haproxy和keepalived状态：systemctl status keepalived haproxy</span><br><span class="line">master节点查看监听端口：netstat -lntp</span><br></pre></td></tr></table></figure>



<h2 id="六丶Kubernetes-Master节点组件安装"><a href="#六丶Kubernetes-Master节点组件安装" class="headerlink" title="六丶Kubernetes Master节点组件安装"></a>六丶Kubernetes Master节点组件安装</h2><h4 id="1-所有节点创建配置文件目录（Master-and-Node）-service文件目录，kebernetes配置文件所在目录"><a href="#1-所有节点创建配置文件目录（Master-and-Node）-service文件目录，kebernetes配置文件所在目录" class="headerlink" title="1. 所有节点创建配置文件目录（Master and Node）(service文件目录，kebernetes配置文件所在目录)"></a>1. 所有节点创建配置文件目录（Master and Node）(service文件目录，kebernetes配置文件所在目录)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/<span class="built_in">log</span>/kubernetes</span><br></pre></td></tr></table></figure>

<h4 id="2-apiserver配置"><a href="#2-apiserver配置" class="headerlink" title="2.apiserver配置"></a>2.apiserver配置</h4><p><strong><code>注意配置文件中service的网段（--service-cluster-ip-range=10.96.0.0/16）注意本文档使用的k8s service网段为10.96.0.0/16，该网段不能和宿主机的网段、Pod网段的重复</code></strong></p>
<h6 id="1-Master01"><a href="#1-Master01" class="headerlink" title="(1)Master01"></a>(1)Master01</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ vim /usr/lib/systemd/system/kube-apiserver.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-apiserver \</span><br><span class="line">      --v=2  \</span><br><span class="line">      --logtostderr=<span class="literal">true</span>  \</span><br><span class="line">      --allow-privileged=<span class="literal">true</span>  \</span><br><span class="line">      --<span class="built_in">bind</span>-address=0.0.0.0  \</span><br><span class="line">      --secure-port=6443  \</span><br><span class="line">      --insecure-port=0  \</span><br><span class="line">      --advertise-address=192.168.174.30 \</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/16  \</span><br><span class="line">      --service-node-port-range=30000-32767  \</span><br><span class="line">      --etcd-servers=https://192.168.174.30:2379,https://192.168.174.31:2379,https://192.168.174.32:2379 \</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \</span><br><span class="line">      --<span class="built_in">enable</span>-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \</span><br><span class="line">      --authorization-mode=Node,RBAC  \</span><br><span class="line">      --<span class="built_in">enable</span>-bootstrap-token-auth=<span class="literal">true</span>  \</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \</span><br><span class="line">      --requestheader-allowed-names=aggregator  \</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \</span><br><span class="line">      --requestheader-username-headers=X-Remote-User</span><br><span class="line">      <span class="comment"># --token-auth-file=/etc/kubernetes/token.csv</span></span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h6 id="2-Master02"><a href="#2-Master02" class="headerlink" title="(2)Master02"></a>(2)Master02</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">$ vim  /usr/lib/systemd/system/kube-apiserver.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-apiserver \</span><br><span class="line">      --v=2  \</span><br><span class="line">      --logtostderr=<span class="literal">true</span>  \</span><br><span class="line">      --allow-privileged=<span class="literal">true</span>  \</span><br><span class="line">      --<span class="built_in">bind</span>-address=0.0.0.0  \</span><br><span class="line">      --secure-port=6443  \</span><br><span class="line">      --insecure-port=0  \</span><br><span class="line">      --advertise-address=192.168.174.31 \</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/16  \</span><br><span class="line">      --service-node-port-range=30000-32767  \</span><br><span class="line">      --etcd-servers=https://192.168.174.30:2379,https://192.168.174.31:2379,https://192.168.174.32:2379 \</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \</span><br><span class="line">      --<span class="built_in">enable</span>-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \</span><br><span class="line">      --authorization-mode=Node,RBAC  \</span><br><span class="line">      --<span class="built_in">enable</span>-bootstrap-token-auth=<span class="literal">true</span>  \</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \</span><br><span class="line">      --requestheader-allowed-names=aggregator  \</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \</span><br><span class="line">      --requestheader-username-headers=X-Remote-User</span><br><span class="line">      <span class="comment"># --token-auth-file=/etc/kubernetes/token.csv</span></span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h6 id="3-Master03"><a href="#3-Master03" class="headerlink" title="(3)Master03"></a>(3)Master03</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ vim  /usr/lib/systemd/system/kube-apiserver.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-apiserver \</span><br><span class="line">      --v=2  \</span><br><span class="line">      --logtostderr=<span class="literal">true</span>  \</span><br><span class="line">      --allow-privileged=<span class="literal">true</span>  \</span><br><span class="line">      --<span class="built_in">bind</span>-address=0.0.0.0  \</span><br><span class="line">      --secure-port=6443  \</span><br><span class="line">      --insecure-port=0  \</span><br><span class="line">      --advertise-address=192.168.174.32 \</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/16  \</span><br><span class="line">      --service-node-port-range=30000-32767  \</span><br><span class="line">      --etcd-servers=https://192.168.174.30:2379,https://192.168.174.31:2379,https://192.168.174.32:2379 \</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \</span><br><span class="line">      --<span class="built_in">enable</span>-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \</span><br><span class="line">      --authorization-mode=Node,RBAC  \</span><br><span class="line">      --<span class="built_in">enable</span>-bootstrap-token-auth=<span class="literal">true</span>  \</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \</span><br><span class="line">      --requestheader-allowed-names=aggregator  \</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \</span><br><span class="line">      --requestheader-username-headers=X-Remote-User</span><br><span class="line">      <span class="comment"># --token-auth-file=/etc/kubernetes/token.csv</span></span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h6 id="4-所有Master节点启动apiserver"><a href="#4-所有Master节点启动apiserver" class="headerlink" title="(4)所有Master节点启动apiserver"></a>(4)所有Master节点启动apiserver</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 启动服务</span></span><br><span class="line">$ systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> --now kube-apiserver</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看服务的状态</span></span><br><span class="line">$ systemctl status kube-apiserver</span><br><span class="line">● kube-apiserver.service - Kubernetes API Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-apiserver.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Sat 2020-08-22 21:26:49 CST; 26s ago </span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看日志</span></span><br><span class="line">$ tail -f /var/<span class="built_in">log</span>/messages (出现以下日志信息忽略)</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/4.png" alt="image-20240616020025439"></p>
<h4 id="3-kube-controller-manager配置（三台Master）"><a href="#3-kube-controller-manager配置（三台Master）" class="headerlink" title="3. kube-controller-manager配置（三台Master）"></a>3. kube-controller-manager配置（三台Master）</h4><p>​    <strong>注意使用的k8s Pod网段为172.16.0.0/16，该网段不能和宿主机的网段、k8s Service网段的重复，请按需修改</strong></p>
<h6 id="1-三台Master配置（同时执行，配置相同）"><a href="#1-三台Master配置（同时执行，配置相同）" class="headerlink" title="(1)三台Master配置（同时执行，配置相同）"></a>(1)三台Master配置（同时执行，配置相同）</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ vim /usr/lib/systemd/system/kube-controller-manager.service </span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-controller-manager \</span><br><span class="line">      --v=2 \</span><br><span class="line">      --logtostderr=<span class="literal">true</span> \</span><br><span class="line">      --address=127.0.0.1 \</span><br><span class="line">      --root-ca-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \</span><br><span class="line">      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \</span><br><span class="line">      --leader-elect=<span class="literal">true</span> \</span><br><span class="line">      --use-service-account-credentials=<span class="literal">true</span> \</span><br><span class="line">      --node-monitor-grace-period=40s \</span><br><span class="line">      --node-monitor-period=5s \</span><br><span class="line">      --pod-eviction-timeout=2m0s \</span><br><span class="line">      --controllers=*,bootstrapsigner,tokencleaner \</span><br><span class="line">      --allocate-node-cidrs=<span class="literal">true</span> \</span><br><span class="line">      --cluster-cidr=172.16.0.0/16 \</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \</span><br><span class="line">      --node-cidr-mask-size=24</span><br><span class="line">      </span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h6 id="2-三台Master节点启动kube-controller-manager"><a href="#2-三台Master节点启动kube-controller-manager" class="headerlink" title="(2)三台Master节点启动kube-controller-manager"></a>(2)三台Master节点启动kube-controller-manager</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl daemon-reload  &amp;&amp; systemctl <span class="built_in">enable</span> --now kube-controller-manager</span><br><span class="line"></span><br><span class="line">$ tail -f /var/<span class="built_in">log</span>/messages</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/5.png" alt="image-20240616020438903"></p>
<h4 id="4-Master节点配置-kube-scheduler（三台Master节点）"><a href="#4-Master节点配置-kube-scheduler（三台Master节点）" class="headerlink" title="4. Master节点配置 kube-scheduler（三台Master节点）"></a>4. Master节点配置 kube-scheduler（三台Master节点）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ vim /usr/lib/systemd/system/kube-scheduler.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-scheduler \</span><br><span class="line">      --v=2 \</span><br><span class="line">      --logtostderr=<span class="literal">true</span> \</span><br><span class="line">      --address=127.0.0.1 \</span><br><span class="line">      --leader-elect=<span class="literal">true</span> \</span><br><span class="line">      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 启动服务</span></span><br><span class="line">$ systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> --now kube-scheduler</span><br><span class="line">$ tail -f /var/<span class="built_in">log</span>/messages</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/6.png" alt="image-20240616020628347"></p>
<h2 id="七丶TLS-Bootstrapping配置（Master01）"><a href="#七丶TLS-Bootstrapping配置（Master01）" class="headerlink" title="七丶TLS Bootstrapping配置（Master01）"></a>七丶TLS Bootstrapping配置（Master01）</h2><p><strong>⚠️:由于工作节点较多，且每个节点的kubelet证书不一致，且kubelet和主机的主机名IP地址存在关系，不能统一的去生成，所以 Bootstrap会自动的为工作节点颁发kubelet证书。</strong></p>
<p><code>其中如下配置按需更改192.168.174.66:8443为VIP地址及端口号</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 配置Bootstrap的文件</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/kubernetes_install/bootstrap</span><br><span class="line">$ kubectl config <span class="built_in">set</span>-cluster kubernetes     --certificate-authority=/etc/kubernetes/pki/ca.pem     --embed-certs=<span class="literal">true</span>     --server=https://192.168.174.66:8443     --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">Cluster <span class="string">"kubernetes"</span> <span class="built_in">set</span>.</span><br><span class="line"></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-credentials tls-bootstrap-token-user     --token=c8ad9c.2e4d610cf3e7426e --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">User <span class="string">"tls-bootstrap-token-user"</span> <span class="built_in">set</span>.</span><br><span class="line"></span><br><span class="line">$ kubectl config <span class="built_in">set</span>-context tls-bootstrap-token-user@kubernetes     --cluster=kubernetes     --user=tls-bootstrap-token-user     --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">Context <span class="string">"tls-bootstrap-token-user@kubernetes"</span> created.</span><br><span class="line"></span><br><span class="line">$ kubectl config use-context tls-bootstrap-token-user@kubernetes     --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">Switched to context <span class="string">"tls-bootstrap-token-user@kubernetes"</span>.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 创建kubectl需要的执行配置文件（不创建；kubectl无法执行，其他master节点操作一致）</span></span><br><span class="line">$ mkdir -p /root/.kube; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看集群状态，否则无法继续执行</span></span><br><span class="line">$ kubectl get cs</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">   Warning: v1 ComponentStatus is deprecated <span class="keyword">in</span> v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE                         ERROR</span><br><span class="line">scheduler            Healthy   ok                              </span><br><span class="line">controller-manager   Healthy   ok                              </span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>,<span class="string">"reason"</span>:<span class="string">""</span>&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>,<span class="string">"reason"</span>:<span class="string">""</span>&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>,<span class="string">"reason"</span>:<span class="string">""</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看集群状态</span></span><br><span class="line">$ kubectl cluster-info</span><br><span class="line">	<span class="comment"># 执行结果</span></span><br><span class="line">Kubernetes control plane is running at https://192.168.174.66:8443</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use <span class="string">'kubectl cluster-info dump'</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建bootstrap的token值</span></span><br><span class="line">$ kubectl create -f bootstrap.secret.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/7.png" alt="image-20240616021441067"></p>
<h2 id="1-Node节点配置"><a href="#1-Node节点配置" class="headerlink" title="1.Node节点配置"></a>1.Node节点配置</h2><h3 id="1-传输其他节点所需要的证书（聚合证书，根证书，bootstrap证书）"><a href="#1-传输其他节点所需要的证书（聚合证书，根证书，bootstrap证书）" class="headerlink" title="(1)传输其他节点所需要的证书（聚合证书，根证书，bootstrap证书）"></a>(1)传输其他节点所需要的证书（聚合证书，根证书，bootstrap证书）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; Master01</span></span><br><span class="line">$ vim scp.sh</span><br><span class="line">NODE=<span class="string">'k8s-master02 k8s-master03 k8s-node01 k8s-node02'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$NODE</span>;<span class="keyword">do</span></span><br><span class="line">  ssh <span class="variable">$i</span> mkdir -p /etc/kubernetes/pki</span><br><span class="line">   <span class="keyword">for</span> FILE <span class="keyword">in</span> pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig;<span class="keyword">do</span></span><br><span class="line">      scp /etc/kubernetes/<span class="variable">$FILE</span> <span class="variable">$i</span>:/etc/kubernetes/<span class="variable">$&#123;FILE&#125;</span></span><br><span class="line">      <span class="keyword">done</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ bash scp.sh</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/8.png" alt="image-20240618110930009"></p>
<h3 id="2-kubelet配置-Master-and-Node"><a href="#2-kubelet配置-Master-and-Node" class="headerlink" title="(2)kubelet配置(Master and Node)"></a>(2)kubelet配置(Master and Node)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 创建需要的文件目录</span></span><br><span class="line">$ mkdir -p /var/lib/kubelet /var/<span class="built_in">log</span>/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/</span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 所有节点配置kubelet service</span></span><br><span class="line">$ vim  /usr/lib/systemd/system/kubelet.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kubelet</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">StartLimitInterval=0</span><br><span class="line">RestartSec=10</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 如果Runtime为Docker，请使用如下Kubelet的配置：</span></span><br><span class="line">$ vim /etc/systemd/system/kubelet.service.d/10-kubelet.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_SYSTEM_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node='' "</span></span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kubelet <span class="variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="variable">$KUBELET_CONFIG_ARGS</span> <span class="variable">$KUBELET_SYSTEM_ARGS</span> <span class="variable">$KUBELET_EXTRA_ARGS</span></span><br></pre></td></tr></table></figure>

<h3 id="3-kubelet配置文件编写-master-and-node"><a href="#3-kubelet配置文件编写-master-and-node" class="headerlink" title="(3)kubelet配置文件编写(master and node)"></a>(3)kubelet配置文件编写(master and node)</h3><p><strong>如果更改了k8s的service网段，需要更改kubelet-conf.yml 的clusterDNS:配置，改成k8s Service网段的第十个地址，比如10.96.0.10/16</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/kubernetes/kubelet-conf.yml</span><br><span class="line"></span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/ca.pem</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">cgroupsPerQOS: <span class="literal">true</span></span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10   <span class="comment">#coredns地址</span></span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">containerLogMaxFiles: 5</span><br><span class="line">containerLogMaxSize: 10Mi</span><br><span class="line">contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">cpuCFSQuota: <span class="literal">true</span></span><br><span class="line">cpuManagerPolicy: none</span><br><span class="line">cpuManagerReconcilePeriod: 10s</span><br><span class="line">enableControllerAttachDetach: <span class="literal">true</span></span><br><span class="line">enableDebuggingHandlers: <span class="literal">true</span></span><br><span class="line">enforceNodeAllocatable:</span><br><span class="line">- pods</span><br><span class="line">eventBurst: 10</span><br><span class="line">eventRecordQPS: 5</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">evictionPressureTransitionPeriod: 5m0s</span><br><span class="line">failSwapOn: <span class="literal">true</span></span><br><span class="line">fileCheckFrequency: 20s</span><br><span class="line">hairpinMode: promiscuous-bridge</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 20s</span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">imageMinimumGCAge: 2m0s</span><br><span class="line">iptablesDropBit: 15</span><br><span class="line">iptablesMasqueradeBit: 14</span><br><span class="line">kubeAPIBurst: 10</span><br><span class="line">kubeAPIQPS: 5</span><br><span class="line">makeIPTablesUtilChains: <span class="literal">true</span></span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">nodeStatusUpdateFrequency: 10s</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">podPidsLimit: -1</span><br><span class="line">registryBurst: 10</span><br><span class="line">registryPullQPS: 5</span><br><span class="line">resolvConf: /etc/resolv.conf</span><br><span class="line">rotateCertificates: <span class="literal">true</span></span><br><span class="line">runtimeRequestTimeout: 2m0s</span><br><span class="line">serializeImagePulls: <span class="literal">true</span></span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionIdleTimeout: 4h0m0s</span><br><span class="line">syncFrequency: 1m0s</span><br><span class="line">volumeStatsAggPeriod: 1m0s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 启动服务</span></span><br><span class="line">$ systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> --now kubelet</span><br><span class="line">$ tail -f /var/<span class="built_in">log</span>/messages</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">	Dec  5 18:04:04 k8s-master01 kubelet: I1205 18:04:04.737643    6050 cni.go:240] <span class="string">"Unable to update cni config"</span> err=<span class="string">"no networks found in /etc/cni/net.d"</span></span><br><span class="line">Dec  5 18:04:05 k8s-master01 kubelet: E1205 18:04:05.374596    6050 kubelet.go:2391] <span class="string">"Container runtime network not ready"</span> networkReady=<span class="string">"NetworkReady=false reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitialized"</span></span><br><span class="line">Dec  5 18:04:09 k8s-master01 kubelet: I1205 18:04:09.738224    6050 cni.go:240] <span class="string">"Unable to update cni config"</span> err=<span class="string">"no networks found in /etc/cni/net.d"</span></span><br><span class="line">Dec  5 18:04:10 k8s-master01 kubelet: E1205 18:04:10.379233    6050 kubelet.go:2391] <span class="string">"Container runtime network not ready"</span> networkReady=<span class="string">"NetworkReady=false reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitialized"</span></span><br><span class="line">Dec  5 18:04:14 k8s-master01 kubelet: I1205 18:04:14.738919    6050 cni.go:240] <span class="string">"Unable to update cni config"</span> err=<span class="string">"no networks found in /etc/cni/net.d"</span></span><br><span class="line">Dec  5 18:04:15 k8s-master01 kubelet: E1205 18:04:15.386167    6050 kubelet.go:2391] <span class="string">"Container runtime network not ready"</span> networkReady=<span class="string">"NetworkReady=false reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitialized"</span></span><br><span class="line"><span class="comment">#由于没有安装CNI查看导致的。等后续安装calico后恢复正常</span></span><br></pre></td></tr></table></figure>

<h2 id="2-kube-proxy配置（Master01）"><a href="#2-kube-proxy配置（Master01）" class="headerlink" title="2.kube-proxy配置（Master01）"></a>2.kube-proxy配置（Master01）</h2><p>​    <strong>如果不是高可用集群，192.168.174.66:8443改为master01的地址，8443改为apiserver的端口，默认是6443</strong></p>
<h6 id="1-kube-proxy配置创建"><a href="#1-kube-proxy配置创建" class="headerlink" title="(1)kube-proxy配置创建"></a>(1)kube-proxy配置创建</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/kubernetes_install</span><br><span class="line">$ kubectl -n kube-system create serviceaccount kube-proxy</span><br><span class="line"></span><br><span class="line">kubectl create clusterrolebinding system:kube-proxy         --clusterrole system:node-proxier         --serviceaccount kube-system:kube-proxy</span><br><span class="line"></span><br><span class="line">SECRET=$(kubectl -n kube-system get sa/kube-proxy \</span><br><span class="line">    --output=jsonpath=<span class="string">'&#123;.secrets[0].name&#125;'</span>)</span><br><span class="line"></span><br><span class="line">JWT_TOKEN=$(kubectl -n kube-system get secret/<span class="variable">$SECRET</span> \</span><br><span class="line">--output=jsonpath=<span class="string">'&#123;.data.token&#125;'</span> | base64 -d)</span><br><span class="line"></span><br><span class="line">PKI_DIR=/etc/kubernetes/pki</span><br><span class="line">K8S_DIR=/etc/kubernetes</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes     --certificate-authority=/etc/kubernetes/pki/ca.pem     --embed-certs=<span class="literal">true</span>     --server=https://192.168.174.66:8443     --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials kubernetes     --token=<span class="variable">$&#123;JWT_TOKEN&#125;</span>     --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set</span>-context kubernetes     --cluster=kubernetes     --user=kubernetes     --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context kubernetes     --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 将kube-proxy配置文件传输给其他集群</span></span><br><span class="line">$ <span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-master02 k8s-master03; <span class="keyword">do</span></span><br><span class="line">     scp /etc/kubernetes/kube-proxy.kubeconfig  <span class="variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-node01 k8s-node02; <span class="keyword">do</span></span><br><span class="line">     scp /etc/kubernetes/kube-proxy.kubeconfig <span class="variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"> <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h6 id="2-所有节点添加kube-proxy的配置和service文件（Master-and-Node）"><a href="#2-所有节点添加kube-proxy的配置和service文件（Master-and-Node）" class="headerlink" title="(2)所有节点添加kube-proxy的配置和service文件（Master and Node）"></a>(2)所有节点添加kube-proxy的配置和service文件（Master and Node）</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; kube-proxy service文件</span></span><br><span class="line">$ vim /usr/lib/systemd/system/kube-proxy.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube Proxy</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/kube-proxy \</span><br><span class="line">  --config=/etc/kubernetes/kube-proxy.yaml \</span><br><span class="line">  --v=2</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; kube-proxy配置文件</span></span><br><span class="line">⚠️: 如果更改了集群Pod的网段，需要更改kube-proxy.yaml的clusterCIDR为自己的Pod网段</span><br><span class="line">$ vim /etc/kubernetes/kube-proxy.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">clientConnection:</span><br><span class="line">  acceptContentTypes: <span class="string">""</span></span><br><span class="line">  burst: 10</span><br><span class="line">  contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">  qps: 5</span><br><span class="line">clusterCIDR: 172.16.0.0/16 </span><br><span class="line">configSyncPeriod: 15m0s</span><br><span class="line">conntrack:</span><br><span class="line">  max: null</span><br><span class="line">  maxPerCore: 32768</span><br><span class="line">  min: 131072</span><br><span class="line">  tcpCloseWaitTimeout: 1h0m0s</span><br><span class="line">  tcpEstablishedTimeout: 24h0m0s</span><br><span class="line">enableProfiling: <span class="literal">false</span></span><br><span class="line">healthzBindAddress: 0.0.0.0:10256</span><br><span class="line">hostnameOverride: <span class="string">""</span></span><br><span class="line">iptables:</span><br><span class="line">  masqueradeAll: <span class="literal">false</span></span><br><span class="line">  masqueradeBit: 14</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">ipvs:</span><br><span class="line">  masqueradeAll: <span class="literal">true</span></span><br><span class="line">  minSyncPeriod: 5s</span><br><span class="line">  scheduler: <span class="string">"rr"</span></span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: 127.0.0.1:10249</span><br><span class="line">mode: <span class="string">"ipvs"</span></span><br><span class="line">nodePortAddresses: null</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">portRange: <span class="string">""</span></span><br><span class="line">udpIdleTimeout: 250ms</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 启动服务</span></span><br><span class="line">$ systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> --now kube-proxy</span><br><span class="line">执行结果：</span><br><span class="line">	Created symlink /etc/systemd/system/multi-user.target.wants/kube-proxy.service → /usr/lib/systemd/system/kube-proxy.service</span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看日志是否报错</span></span><br><span class="line">$ tail -f /var/<span class="built_in">log</span>/messages</span><br><span class="line">执行结果：</span><br><span class="line">   Dec  5 18:21:54 k8s-master01 kube-proxy: I1205 18:21:54.989375    9811 shared_informer.go:247] Caches are synced <span class="keyword">for</span> service config</span><br><span class="line">Dec  5 18:21:54 k8s-master01 kube-proxy: I1205 18:21:54.989564    9811 service.go:419] <span class="string">"Adding new service port"</span> portName=<span class="string">"default/kubernetes:https"</span> servicePort=<span class="string">"10.96.0.1:443/TCP"</span></span><br><span class="line">Dec  5 18:21:54 k8s-master01 kube-proxy: I1205 18:21:54.993513    9811 shared_informer.go:247] Caches are synced <span class="keyword">for</span> node config</span><br></pre></td></tr></table></figure>

<h2 id="八丶安装Calico（Master01）"><a href="#八丶安装Calico（Master01）" class="headerlink" title="八丶安装Calico（Master01）"></a>八丶安装Calico（Master01）</h2><p>​        ⚠️: 安装官方推荐版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 切换目录</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/kubernetes_install/calico</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 更改calico的网段，改为自己的Pod网段</span></span><br><span class="line">$ sed -i <span class="string">"s#POD_CIDR#172.16.0.0/16#g"</span> calico.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 检查网段是自己的Pod网段</span></span><br><span class="line">$ grep <span class="string">"IPV4POOL_CIDR"</span> calico.yaml  -A 1</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建calico</span></span><br><span class="line">$ kubectl apply -f calico.yaml</span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">service/calico-typha created</span><br><span class="line">deployment.apps/calico-typha created</span><br><span class="line">Warning: policy/v1beta1 PodDisruptionBudget is deprecated <span class="keyword">in</span> v1.21+, unavailable <span class="keyword">in</span> v1.25+; use policy/v1 PodDisruptionBudget</span><br><span class="line">poddisruptionbudget.policy/calico-typha created</span><br><span class="line">daemonset.apps/calico-node created</span><br><span class="line">serviceaccount/calico-node created</span><br><span class="line">deployment.apps/calico-kube-controllers created</span><br><span class="line">serviceaccount/calico-kube-controllers created</span><br><span class="line">poddisruptionbudget.policy/calico-kube-controllers created</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看容器状态</span></span><br><span class="line">$ kubectl get po -n kube-system</span><br><span class="line">NAME                                       READY   STATUS    RESTARTS      AGE</span><br><span class="line">calico-kube-controllers-66686fdb54-mk2g6   1/1     Running   1 (20s ago)   85s</span><br><span class="line">calico-node-8fxqp                          1/1     Running   0             85s</span><br><span class="line">calico-node-8nkfl                          1/1     Running   0             86s</span><br><span class="line">calico-node-pmpf4                          1/1     Running   0             86s</span><br><span class="line">calico-node-vnlk7                          1/1     Running   0             86s</span><br><span class="line">calico-node-xpchb                          1/1     Running   0             85s</span><br><span class="line">calico-typha-67c6dc57d6-259t8              1/1     Running   0             86s</span><br><span class="line">calico-typha-67c6dc57d6-49h5d              1/1     Running   0             86s</span><br><span class="line">calico-typha-67c6dc57d6-rsc7n              1/1     Running   0             86s</span><br><span class="line">⚠️: 如果容器状态异常可以使用kubectl describe 或者kubectl logs查看容器的日志</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/9.png" alt="image-20240618193903565"></p>
<h2 id="九丶安装CoreDNS"><a href="#九丶安装CoreDNS" class="headerlink" title="九丶安装CoreDNS"></a>九丶安装CoreDNS</h2><h6 id="1-安装官方推荐版本"><a href="#1-安装官方推荐版本" class="headerlink" title="(1)安装官方推荐版本"></a>(1)安装官方推荐版本</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 切换目录</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/kubernetes_install</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 更改了k8s service的网段需要将coredns的serviceIP改成k8s service网段的第十个IP</span></span><br><span class="line">$ COREDNS_SERVICE_IP=`kubectl get svc | grep kubernetes | awk <span class="string">'&#123;print $3&#125;'</span>`0</span><br><span class="line">$ sed -i <span class="string">"s#KUBEDNS_SERVICE_IP#<span class="variable">$&#123;COREDNS_SERVICE_IP&#125;</span>#g"</span> CoreDNS/coredns.yaml</span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 安装CoreDNS</span></span><br><span class="line">$ kubectl  create -f CoreDNS/coredns.yaml</span><br><span class="line">serviceaccount/coredns created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">configmap/coredns created</span><br><span class="line">deployment.apps/coredns created</span><br><span class="line">service/kube-dns created</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/10.png" alt="image-20240618193828829"></p>
<h6 id="2-或者安装最新版"><a href="#2-或者安装最新版" class="headerlink" title="(2)或者安装最新版"></a>(2)或者安装最新版</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 更改了k8s service的网段需要将coredns的serviceIP改成k8s service网段的第十个IP</span></span><br><span class="line">$ COREDNS_SERVICE_IP=`kubectl get svc | grep kubernetes | awk <span class="string">'&#123;print $3&#125;'</span>`0</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/coredns/deployment.git</span><br><span class="line">$ <span class="built_in">cd</span> deployment/kubernetes</span><br><span class="line">$ ./deploy.sh -s -i <span class="variable">$&#123;COREDNS_SERVICE_IP&#125;</span> | kubectl apply -f -</span><br><span class="line">serviceaccount/coredns created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">configmap/coredns created</span><br><span class="line">deployment.apps/coredns created</span><br><span class="line">service/kube-dns created</span><br><span class="line">查看状态</span><br><span class="line">$ kubectl get po -n kube-system -l k8s-app=kube-dns</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-85b4878f78-h29kh   1/1     Running   0          8h</span><br></pre></td></tr></table></figure>

<h2 id="十丶安装Metrics-Server"><a href="#十丶安装Metrics-Server" class="headerlink" title="十丶安装Metrics Server"></a>十丶安装Metrics Server</h2><p>​      在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 切换目录</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/kubernetes_install/metrics-server</span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建服务</span></span><br><span class="line">$ kubectl  create -f .</span><br><span class="line">serviceaccount/metrics-server created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:metrics-server created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created</span><br><span class="line">service/metrics-server created</span><br><span class="line">deployment.apps/metrics-server created</span><br><span class="line">apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 等待metrics server启动然后查看状态</span></span><br><span class="line">$ kubectl  top node</span><br><span class="line">NAME           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">k8s-master01   231m         5%     1620Mi          42%       </span><br><span class="line">k8s-master02   274m         6%     1203Mi          31%       </span><br><span class="line">k8s-master03   202m         5%     1251Mi          32%       </span><br><span class="line">k8s-node01     69m          1%     667Mi           17%       </span><br><span class="line">k8s-node02     73m          1%     650Mi           16%</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/11.png" alt="image-20240618193945746"></p>
<h2 id="十一丶Dashboard"><a href="#十一丶Dashboard" class="headerlink" title="十一丶Dashboard"></a>十一丶Dashboard</h2><p>官方GitHub地址：<a href="https://github.com/kubernetes/dashboard" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/kubernetes_install/dashboard</span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建Dashboard</span></span><br><span class="line">$ kubectl  create -f . </span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">serviceaccount/admin-user created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/admin-user created</span><br><span class="line">namespace/kubernetes-dashboard created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">secret/kubernetes-dashboard-csrf created</span><br><span class="line">secret/kubernetes-dashboard-key-holder created</span><br><span class="line">configmap/kubernetes-dashboard-settings created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/dashboard-metrics-scraper created</span><br><span class="line">deployment.apps/dashboard-metrics-scraper created</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Dashborad</span></span><br><span class="line">$ kubectl get po -n kubernetes-dashboard</span><br><span class="line">	<span class="comment">#执行结果：</span></span><br><span class="line">kubernetes-dashboard-85f59f8ff7-lrj4n        1/1     Running   0          2m15s</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Dashdoard暴露的端口号</span></span><br><span class="line">$ kubectl get svc -n kubernetes-dashboard</span><br><span class="line">执行结果：</span><br><span class="line">	NAME                        TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">dashboard-metrics-scraper   ClusterIP   10.96.29.130   &lt;none&gt;        8000/TCP        24m</span><br><span class="line">kubernetes-dashboard        NodePort    10.96.0.121    &lt;none&gt;        443:32117/TCP   24m</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Token值</span></span><br><span class="line">$ kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/12.png" alt="image-20240616031745035"></p>
<p>  <strong>登录Dashboard</strong></p>
<p><strong>https://节点IP:32117</strong></p>
<p>谷歌游览器修改目标</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--test-type --ignore-certificate-errors</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/13.png" alt="image-20240616031925822"></p>
<h2 id="十二丶集群验证"><a href="#十二丶集群验证" class="headerlink" title="十二丶集群验证"></a>十二丶集群验证</h2><p><strong>查看kube-apiserver的证书有效时间</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]<span class="comment"># openssl x509 -enddate -noout -in /etc/kubernetes/pki/apiserver.pem</span></span><br><span class="line">notAfter=May 22 17:10:00 2124 GMT</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 安装pod，测试集群连通性</span></span><br><span class="line">$ cat&lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: busybox</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: busybox</span><br><span class="line">    image: registry.cn-hangzhou.aliyuncs.com/hujiaming/busybox:latest</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - sleep</span><br><span class="line">      - <span class="string">"3600"</span></span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看kubernetes下的service</span></span><br><span class="line">$ kubectl get svc</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; busybox解析同namespace下的service</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span>  busybox -n default -- nslookup kubernetes</span><br><span class="line">执行结果：（成功）</span><br><span class="line">	Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line">     Name:      kubernetes</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; busybox跨namespace解析kube-system下的namespace</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span>  busybox -n default -- nslookup kube-dns.kube-system.svc.cluster.local</span><br><span class="line">执行结果：</span><br><span class="line">	Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line">    Name:      kube-dns.kube-system</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 每个节点都必须要访问kubernetes的service:443和kube-dns的service:53</span></span><br><span class="line">$ telnet 10.96.0.1 443   <span class="comment">#kubernetes下的service（kubectl get svc）</span></span><br><span class="line">	<span class="comment"># 返回结果：</span></span><br><span class="line">Trying 10.96.0.1...</span><br><span class="line">Connected to 10.96.0.1.</span><br><span class="line">Escape character is <span class="string">'^]'</span>.</span><br><span class="line"></span><br><span class="line">$ telnet 10.96.0.10 53   <span class="comment">#kube-system下的service (kubectl get svc -n kube-system)</span></span><br><span class="line">	<span class="comment"># 执行结果：</span></span><br><span class="line">Trying 10.96.0.10...</span><br><span class="line">Connected to 10.96.0.10.</span><br><span class="line">Escape character is <span class="string">'^]'</span>.</span><br><span class="line">Connection closed by foreign host.</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; Pod和Pod之间通信测试</span></span><br><span class="line">  <span class="comment">#&gt;&gt;&gt; 进入一个Pod当中</span></span><br><span class="line">  $ kubectl <span class="built_in">exec</span> -it pod名称 -n 命名空间 -- sh/bash</span><br><span class="line">  <span class="comment">#&gt;&gt;&gt; ping其他Pod</span></span><br><span class="line">  / <span class="comment"># ping 172.25.244.193</span></span><br><span class="line">  <span class="comment">#&gt;&gt;&gt; ping宿主机</span></span><br><span class="line">  / <span class="comment"># ping 192.168.174.30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建一个deployment副本</span></span><br><span class="line">$ kubectl create deploy nginx --image=registry.cn-hangzhou.aliyuncs.com/hujiaming/nginx:v1.21 --replicas=1</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看创建的副本</span></span><br><span class="line">$ kubectl get deploy</span><br><span class="line">执行结果：</span><br><span class="line">	NAME    READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS   IMAGES        SELECTOR</span><br><span class="line">nginx   0/1     1            0           7m35s   nginx        nginx:v1.21   app=nginx</span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 删除创建的deployment副本</span></span><br><span class="line">$ kubectl delete deploy nginx</span><br></pre></td></tr></table></figure>

<p><strong>集群验证步骤：</strong></p>
<ul>
<li><strong>Pod必须解析service，Pod必须能解析跨namespace的service</strong></li>
<li><strong>每个节点都必须要访问kubernetes的service:443和kube-dns的service:53</strong></li>
<li><strong>每个Pod和Pod之间能通信（同namespace能通信，跨namespace能通信，跨主机通信）</strong></li>
</ul>
<h2 id="十三、kube-master的组件状态"><a href="#十三、kube-master的组件状态" class="headerlink" title="十三、kube-master的组件状态"></a>十三、kube-master的组件状态</h2><p>​    <strong>在kubernetes集群中master节点有三个控制组件，其中kube-apiserver为无状态服务，而另外两个组件是有状态服务，这两个组件同时只会运行集群中的任意一个。</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看kube-controller-manager、kube-scheduler正在运行的节点</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get leases -n kube-system</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/14.png" alt="image-20240617194259305"></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">L66</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://l66stbz.github.io/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/">https://l66stbz.github.io/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://l66stbz.github.io" target="_blank">L66</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a></div><div class="post_share"><div class="social-share" data-image="https://l66stbz.github.io/2024/09/24/kubernetes容忍及污点/09-kubernetes容忍及污点/1.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2024/09/16/Kubernetes%E5%9F%BA%E7%A1%80%E8%B5%84%E6%BA%90%E8%B0%83%E5%BA%A6/03-Kubernetes%E5%9F%BA%E7%A1%80%E8%B5%84%E6%BA%90%E8%B0%83%E5%BA%A6/"><img class="prev_cover" src="https://l66stbz.github.io/2024/09/16/Kubernetes基础资源调度/03-Kubernetes基础资源调度/1.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Kubernetes基础资源调度</div></div></a></div><div class="next-post pull_right"><a href="/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/"><img class="next_cover" src="https://l66stbz.github.io/2024/09/14/Kubernetes容器编排工具部署（adm）/02-Kubernetes容器编排工具部署（adm）/1.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Kubernetes容器编排工具部署（adm）</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2024/09/24/kubernetes容忍及污点/09-kubernetes容忍及污点/" title="Kubernetes容忍及污点"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/24/kubernetes容忍及污点/09-kubernetes容忍及污点/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-24</div><div class="relatedPosts_title">Kubernetes容忍及污点</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/13/Kubernetes基础概念/01-Kubernetes基础概念/" title="Kubernetes基础概念"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/13/Kubernetes基础概念/01-Kubernetes基础概念/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-13</div><div class="relatedPosts_title">Kubernetes基础概念</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/14/Kubernetes容器编排工具部署（adm）/02-Kubernetes容器编排工具部署（adm）/" title="Kubernetes容器编排工具部署（adm）"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/14/Kubernetes容器编排工具部署（adm）/02-Kubernetes容器编排工具部署（adm）/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-14</div><div class="relatedPosts_title">Kubernetes容器编排工具部署（adm）</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/19/Kubernetes RBAC细粒度权限划分/07-Kubernetes RBAC细粒度权限划分/" title="Kubernetes RBAC细粒度权限划分"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/19/Kubernetes RBAC细粒度权限划分/07-Kubernetes RBAC细粒度权限划分/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-19</div><div class="relatedPosts_title">Kubernetes RBAC细粒度权限划分</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/20/Kubernetes持久化文件存储/08-Kubernetes持久化文件存储/" title="Kubernetes持久化文件存储"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/20/Kubernetes持久化文件存储/08-Kubernetes持久化文件存储/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-20</div><div class="relatedPosts_title">Kubernetes持久化文件存储</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/18/Kubernetes配置管理/06-Kubernetes配置管理/" title="Kubernetes配置管理"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/18/Kubernetes配置管理/06-Kubernetes配置管理/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-18</div><div class="relatedPosts_title">Kubernetes配置管理</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By L66</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/js/third-party/click_heart.js"></script></body></html>