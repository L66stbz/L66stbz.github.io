<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kubernetes持久化文件存储 | L66</title><meta name="description" content="[TOC] 一、搭建nfs动态存储1、 准备一台nfs服务器123456789101112131415161718192021# Step 1：创建数据目录$ mkdir &#x2F;data&#x2F;k8s -p# step 2：安装nfs$ yum install -y nfs-utils# step 3：授予数据目录权限$ chomd 777 -R &#x2F;data# step 4：共享数据目录$ cat &gt;"><meta name="keywords" content="Linux,Kubernetes"><meta name="author" content="L66"><meta name="copyright" content="L66"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/3.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Kubernetes持久化文件存储"><meta name="twitter:description" content="[TOC] 一、搭建nfs动态存储1、 准备一台nfs服务器123456789101112131415161718192021# Step 1：创建数据目录$ mkdir &#x2F;data&#x2F;k8s -p# step 2：安装nfs$ yum install -y nfs-utils# step 3：授予数据目录权限$ chomd 777 -R &#x2F;data# step 4：共享数据目录$ cat &gt;"><meta name="twitter:image" content="https://l66stbz.github.io/2024/09/23/spring cloud k8s容器化部署/spring cloud k8s容器化部署若依/1.png"><meta property="og:type" content="article"><meta property="og:title" content="Kubernetes持久化文件存储"><meta property="og:url" content="https://l66stbz.github.io/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/"><meta property="og:site_name" content="L66"><meta property="og:description" content="[TOC] 一、搭建nfs动态存储1、 准备一台nfs服务器123456789101112131415161718192021# Step 1：创建数据目录$ mkdir &#x2F;data&#x2F;k8s -p# step 2：安装nfs$ yum install -y nfs-utils# step 3：授予数据目录权限$ chomd 777 -R &#x2F;data# step 4：共享数据目录$ cat &gt;"><meta property="og:image" content="https://l66stbz.github.io/2024/09/23/spring cloud k8s容器化部署/spring cloud k8s容器化部署若依/1.png"><meta property="article:published_time" content="2024-09-23T13:50:00.000Z"><meta property="article:modified_time" content="2024-09-26T13:09:11.820Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://l66stbz.github.io/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/"><link rel="next" title="Kubernetes持久化文件存储" href="https://l66stbz.github.io/2024/09/20/Kubernetes%E6%8C%81%E4%B9%85%E5%8C%96%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8/08-Kubernetes%E6%8C%81%E4%B9%85%E5%8C%96%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="APlayer.min.css"><div id="aplayer"></div><script src="https://cdn.jsdelivr.net/gh/radium-bit/res@master/live2d/autoload.js" async></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js" async></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="L66" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/2.jpg" onerror="onerror=null;src='/img/2.jpg'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">67</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">37</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/photo/"><i class="fa-fw fa fa-film"></i><span> Photo</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、搭建nfs动态存储"><span class="toc-number">1.</span> <span class="toc-text">一、搭建nfs动态存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、-准备一台nfs服务器"><span class="toc-number">1.1.</span> <span class="toc-text">1、 准备一台nfs服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、Kubernetes集群操作"><span class="toc-number">1.2.</span> <span class="toc-text">2、Kubernetes集群操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、MySQL8-0一主两从集群容器化部署"><span class="toc-number">2.</span> <span class="toc-text">二、MySQL8.0一主两从集群容器化部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-创建namespace"><span class="toc-number">2.1.</span> <span class="toc-text">1. 创建namespace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-创建存放MySQL密码secret"><span class="toc-number">2.2.</span> <span class="toc-text">2. 创建存放MySQL密码secret</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-创建MySQL-master节点configmap配置文件"><span class="toc-number">2.3.</span> <span class="toc-text">3. 创建MySQL-master节点configmap配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-创建MySQL主节点"><span class="toc-number">2.4.</span> <span class="toc-text">4. 创建MySQL主节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-nfs服务器查看挂载目录（nfs-server主机操作）"><span class="toc-number">2.5.</span> <span class="toc-text">5. nfs服务器查看挂载目录（nfs-server主机操作）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-部署第一个mysql-slave节点"><span class="toc-number">2.6.</span> <span class="toc-text">6. 部署第一个mysql-slave节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-创建mysql-slave01节点"><span class="toc-number">2.7.</span> <span class="toc-text">7. 创建mysql-slave01节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-查看nfs挂载目录数据（nfs-server节点查看）"><span class="toc-number">2.8.</span> <span class="toc-text">8. 查看nfs挂载目录数据（nfs-server节点查看）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-部署第二个mysql-slave02节点"><span class="toc-number">2.9.</span> <span class="toc-text">9. 部署第二个mysql-slave02节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-创建mysql-slave02节点"><span class="toc-number">2.10.</span> <span class="toc-text">10. 创建mysql-slave02节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-三台MySQL组成集群"><span class="toc-number">2.11.</span> <span class="toc-text">11. 三台MySQL组成集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-1-查看主节点状态信息"><span class="toc-number">2.11.1.</span> <span class="toc-text">11.1 查看主节点状态信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-2-两台mysql-slave节点连接master节点"><span class="toc-number">2.11.2.</span> <span class="toc-text">11.2 两台mysql-slave节点连接master节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-3-mysql-slave01执行命令连接master容器"><span class="toc-number">2.11.3.</span> <span class="toc-text">11.3 mysql-slave01执行命令连接master容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-4-mysql-slave02执行命令连接mater容器"><span class="toc-number">2.11.4.</span> <span class="toc-text">11.4 mysql-slave02执行命令连接mater容器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-测试MySQL主从集群"><span class="toc-number">2.12.</span> <span class="toc-text">12. 测试MySQL主从集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、Redis三主三从cluster集群部署"><span class="toc-number">3.</span> <span class="toc-text">三、Redis三主三从cluster集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-redis-cluster集群初始化"><span class="toc-number">3.1.</span> <span class="toc-text">1. redis cluster集群初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-redis-cluster集群组建"><span class="toc-number">3.2.</span> <span class="toc-text">2. redis cluster集群组建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-redis-cluster集群测试"><span class="toc-number">3.3.</span> <span class="toc-text">3. redis cluster集群测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、Nocas集群部署"><span class="toc-number">4.</span> <span class="toc-text">四、Nocas集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-创建数据库（此数据包含了nacos配置文件表）"><span class="toc-number">4.1.</span> <span class="toc-text">1. 创建数据库（此数据包含了nacos配置文件表）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-创建nacos-configmap"><span class="toc-number">4.2.</span> <span class="toc-text">2. 创建nacos configmap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-创建nacos-集群Pod"><span class="toc-number">4.3.</span> <span class="toc-text">3. 创建nacos 集群Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-测试nacos集群"><span class="toc-number">4.4.</span> <span class="toc-text">4. 测试nacos集群</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#若依微服务项目容器化部署"><span class="toc-number"></span> <span class="toc-text">若依微服务项目容器化部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、创建项目部署命名空间"><span class="toc-number">1.</span> <span class="toc-text">一、创建项目部署命名空间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、创建部署环境configmap（代码需指定部署环境）"><span class="toc-number">2.</span> <span class="toc-text">二、创建部署环境configmap（代码需指定部署环境）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、创建MySQL"><span class="toc-number">3.</span> <span class="toc-text">二、创建MySQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-创建MySQL-密码secret"><span class="toc-number">3.1.</span> <span class="toc-text">1. 创建MySQL 密码secret</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-创建MySQL-配置文件configmap"><span class="toc-number">3.2.</span> <span class="toc-text">2. 创建MySQL 配置文件configmap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-部署MySQL-Pod"><span class="toc-number">3.3.</span> <span class="toc-text">3. 部署MySQL Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-MySQL-验证使用"><span class="toc-number">3.4.</span> <span class="toc-text">4. MySQL 验证使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、部署Nacos"><span class="toc-number">4.</span> <span class="toc-text">三、部署Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-创建configmap"><span class="toc-number">4.1.</span> <span class="toc-text">1. 创建configmap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-部署Nacos-Pod"><span class="toc-number">4.2.</span> <span class="toc-text">2. 部署Nacos Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-创建nacos-ingress"><span class="toc-number">4.3.</span> <span class="toc-text">3. 创建nacos ingress</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、部署redis"><span class="toc-number">5.</span> <span class="toc-text">四、部署redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-配置redis-配置文件configmap"><span class="toc-number">5.1.</span> <span class="toc-text">1. 配置redis 配置文件configmap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-部署redis-Pod"><span class="toc-number">5.2.</span> <span class="toc-text">2. 部署redis Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-测试redis可用性"><span class="toc-number">5.3.</span> <span class="toc-text">3. 测试redis可用性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、部署sentinel"><span class="toc-number">6.</span> <span class="toc-text">五、部署sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-创建Sentinel的ConfigMap"><span class="toc-number">6.1.</span> <span class="toc-text">1. 创建Sentinel的ConfigMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-创建sentinel-密码secret"><span class="toc-number">6.2.</span> <span class="toc-text">2. 创建sentinel 密码secret</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-创建sentinel-Pod"><span class="toc-number">6.3.</span> <span class="toc-text">3. 创建sentinel Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-使用ingress-暴露sentinel"><span class="toc-number">6.4.</span> <span class="toc-text">4. 使用ingress 暴露sentinel</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、部署file模块"><span class="toc-number">7.</span> <span class="toc-text">六、部署file模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-部署file-Pod"><span class="toc-number">7.1.</span> <span class="toc-text">1. 部署file Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-nacos-验证file模块是否注册"><span class="toc-number">7.2.</span> <span class="toc-text">2. nacos 验证file模块是否注册</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七、gateway网关服务部署"><span class="toc-number">8.</span> <span class="toc-text">七、gateway网关服务部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-部署-gateway-Pod"><span class="toc-number">8.1.</span> <span class="toc-text">1. 部署 gateway Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-nacos-验证gateway是否注册"><span class="toc-number">8.2.</span> <span class="toc-text">2. nacos 验证gateway是否注册</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#八、部署system模块"><span class="toc-number">9.</span> <span class="toc-text">八、部署system模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-部署system-Pod"><span class="toc-number">9.1.</span> <span class="toc-text">1. 部署system Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-nacos-验证system-是否注册"><span class="toc-number">9.2.</span> <span class="toc-text">2. nacos 验证system 是否注册</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#九、部署auth-模块"><span class="toc-number">10.</span> <span class="toc-text">九、部署auth 模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-部署auth-Pod"><span class="toc-number">10.1.</span> <span class="toc-text">1. 部署auth Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-nacos-验证auth是否注册"><span class="toc-number">10.2.</span> <span class="toc-text">2. nacos 验证auth是否注册</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十、部署前端应用"><span class="toc-number">11.</span> <span class="toc-text">十、部署前端应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-部署前端Pod"><span class="toc-number">11.1.</span> <span class="toc-text">1. 部署前端Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-使用ingress-暴露前端服务（无法正常使用，需要修改前端svc的类型为NodePort）"><span class="toc-number">11.2.</span> <span class="toc-text">2. 使用ingress 暴露前端服务（无法正常使用，需要修改前端svc的类型为NodePort）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十一、部署Job-模块"><span class="toc-number">12.</span> <span class="toc-text">十一、部署Job 模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-部署job模块-Pod"><span class="toc-number">12.1.</span> <span class="toc-text">1. 部署job模块 Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-nacos-验证job模块是否注册成功"><span class="toc-number">12.2.</span> <span class="toc-text">2. nacos 验证job模块是否注册成功</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-若依前端界面查看定时任务模块是否加载成功"><span class="toc-number">12.3.</span> <span class="toc-text">3. 若依前端界面查看定时任务模块是否加载成功</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十二、部署gen-模块"><span class="toc-number">13.</span> <span class="toc-text">十二、部署gen 模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-部署gen-Pod"><span class="toc-number">13.1.</span> <span class="toc-text">1. 部署gen Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-nacos-验证gen模块是否注册"><span class="toc-number">13.2.</span> <span class="toc-text">2. nacos 验证gen模块是否注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-若依前端验证代码生成模块是否可用"><span class="toc-number">13.3.</span> <span class="toc-text">3. 若依前端验证代码生成模块是否可用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十三、部署monitor模块"><span class="toc-number">14.</span> <span class="toc-text">十三、部署monitor模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-部署monitor-Pod"><span class="toc-number">14.1.</span> <span class="toc-text">1. 部署monitor Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-nacos-验证monitor-是否注册"><span class="toc-number">14.2.</span> <span class="toc-text">2. nacos 验证monitor 是否注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-设置svc-NodePort类型-暴露monitor服务"><span class="toc-number">14.3.</span> <span class="toc-text">3. 设置svc NodePort类型 暴露monitor服务</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://l66stbz.github.io/2024/09/23/spring cloud k8s容器化部署/spring cloud k8s容器化部署若依/1.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">L66</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/photo/"><i class="fa-fw fa fa-film"></i><span> Photo</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Kubernetes持久化文件存储</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2024-09-23 21:50:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2024-09-23</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2024-09-26 21:09:11"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2024-09-26</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p>[TOC]</p>
<h2 id="一、搭建nfs动态存储"><a href="#一、搭建nfs动态存储" class="headerlink" title="一、搭建nfs动态存储"></a>一、搭建nfs动态存储</h2><h3 id="1、-准备一台nfs服务器"><a href="#1、-准备一台nfs服务器" class="headerlink" title="1、 准备一台nfs服务器"></a>1、 准备一台nfs服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Step 1：创建数据目录</span></span><br><span class="line">$ mkdir /data/k8s -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2：安装nfs</span></span><br><span class="line">$ yum install -y nfs-utils</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 3：授予数据目录权限</span></span><br><span class="line">$ chomd 777 -R /data</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 4：共享数据目录</span></span><br><span class="line">$ cat &gt;&gt; /etc/exports &lt;&lt; EOF</span><br><span class="line">/data/k8s *(rw,sync,no_root_squash)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 5：启动NFS服务</span></span><br><span class="line">$ systemctl <span class="built_in">enable</span> --now nfs-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 6：测试</span></span><br><span class="line">$ showmount  -e 192.168.174.111</span><br><span class="line">Export list <span class="keyword">for</span> 192.168.174.111:</span><br><span class="line">/data/k8s *</span><br></pre></td></tr></table></figure>

<h3 id="2、Kubernetes集群操作"><a href="#2、Kubernetes集群操作" class="headerlink" title="2、Kubernetes集群操作"></a>2、Kubernetes集群操作</h3><p>nfs驱动下载地址：<a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner" target="_blank" rel="noopener">https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner</a></p>
<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/2.png" alt="image-20240923145525063"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1：集群所有节点安装nfs-utils（所有节点）</span></span><br><span class="line">$ yum install -y nfs-utils</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2：安装nfs驱动（k8s-master01操作）</span></span><br><span class="line">$ wget https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/archive/refs/tags/nfs-subdir-external-provisioner-4.0.18.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 3：解压压缩包（k8s-master01操作）</span></span><br><span class="line">$ tar xf nfs-subdir-external-provisioner-4.0.18.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 4：切换工作目录（k8s-master01操作）</span></span><br><span class="line">$ <span class="built_in">cd</span> nfs-subdir-external-provisioner-nfs-subdir-external-provisioner-4.0.18/deploy/</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 5：修改镜像地址（k8s-master01操作）</span></span><br><span class="line">$ vim deployment.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/3.png" alt="image-20240923150950242"></p>
<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/4.png" alt="image-20240923151234342"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 6：查看资源创建所处命名空间（k8s-master01操作）</span></span><br><span class="line">yamls=$(grep -rl <span class="string">'namespace: default'</span> ./)</span><br><span class="line"> <span class="keyword">for</span> yaml <span class="keyword">in</span> <span class="variable">$&#123;yamls&#125;</span>; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$&#123;yaml&#125;</span></span><br><span class="line">  cat <span class="variable">$&#123;yaml&#125;</span> | grep <span class="string">'namespace: default'</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># setp 7：创建资源所处命名空间（k8s-master01操作）</span></span><br><span class="line">$ kubectl create namespace nfs-provisioner --dry-run=client -oyaml &gt; nfs-provisioner-ns.yaml</span><br><span class="line">	<span class="comment"># 资源清单内容如下：</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: nfs-provisioner</span><br><span class="line">spec: &#123;&#125;</span><br><span class="line">status: &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 8：查看命名空间（k8s-master01操作）</span></span><br><span class="line">$ kubectl get ns | grep nfs</span><br><span class="line">nfs-provisioner        Active        39s</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 9：替换资源创建默认命名空间（k8s-master01操作）</span></span><br><span class="line">$ sed -i <span class="string">'s/namespace: default/namespace: nfs-provisioner/g'</span> `grep -rl <span class="string">'namespace: default'</span> ./`</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 10：查看是否修改（k8s-master01操作）</span></span><br><span class="line">$ yamls=$(grep -rl <span class="string">'namespace: nfs-provisioner'</span> ./)</span><br><span class="line"> <span class="keyword">for</span> yaml <span class="keyword">in</span> <span class="variable">$&#123;yamls&#125;</span>; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$&#123;yaml&#125;</span></span><br><span class="line">  cat <span class="variable">$&#123;yaml&#125;</span> | grep <span class="string">'namespace: nfs-provisioner'</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 11：创建资源（k8s-master01操作）</span></span><br><span class="line">$ kubectl create -k .</span><br><span class="line">storageclass.storage.k8s.io/nfs-client created</span><br><span class="line">serviceaccount/nfs-client-provisioner created</span><br><span class="line">role.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created</span><br><span class="line">deployment.apps/nfs-client-provisioner created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 12：创建资源（k8s-master01操作）</span></span><br><span class="line">$ kubectl get all  -n nfs-provisioner</span><br><span class="line">NAME                                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner-5844696d4f-8hd28   1/1     Running   0          96s</span><br><span class="line"></span><br><span class="line">NAME                                     READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/nfs-client-provisioner   1/1     1            1           96s</span><br><span class="line"></span><br><span class="line">NAME                                                DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/nfs-client-provisioner-5844696d4f   1         1         1       96s</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 13：查看sc</span></span><br><span class="line">kubectl  get sc</span><br><span class="line">NAME         PROVISIONER                                   RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">nfs-client   k8s-sigs.io/nfs-subdir-external-provisioner   Delete          Immediate           <span class="literal">false</span>                  2m58s</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 14：测试使用动态存储（k8s-master01操作）,创建资源清单，内容如下</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">test-sc.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">"nginx"</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment"># 副本数</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming/nginx:1.26.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteOnce"</span> <span class="string">]</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">"nfs-client"</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># step 15：创建资源</span></span><br><span class="line">$ kubectl create -f <span class="built_in">test</span>-sc.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 16：查看资源</span></span><br><span class="line">$ kubectl get po  -l app=nginx</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-0   1/1     Running   0          3m19s</span><br><span class="line">nginx-1   1/1     Running   0          2m55s</span><br><span class="line">nginx-2   1/1     Running   0          2m30s</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 17：查看pv和pvc</span></span><br><span class="line">$ kubectl get pvc,pv</span><br><span class="line">NAME                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">persistentvolumeclaim/www-nginx-0   Bound    pvc-9e6dda2a-272f-4378-bfce-89a6539ddb7a   1Gi        RWO            nfs-client     4m11s</span><br><span class="line">persistentvolumeclaim/www-nginx-1   Bound    pvc-166f3ff2-5d9f-4dc2-9692-a652e81ee1fd   1Gi        RWO            nfs-client     3m47s</span><br><span class="line">persistentvolumeclaim/www-nginx-2   Bound    pvc-7dd6504c-1a14-42fe-8d2f-3b563d9488f1   1Gi        RWO            nfs-client     3m22s</span><br><span class="line"></span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS   REASON   AGE</span><br><span class="line">persistentvolume/pvc-166f3ff2-5d9f-4dc2-9692-a652e81ee1fd   1Gi        RWO            Delete           Bound    default/www-nginx-1   nfs-client              3m47s</span><br><span class="line">persistentvolume/pvc-7dd6504c-1a14-42fe-8d2f-3b563d9488f1   1Gi        RWO            Delete           Bound    default/www-nginx-2   nfs-client              3m21s</span><br><span class="line">persistentvolume/pvc-9e6dda2a-272f-4378-bfce-89a6539ddb7a   1Gi        RWO            Delete           Bound    default/www-nginx-0   nfs-client              4m11s</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong><code>提示：由于在sc资源清单中设置得默认得回收策略是delete，当删除pvc时自动删除pv。</code></strong></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 18：删除测试资源</span></span><br><span class="line">$ kubectl delete -f <span class="built_in">test</span>-sc.yaml </span><br><span class="line"></span><br><span class="line"><span class="comment"># step 19：删除pvc</span></span><br><span class="line">$ kubectl delete pvc www-nginx-0  www-nginx-1 www-nginx-2</span><br><span class="line">persistentvolumeclaim <span class="string">"www-nginx-0"</span> deleted</span><br><span class="line">persistentvolumeclaim <span class="string">"www-nginx-1"</span> deleted</span><br><span class="line">persistentvolumeclaim <span class="string">"www-nginx-2"</span> deleted</span><br></pre></td></tr></table></figure>

<blockquote>
<p>至此<code>nfs</code>动态存储已经部署完成！</p>
</blockquote>
<h2 id="二、MySQL8-0一主两从集群容器化部署"><a href="#二、MySQL8-0一主两从集群容器化部署" class="headerlink" title="二、MySQL8.0一主两从集群容器化部署"></a>二、MySQL8.0一主两从集群容器化部署</h2><h3 id="1-创建namespace"><a href="#1-创建namespace" class="headerlink" title="1. 创建namespace"></a>1. 创建namespace</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1：创建namespace</span></span><br><span class="line">$ kubectl create ns cloud --dry-run=client -oyaml &gt; cloud-ns.yaml</span><br><span class="line">	<span class="comment"># 资源清单内容如下</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: cloud</span><br><span class="line">spec: &#123;&#125;</span><br><span class="line">status: &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2：创建资源</span></span><br><span class="line">$ kubectl create -f cloud-ns.yaml </span><br><span class="line">namespace/cloud created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 3：查看资源</span></span><br><span class="line">$ kubectl  get ns | grep cloud</span><br><span class="line">cloud                  Active        35s</span><br></pre></td></tr></table></figure>

<h3 id="2-创建存放MySQL密码secret"><a href="#2-创建存放MySQL密码secret" class="headerlink" title="2. 创建存放MySQL密码secret"></a>2. 创建存放MySQL密码secret</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1：创建资源清单。注意修改root的密码和命名空间，我的root密码设置为的是root</span></span><br><span class="line">$ kubectl create secret generic mysql-password --namespace=cloud --from-literal=mysql_root_password=root --dry-run=client -oyaml &gt; mysqlpass-secret.yaml</span><br><span class="line">	<span class="comment"># 资源清单内容如下</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  mysql_root_password: cm9vdA==</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: mysql-password</span><br><span class="line">  namespace: cloud</span><br><span class="line">  </span><br><span class="line"><span class="comment"># step 2：创建secret资源</span></span><br><span class="line">$ kubectl create -f mysqlpass-secret.yaml </span><br><span class="line">secret/mysql-password created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 3：查看secret资源</span></span><br><span class="line">$ kubectl get secret  -n cloud</span><br><span class="line">NAME                  TYPE                                  DATA   AGE</span><br><span class="line">default-token-hb6pl   kubernetes.io/service-account-token   3      4m32s</span><br><span class="line">mysql-password        Opaque                                1      12s</span><br></pre></td></tr></table></figure>

<h3 id="3-创建MySQL-master节点configmap配置文件"><a href="#3-创建MySQL-master节点configmap配置文件" class="headerlink" title="3. 创建MySQL-master节点configmap配置文件"></a>3. 创建MySQL-master节点configmap配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 4：创建mysql-master配置文件</span></span><br><span class="line">$ vim my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">skip-host-cache</span><br><span class="line">skip-name-resolve</span><br><span class="line">datadir          = /var/lib/mysql</span><br><span class="line">socket           = /var/run/mysqld/mysqld.sock</span><br><span class="line">secure-file-priv = /var/lib/mysql-files</span><br><span class="line">pid-file         = /var/run/mysqld/mysqld.pid</span><br><span class="line">user             = mysql</span><br><span class="line">secure-file-priv = NULL</span><br><span class="line">server-id        = 1</span><br><span class="line"><span class="built_in">log</span>-bin          = master-bin</span><br><span class="line">log_bin_index    = master-bin.index</span><br><span class="line"><span class="comment">#binlog_do_db     = xiaohh_user</span></span><br><span class="line">binlog_ignore_db = information_schema</span><br><span class="line">binlog_ignore_db = mysql</span><br><span class="line">binlog_ignore_db = performance_schema</span><br><span class="line">binlog_ignore_db = sys</span><br><span class="line">binlog-format    = ROW</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">socket           = /var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line">!includedir /etc/mysql/conf.d/</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 5：创建mysql-master配置文件configmap</span></span><br><span class="line">$ kubectl create configmap mysql-master-cm -n cloud --from-file=my.cnf --dry-run=client -o yaml &gt; mysqlmaster-confmap.yaml</span><br><span class="line">	<span class="comment"># 资源清单如下</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  my.cnf: |</span><br><span class="line">    [mysqld]</span><br><span class="line">    skip-host-cache</span><br><span class="line">    skip-name-resolve</span><br><span class="line">    datadir          = /var/lib/mysql</span><br><span class="line">    socket           = /var/run/mysqld/mysqld.sock</span><br><span class="line">    secure-file-priv = /var/lib/mysql-files</span><br><span class="line">    pid-file         = /var/run/mysqld/mysqld.pid</span><br><span class="line">    user             = mysql</span><br><span class="line">    secure-file-priv = NULL</span><br><span class="line">    server-id        = 1</span><br><span class="line">    <span class="built_in">log</span>-bin          = master-bin</span><br><span class="line">    log_bin_index    = master-bin.index</span><br><span class="line">    binlog_ignore_db = information_schema</span><br><span class="line">    binlog_ignore_db = mysql</span><br><span class="line">    binlog_ignore_db = performance_schema</span><br><span class="line">    binlog_ignore_db = sys</span><br><span class="line">    binlog-format    = ROW</span><br><span class="line"></span><br><span class="line">    [client]</span><br><span class="line">    socket           = /var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line">    !includedir /etc/mysql/conf.d/</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: mysql-master-cm</span><br><span class="line">  namespace: cloud</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 6：创建资源</span></span><br><span class="line">$ kubectl create -f mysqlmaster-confmap.yaml </span><br><span class="line">configmap/mysql-master-cm created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 7：查看configmap资源</span></span><br><span class="line">$ kubectl get cm -n cloud | grep mysql</span><br><span class="line">mysql-master-cm    1      33s</span><br></pre></td></tr></table></figure>

<h3 id="4-创建MySQL主节点"><a href="#4-创建MySQL主节点" class="headerlink" title="4. 创建MySQL主节点"></a>4. 创建MySQL主节点</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 8：创建mysql-master节点资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">mysql-master-sts.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deploy-mysql-master-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">cloud</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql-master</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">3306</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30306</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql-master</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">ClientIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deploy-mysql-master</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mysql-master</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">"deploy-mysql-master-svc"</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql-master</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--collation-server=utf8mb4_unicode_ci</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--lower_case_table_names=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--default-time_zone=+8:00</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="comment"># image: docker.io/library/mysql:8.0.34</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming/mysql:8.0.34</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-conf</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/my.cnf</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">my.cnf</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mysql_root_password</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql-password</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line"><span class="comment">#      - name: mysql-data</span></span><br><span class="line"><span class="comment">#        persistentVolumeClaim:</span></span><br><span class="line"><span class="comment">#          claimName: deploy-mysql-master-nfs-pvc</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-conf</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysql-master-cm</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">my.cnf</span></span><br><span class="line">            <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">my.cnf</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mysql-data</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteOnce"</span> <span class="string">]</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">"nfs-client"</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">          </span><br><span class="line"><span class="comment"># step 9：创建MySQL-master pod</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">mysql-master-sts.yaml</span> </span><br><span class="line"><span class="string">service/deploy-mysql-master-svc</span> <span class="string">created</span></span><br><span class="line"><span class="string">statefulset.apps/deploy-mysql-master</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 10：查看Pod</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">po</span> <span class="string">-n</span> <span class="string">cloud</span></span><br><span class="line"><span class="string">NAME</span>                    <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">deploy-mysql-master-0</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">56s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 11：查看pvc，pv</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pvc,pv</span> <span class="string">-n</span> <span class="string">cloud</span></span><br><span class="line"><span class="string">NAME</span>                                                     <span class="string">STATUS</span>   <span class="string">VOLUME</span>                                     <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">STORAGECLASS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">persistentvolumeclaim/mysql-data-deploy-mysql-master-0</span>   <span class="string">Bound</span>    <span class="string">pvc-43325493-08a6-4aea-92db-491d7cf578d5</span>   <span class="string">1Gi</span>        <span class="string">RWO</span>            <span class="string">nfs-client</span>     <span class="string">2m</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAME</span>                                                        <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">RECLAIM</span> <span class="string">POLICY</span>   <span class="string">STATUS</span>   <span class="string">CLAIM</span>                                    <span class="string">STORAGECLASS</span>   <span class="string">REASON</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">persistentvolume/pvc-43325493-08a6-4aea-92db-491d7cf578d5</span>   <span class="string">1Gi</span>        <span class="string">RWO</span>            <span class="string">Delete</span>           <span class="string">Bound</span>    <span class="string">cloud/mysql-data-deploy-mysql-master-0</span>   <span class="string">nfs-client</span>              <span class="string">2m</span></span><br></pre></td></tr></table></figure>

<h3 id="5-nfs服务器查看挂载目录（nfs-server主机操作）"><a href="#5-nfs服务器查看挂载目录（nfs-server主机操作）" class="headerlink" title="5. nfs服务器查看挂载目录（nfs-server主机操作）"></a>5. nfs服务器查看挂载目录（nfs-server主机操作）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 12：查看挂载目录</span></span><br><span class="line">$ <span class="built_in">cd</span> /data/k8s/cloud-mysql-data-deploy-mysql-master-0-pvc-43325493-08a6-4aea-92db-491d7cf578d5/</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/5.png" alt="image-20240923163203493"></p>
<h3 id="6-部署第一个mysql-slave节点"><a href="#6-部署第一个mysql-slave节点" class="headerlink" title="6. 部署第一个mysql-slave节点"></a>6. 部署第一个mysql-slave节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 13：创建mysql-slave01相关文件存放目录</span></span><br><span class="line">$ mkdik mysql-slave01</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 14：切换工作目录</span></span><br><span class="line">$ <span class="built_in">cd</span> mysql-slave01</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 15：准备mysql-slave01节点configmap</span></span><br><span class="line">$ vim my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">skip-host-cache</span><br><span class="line">skip-name-resolve</span><br><span class="line">datadir          = /var/lib/mysql</span><br><span class="line">socket           = /var/run/mysqld/mysqld.sock</span><br><span class="line">secure-file-priv = /var/lib/mysql-files</span><br><span class="line">pid-file         = /var/run/mysqld/mysqld.pid</span><br><span class="line">user             = mysql</span><br><span class="line">secure-file-priv = NULL</span><br><span class="line">server-id        = 2</span><br><span class="line"><span class="built_in">log</span>-bin          = slave-bin</span><br><span class="line">relay-log        = slave-relay-bin</span><br><span class="line">relay-log-index  = slave-relay-bin.index</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">socket           = /var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line">!includedir /etc/mysql/conf.d/</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 16：创建mysql-slave01资源清单</span></span><br><span class="line">$ kubectl create configmap mysql-slave-01-cm -n cloud --from-file=my.cnf --dry-run=client -o yaml &gt; mysql-slave-01-cm.yaml</span><br><span class="line">	<span class="comment"># 资源清单内容如下</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  my.cnf: |</span><br><span class="line">    [mysqld]</span><br><span class="line">    skip-host-cache</span><br><span class="line">    skip-name-resolve</span><br><span class="line">    datadir          = /var/lib/mysql</span><br><span class="line">    socket           = /var/run/mysqld/mysqld.sock</span><br><span class="line">    secure-file-priv = /var/lib/mysql-files</span><br><span class="line">    pid-file         = /var/run/mysqld/mysqld.pid</span><br><span class="line">    user             = mysql</span><br><span class="line">    secure-file-priv = NULL</span><br><span class="line">    server-id        = 2</span><br><span class="line">    <span class="built_in">log</span>-bin          = slave-bin</span><br><span class="line">    relay-log        = slave-relay-bin</span><br><span class="line">    relay-log-index  = slave-relay-bin.index</span><br><span class="line"></span><br><span class="line">    [client]</span><br><span class="line">    socket           = /var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line">    !includedir /etc/mysql/conf.d/</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: mysql-slave-01-cm</span><br><span class="line">  namespace: cloud</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 17：创建mysql-slave01配置文件configmap</span></span><br><span class="line">$ kubectl create -f mysql-slave-01-cm.yaml </span><br><span class="line">configmap/mysql-slave-01-cm created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 18：查看configmap资源</span></span><br><span class="line">$ kubectl get cm -n cloud</span><br><span class="line">NAME                DATA   AGE</span><br><span class="line">kube-root-ca.crt    1      33m</span><br><span class="line">mysql-master-cm     1      24m</span><br><span class="line">mysql-slave-01-cm   1      29s</span><br></pre></td></tr></table></figure>

<h3 id="7-创建mysql-slave01节点"><a href="#7-创建mysql-slave01节点" class="headerlink" title="7. 创建mysql-slave01节点"></a>7. 创建mysql-slave01节点</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 19：配置mysql-slave01资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">mysql-slave01.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deploy-mysql-slave-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">cloud</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql-slave</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">3306</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30308</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql-slave</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">ClientIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deploy-mysql-slave-01</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mysql-slave</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">"deploy-mysql-slave-svc"</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql-slave</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--collation-server=utf8mb4_unicode_ci</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--lower_case_table_names=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--default-time_zone=+8:00</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming/mysql:8.0.34</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-slave01-data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-conf</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/my.cnf</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">my.cnf</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mysql_root_password</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql-password</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line"><span class="comment">#      - name: mysql-data</span></span><br><span class="line"><span class="comment">#        persistentVolumeClaim:</span></span><br><span class="line"><span class="comment">#          claimName: deploy-mysql-slave-01-nfs-pvc</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-conf</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysql-slave-01-cm</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">my.cnf</span></span><br><span class="line">            <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">my.cnf</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mysql-slave01-data</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteOnce"</span> <span class="string">]</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">"nfs-client"</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 20：创建mysql-slave01 pod</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">-f</span> <span class="string">mysql-slave01.yaml</span> </span><br><span class="line"><span class="string">NAME</span>                             <span class="string">TYPE</span>       <span class="string">CLUSTER-IP</span>      <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>          <span class="string">AGE</span></span><br><span class="line"><span class="string">service/deploy-mysql-slave-svc</span>   <span class="string">NodePort</span>   <span class="number">10.96</span><span class="number">.253</span><span class="number">.198</span>   <span class="string">&lt;none&gt;</span>        <span class="number">3306</span><span class="string">:30308/TCP</span>   <span class="string">3m36s</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAME</span>                                     <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">statefulset.apps/deploy-mysql-slave-01</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">3m36s</span></span><br></pre></td></tr></table></figure>

<h3 id="8-查看nfs挂载目录数据（nfs-server节点查看）"><a href="#8-查看nfs挂载目录数据（nfs-server节点查看）" class="headerlink" title="8. 查看nfs挂载目录数据（nfs-server节点查看）"></a>8. 查看nfs挂载目录数据（nfs-server节点查看）</h3><p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/6.png" alt="image-20240923164959890"></p>
<h3 id="9-部署第二个mysql-slave02节点"><a href="#9-部署第二个mysql-slave02节点" class="headerlink" title="9. 部署第二个mysql-slave02节点"></a>9. 部署第二个mysql-slave02节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 21：创建工作目录</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/ &amp;&amp; mkdir mysql-slave02 &amp;&amp; <span class="built_in">cd</span> mysql-slave02</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 22：编写mysql-slave02 my.cnf配置文件</span></span><br><span class="line">$ vim my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">skip-host-cache</span><br><span class="line">skip-name-resolve</span><br><span class="line">datadir          = /var/lib/mysql</span><br><span class="line">socket           = /var/run/mysqld/mysqld.sock</span><br><span class="line">secure-file-priv = /var/lib/mysql-files</span><br><span class="line">pid-file         = /var/run/mysqld/mysqld.pid</span><br><span class="line">user             = mysql</span><br><span class="line">secure-file-priv = NULL</span><br><span class="line">server-id        = 3</span><br><span class="line"><span class="built_in">log</span>-bin          = slave-bin</span><br><span class="line">relay-log        = slave-relay-bin</span><br><span class="line">relay-log-index  = slave-relay-bin.index</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">socket           = /var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line">!includedir /etc/mysql/conf.d/</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 22：创建mysql-slave02 configmap资源清单</span></span><br><span class="line">$ kubectl create configmap mysql-slave-02-cm -n cloud --from-file=my.cnf --dry-run=client -o yaml &gt; mysql-slave02-cm.yaml</span><br><span class="line">	<span class="comment"># 资源清单内容如下</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  my.cnf: |</span><br><span class="line">    [mysqld]</span><br><span class="line">    skip-host-cache</span><br><span class="line">    skip-name-resolve</span><br><span class="line">    datadir          = /var/lib/mysql</span><br><span class="line">    socket           = /var/run/mysqld/mysqld.sock</span><br><span class="line">    secure-file-priv = /var/lib/mysql-files</span><br><span class="line">    pid-file         = /var/run/mysqld/mysqld.pid</span><br><span class="line">    user             = mysql</span><br><span class="line">    secure-file-priv = NULL</span><br><span class="line">    server-id        = 3</span><br><span class="line">    <span class="built_in">log</span>-bin          = slave-bin</span><br><span class="line">    relay-log        = slave-relay-bin</span><br><span class="line">    relay-log-index  = slave-relay-bin.index</span><br><span class="line"></span><br><span class="line">    [client]</span><br><span class="line">    socket           = /var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line">    !includedir /etc/mysql/conf.d/</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: mysql-slave-02-cm</span><br><span class="line">  namespace: cloud</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 23：创建mysql-slave02 配置文件configmap</span></span><br><span class="line">$ kubectl create -f mysql-slave02-cm.yaml </span><br><span class="line">configmap/mysql-slave-02-cm created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 24：查看资源</span></span><br><span class="line">$ kubectl get cm -n cloud</span><br><span class="line">NAME                DATA   AGE</span><br><span class="line">kube-root-ca.crt    1      57m</span><br><span class="line">mysql-master-cm     1      47m</span><br><span class="line">mysql-slave-01-cm   1      24m</span><br><span class="line">mysql-slave-02-cm   1      36s</span><br></pre></td></tr></table></figure>

<h3 id="10-创建mysql-slave02节点"><a href="#10-创建mysql-slave02节点" class="headerlink" title="10. 创建mysql-slave02节点"></a>10. 创建mysql-slave02节点</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 25：创建mysql-slave02资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">mysql-slave02-sts.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deploy-mysql-slave-02</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mysql-slave-02</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">"deploy-mysql-slave-svc"</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql-slave-02</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--collation-server=utf8mb4_unicode_ci</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--lower_case_table_names=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--default-time_zone=+8:00</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming/mysql:8.0.34</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-slave02-data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-conf</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/my.cnf</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">my.cnf</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mysql_root_password</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql-password</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line"><span class="comment">#      - name: mysql-data</span></span><br><span class="line"><span class="comment">#        persistentVolumeClaim:</span></span><br><span class="line"><span class="comment">#          claimName: deploy-mysql-slave-02-nfs-pvc</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-conf</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysql-slave-02-cm</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">my.cnf</span></span><br><span class="line">            <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">my.cnf</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mysql-slave02-data</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteOnce"</span> <span class="string">]</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">"nfs-client"</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 26：创建Pod</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">mysql-slave02-sts.yaml</span> </span><br><span class="line"><span class="string">statefulset.apps/deploy-mysql-slave-02</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 27：查看Pod</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">po</span> <span class="string">-n</span> <span class="string">cloud</span></span><br><span class="line"><span class="string">NAME</span>                      <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">deploy-mysql-master-0</span>     <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">43m</span></span><br><span class="line"><span class="string">deploy-mysql-slave-01-0</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">24m</span></span><br><span class="line"><span class="string">deploy-mysql-slave-02-0</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">94s</span></span><br></pre></td></tr></table></figure>

<h3 id="11-三台MySQL组成集群"><a href="#11-三台MySQL组成集群" class="headerlink" title="11. 三台MySQL组成集群"></a>11. 三台MySQL组成集群</h3><h4 id="11-1-查看主节点状态信息"><a href="#11-1-查看主节点状态信息" class="headerlink" title="11.1 查看主节点状态信息"></a>11.1 查看主节点状态信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1：进入MySQL主节点容器</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it deploy-mysql-master-0 -n cloud  -- bash</span><br><span class="line">	<span class="comment"># step 1.1：登录mysql</span></span><br><span class="line">bash-4.4<span class="comment"># mysql -uroot -proot</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># step 1.2：查看master状态</span></span><br><span class="line">mysql&gt; show master status;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/7.png" alt="image-20240923194018366"></p>
<h4 id="11-2-两台mysql-slave节点连接master节点"><a href="#11-2-两台mysql-slave节点连接master节点" class="headerlink" title="11.2 两台mysql-slave节点连接master节点"></a>11.2 两台mysql-slave节点连接master节点</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change master to master_host=<span class="string">'deploy-mysql-master-0.deploy-mysql-master-svc.cloud.svc.cluster.local'</span>, master_port=3306, master_user=<span class="string">'root'</span>, master_password=<span class="string">'root'</span>, master_log_file=<span class="string">'master-bin.000003'</span>, master_log_pos=157, master_connect_retry=30, get_master_public_key=1;</span><br></pre></td></tr></table></figure>

<p>命令参数如下：</p>
<ul>
<li><strong>master_host</strong>: 这个参数是master的地址，kubernetes提供的解析规则是<code>pod名称.service名称.命名空间.svc.cluster.local</code>。</li>
<li><strong>master_port</strong>: 主节点的mysql端口，我们没改默认是3306。</li>
<li><strong>master_user</strong>: 登录到主节点的mysql用户。</li>
<li><strong>master_password</strong>: 登录到主节点要用到的密码。</li>
<li><strong>master_log_file</strong>: 我们之前查看mysql主节点状态时候的 File 字段。</li>
<li><strong>master_log_pos</strong>: 我们之前查看mysql主节点状态时候的 Position 字段。</li>
<li><strong>master_connect_retry</strong>: 主节点重连时间。</li>
<li><strong>get_master_public_key</strong>: 连接主mysql的公钥获取方式。</li>
</ul>
<h4 id="11-3-mysql-slave01执行命令连接master容器"><a href="#11-3-mysql-slave01执行命令连接master容器" class="headerlink" title="11.3 mysql-slave01执行命令连接master容器"></a>11.3 mysql-slave01执行命令连接master容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 2：进入mysql-slave01容器中</span></span><br><span class="line">$ kubectl get po -n cloud</span><br><span class="line">NAME                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">deploy-mysql-master-0     1/1     Running   0          55m</span><br><span class="line">deploy-mysql-slave-01-0   1/1     Running   0          37m</span><br><span class="line">deploy-mysql-slave-02-0   1/1     Running   0          14m</span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it deploy-mysql-slave-01-0  -n cloud -- bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 3：连接数据库</span></span><br><span class="line">bash-4.4<span class="comment"># mysql -uroot -proot</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 4：连接MySQL-master Pod</span></span><br><span class="line">mysql&gt; change master to master_host=<span class="string">'deploy-mysql-master-0.deploy-mysql-master-svc.cloud.svc.cluster.local'</span>, master_port=3306, master_user=<span class="string">'root'</span>, master_password=<span class="string">'root'</span>, master_log_file=<span class="string">'master-bin.000005'</span>, master_log_pos=157, master_connect_retry=30, get_master_public_key=1;</span><br><span class="line">Query OK, 0 rows affected, 11 warnings (0.12 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 5：启动slave01</span></span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.03 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 6： 查看主从连接状态</span></span><br><span class="line">mysql&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> <span class="built_in">source</span> to send event</span><br><span class="line">                  Master_Host: deploy-mysql-master-0.deploy-mysql-master-svc.cloud.svc.cluster.local</span><br><span class="line">                  Master_User: root</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 30</span><br><span class="line">              Master_Log_File: master-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 157</span><br><span class="line">               Relay_Log_File: slave-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 327</span><br><span class="line">        Relay_Master_Log_File: master-bin.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 157</span><br><span class="line">              Relay_Log_Space: 537</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: 9f372890-7985-11ef-8931-7a8c0cecaa4a</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Replica has <span class="built_in">read</span> all relay <span class="built_in">log</span>; waiting <span class="keyword">for</span> more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">       Master_public_key_path: </span><br><span class="line">        Get_master_public_key: 1</span><br><span class="line">            Network_Namespace: </span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span>, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="11-4-mysql-slave02执行命令连接mater容器"><a href="#11-4-mysql-slave02执行命令连接mater容器" class="headerlink" title="11.4 mysql-slave02执行命令连接mater容器"></a>11.4 mysql-slave02执行命令连接mater容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 7：进入mysql-slave02容器</span></span><br><span class="line">$ kubectl  get po -n cloud</span><br><span class="line">NAME                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">deploy-mysql-master-0     1/1     Running   0          66m</span><br><span class="line">deploy-mysql-slave-01-0   1/1     Running   0          48m</span><br><span class="line">deploy-mysql-slave-02-0   1/1     Running   0          24m</span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it deploy-mysql-slave-02-0 -n cloud -- bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 8：连接数据库</span></span><br><span class="line">$ bash-4.4<span class="comment"># mysql -uroot -proot</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 9：连接MySQL-master Pod</span></span><br><span class="line">mysql&gt; change master to master_host=<span class="string">'deploy-mysql-master-0.deploy-mysql-master-svc.cloud.svc.cluster.local'</span>, master_port=3306, master_user=<span class="string">'root'</span>, master_password=<span class="string">'root'</span>, master_log_file=<span class="string">'master-bin.000005'</span>, master_log_pos=157, master_connect_retry=30, get_master_public_key=1;</span><br><span class="line">Query OK, 0 rows affected, 11 warnings (0.12 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 10：启动slave01</span></span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.03 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 11： 查看主从连接状态</span></span><br><span class="line">mysql&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> <span class="built_in">source</span> to send event</span><br><span class="line">                  Master_Host: deploy-mysql-master-0.deploy-mysql-master-svc.cloud.svc.cluster.local</span><br><span class="line">                  Master_User: root</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 30</span><br><span class="line">              Master_Log_File: master-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 157</span><br><span class="line">               Relay_Log_File: slave-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 327</span><br><span class="line">        Relay_Master_Log_File: master-bin.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 157</span><br><span class="line">              Relay_Log_Space: 537</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: 9f372890-7985-11ef-8931-7a8c0cecaa4a</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Replica has <span class="built_in">read</span> all relay <span class="built_in">log</span>; waiting <span class="keyword">for</span> more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">       Master_public_key_path: </span><br><span class="line">        Get_master_public_key: 1</span><br><span class="line">            Network_Namespace: </span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span>, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="12-测试MySQL主从集群"><a href="#12-测试MySQL主从集群" class="headerlink" title="12. 测试MySQL主从集群"></a>12. 测试MySQL主从集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1：进入MySQL-master容器</span></span><br><span class="line">$ kubectl get po -n cloud</span><br><span class="line">NAME                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">deploy-mysql-master-0     1/1     Running   0          69m</span><br><span class="line">deploy-mysql-slave-01-0   1/1     Running   0          51m</span><br><span class="line">deploy-mysql-slave-02-0   1/1     Running   0          28m</span><br><span class="line">$ kubectl  <span class="built_in">exec</span> -it deploy-mysql-master-0 -n cloud -- bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2：登录数据库</span></span><br><span class="line">bash-4.4<span class="comment"># mysql -uroot -proot </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 3：创建测试库、测试表</span></span><br><span class="line">mysql&gt; CREATE DATABASE `cloud`;</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| cloud        |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 4：从库查看数据是否同步，进入mysql-slave</span></span><br><span class="line">$ kubectl get po -n cloud</span><br><span class="line">NAME                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">deploy-mysql-master-0     1/1     Running   0          74m</span><br><span class="line">deploy-mysql-slave-01-0   1/1     Running   0          56m</span><br><span class="line">deploy-mysql-slave-02-0   1/1     Running   0          32m</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it deploy-mysql-slave-01-0 -n cloud -- bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 5：进入数据库</span></span><br><span class="line">bash-4.4<span class="comment"># mysql -uroot -proot</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 6：查看数据是否同步</span></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| cloud        |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h2 id="三、Redis三主三从cluster集群部署"><a href="#三、Redis三主三从cluster集群部署" class="headerlink" title="三、Redis三主三从cluster集群部署"></a>三、Redis三主三从cluster集群部署</h2><h3 id="1-redis-cluster集群初始化"><a href="#1-redis-cluster集群初始化" class="headerlink" title="1. redis cluster集群初始化"></a>1. redis cluster集群初始化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1：查看当前启动sc</span></span><br><span class="line">$ kubectl  get sc</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/8.png" alt="image-20240923201733806"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 2：编写redis配置文件</span></span><br><span class="line">$ vim redis.conf</span><br><span class="line"><span class="comment"># 关闭保护模式</span></span><br><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志级别</span></span><br><span class="line">loglevel warning</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志存放目录</span></span><br><span class="line">logfile <span class="string">"/data/redis.log"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据文件目录</span></span><br><span class="line">dir /data</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库数量</span></span><br><span class="line">databases 16</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存数据库到数据文件</span></span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群相关配置</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-6379.conf</span><br><span class="line">cluster-node-timeout 15000</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># setp 3：创建redis配置文件cofigmap</span></span><br><span class="line">$ kubectl create configmap redis-cluster-config --from-file=redis.conf -n cloud --dry-run=client -o yaml &gt; redis-conf-cm.yaml</span><br><span class="line">	<span class="comment"># 资源清单内容如下</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  redis.conf: |+</span><br><span class="line">    <span class="comment"># 关闭保护模式</span></span><br><span class="line">    protected-mode no</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志级别</span></span><br><span class="line">    loglevel warning</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志存放目录</span></span><br><span class="line">    logfile <span class="string">"/data/redis.log"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据文件目录</span></span><br><span class="line">    dir /data</span><br><span class="line">    dbfilename dump.rdb</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据库数量</span></span><br><span class="line">    databases 16</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存数据库到数据文件</span></span><br><span class="line">    save 900 1</span><br><span class="line">    save 300 10</span><br><span class="line">    save 60 10000</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 集群相关配置</span></span><br><span class="line">    cluster-enabled yes</span><br><span class="line">    cluster-config-file nodes-6379.conf</span><br><span class="line">    cluster-node-timeout 15000</span><br><span class="line"></span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: redis-cluster-config</span><br><span class="line">  namespace: cloud</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 4：创建confimap</span></span><br><span class="line">$ kubectl create -f redis-conf-cm.yaml </span><br><span class="line">configmap/redis-cluster-config created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 5：查看资源</span></span><br><span class="line">$ kubectl  get cm -n cloud</span><br><span class="line">NAME                   DATA   AGE</span><br><span class="line">kube-root-ca.crt       1      4h18m</span><br><span class="line">mysql-master-cm        1      4h8m</span><br><span class="line">mysql-slave-01-cm      1      3h44m</span><br><span class="line">mysql-slave-02-cm      1      3h20m</span><br><span class="line">redis-cluster-config   1      42s</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 6：创建redis集群Pod</span></span><br><span class="line">$ vim redis-cluster.yaml</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: deploy-redis-svc</span><br><span class="line">  namespace: cloud</span><br><span class="line">  labels:</span><br><span class="line">    app: redis</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 6379</span><br><span class="line">    name: redis</span><br><span class="line">    targetPort: 6379</span><br><span class="line">    nodePort: 30379</span><br><span class="line">  selector:</span><br><span class="line">    app: redis</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  sessionAffinity: ClientIP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: deploy-redis</span><br><span class="line">  namespace: cloud</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: redis</span><br><span class="line">  <span class="comment"># 引用上面定义的Service</span></span><br><span class="line">  serviceName: <span class="string">"deploy-redis-svc"</span></span><br><span class="line">  <span class="comment"># 注意这里部署六个节点，按照本篇文章的逻辑最好不要修改</span></span><br><span class="line">  replicas: 6</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: redis</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 10</span><br><span class="line">      containers:</span><br><span class="line">      - <span class="built_in">command</span>:</span><br><span class="line">      	<span class="comment"># 这里指定使用那个配置文件启动redis-server</span></span><br><span class="line">        - <span class="string">"redis-server"</span></span><br><span class="line">        - <span class="string">"/usr/local/etc/redis.conf"</span></span><br><span class="line">        name: redis</span><br><span class="line">        <span class="comment"># 因为redis6集群对域名支持不好，并且Kubernetes是需要通过域名连接各个pod的，所以我们采用redis7来完成这次部署</span></span><br><span class="line">        <span class="comment"># 如果你能拉取到DockerHub上的镜像那么你就使用这个</span></span><br><span class="line">        <span class="comment"># image: docker.io/library/redis:7.0.12</span></span><br><span class="line">        <span class="comment"># 如果你拉取不到，那么就使用我拉取并推送到国内阿里云的镜像</span></span><br><span class="line">        image: registry.cn-shenzhen.aliyuncs.com/xiaohh-docker/redis:7.0.12</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 6379</span><br><span class="line">          name: redis</span><br><span class="line">        volumeMounts:</span><br><span class="line">        <span class="comment"># 挂载redis的数据卷，使用的是我在下面声明的存储类模版</span></span><br><span class="line">        - name: redis-data</span><br><span class="line">          mountPath: /data</span><br><span class="line">        <span class="comment"># 挂载redis的配置文件</span></span><br><span class="line">        - name: redis-config</span><br><span class="line">          mountPath: /usr/<span class="built_in">local</span>/etc</span><br><span class="line">          readOnly: <span class="literal">true</span></span><br><span class="line">      volumes:</span><br><span class="line">      <span class="comment"># 读取configmap，获取redis的配置文件，方便上面挂载这个配置文件</span></span><br><span class="line">      - name: redis-config</span><br><span class="line">        configMap:</span><br><span class="line">          name: redis-cluster-config</span><br><span class="line">          items:</span><br><span class="line">          - key: redis.conf</span><br><span class="line">            path: redis.conf</span><br><span class="line">  <span class="comment"># 定义存储类模版</span></span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: redis-data <span class="comment"># 这个名字要与上面的对应</span></span><br><span class="line">    spec:</span><br><span class="line">      accessModes:</span><br><span class="line">      - ReadWriteMany <span class="comment"># 设置多节点读写模式</span></span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 1Gi <span class="comment"># 申请1个g的存储空间，可根据自己的服务器空间修改</span></span><br><span class="line">      storageClassName: nfs-client <span class="comment"># 这里填写你存储类的名字</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 7：创建资源</span></span><br><span class="line">$ kubectl create -f redis-cluster.yaml </span><br><span class="line">service/deploy-redis-svc created</span><br><span class="line">statefulset.apps/deploy-redis created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 8：查看资源</span></span><br><span class="line">$  kubectl  get po -n cloud  -l app=redis</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">deploy-redis-0   1/1     Running   0          7m51s</span><br><span class="line">deploy-redis-1   1/1     Running   0          5m50s</span><br><span class="line">deploy-redis-2   1/1     Running   0          2m</span><br><span class="line">deploy-redis-3   1/1     Running   0          96s</span><br><span class="line">deploy-redis-4   1/1     Running   0          91s</span><br><span class="line">deploy-redis-5   1/1     Running   0          68s</span><br></pre></td></tr></table></figure>

<h3 id="2-redis-cluster集群组建"><a href="#2-redis-cluster集群组建" class="headerlink" title="2. redis cluster集群组建"></a>2. redis cluster集群组建</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1：进入redis-0 Pod中</span></span><br><span class="line">$ kubectl  <span class="built_in">exec</span> -it deploy-redis-0 -n cloud -- bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2：redis-0 Pod中执行集群组建</span></span><br><span class="line">root@deploy-redis-0:/data<span class="comment"># redis-cli --cluster create --cluster-replicas 1 \</span></span><br><span class="line">deploy-redis-0.deploy-redis-svc.cloud.svc.cluster.local:6379 \</span><br><span class="line">deploy-redis-1.deploy-redis-svc.cloud.svc.cluster.local:6379 \</span><br><span class="line">deploy-redis-2.deploy-redis-svc.cloud.svc.cluster.local:6379 \</span><br><span class="line">deploy-redis-3.deploy-redis-svc.cloud.svc.cluster.local:6379 \</span><br><span class="line">deploy-redis-4.deploy-redis-svc.cloud.svc.cluster.local:6379 \</span><br><span class="line">deploy-redis-5.deploy-redis-svc.cloud.svc.cluster.local:6379</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/9.png" alt="image-20240923204125203"></p>
<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/10.png" alt="image-20240923204210303"></p>
<h3 id="3-redis-cluster集群测试"><a href="#3-redis-cluster集群测试" class="headerlink" title="3. redis cluster集群测试"></a>3. redis cluster集群测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1：redis-0 Pod中验证</span></span><br><span class="line">root@deploy-redis-0:/data<span class="comment"># redis-cli  -c</span></span><br><span class="line">127.0.0.1:6379&gt; cluster nodes</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/11.png" alt="image-20240923204400412"></p>
<h2 id="四、Nocas集群部署"><a href="#四、Nocas集群部署" class="headerlink" title="四、Nocas集群部署"></a>四、Nocas集群部署</h2><h3 id="1-创建数据库（此数据包含了nacos配置文件表）"><a href="#1-创建数据库（此数据包含了nacos配置文件表）" class="headerlink" title="1. 创建数据库（此数据包含了nacos配置文件表）"></a>1. 创建数据库（此数据包含了nacos配置文件表）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1：创建资源清单</span></span><br><span class="line">$ vim nacos-mysql.yaml</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: deploy-mysql-nacos-svc</span><br><span class="line">  namespace: cloud</span><br><span class="line">  labels:</span><br><span class="line">    app: mysql-nacos</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3306</span><br><span class="line">    name: mysql</span><br><span class="line">    targetPort: 3306</span><br><span class="line">    nodePort: 30310</span><br><span class="line">  selector:</span><br><span class="line">    app: mysql-nacos</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  sessionAffinity: ClientIP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: deploy-mysql-nacos</span><br><span class="line">  namespace: cloud</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mysql-nacos</span><br><span class="line">  serviceName: <span class="string">"deploy-mysql-nacos-svc"</span></span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: mysql-nacos</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 10</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - --character-set-server=utf8mb4</span><br><span class="line">        - --collation-server=utf8mb4_unicode_ci</span><br><span class="line">        - --lower_case_table_names=1</span><br><span class="line">        - --default-time_zone=+8:00</span><br><span class="line">        name: mysql</span><br><span class="line">        image: registry.cn-hangzhou.aliyuncs.com/hujiaming/nacos-mysql:2.0.4</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3306</span><br><span class="line">          name: mysql</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: nacos-mysql-data</span><br><span class="line">          mountPath: /var/lib/mysql</span><br><span class="line">        env:</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              key: mysql_root_password</span><br><span class="line">              name: mysql-password</span><br><span class="line">  <span class="comment"># 定义存储类模版</span></span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: nacos-mysql-data <span class="comment"># 这个名字要与上面的对应</span></span><br><span class="line">    spec:</span><br><span class="line">      accessModes:</span><br><span class="line">      - ReadWriteMany <span class="comment"># 设置多节点读写模式</span></span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 1Gi <span class="comment"># 申请1个g的存储空间，可根据自己的服务器空间修改</span></span><br><span class="line">      storageClassName: nfs-client <span class="comment"># 这里填写你存储类的名字</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2：创建资源</span></span><br><span class="line">$ kubectl create -f nacos-mysql.yaml </span><br><span class="line">service/deploy-mysql-nacos-svc created</span><br><span class="line">statefulset.apps/deploy-mysql-nacos created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 3：查看资源</span></span><br><span class="line">$ kubectl get -f nacos-mysql.yaml </span><br><span class="line">NAME                             TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/deploy-mysql-nacos-svc   NodePort   10.96.57.28   &lt;none&gt;        3306:30310/TCP   2m22s</span><br><span class="line"></span><br><span class="line">NAME                                  READY   AGE</span><br><span class="line">statefulset.apps/deploy-mysql-nacos   1/1     2m22s</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 4：查看Pod</span></span><br><span class="line">$ kubectl get po  -l app=mysql-nacos -n cloud</span><br><span class="line">NAME                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">deploy-mysql-nacos-0   1/1     Running   0          3m40s</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 5：进入Pod</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it deploy-mysql-nacos-0 -n cloud -- bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 6：在Pod中登录MySQL</span></span><br><span class="line">bash-4.2<span class="comment"># mysql -uroot -proot</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 7：查看数据库</span></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| nacos_config       |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.02 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 8：切换数据库</span></span><br><span class="line">mysql&gt; use nacos_config；</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 9：查看nacos_config数据库所有的表</span></span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+------------------------+</span><br><span class="line">| Tables_in_nacos_config |</span><br><span class="line">+------------------------+</span><br><span class="line">| config_info            |</span><br><span class="line">| config_info_aggr       |</span><br><span class="line">| config_info_beta       |</span><br><span class="line">| config_info_tag        |</span><br><span class="line">| config_tags_relation   |</span><br><span class="line">| group_capacity         |</span><br><span class="line">| his_config_info        |</span><br><span class="line">| permissions            |</span><br><span class="line">| roles                  |</span><br><span class="line">| tenant_capacity        |</span><br><span class="line">| tenant_info            |</span><br><span class="line">| users                  |</span><br><span class="line">+------------------------+</span><br><span class="line">12 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="2-创建nacos-configmap"><a href="#2-创建nacos-configmap" class="headerlink" title="2. 创建nacos configmap"></a>2. 创建nacos configmap</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1：创建configmap</span></span><br><span class="line">$ kubectl create configmap nacos-deploy-config -n cloud \</span><br><span class="line">--from-literal=mode=cluster \</span><br><span class="line">--from-literal=nacos-servers=<span class="string">'deploy-nacos-0.deploy-nacos-svc.cloud.svc.cluster.local:8848 deploy-nacos-1.deploy-nacos-svc.cloud.svc.cluster.local:8848 deploy-nacos-2.deploy-nacos-svc.cloud.svc.cluster.local:8848'</span> \</span><br><span class="line">--from-literal=spring-datasource-platform=mysql \</span><br><span class="line">--from-literal=mysql-service-host=<span class="string">'deploy-mysql-nacos-0.deploy-mysql-nacos-svc.cloud.svc.cluster.local'</span> \</span><br><span class="line">--from-literal=mysql-service-port=3306 \</span><br><span class="line">--from-literal=mysql-service-db-name=nacos_config \</span><br><span class="line">--from-literal=mysql-service-user=root \</span><br><span class="line">--from-literal=mysql-database-num=1 \</span><br><span class="line">--from-literal=mysql-service-db-param=<span class="string">'characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useSSL=false'</span> \</span><br><span class="line">--from-literal=jvm-xms=256m \</span><br><span class="line">--from-literal=jvm-xmx=256m \</span><br><span class="line">--from-literal=jvm-xmn=128m \</span><br><span class="line">--dry-run=client -o yaml &gt; nacos-mysql-file-cm.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2：创建资源</span></span><br><span class="line">$ kubectl create -f nacos-mysql-file-cm.yaml </span><br><span class="line">configmap/nacos-deploy-config created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 3：查看资源</span></span><br><span class="line">$ kubectl get -f nacos-mysql-file-cm.yaml </span><br><span class="line">NAME                  DATA   AGE</span><br><span class="line">nacos-deploy-config   12     33s</span><br></pre></td></tr></table></figure>

<h3 id="3-创建nacos-集群Pod"><a href="#3-创建nacos-集群Pod" class="headerlink" title="3. 创建nacos 集群Pod"></a>3. 创建nacos 集群Pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1：创建资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">nacos-sts.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deploy-nacos-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">cloud</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nacos</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8848</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8848</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30848</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nacos</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">ClientIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deploy-nacos</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nacos</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">"deploy-nacos-svc"</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nacos</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming/nacos-server:v2.0.4</span></span><br><span class="line">        <span class="attr">ports:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8848</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nacos</span></span><br><span class="line">        <span class="attr">env:</span> <span class="comment"># 引用各类环境变量为nacos做配置，注意大部分引用configmap，只有数据库密码引用的创建mysql时候的secret</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMN</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">jvm-xmn</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">nacos-deploy-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMS</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">jvm-xms</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">nacos-deploy-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMX</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">jvm-xmx</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">nacos-deploy-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MODE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mode</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">nacos-deploy-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_DATABASE_NUM</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mysql-database-num</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">nacos-deploy-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_DB_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mysql-service-db-name</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">nacos-deploy-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_DB_PARAM</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mysql-service-db-param</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">nacos-deploy-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_HOST</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mysql-service-host</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">nacos-deploy-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mysql_root_password</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql-password</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_PORT</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mysql-service-port</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">nacos-deploy-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_USER</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mysql-service-user</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">nacos-deploy-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NACOS_SERVERS</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">nacos-servers</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">nacos-deploy-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_DATASOURCE_PLATFORM</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">spring-datasource-platform</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">nacos-deploy-config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2：创建资源</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">nacos-sts.yaml</span> </span><br><span class="line"><span class="string">service/deploy-nacos-svc</span> <span class="string">created</span></span><br><span class="line"><span class="string">statefulset.apps/deploy-nacos</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 3：查看资源</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">po</span>  <span class="string">-n</span> <span class="string">cloud</span> <span class="string">-l</span> <span class="string">app=nacos</span></span><br><span class="line"><span class="string">NAME</span>             <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">deploy-nacos-0</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">6m17s</span></span><br><span class="line"><span class="string">deploy-nacos-1</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">6m14s</span></span><br><span class="line"><span class="string">deploy-nacos-2</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">4m13s</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">svc</span> <span class="string">-n</span> <span class="string">cloud</span> <span class="string">-l</span> <span class="string">app=nacos</span></span><br><span class="line"><span class="string">NAME</span>               <span class="string">TYPE</span>       <span class="string">CLUSTER-IP</span>    <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>          <span class="string">AGE</span></span><br><span class="line"><span class="string">deploy-nacos-svc</span>   <span class="string">NodePort</span>   <span class="number">10.96</span><span class="number">.32</span><span class="number">.82</span>   <span class="string">&lt;none&gt;</span>        <span class="number">8848</span><span class="string">:30848/TCP</span>   <span class="string">6m47s</span></span><br></pre></td></tr></table></figure>

<h3 id="4-测试nacos集群"><a href="#4-测试nacos集群" class="headerlink" title="4. 测试nacos集群"></a>4. 测试nacos集群</h3><ol>
<li><strong>登录nacos web界面</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1：查看nacos svc</span></span><br><span class="line">$ kubectl  get svc -n cloud -l app=nacos</span><br><span class="line">NAME               TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">deploy-nacos-svc   NodePort   10.96.32.82   &lt;none&gt;        8848:30848/TCP   6m47s</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>浏览器访问：http://集群节点IP+30848/nacos</strong></li>
</ol>
<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/12.png" alt="image-20240923213906093"></p>
<blockquote>
<p>用户名：nacos        密码：nacos</p>
</blockquote>
<ol start="3">
<li><strong>查看集群列表</strong></li>
</ol>
<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/13.png" alt="image-20240923214027083"></p>
<ol start="4">
<li><strong>插入测试数据</strong></li>
</ol>
<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/14.png" alt="image-20240923214223729"></p>
<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/15.png" alt="image-20240923214303929"></p>
<ol start="5">
<li><strong>数据库数据查询测试数据</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1：进入 nacos 数据库 Pod</span></span><br><span class="line">[root@k8s-master01 nacos]<span class="comment"># kubectl  exec -it deploy-mysql-nacos-0 -n cloud  -- bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2：连接数据库</span></span><br><span class="line">bash-4.2<span class="comment"># mysql -uroot -proot</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 3：查看测试数据</span></span><br><span class="line">mysql&gt; select * from nacos_config.config_info;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/16.png" alt="image-20240923214726448"></p>
<ol start="6">
<li><strong>删除测试数据</strong></li>
</ol>
<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/17.png" alt="image-20240923214809083"></p>
<h1 id="若依微服务项目容器化部署"><a href="#若依微服务项目容器化部署" class="headerlink" title="若依微服务项目容器化部署"></a>若依微服务项目容器化部署</h1><h2 id="一、创建项目部署命名空间"><a href="#一、创建项目部署命名空间" class="headerlink" title="一、创建项目部署命名空间"></a>一、创建项目部署命名空间</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1：创建项目目录</span></span><br><span class="line">$ mkdir ruoyi-cloud &amp;&amp; <span class="built_in">cd</span> ruoyi-cloud</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2：准备namespace资源清单</span></span><br><span class="line">$ kubectl create namespace yueyang-cloud --dry-run=client --output=yaml  &gt; 01-yueyang-cloud-ns.yaml</span><br><span class="line">	<span class="comment"># 资源清单内容如下</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: yueyang-cloud</span><br><span class="line">spec: &#123;&#125;</span><br><span class="line">status: &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 3：创建资源</span></span><br><span class="line">$ kubectl create -f 01-yueyang-cloud-ns.yaml </span><br><span class="line">namespace/yueyang-cloud created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 4：查看资源</span></span><br><span class="line">$ kubectl get -f 01-yueyang-cloud-ns.yaml </span><br><span class="line">NAME            STATUS   AGE</span><br><span class="line">yueyang-cloud   Active   3s</span><br></pre></td></tr></table></figure>



<h2 id="二、创建部署环境configmap（代码需指定部署环境）"><a href="#二、创建部署环境configmap（代码需指定部署环境）" class="headerlink" title="二、创建部署环境configmap（代码需指定部署环境）"></a>二、创建部署环境configmap（代码需指定部署环境）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 5：创建资源清单</span></span><br><span class="line">$ kubectl create configmap spring-profile-cm --namespace=yueyang-cloud --from-literal=spring-profiles-active=prod --dry-run=client -oyaml &gt; 02-spring-profiles-active-cm.yaml</span><br><span class="line">	<span class="comment"># 资源清单内容如下</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  spring-profiles-active: prod</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: spring-profile-cm</span><br><span class="line">  namespace: yueyang-cloud</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 6：创建confimap</span></span><br><span class="line">$ kubectl create -f 02-spring-profiles-active-cm.yaml </span><br><span class="line">configmap/spring-profile-cm created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 7：查看资源</span></span><br><span class="line">$ kubectl get -f 02-spring-profiles-active-cm.yaml </span><br><span class="line">NAME                DATA   AGE</span><br><span class="line">spring-profile-cm   1      27s</span><br></pre></td></tr></table></figure>



<h2 id="二、创建MySQL"><a href="#二、创建MySQL" class="headerlink" title="二、创建MySQL"></a>二、创建MySQL</h2><h3 id="1-创建MySQL-密码secret"><a href="#1-创建MySQL-密码secret" class="headerlink" title="1. 创建MySQL 密码secret"></a>1. 创建MySQL 密码secret</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 8：创建资源清单</span></span><br><span class="line">$ kubectl create secret generic yueyang-mysql-password-secret --namespace=yueyang-cloud  --from-literal=mysql-root-password=root --dry-run=client -oyaml &gt; 03-mysql-root-password-secret.yaml</span><br><span class="line">	<span class="comment"># 资源清单内容如下</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  mysql-root-password: cm9vdA==</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: yueyang-mysql-password-secret</span><br><span class="line">  namespace: yueyang-cloud</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 9：创建secret</span></span><br><span class="line">$ kubectl create -f 03-mysql-root-password-secret.yaml </span><br><span class="line">secret/yueyang-mysql-password-secret</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 10：查看资源</span></span><br><span class="line">$ kubectl get -f 03-mysql-root-password-secret.yaml </span><br><span class="line">NAME                             TYPE     DATA   AGE</span><br><span class="line">yueyang-mysql-password-secret   Opaque   1      6s</span><br></pre></td></tr></table></figure>

<h3 id="2-创建MySQL-配置文件configmap"><a href="#2-创建MySQL-配置文件configmap" class="headerlink" title="2. 创建MySQL 配置文件configmap"></a>2. 创建MySQL 配置文件configmap</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 11：编写my.cnf配置文件</span></span><br><span class="line">$ vim my.cnf</span><br><span class="line"><span class="comment"># For advice on how to change settings please see</span></span><br><span class="line"><span class="comment"># http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html</span></span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Remove leading # and set to the amount of RAM for the most important data</span></span><br><span class="line"><span class="comment"># cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.</span></span><br><span class="line"><span class="comment"># innodb_buffer_pool_size = 128M</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Remove leading # to turn on a very important data integrity option: logging</span></span><br><span class="line"><span class="comment"># changes to the binary log between backups.</span></span><br><span class="line"><span class="comment"># log_bin</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Remove leading # to set options mainly useful for reporting servers.</span></span><br><span class="line"><span class="comment"># The server defaults are faster for transactions and fast SELECTs.</span></span><br><span class="line"><span class="comment"># Adjust sizes as needed, experiment to find the optimal values.</span></span><br><span class="line"><span class="comment"># join_buffer_size = 128M</span></span><br><span class="line"><span class="comment"># sort_buffer_size = 2M</span></span><br><span class="line"><span class="comment"># read_rnd_buffer_size = 2M</span></span><br><span class="line">skip-host-cache</span><br><span class="line">skip-name-resolve</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/run/mysqld/mysqld.sock</span><br><span class="line">secure-file-priv=/var/lib/mysql-files</span><br><span class="line">user=mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"></span><br><span class="line"><span class="comment">#log-error=/var/log/mysqld.log</span></span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line">[client]</span><br><span class="line">socket=/var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line">!includedir /etc/mysql/conf.d/</span><br><span class="line">!includedir /etc/mysql/mysql.conf.d/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 12：准备configmap资源清单</span></span><br><span class="line">$ kubectl create configmap yueyang-mysql-config-cm --namespace=yueyang-cloud --from-file=my.cnf --dry-run=client -oyaml &gt; 04-yueyang-mysql-config-cm.yaml</span><br><span class="line">	<span class="comment"># 资源清单内容如下</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  my.cnf: |</span><br><span class="line">    <span class="comment"># For advice on how to change settings please see</span></span><br><span class="line">    <span class="comment"># http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html</span></span><br><span class="line"></span><br><span class="line">    [mysqld]</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Remove leading # and set to the amount of RAM for the most important data</span></span><br><span class="line">    <span class="comment"># cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.</span></span><br><span class="line">    <span class="comment"># innodb_buffer_pool_size = 128M</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Remove leading # to turn on a very important data integrity option: logging</span></span><br><span class="line">    <span class="comment"># changes to the binary log between backups.</span></span><br><span class="line">    <span class="comment"># log_bin</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Remove leading # to set options mainly useful for reporting servers.</span></span><br><span class="line">    <span class="comment"># The server defaults are faster for transactions and fast SELECTs.</span></span><br><span class="line">    <span class="comment"># Adjust sizes as needed, experiment to find the optimal values.</span></span><br><span class="line">    <span class="comment"># join_buffer_size = 128M</span></span><br><span class="line">    <span class="comment"># sort_buffer_size = 2M</span></span><br><span class="line">    <span class="comment"># read_rnd_buffer_size = 2M</span></span><br><span class="line">    skip-host-cache</span><br><span class="line">    skip-name-resolve</span><br><span class="line">    datadir=/var/lib/mysql</span><br><span class="line">    socket=/var/run/mysqld/mysqld.sock</span><br><span class="line">    secure-file-priv=/var/lib/mysql-files</span><br><span class="line">    user=mysql</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">    symbolic-links=0</span><br><span class="line"></span><br><span class="line">    <span class="comment">#log-error=/var/log/mysqld.log</span></span><br><span class="line">    pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line">    [client]</span><br><span class="line">    socket=/var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line">    !includedir /etc/mysql/conf.d/</span><br><span class="line">    !includedir /etc/mysql/mysql.conf.d/</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: mysql-config-cm</span><br><span class="line">  namespace: yueyang-cloud</span><br><span class="line">  </span><br><span class="line"><span class="comment"># step 13：创建资源</span></span><br><span class="line">$ kubectl create -f 04-yueyang-mysql-config-cm.yaml </span><br><span class="line">configmap/mysql-config-cm created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 14：查看资源</span></span><br><span class="line">$ kubectl get -f 04-yueyang-mysql-config-cm.yaml </span><br><span class="line">NAME                      DATA   AGE</span><br><span class="line">mysql-config-cm   1      26s</span><br></pre></td></tr></table></figure>

<h3 id="3-部署MySQL-Pod"><a href="#3-部署MySQL-Pod" class="headerlink" title="3. 部署MySQL Pod"></a>3. 部署MySQL Pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 15：编写资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="number">05</span><span class="string">-mysql-sts.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-mysql-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">3306</span></span><br><span class="line">      <span class="comment"># 如果需要NodePort暴露则将这里打开</span></span><br><span class="line">      <span class="comment"># nodePort: 30306</span></span><br><span class="line">  <span class="comment"># 如果需要NodePort暴露则将这里注释</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-mysql</span></span><br><span class="line">  <span class="comment"># 如果需要NodePort暴露则将这里改为NodePort</span></span><br><span class="line">  <span class="comment"># ClusterIP, NodePort, LoadBalancer</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="comment"># 如果需要NodePort暴露则将这里改为ClientIP</span></span><br><span class="line">  <span class="comment"># ClientIP, None</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-mysql</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">yueyang-mysql</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">"yueyang-mysql-svc"</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">yueyang-mysql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="comment"># 一些部署MySQL的参数</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--collation-server=utf8mb4_unicode_ci</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--lower_case_table_names=1</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--default-time_zone=+8:00</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">          <span class="comment"># 注意修改为你自己的镜像地址</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming-01/mysql:1.0.0</span></span><br><span class="line">          <span class="comment"># 存活探针，用于检查pod是否处于存活状态</span></span><br><span class="line"><span class="comment">#          livenessProbe:</span></span><br><span class="line">                <span class="comment"># 初始化后20秒开始检查</span></span><br><span class="line"><span class="comment">#            initialDelaySeconds: 20</span></span><br><span class="line">            <span class="comment"># 之后每过10秒检查一次</span></span><br><span class="line"><span class="comment">#            periodSeconds: 10</span></span><br><span class="line"><span class="comment">#            # 检查内容为3306端口是否存活</span></span><br><span class="line"> <span class="comment">#           tcpSocket:</span></span><br><span class="line">  <span class="comment">#            port: 3306</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-conf</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/my.cnf</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">my.cnf</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">secretKeyRef:</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">mysql-root-password</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">yueyang-mysql-password-secret</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yueyang-image-account-secret</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line"><span class="comment">#        - name: mysql-data</span></span><br><span class="line"><span class="comment">#          persistentVolumeClaim:</span></span><br><span class="line"><span class="comment">#            claimName: yueyang-mysql-pvc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-conf</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mysql-config-cm</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">my.cnf</span></span><br><span class="line">                <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">                <span class="attr">path:</span> <span class="string">my.cnf</span></span><br><span class="line">  <span class="comment"># 定义存储类模版</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mysql-data</span> <span class="comment"># 这个名字要与上面的对应</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ReadWriteMany</span> <span class="comment"># 设置多节点读写模式</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">2Gi</span> <span class="comment"># 申请2个g的存储空间，可根据自己的服务器空间修改</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">nfs-client</span> <span class="comment"># 这里填写你存储类的名字</span></span><br><span class="line">      </span><br><span class="line"></span><br><span class="line"><span class="comment"># step 16：创建资源</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="number">05</span><span class="string">-mysql-sts.yaml</span> </span><br><span class="line"><span class="string">service/yueyang-mysql-svc</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 17：查看Pod</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">po</span> <span class="string">-n</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="string">NAME</span>              <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">yueyang-mysql-0</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">8s</span></span><br></pre></td></tr></table></figure>

<h3 id="4-MySQL-验证使用"><a href="#4-MySQL-验证使用" class="headerlink" title="4. MySQL 验证使用"></a>4. MySQL 验证使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 18：进入MySQL pod</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it yueyang-mysql-0  -n yueyang-cloud -- bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 19：连接数据库</span></span><br><span class="line">$ bash-4.2<span class="comment"># mysql -uroot -proot</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 20：所有数据库</span></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| yueyang_config     |</span><br><span class="line">| yueyang_gen        |</span><br><span class="line">| yueyang_job        |</span><br><span class="line">| yueyang_seata      |</span><br><span class="line">| yueyang_system     |</span><br><span class="line">+--------------------+</span><br><span class="line">9 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure>

<h2 id="三、部署Nacos"><a href="#三、部署Nacos" class="headerlink" title="三、部署Nacos"></a>三、部署Nacos</h2><p>需要创建的configmap总共有那么几个常量：</p>
<ul>
<li><strong>jvm-xmn:</strong>  jvm新生区的内存大小</li>
<li><strong>jvm-xms:</strong>  jvm永久区的最小大小</li>
<li><strong>jvm-xmx:</strong>  jvm永久区的最大大小</li>
<li><strong>mode:</strong>  nacos启动模式，因为是单点启动，所以设置为 standalone</li>
<li><strong>mysql-database-num:</strong>  nacos连接数据库的数量，设置为1</li>
<li><strong>mysql-service-db-name:</strong>  mysql当中nacos数据库的名字。上一个步骤当中我们部署了mysql，里面关于nacos数据库的名字为yueyang_config</li>
<li><strong>mysql-service-db-param:</strong>  nacos连接数据库的参数</li>
<li><strong>mysql-service-host:</strong>  mysql数据库的地址</li>
<li>mysql-service-port:  mysql数据库的端口</li>
<li><strong>mysql-service-user:</strong>  连接mysql的用户名</li>
<li><strong>spring-datasource-platform:</strong>  nacos连接数据库的平台，只支持mysql</li>
</ul>
<h3 id="1-创建configmap"><a href="#1-创建configmap" class="headerlink" title="1. 创建configmap"></a>1. 创建configmap</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 21：配置资源清单</span></span><br><span class="line">$ kubectl create configmap yueyang-nacos-cm --namespace=yueyang-cloud --dry-run=client --output=yaml \</span><br><span class="line">--from-literal=jvm-xmn=64m \</span><br><span class="line">--from-literal=jvm-xms=128m \</span><br><span class="line">--from-literal=jvm-xmx=128m \</span><br><span class="line">--from-literal=mode=standalone \</span><br><span class="line">--from-literal=mysql-database-num=1 \</span><br><span class="line">--from-literal=mysql-service-db-name=yueyang_config \</span><br><span class="line">--from-literal=mysql-service-db-param=<span class="string">'characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useSSL=false&amp;serverTimezone=UTC'</span> \</span><br><span class="line">--from-literal=mysql-service-host=<span class="string">'yueyang-mysql-0.yueyang-mysql-svc.yueyang-cloud.svc.cluster.local'</span> \</span><br><span class="line">--from-literal=mysql-service-port=3306 \</span><br><span class="line">--from-literal=mysql-service-user=root \</span><br><span class="line">--from-literal=spring-datasource-platform=mysql  &gt; 06-yueyang-nacos-cm.yaml</span><br><span class="line">	<span class="comment"># 资源清单如下：</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  jvm-xmn: 64m</span><br><span class="line">  jvm-xms: 128m</span><br><span class="line">  jvm-xmx: 128m</span><br><span class="line">  mode: standalone</span><br><span class="line">  mysql-database-num: <span class="string">"1"</span></span><br><span class="line">  mysql-service-db-name: yueyang_config</span><br><span class="line">  mysql-service-db-param: characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=<span class="literal">true</span>&amp;useSSL=<span class="literal">false</span>&amp;serverTimezone=UTC</span><br><span class="line">  mysql-service-host: yueyang-mysql-0.yueyang-mysql-svc.yueyang-cloud.svc.cluster.local</span><br><span class="line">  mysql-service-port: <span class="string">"3306"</span></span><br><span class="line">  mysql-service-user: root</span><br><span class="line">  spring-datasource-platform: mysql</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: yueyang-nacos-cm</span><br><span class="line">  namespace: yueyang-cloud</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 22：创建资源</span></span><br><span class="line">$ kubectl create -f 06-yueyang-nacos-cm.yaml </span><br><span class="line">configmap/yueyang-nacos-cm created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 23：查看资源</span></span><br><span class="line">$ kubectl get -f 06-yueyang-nacos-cm.yaml </span><br><span class="line">NAME               DATA   AGE</span><br><span class="line">yueyang-nacos-cm   11     66s</span><br></pre></td></tr></table></figure>

<h3 id="2-部署Nacos-Pod"><a href="#2-部署Nacos-Pod" class="headerlink" title="2. 部署Nacos Pod"></a>2. 部署Nacos Pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 24：编写资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="number">07</span><span class="string">-nacos-sts.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-nacos-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-nacos</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8848</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">client</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8848</span></span><br><span class="line">      <span class="comment"># 如果你需要使用到NodePort或LoadBalancer暴露应用，那么你可以将这里打开</span></span><br><span class="line">      <span class="comment"># nodePort: 30848</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9848</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">client-rpc</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9848</span></span><br><span class="line">      <span class="comment"># nodePort: 30948</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9849</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">raft-rpc</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9849</span></span><br><span class="line">      <span class="comment"># nodePort: 30849</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">7848</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">old-raft-rpc</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">7848</span></span><br><span class="line">      <span class="comment"># nodePort: 30748</span></span><br><span class="line">  <span class="comment"># 如果你需要使用到NodePort或LoadBalancer暴露应用，那么你需要注释掉clusterIP</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-nacos</span></span><br><span class="line">  <span class="comment"># ClusterIP, NodePort, LoadBalancer</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="comment"># 如果你需要使用到NodePort或LoadBalancer暴露应用，那么你需要将这里改为ClientIP</span></span><br><span class="line">  <span class="comment"># ClientIP, None</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-nacos</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">yueyang-nacos</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">"yueyang-nacos-svc"</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">yueyang-nacos</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nacos</span></span><br><span class="line">                <span class="comment"># 这里一个是官方镜像，一个是我拉取的官方镜像然后推送到国内阿里云的镜像</span></span><br><span class="line">          <span class="comment"># image: docker.io/nacos/nacos-server:v2.0.4</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming/nacos-server:v2.0.4</span></span><br><span class="line">          <span class="comment"># 存活探针</span></span><br><span class="line"><span class="comment">#          livenessProbe:</span></span><br><span class="line">                <span class="comment"># 通过发送http的get请求确认nacos是否存活</span></span><br><span class="line"><span class="comment">#            httpGet:</span></span><br><span class="line">                <span class="comment"># 请求8848端口的/nacos/actuator/health路径，如果返回为200则证明存活</span></span><br><span class="line"><span class="comment">#              path: /nacos/actuator/health</span></span><br><span class="line"><span class="comment">#              port: 8848</span></span><br><span class="line"><span class="comment">#              scheme: HTTP</span></span><br><span class="line">            <span class="comment"># pod初始化完成后多久开始进行存活探针的检查，这里设置为30秒</span></span><br><span class="line"><span class="comment">#            initialDelaySeconds: 30</span></span><br><span class="line">            <span class="comment"># 之后每十秒检查一次是否存活</span></span><br><span class="line"><span class="comment">#            periodSeconds: 10</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8848</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">client</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9848</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">client-rpc</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9849</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">raft-rpc</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">7848</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">old-raft-rpc</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">                <span class="comment"># 挂载数据目录</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nacos-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/home/nacos/data</span></span><br><span class="line">                <span class="comment"># 挂载日志目录</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nacos-logs</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/home/nacos/logs</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">                <span class="comment"># 引用ConfigMap里面的各个属性</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMN</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">jvm-xmn</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">yueyang-nacos-cm</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMS</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">jvm-xms</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">yueyang-nacos-cm</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMX</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">jvm-xmx</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">yueyang-nacos-cm</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MODE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">mode</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">yueyang-nacos-cm</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_DATABASE_NUM</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">mysql-database-num</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">yueyang-nacos-cm</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_DB_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">mysql-service-db-name</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">yueyang-nacos-cm</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_DB_PARAM</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">mysql-service-db-param</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">yueyang-nacos-cm</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_HOST</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">mysql-service-host</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">yueyang-nacos-cm</span></span><br><span class="line">            <span class="comment"># 数据库的密码引用之前为MySQL创建的Secret</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_PASSWORD</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">secretKeyRef:</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">mysql-root-password</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">yueyang-mysql-password-secret</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_PORT</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">mysql-service-port</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">yueyang-nacos-cm</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_USER</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">mysql-service-user</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">yueyang-nacos-cm</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_DATASOURCE_PLATFORM</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">spring-datasource-platform</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">yueyang-nacos-cm</span></span><br><span class="line">  <span class="comment"># 定义存储类模版</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nacos-data</span> <span class="comment"># 这个名字要与上面的对应</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ReadWriteMany</span> <span class="comment"># 设置多节点读写模式</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">2Gi</span> <span class="comment"># 申请2个g的存储空间，可根据自己的服务器空间修改</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">nfs-client</span> <span class="comment"># 这里填写你存储类的名字</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nacos-logs</span> <span class="comment"># 这个名字要与上面的对应</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ReadWriteMany</span> <span class="comment"># 设置多节点读写模式</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">2Gi</span> <span class="comment"># 申请2个g的存储空间，可根据自己的服务器空间修改</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">nfs-client</span> <span class="comment"># 这里填写你存储类的名字</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 25：创建资源</span></span><br><span class="line">$ kubectl create -f 07-nacos-sts.yaml </span><br><span class="line">service/yueyang-nacos-svc created</span><br><span class="line">statefulset.apps/yueyang-nacos created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 26：查看资源</span></span><br><span class="line">$ kubectl  get po,svc -n yueyang-cloud</span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/yueyang-mysql-0   1/1     Running   0          18m</span><br><span class="line">pod/yueyang-nacos-0   1/1     Running   0          71s</span><br><span class="line"></span><br><span class="line">NAME                        TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                               AGE</span><br><span class="line">service/yueyang-mysql-svc   ClusterIP   None         &lt;none&gt;        3306/TCP                              18m</span><br><span class="line">service/yueyang-nacos-svc   ClusterIP   None         &lt;none&gt;        8848/TCP,9848/TCP,9849/TCP,7848/TCP   71s</span><br></pre></td></tr></table></figure>

<h3 id="3-创建nacos-ingress"><a href="#3-创建nacos-ingress" class="headerlink" title="3. 创建nacos ingress"></a>3. 创建nacos ingress</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 27：创建ingress 资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="number">08</span><span class="string">-nacos-ingress.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-nacos-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">nacos.tanke.love</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">yueyang-nacos-svc</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8848</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 28：创建ingress资源</span></span><br><span class="line">$ kubectl  create -f 08-nacos-ingress.yaml </span><br><span class="line">ingress.networking.k8s.io/yueyang-nacos-ingress created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 29：查看ingress资源</span></span><br><span class="line">$ kubectl get -f 08-nacos-ingress.yaml </span><br><span class="line">NAME                    CLASS   HOSTS              ADDRESS   PORTS   AGE</span><br><span class="line">yueyang-nacos-ingress   nginx   nacos.tanke.love             80      46s</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 30：查看ingress控制svc</span></span><br><span class="line">$ kubectl get  svc -n ingress-nginx</span><br></pre></td></tr></table></figure>

<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202409242356072.png" alt="image-20240924235646026"></p>
<p>浏览器访问<a href="http://nacos.tanke.love:30242/nacos" target="_blank" rel="noopener">http://nacos.tanke.love:30242/nacos</a></p>
<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/18.png" alt="image-20240925002025990"></p>
<h2 id="四、部署redis"><a href="#四、部署redis" class="headerlink" title="四、部署redis"></a>四、部署redis</h2><h3 id="1-配置redis-配置文件configmap"><a href="#1-配置redis-配置文件configmap" class="headerlink" title="1. 配置redis 配置文件configmap"></a>1. 配置redis 配置文件configmap</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 31：编写redis配置文件</span></span><br><span class="line">$ vim redis.conf</span><br><span class="line"><span class="comment"># 关闭保护模式</span></span><br><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line"><span class="comment"># redis链接密码，如果需要密码，那么请取消注释</span></span><br><span class="line"><span class="comment"># requirepass redis</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志级别</span></span><br><span class="line">loglevel warning</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志存放目录</span></span><br><span class="line">logfile <span class="string">"/data/redis.log"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据文件目录</span></span><br><span class="line">dir /data</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库数量</span></span><br><span class="line">databases 16</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存数据库到数据文件</span></span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 32：配置redis配置文件configmap</span></span><br><span class="line">$ kubectl create configmap yueyang-redis-config-cm --namespace=yueyang-cloud --from-file=redis.conf --dry-run=client --output=yaml &gt; 09-redis-file-cm.yaml</span><br><span class="line">	<span class="comment"># 资源清单内容如下</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  redis.conf: |</span><br><span class="line">    <span class="comment"># 关闭保护模式</span></span><br><span class="line">    protected-mode no</span><br><span class="line"></span><br><span class="line">    <span class="comment"># redis链接密码，如果需要密码，那么请取消注释</span></span><br><span class="line">    <span class="comment"># requirepass redis</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志级别</span></span><br><span class="line">    loglevel warning</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志存放目录</span></span><br><span class="line">    logfile <span class="string">"/data/redis.log"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据文件目录</span></span><br><span class="line">    dir /data</span><br><span class="line">    dbfilename dump.rdb</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据库数量</span></span><br><span class="line">    databases 16</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存数据库到数据文件</span></span><br><span class="line">    save 900 1</span><br><span class="line">    save 300 10</span><br><span class="line">    save 60 10000</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: yueyang-redis-config-cm</span><br><span class="line">  namespace: yueyang-cloud</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 33：创建资源</span></span><br><span class="line">$ kubectl create -f 09-redis-file-cm.yaml </span><br><span class="line">configmap/yueyang-redis-config-cm created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 34：查看资源</span></span><br><span class="line">$ kubectl get -f 09-redis-file-cm.yaml </span><br><span class="line">NAME                      DATA   AGE</span><br><span class="line">yueyang-redis-config-cm   1      17s</span><br></pre></td></tr></table></figure>

<h3 id="2-部署redis-Pod"><a href="#2-部署redis-Pod" class="headerlink" title="2. 部署redis Pod"></a>2. 部署redis Pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 35：编写资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="number">10</span><span class="string">-redis-sts.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-redis-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">6379</span></span><br><span class="line">      <span class="comment"># 如果需要NodePort暴露则将这里打开</span></span><br><span class="line">      <span class="comment"># nodePort: 30379</span></span><br><span class="line">   <span class="comment"># 如果需要NodePort暴露则将这里注释</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-redis</span></span><br><span class="line">  <span class="comment"># 如果需要NodePort暴露则将这里改为NodePort</span></span><br><span class="line">  <span class="comment"># ClusterIP, NodePort, LoadBalancer</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="comment"># 如果需要NodePort暴露则将这里改为ClientIP</span></span><br><span class="line">  <span class="comment"># ClientIP, None</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-redis</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">yueyang-redis</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">"yueyang-redis-svc"</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">yueyang-redis</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="comment"># 启动命令，使用指定配置文件启动</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"redis-server"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"/usr/local/etc/redis.conf"</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">                <span class="comment"># 这里一个是官方镜像，一个是我拉取的官方镜像然后推送到国内阿里云的镜像</span></span><br><span class="line">          <span class="comment"># image: docker.io/library/redis:5.0.14</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-shenzhen.aliyuncs.com/xiaohh-docker/redis:5.0.14</span></span><br><span class="line">          <span class="comment"># 存活探针</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">                <span class="comment"># pod初始化完成后20秒开始检测</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">            <span class="comment"># 之后每隔10秒检查一次</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="comment"># 检查的流程是用tcp协议去查看6379端口是否存活</span></span><br><span class="line">            <span class="attr">tcpSocket:</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">                <span class="comment"># 挂载数据目录</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">            <span class="comment"># 挂载配置文件</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-config</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/usr/local/etc</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">yueyang-redis-config-cm</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">redis.conf</span></span><br><span class="line">                <span class="attr">path:</span> <span class="string">redis.conf</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-data</span> <span class="comment"># 这个名字要与上面的对应</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ReadWriteMany</span> <span class="comment"># 设置多节点读写模式</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">2Gi</span> <span class="comment"># 申请2个g的存储空间，可根据自己的服务器空间修改</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">nfs-client</span> <span class="comment"># 这里填写你存储类的名字</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 36：创建资源</span></span><br><span class="line">$ kubectl create -f 10-redis-sts.yaml </span><br><span class="line">service/yueyang-redis-svc created</span><br><span class="line">statefulset.apps/yueyang-redis created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 37：查看资源</span></span><br><span class="line">$ kubectl get -f 10-redis-sts.yaml </span><br><span class="line">NAME                        TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/yueyang-redis-svc   ClusterIP   None         &lt;none&gt;        6379/TCP   7s</span><br><span class="line"></span><br><span class="line">NAME                             READY   AGE</span><br><span class="line">statefulset.apps/yueyang-redis   0/1     7s</span><br></pre></td></tr></table></figure>



<h3 id="3-测试redis可用性"><a href="#3-测试redis可用性" class="headerlink" title="3. 测试redis可用性"></a>3. 测试redis可用性</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 38：查看Pod</span></span><br><span class="line">$ kubectl get po -n yueyang-cloud</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE</span><br><span class="line">yueyang-mysql-0   1/1     Running   0          58m</span><br><span class="line">yueyang-nacos-0   1/1     Running   0          11m</span><br><span class="line">yueyang-redis-0   1/1     Running   0          109s</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 39：进入redis pod</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it yueyang-redis-0  -n yueyang-cloud  -- bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 40：连接redis数据库       </span></span><br><span class="line">root@yueyang-redis-0:/data<span class="comment"># redis-cli </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 41：测试</span></span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br></pre></td></tr></table></figure>



<h2 id="五、部署sentinel"><a href="#五、部署sentinel" class="headerlink" title="五、部署sentinel"></a>五、部署sentinel</h2><p>​    ruoyi-cloud需要使用到sentinel进行熔断限流</p>
<h3 id="1-创建Sentinel的ConfigMap"><a href="#1-创建Sentinel的ConfigMap" class="headerlink" title="1. 创建Sentinel的ConfigMap"></a>1. 创建Sentinel的ConfigMap</h3><p>​        镜像当中有一些环境变量，我们定义一个ConfigMap来存储它。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 42：配置资源清单</span></span><br><span class="line">$ kubectl create configmap yueyang-sentinel-cm --namespace=yueyang-cloud --dry-run=client --output=yaml --from-literal=api-port=8719 --from-literal=java-option=<span class="string">'-Dfile.encoding=UTF-8 -XX:+UseParallelGC -XX:+PrintGCDetails -Xloggc:/var/log/devops-example.gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:+DisableExplicitGC'</span> --from-literal=server-port=8718 --from-literal=xmn=64m --from-literal=xms=128m --from-literal=xmx=128m &gt; 11-sentinel-cm.yaml</span><br><span class="line">	<span class="comment"># 资源清单内容如下：</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  api-port: <span class="string">"8719"</span></span><br><span class="line">  java-option: -Dfile.encoding=UTF-8 -XX:+UseParallelGC -XX:+PrintGCDetails -Xloggc:/var/<span class="built_in">log</span>/devops-example.gc.log</span><br><span class="line">    -XX:+HeapDumpOnOutOfMemoryError -XX:+DisableExplicitGC</span><br><span class="line">  server-port: <span class="string">"8718"</span></span><br><span class="line">  xmn: 64m</span><br><span class="line">  xms: 128m</span><br><span class="line">  xmx: 128m</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: yueyang-sentinel-cm</span><br><span class="line">  namespace: yueyang-cloud</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 43：创建资源</span></span><br><span class="line">$ kubectl  create -f 11-sentinel-cm.yaml </span><br><span class="line">configmap/yueyang-sentinel-cm created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 44：查看资源</span></span><br><span class="line">$ kubectl get -f 11-sentinel-cm.yaml </span><br><span class="line">NAME                  DATA   AGE</span><br><span class="line">yueyang-sentinel-cm   6      18s</span><br></pre></td></tr></table></figure>

<h3 id="2-创建sentinel-密码secret"><a href="#2-创建sentinel-密码secret" class="headerlink" title="2. 创建sentinel 密码secret"></a>2. 创建sentinel 密码secret</h3><p>​        用secret来存储sentinel的用户名和密码。⚠️生产环境注意修改sentinel的用户名和密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 45：配置资源清单</span></span><br><span class="line">$ kubectl create secret generic yueyang-sentinel-password-secret --namespace=yueyang-cloud --dry-run=client --output=yaml --from-literal=sentinel-password=sentinel --from-literal=sentinel-username=sentinel &gt; 12-sentinel-pass.yaml</span><br><span class="line">	<span class="comment"># 资源清单内容如下</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  sentinel-password: c2VudGluZWw=</span><br><span class="line">  sentinel-username: c2VudGluZWw=</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: yueyang-sentinel-password-secret</span><br><span class="line">  namespace: yueyang-cloud</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 46：创建资源</span></span><br><span class="line">$ kubectl  create -f  12-sentinel-pass.yaml </span><br><span class="line">secret/yueyang-sentinel-password-secret created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 47：查看资源</span></span><br><span class="line">$ kubectl get -f 12-sentinel-pass.yaml </span><br><span class="line">NAME                               TYPE     DATA   AGE</span><br><span class="line">yueyang-sentinel-password-secret   Opaque   2      27s</span><br></pre></td></tr></table></figure>

<h3 id="3-创建sentinel-Pod"><a href="#3-创建sentinel-Pod" class="headerlink" title="3. 创建sentinel Pod"></a>3. 创建sentinel Pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 48：配置资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="number">13</span><span class="string">-sentinel-deploy.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-sentinel-deploy</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-sentinel-deploy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">yueyang-sentinel-deploy</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">yueyang-sentinel-deploy</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming/sentinel:1.8.6</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">sentinel</span></span><br><span class="line">        <span class="comment"># 存活探针</span></span><br><span class="line"><span class="comment">#        livenessProbe:</span></span><br><span class="line">        	<span class="comment"># 使用http的get请求判断pod是否存活，请求8719端口的/clusterNode判断pod是否存活</span></span><br><span class="line"><span class="comment">#          httpGet:</span></span><br><span class="line"><span class="comment">#            path: /clusterNode</span></span><br><span class="line"><span class="comment">#            port: 8719</span></span><br><span class="line"><span class="comment">#            scheme: HTTP</span></span><br><span class="line">          <span class="comment"># 在pod初始化完毕20秒后再开始进行存活探针</span></span><br><span class="line"><span class="comment">#          initialDelaySeconds: 20</span></span><br><span class="line">          <span class="comment"># 之后每隔10秒检查一下应用是否存活</span></span><br><span class="line"><span class="comment">#          periodSeconds: 10</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8718</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">dashboard</span></span><br><span class="line">            <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8719</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">api</span></span><br><span class="line">            <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="comment"># 引用configmap当中各类配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMX</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">configMapKeyRef:</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">xmx</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">yueyang-sentinel-cm</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMS</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">configMapKeyRef:</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">xms</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">yueyang-sentinel-cm</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMN</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">configMapKeyRef:</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">xmn</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">yueyang-sentinel-cm</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">API_PORT</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">configMapKeyRef:</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">api-port</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">yueyang-sentinel-cm</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SERVER_PORT</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">configMapKeyRef:</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">server-port</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">yueyang-sentinel-cm</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTION</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">configMapKeyRef:</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">java-option</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">yueyang-sentinel-cm</span></span><br><span class="line">          <span class="comment"># 引用secret里面的用户名和密码</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SENTINEL_USERNAME</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">sentinel-username</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">yueyang-sentinel-password-secret</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SENTINEL_PASSWORD</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">sentinel-password</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">yueyang-sentinel-password-secret</span></span><br><span class="line">        <span class="attr">resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-sentinel-deploy</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-sentinel-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dashboard</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8718</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8718</span></span><br><span class="line">      <span class="comment"># nodePort: 30718</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">api</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8719</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8719</span></span><br><span class="line">      <span class="comment"># nodePort: 30719</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-sentinel-deploy</span></span><br><span class="line">  <span class="comment"># ClusterIP, NodePort, LoadBalancer</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 49：创建资源</span></span><br><span class="line">$ kubectl create -f 13-sentinel-deploy.yaml </span><br><span class="line">deployment.apps/yueyang-sentinel-deploy created</span><br><span class="line">service/yueyang-sentinel-svc created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 50：查看资源</span></span><br><span class="line">$ kubectl get -f 13-sentinel-deploy.yaml </span><br><span class="line">NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/yueyang-sentinel-deploy   1/1     1            1           44s</span><br><span class="line"></span><br><span class="line">NAME                           TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line">service/yueyang-sentinel-svc   ClusterIP   10.96.53.233   &lt;none&gt;        8718/TCP,8719/TCP   44s</span><br></pre></td></tr></table></figure>

<h3 id="4-使用ingress-暴露sentinel"><a href="#4-使用ingress-暴露sentinel" class="headerlink" title="4. 使用ingress 暴露sentinel"></a>4. 使用ingress 暴露sentinel</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 51：配置资源清单</span></span><br><span class="line">$ vim 14-sentinel-ingress.yaml</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: yueyang-sentinel-ingress</span><br><span class="line">  namespace: yueyang-cloud</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  rules:</span><br><span class="line">  - host: sentinel.tanke.love</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          service:</span><br><span class="line">            name: yueyang-sentinel-svc</span><br><span class="line">            port:</span><br><span class="line">              number: 8718</span><br><span class="line">        path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 52：创建资源</span></span><br><span class="line">$ kubectl create -f 14-sentinel-ingress.yaml </span><br><span class="line">ingress.networking.k8s.io/yueyang-sentinel-ingress created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 53：查看资源</span></span><br><span class="line">$ kubectl get -f 14-sentinel-ingress.yaml </span><br><span class="line">NAME                       CLASS   HOSTS                 ADDRESS        PORTS   AGE</span><br><span class="line">yueyang-sentinel-ingress   nginx   sentinel.tanke.love   10.96.28.207   80      30s</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 54：查看ingress 控制器svc</span></span><br><span class="line">$ kubectl  get svc -n ingress-nginx</span><br></pre></td></tr></table></figure>

<p><img src="https://hjmimage.oss-cn-zhangjiakou.aliyuncs.com/202409250049649.png" alt="image-20240925004910592"></p>
<p>浏览器访问：<a href="http://http://sentinel.tanke.love:30242/" target="_blank" rel="noopener">http://http://sentinel.tanke.love:30242/</a></p>
<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/19.png" alt="image-20240925004923912"></p>
<blockquote>
<p>账号密码均为：<strong>sentinel</strong></p>
</blockquote>
<h2 id="六、部署file模块"><a href="#六、部署file模块" class="headerlink" title="六、部署file模块"></a>六、部署file模块</h2><h3 id="1-部署file-Pod"><a href="#1-部署file-Pod" class="headerlink" title="1. 部署file Pod"></a>1. 部署file Pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 55：配置file 服务资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="number">15</span><span class="string">-file-deploy.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-file-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="comment"># 存储类类型，我们使用nfs</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">"nfs-client"</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">        <span class="comment"># 申请的容量，生产环境注意修改</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-file-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-file-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">yueyang-file-deployment</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="string">&#123;</span> <span class="string">&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">yueyang-file-deployment</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">             <span class="comment"># 运行时环境，引用一开始创建的configmap，值为prod</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">spring-profile-cm</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">spring-profiles-active</span></span><br><span class="line">            <span class="comment"># 设置一些jvm调优参数</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTION</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"-Dfile.encoding=UTF-8 -XX:+UseParallelGC -XX:+PrintGCDetails -Xloggc:/var/log/devops-example.gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:+DisableExplicitGC"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMX</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"128m"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"128m"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMN</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"64m"</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming-01/file:1.0.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">file</span></span><br><span class="line">          <span class="comment"># 存活探针</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="comment"># 发送http get请求到10020端口的/actuator/health路径检查pod是否健康</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10020</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="comment"># pod初始化完毕20秒之后再开始</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">            <span class="comment"># 之后每10秒进行一次健康检查</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">10020</span></span><br><span class="line">          <span class="attr">resources:</span> <span class="string">&#123;</span> <span class="string">&#125;</span></span><br><span class="line">          <span class="comment"># 挂载上传文件的目录</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data/file</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">file-data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="comment"># 定义file-data，使用上一步创建的file模块的pvc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">file-data</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">yueyang-file-pvc</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 56：创建资源</span></span><br><span class="line">$ kubectl create -f 15-file-deploy.yaml </span><br><span class="line">persistentvolumeclaim/yueyang-file-pvc created</span><br><span class="line">deployment.apps/yueyang-file-deployment created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 57：查看资源</span></span><br><span class="line">$ kubectl get  -f 15-file-deploy.yaml </span><br><span class="line">NAME                                     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">persistentvolumeclaim/yueyang-file-pvc   Bound    pvc-233963b3-180c-4c7c-807d-78408f34e472   1Gi        RWX            nfs-client     78s</span><br><span class="line"></span><br><span class="line">NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/yueyang-file-deployment   1/1     1            1           78s</span><br></pre></td></tr></table></figure>

<h3 id="2-nacos-验证file模块是否注册"><a href="#2-nacos-验证file模块是否注册" class="headerlink" title="2. nacos 验证file模块是否注册"></a>2. nacos 验证file模块是否注册</h3><p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/20.png" alt="image-20240925010107104"></p>
<h2 id="七、gateway网关服务部署"><a href="#七、gateway网关服务部署" class="headerlink" title="七、gateway网关服务部署"></a>七、gateway网关服务部署</h2><h3 id="1-部署-gateway-Pod"><a href="#1-部署-gateway-Pod" class="headerlink" title="1. 部署 gateway Pod"></a>1. 部署 gateway Pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 58：创建资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="number">16</span><span class="string">-gateway-deploy.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-gateway-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-gateway-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-gateway-deployment</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-gateway-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-gateway-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">yueyang-gateway-deployment</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="string">&#123;</span> <span class="string">&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">yueyang-gateway-deployment</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">           <span class="comment"># 运行时环境，引用一开始创建的configmap，值为prod</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">spring-profile-cm</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">spring-profiles-active</span></span><br><span class="line">            <span class="comment"># 设置一些jvm调优参数</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTION</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"-Dfile.encoding=UTF-8 -XX:+UseParallelGC -XX:+PrintGCDetails -Xloggc:/var/log/devops-example.gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:+DisableExplicitGC"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMX</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"128m"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"128m"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMN</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"64m"</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming-01/gateway:1.0.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">          <span class="comment"># 存活探针</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="comment"># 发送http get请求到8080端口的/actuator/health路径检查pod是否健康</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="comment"># pod初始化完毕20秒之后再开始</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">            <span class="comment"># 之后每10秒进行一次健康检查</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">resources:</span> <span class="string">&#123;</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 59：创建资源</span></span><br><span class="line">$ kubectl replace -f 16-gateway-deploy.yaml </span><br><span class="line">service/yueyang-gateway-svc replaced</span><br><span class="line">deployment.apps/yueyang-gateway-deployment replaced</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 60：查看资源</span></span><br><span class="line">$ kubectl get -f 16-gateway-deploy.yaml </span><br><span class="line">NAME                          TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/yueyang-gateway-svc   ClusterIP   10.96.230.51   &lt;none&gt;        8080/TCP   3s</span><br><span class="line"></span><br><span class="line">NAME                                         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/yueyang-gateway-deployment   1/1     1            1           3m44s</span><br></pre></td></tr></table></figure>

<h3 id="2-nacos-验证gateway是否注册"><a href="#2-nacos-验证gateway是否注册" class="headerlink" title="2. nacos 验证gateway是否注册"></a>2. nacos 验证gateway是否注册</h3><p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/21.png" alt="image-20240925010718408"></p>
<h2 id="八、部署system模块"><a href="#八、部署system模块" class="headerlink" title="八、部署system模块"></a>八、部署system模块</h2><h3 id="1-部署system-Pod"><a href="#1-部署system-Pod" class="headerlink" title="1. 部署system Pod"></a>1. 部署system Pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 61：配置资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="number">17</span><span class="string">-system-deploy.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-system-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-system-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">10050</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">10050</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-system-deployment</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-system-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-system-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">yueyang-system-deployment</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="string">&#123;</span> <span class="string">&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">yueyang-system-deployment</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">                        <span class="comment"># 运行时环境，引用一开始创建的configmap，值为prod</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">spring-profile-cm</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">spring-profiles-active</span></span><br><span class="line">            <span class="comment"># 设置一些jvm调优参数</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTION</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"-Dfile.encoding=UTF-8 -XX:+UseParallelGC -XX:+PrintGCDetails -Xloggc:/var/log/devops-example.gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:+DisableExplicitGC"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMX</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"128m"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"128m"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMN</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"64m"</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming-01/system:1.0.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">system</span></span><br><span class="line">          <span class="comment"># 存活探针</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="comment"># 发送http get请求到10050端口的/actuator/health路径检查pod是否健康</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10050</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="comment"># pod初始化完毕20秒之后再开始</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">            <span class="comment"># 之后每10秒进行一次健康检查</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">10050</span></span><br><span class="line">          <span class="attr">resources:</span> <span class="string">&#123;</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 62：创建资源</span></span><br><span class="line">$ kubectl create -f 17-system-deploy.yaml </span><br><span class="line">service/yueyang-system-svc created</span><br><span class="line">deployment.apps/yueyang-system-deployment created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 63：查看资源</span></span><br><span class="line">$ kubectl get -f 17-system-deploy.yaml </span><br><span class="line">NAME                         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)     AGE</span><br><span class="line">service/yueyang-system-svc   ClusterIP   10.96.208.84   &lt;none&gt;        10050/TCP   2m33s</span><br><span class="line"></span><br><span class="line">NAME                                        READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/yueyang-system-deployment   1/1     1            1           2m34s</span><br></pre></td></tr></table></figure>

<h3 id="2-nacos-验证system-是否注册"><a href="#2-nacos-验证system-是否注册" class="headerlink" title="2. nacos 验证system 是否注册"></a>2. nacos 验证system 是否注册</h3><p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/22.png" alt="image-20240925011717635"></p>
<h2 id="九、部署auth-模块"><a href="#九、部署auth-模块" class="headerlink" title="九、部署auth 模块"></a>九、部署auth 模块</h2><h3 id="1-部署auth-Pod"><a href="#1-部署auth-Pod" class="headerlink" title="1. 部署auth Pod"></a>1. 部署auth Pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 64：配置资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="number">18</span><span class="string">-auth-deploy.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-auth-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-auth-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">10050</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">10050</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-auth-deployment</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-auth-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-auth-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">yueyang-auth-deployment</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="string">&#123;</span> <span class="string">&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">yueyang-auth-deployment</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        		<span class="comment"># 运行时环境，引用一开始创建的configmap，值为prod</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">spring-profile-cm</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">spring-profiles-active</span></span><br><span class="line">            <span class="comment"># 设置一些jvm调优参数</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTION</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"-Dfile.encoding=UTF-8 -XX:+UseParallelGC -XX:+PrintGCDetails -Xloggc:/var/log/devops-example.gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:+DisableExplicitGC"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMX</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"128m"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"128m"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMN</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"64m"</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming-01/auth:1.0.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">auth</span></span><br><span class="line">          <span class="comment"># 存活探针</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="comment"># 发送http get请求到10010端口的/actuator/health路径检查pod是否健康</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10010</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="comment"># pod初始化完毕20秒之后再开始</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">            <span class="comment"># 之后每10秒进行一次健康检查</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">10010</span></span><br><span class="line">          <span class="attr">resources:</span> <span class="string">&#123;</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 65：创建资源</span></span><br><span class="line">$ kubectl create -f 18-auth-deploy.yaml </span><br><span class="line">service/yueyang-auth-svc created</span><br><span class="line">deployment.apps/yueyang-auth-deployment created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 66：查看资源</span></span><br><span class="line">$ kubectl get -f 18-auth-deploy.yaml </span><br><span class="line">NAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)     AGE</span><br><span class="line">service/yueyang-auth-svc   ClusterIP   10.96.254.105   &lt;none&gt;        10050/TCP   35s</span><br><span class="line"></span><br><span class="line">NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/yueyang-auth-deployment   1/1     1            1           35s</span><br></pre></td></tr></table></figure>

<h3 id="2-nacos-验证auth是否注册"><a href="#2-nacos-验证auth是否注册" class="headerlink" title="2. nacos 验证auth是否注册"></a>2. nacos 验证auth是否注册</h3><p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/23.png" alt="image-20240925012246632"></p>
<h2 id="十、部署前端应用"><a href="#十、部署前端应用" class="headerlink" title="十、部署前端应用"></a>十、部署前端应用</h2><h3 id="1-部署前端Pod"><a href="#1-部署前端Pod" class="headerlink" title="1. 部署前端Pod"></a>1. 部署前端Pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 67：创建资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="number">19</span><span class="string">-nginx-deploy.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-ui-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-ui-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-ui-deployment</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-ui-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-ui-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">yueyang-ui-deployment</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="string">&#123;</span> <span class="string">&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">yueyang-ui-deployment</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming-01/ui:1.0.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">ui</span></span><br><span class="line">          <span class="comment"># 存活探针</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">          	<span class="comment"># 使用http get请求80的根目录，查看是否存活</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="comment"># pod初始化完毕20秒后再进行存活检查</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">            <span class="comment"># 之后每隔10秒检查一次</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">resources:</span> <span class="string">&#123;</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 68：创建资源</span></span><br><span class="line">$ kubectl create -f 19-nginx-deploy.yaml </span><br><span class="line">service/yueyang-ui-svc created</span><br><span class="line">deployment.apps/yueyang-ui-deployment created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 69：查看资源</span></span><br><span class="line">$ kubectl get -f 19-nginx-deploy.yaml </span><br><span class="line">NAME                     TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/yueyang-ui-svc   ClusterIP   10.96.45.221   &lt;none&gt;        80/TCP    24s</span><br><span class="line"></span><br><span class="line">NAME                                    READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/yueyang-ui-deployment   1/1     1            1           24s</span><br></pre></td></tr></table></figure>

<h3 id="2-使用ingress-暴露前端服务（无法正常使用，需要修改前端svc的类型为NodePort）"><a href="#2-使用ingress-暴露前端服务（无法正常使用，需要修改前端svc的类型为NodePort）" class="headerlink" title="2. 使用ingress 暴露前端服务（无法正常使用，需要修改前端svc的类型为NodePort）"></a>2. 使用ingress 暴露前端服务（无法正常使用，需要修改前端svc的类型为NodePort）</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 70：配置资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="number">20</span><span class="string">-nginx-ingress.yaml</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-ui-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">rouyi.tanke.love</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">yueyang-ui-svc</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 71：创建资源</span></span><br><span class="line">$ kubectl  create -f 20-nginx-ingress.yaml </span><br><span class="line">ingress.networking.k8s.io/yueyang-ui-ingress created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 72：查看资源</span></span><br><span class="line">$ kubectl get -f 20-nginx-ingress.yaml </span><br><span class="line">NAME                 CLASS   HOSTS              ADDRESS        PORTS   AGE</span><br><span class="line">yueyang-ui-ingress   nginx   rouyi.tanke.love   10.96.28.207   80      61s</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 73：查看ui svc</span></span><br><span class="line">$ kubectl get svc -n yueyang-cloud</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/24.png" alt="image-20240925014138882"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 74：修改svc 类型为NodePort</span></span><br><span class="line">$ kubectl edit svc yueyang-ui-svc  -n yueyang-cloud</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/25.png" alt="image-20240925014238526"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 75：查看svc NodePort端口</span></span><br><span class="line">$ kubectl get svc -n yueyang-cloud</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/26.png" alt="image-20240925014339109"></p>
<p><strong>浏览器访问http://宿主机IP+30228</strong></p>
<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/27.png" alt="image-20240925014436646"></p>
<h2 id="十一、部署Job-模块"><a href="#十一、部署Job-模块" class="headerlink" title="十一、部署Job 模块"></a>十一、部署Job 模块</h2><h3 id="1-部署job模块-Pod"><a href="#1-部署job模块-Pod" class="headerlink" title="1. 部署job模块 Pod"></a>1. 部署job模块 Pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 76：配置资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="number">21</span><span class="string">-job-deploy.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-job-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-job-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-job-deployment</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-job-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-job-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">yueyang-job-deployment</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="string">&#123;</span> <span class="string">&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">yueyang-job-deployment</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">    	<span class="comment"># 拉取镜像的secret</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        		<span class="comment"># 运行时环境，引用一开始创建的configmap，值为prod</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">spring-profile-cm</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">spring-profiles-active</span></span><br><span class="line">            <span class="comment"># 设置一些jvm调优参数</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTION</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"-Dfile.encoding=UTF-8 -XX:+UseParallelGC -XX:+PrintGCDetails -Xloggc:/var/log/devops-example.gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:+DisableExplicitGC"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMX</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"1g"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"1g"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMN</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"512m"</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming-01/job:1.0.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">job</span></span><br><span class="line">          <span class="comment"># 存活探针</span></span><br><span class="line"><span class="comment">#          livenessProbe:</span></span><br><span class="line">            <span class="comment"># 发送http get请求到10040端口的/actuator/health路径检查pod是否健康</span></span><br><span class="line"><span class="comment">#            httpGet:</span></span><br><span class="line"><span class="comment">#              path: /actuator/health</span></span><br><span class="line"><span class="comment">#              port: 10040</span></span><br><span class="line"><span class="comment">#              scheme: HTTP</span></span><br><span class="line">            <span class="comment"># pod初始化完毕20秒之后再开始</span></span><br><span class="line"><span class="comment">#            initialDelaySeconds: 20</span></span><br><span class="line">            <span class="comment"># 之后每10秒进行一次健康检查</span></span><br><span class="line"><span class="comment">#            periodSeconds: 10</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">10040</span></span><br><span class="line">          <span class="attr">resources:</span> <span class="string">&#123;</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 77：创建资源</span></span><br><span class="line">$ kubectl create -f 21-job-deploy.yaml </span><br><span class="line">service/yueyang-job-svc created</span><br><span class="line">deployment.apps/yueyang-job-deployment created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 78：查看资源</span></span><br><span class="line">$ kubectl get -f 21-job-deploy.yaml </span><br><span class="line">NAME                      TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/yueyang-job-svc   ClusterIP   10.96.37.44   &lt;none&gt;        80/TCP    39s</span><br><span class="line"></span><br><span class="line">NAME                                     READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/yueyang-job-deployment   1/1     1            1           39s</span><br></pre></td></tr></table></figure>

<h3 id="2-nacos-验证job模块是否注册成功"><a href="#2-nacos-验证job模块是否注册成功" class="headerlink" title="2. nacos 验证job模块是否注册成功"></a>2. nacos 验证job模块是否注册成功</h3><p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/28.png" alt="image-20240925015037157"></p>
<h3 id="3-若依前端界面查看定时任务模块是否加载成功"><a href="#3-若依前端界面查看定时任务模块是否加载成功" class="headerlink" title="3. 若依前端界面查看定时任务模块是否加载成功"></a>3. 若依前端界面查看定时任务模块是否加载成功</h3><p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/29.png" alt="image-20240925015243793"></p>
<h2 id="十二、部署gen-模块"><a href="#十二、部署gen-模块" class="headerlink" title="十二、部署gen 模块"></a>十二、部署gen 模块</h2><h3 id="1-部署gen-Pod"><a href="#1-部署gen-Pod" class="headerlink" title="1. 部署gen Pod"></a>1. 部署gen Pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 79：配置资源清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="number">22</span><span class="string">-gen-deploy.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-gen-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-gen-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-gen-deployment</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-gen-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-gen-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">yueyang-gen-deployment</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="string">&#123;</span> <span class="string">&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">yueyang-gen-deployment</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">    	<span class="comment"># 拉取镜像的secret</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yueyang-image-account-secret</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        		<span class="comment"># 运行时环境，引用一开始创建的configmap，值为prod</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">spring-profile-cm</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">spring-profiles-active</span></span><br><span class="line">            <span class="comment"># 设置一些jvm调优参数</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTION</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"-Dfile.encoding=UTF-8 -XX:+UseParallelGC -XX:+PrintGCDetails -Xloggc:/var/log/devops-example.gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:+DisableExplicitGC"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMX</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"1g"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"1g"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMN</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"512m"</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming-01/gen:1.0.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">gen</span></span><br><span class="line">          <span class="comment"># 存活探针</span></span><br><span class="line"><span class="comment">#          livenessProbe:</span></span><br><span class="line">            <span class="comment"># 发送http get请求到10030端口的/actuator/health路径检查pod是否健康</span></span><br><span class="line"><span class="comment">#           httpGet:</span></span><br><span class="line"><span class="comment">#              path: /actuator/health</span></span><br><span class="line"><span class="comment">#              port: 10030</span></span><br><span class="line"><span class="comment">#              scheme: HTTP</span></span><br><span class="line">            <span class="comment"># pod初始化完毕20秒之后再开始</span></span><br><span class="line"><span class="comment">#            initialDelaySeconds: 20</span></span><br><span class="line">            <span class="comment"># 之后每10秒进行一次健康检查</span></span><br><span class="line"><span class="comment">#            periodSeconds: 10</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">10030</span></span><br><span class="line">          <span class="attr">resources:</span> <span class="string">&#123;</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 80：部署资源</span></span><br><span class="line">$ kubectl create -f 22-gen-deploy.yaml </span><br><span class="line">service/yueyang-gen-svc created</span><br><span class="line">deployment.apps/yueyang-gen-deployment created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 81：查看资源</span></span><br><span class="line">$ kubectl get -f 22-gen-deploy.yaml </span><br><span class="line">NAME                      TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/yueyang-gen-svc   ClusterIP   10.96.21.87   &lt;none&gt;        80/TCP    39s</span><br><span class="line"></span><br><span class="line">NAME                                     READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/yueyang-gen-deployment   1/1     1            1           39s</span><br></pre></td></tr></table></figure>

<h3 id="2-nacos-验证gen模块是否注册"><a href="#2-nacos-验证gen模块是否注册" class="headerlink" title="2. nacos 验证gen模块是否注册"></a>2. nacos 验证gen模块是否注册</h3><p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/30.png" alt="image-20240925020010054"></p>
<h3 id="3-若依前端验证代码生成模块是否可用"><a href="#3-若依前端验证代码生成模块是否可用" class="headerlink" title="3. 若依前端验证代码生成模块是否可用"></a>3. 若依前端验证代码生成模块是否可用</h3><p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/31.png" alt="image-20240925020210036"></p>
<h2 id="十三、部署monitor模块"><a href="#十三、部署monitor模块" class="headerlink" title="十三、部署monitor模块"></a>十三、部署monitor模块</h2><h3 id="1-部署monitor-Pod"><a href="#1-部署monitor-Pod" class="headerlink" title="1. 部署monitor Pod"></a>1. 部署monitor Pod</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 82：配置资源呢清单</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="number">23</span><span class="string">-monitor-deploy.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-monitor-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-monitor-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8088</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8088</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-monitor-deployment</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">yueyang-monitor-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yueyang-monitor-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">yueyang-cloud</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">yueyang-monitor-deployment</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="string">&#123;</span> <span class="string">&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">yueyang-monitor-deployment</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        		<span class="comment"># 运行时环境，引用一开始创建的configmap，值为prod</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">spring-profile-cm</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">spring-profiles-active</span></span><br><span class="line">            <span class="comment"># 设置一些jvm调优参数</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTION</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"-Dfile.encoding=UTF-8 -XX:+UseParallelGC -XX:+PrintGCDetails -Xloggc:/var/log/devops-example.gc.log -XX:+HeapDumpOnOutOfMemoryError -XX:+DisableExplicitGC"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMX</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"1g"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"1g"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMN</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"512m"</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming-01/monitor:1.0.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">monitor</span></span><br><span class="line">          <span class="comment"># 存活探针</span></span><br><span class="line"><span class="comment">#          livenessProbe:</span></span><br><span class="line">            <span class="comment"># 发送http get请求到8088端口的/actuator/health路径检查pod是否健康</span></span><br><span class="line"><span class="comment">#            httpGet:</span></span><br><span class="line"><span class="comment">#              path: /actuator/health</span></span><br><span class="line"><span class="comment">#              port: 8088</span></span><br><span class="line"><span class="comment">#              scheme: HTTP</span></span><br><span class="line">            <span class="comment"># pod初始化完毕20秒之后再开始</span></span><br><span class="line"><span class="comment">#            initialDelaySeconds: 20</span></span><br><span class="line">            <span class="comment"># 之后每10秒进行一次健康检查</span></span><br><span class="line"><span class="comment">#            periodSeconds: 10</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8088</span></span><br><span class="line">          <span class="attr">resources:</span> <span class="string">&#123;</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 83：创建资源</span></span><br><span class="line">$ kubectl create -f 23-monitor-deploy.yaml </span><br><span class="line">service/yueyang-monitor-svc created</span><br><span class="line">deployment.apps/yueyang-monitor-deployment created</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 84：查看资源</span></span><br><span class="line">$ kubectl get -f 23-monitor-deploy.yaml </span><br><span class="line">NAME                          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/yueyang-monitor-svc   ClusterIP   10.96.120.182   &lt;none&gt;        8088/TCP   47s</span><br><span class="line"></span><br><span class="line">NAME                                         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/yueyang-monitor-deployment   1/1     1            1           47s</span><br></pre></td></tr></table></figure>

<h3 id="2-nacos-验证monitor-是否注册"><a href="#2-nacos-验证monitor-是否注册" class="headerlink" title="2. nacos 验证monitor 是否注册"></a>2. nacos 验证monitor 是否注册</h3><p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/32.png" alt="image-20240925020731221"></p>
<h3 id="3-设置svc-NodePort类型-暴露monitor服务"><a href="#3-设置svc-NodePort类型-暴露monitor服务" class="headerlink" title="3. 设置svc NodePort类型 暴露monitor服务"></a>3. 设置svc NodePort类型 暴露monitor服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 85：修改svc 类型</span></span><br><span class="line">$ kubectl edit svc  yueyang-monitor-svc -n yueyang-cloud</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/33.png" alt="image-20240925021851440"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 86：查看svc</span></span><br><span class="line">$ kubectl get svc -n yueyang-cloud</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/34.png" alt="image-20240925021952232"></p>
<p>浏览器访问：<a href="http://192.168.174.30:32200" target="_blank" rel="noopener">http://192.168.174.30:32200</a></p>
<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/35.png" alt="image-20240925022032439"></p>
<blockquote>
<p>用户名：xiaohh         密码：123456</p>
</blockquote>
<p><img src="/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/36.png" alt="image-20240925022124720"></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">L66</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://l66stbz.github.io/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/">https://l66stbz.github.io/2024/09/23/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/spring%20cloud%20k8s%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%8B%A5%E4%BE%9D/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://l66stbz.github.io" target="_blank">L66</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a></div><div class="post_share"><div class="social-share" data-image="https://l66stbz.github.io/2024/09/23/spring cloud k8s容器化部署/spring cloud k8s容器化部署若依/1.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/2024/09/20/Kubernetes%E6%8C%81%E4%B9%85%E5%8C%96%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8/08-Kubernetes%E6%8C%81%E4%B9%85%E5%8C%96%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8/"><img class="next_cover" src="https://l66stbz.github.io/2024/09/20/Kubernetes持久化文件存储/08-Kubernetes持久化文件存储/1.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Kubernetes持久化文件存储</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2024/09/17/kubernetes HPA自动扩缩/05-kubernetes HPA自动扩缩/" title="Kubernetes HPA自动扩缩"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/17/kubernetes HPA自动扩缩/05-kubernetes HPA自动扩缩/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-17</div><div class="relatedPosts_title">Kubernetes HPA自动扩缩</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/13/Kubernetes基础概念/01-Kubernetes基础概念/" title="Kubernetes基础概念"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/13/Kubernetes基础概念/01-Kubernetes基础概念/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-13</div><div class="relatedPosts_title">Kubernetes基础概念</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/14/Kubernetes容器编排工具部署（adm）/02-Kubernetes容器编排工具部署（adm）/" title="Kubernetes容器编排工具部署（adm）"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/14/Kubernetes容器编排工具部署（adm）/02-Kubernetes容器编排工具部署（adm）/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-14</div><div class="relatedPosts_title">Kubernetes容器编排工具部署（adm）</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/15/kubernetes 二进制高可用安装部署（v1.23+）/kubernetes 二进制高可用安装部署（v1.23+）/" title="kubernetes 二进制高可用安装部署（v1.23+）"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/15/kubernetes 二进制高可用安装部署（v1.23+）/kubernetes 二进制高可用安装部署（v1.23+）/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-15</div><div class="relatedPosts_title">kubernetes 二进制高可用安装部署（v1.23+）</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/19/Kubernetes RBAC细粒度权限划分/07-Kubernetes RBAC细粒度权限划分/" title="Kubernetes RBAC细粒度权限划分"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/19/Kubernetes RBAC细粒度权限划分/07-Kubernetes RBAC细粒度权限划分/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-19</div><div class="relatedPosts_title">Kubernetes RBAC细粒度权限划分</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/20/Kubernetes持久化文件存储/08-Kubernetes持久化文件存储/" title="Kubernetes持久化文件存储"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/20/Kubernetes持久化文件存储/08-Kubernetes持久化文件存储/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-20</div><div class="relatedPosts_title">Kubernetes持久化文件存储</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By L66</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/js/third-party/click_heart.js"></script></body></html>