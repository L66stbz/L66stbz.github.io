<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kubernetes容器编排工具部署（adm） | L66</title><meta name="description" content="Kubernetes容器编排adm部署 [TOC] 1、kubernetes组件信息1.1 Master节点组件 *APIServer *：是整个集群的控制中枢，提供集群中各个模块之间的数据交换，并将集群状态和信息存储到分布式键-值(key-value)存储系统Etcd集群中。同时它也是集群管理、资源配额、提供完备的集群安全机制的入口，为集群各类资源对象提供增删改查以及watch的REST API"><meta name="keywords" content="Linux,Kubernetes"><meta name="author" content="L66"><meta name="copyright" content="L66"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/3.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Kubernetes容器编排工具部署（adm）"><meta name="twitter:description" content="Kubernetes容器编排adm部署 [TOC] 1、kubernetes组件信息1.1 Master节点组件 *APIServer *：是整个集群的控制中枢，提供集群中各个模块之间的数据交换，并将集群状态和信息存储到分布式键-值(key-value)存储系统Etcd集群中。同时它也是集群管理、资源配额、提供完备的集群安全机制的入口，为集群各类资源对象提供增删改查以及watch的REST API"><meta name="twitter:image" content="https://l66stbz.github.io/2024/09/14/Kubernetes容器编排工具部署（adm）/02-Kubernetes容器编排工具部署（adm）/1.png"><meta property="og:type" content="article"><meta property="og:title" content="Kubernetes容器编排工具部署（adm）"><meta property="og:url" content="https://l66stbz.github.io/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/"><meta property="og:site_name" content="L66"><meta property="og:description" content="Kubernetes容器编排adm部署 [TOC] 1、kubernetes组件信息1.1 Master节点组件 *APIServer *：是整个集群的控制中枢，提供集群中各个模块之间的数据交换，并将集群状态和信息存储到分布式键-值(key-value)存储系统Etcd集群中。同时它也是集群管理、资源配额、提供完备的集群安全机制的入口，为集群各类资源对象提供增删改查以及watch的REST API"><meta property="og:image" content="https://l66stbz.github.io/2024/09/14/Kubernetes容器编排工具部署（adm）/02-Kubernetes容器编排工具部署（adm）/1.png"><meta property="article:published_time" content="2024-09-14T13:50:00.000Z"><meta property="article:modified_time" content="2024-09-26T12:41:30.009Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://l66stbz.github.io/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/"><link rel="prev" title="kubernetes 二进制高可用安装部署（v1.23+）" href="https://l66stbz.github.io/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/"><link rel="next" title="Kubernetes基础概念" href="https://l66stbz.github.io/2024/09/13/Kubernetes%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/01-Kubernetes%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="APlayer.min.css"><div id="aplayer"></div><script src="https://cdn.jsdelivr.net/gh/radium-bit/res@master/live2d/autoload.js" async></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js" async></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="L66" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/2.jpg" onerror="onerror=null;src='/img/2.jpg'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">67</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">37</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/photo/"><i class="fa-fw fa fa-film"></i><span> Photo</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes容器编排adm部署"><span class="toc-number">1.</span> <span class="toc-text">Kubernetes容器编排adm部署</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1、kubernetes组件信息"><span class="toc-number">2.</span> <span class="toc-text">1、kubernetes组件信息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-Master节点组件"><span class="toc-number">2.1.</span> <span class="toc-text">1.1 Master节点组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-Node节点组件"><span class="toc-number">2.2.</span> <span class="toc-text">1.2 Node节点组件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2、安装初始化"><span class="toc-number">3.</span> <span class="toc-text">2、安装初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-所有节点中都需要执行-初始化环境"><span class="toc-number">3.1.</span> <span class="toc-text">2.1 所有节点中都需要执行(初始化环境)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-安装kubernetes组件（v1-23-Master-and-Node）"><span class="toc-number">3.2.</span> <span class="toc-text">2.2 安装kubernetes组件（v1.23 Master and Node）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-集群初始化"><span class="toc-number">3.3.</span> <span class="toc-text">2.3 集群初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-初始化yaml文件-Master01"><span class="toc-number">3.3.1.</span> <span class="toc-text">2.3.1 初始化yaml文件(Master01)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-拉取kubernetes组件镜像"><span class="toc-number">3.4.</span> <span class="toc-text">2.4 拉取kubernetes组件镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-Calico网络插件安装-Master01"><span class="toc-number">3.5.</span> <span class="toc-text">2.5 Calico网络插件安装(Master01)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-生成新的token-key值"><span class="toc-number">3.6.</span> <span class="toc-text">2.6 生成新的token key值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-Metrics-server部署-Master01"><span class="toc-number">3.7.</span> <span class="toc-text">2.7 Metrics  server部署(Master01)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-8-修改Kube-proxy改为ipvs模式-k8s-master01"><span class="toc-number">3.8.</span> <span class="toc-text">2.8 修改Kube-proxy改为ipvs模式(k8s-master01)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3、kubernetes常用命令"><span class="toc-number">4.</span> <span class="toc-text">3、kubernetes常用命令</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3、Kubernetes中Pod概念"><span class="toc-number">5.</span> <span class="toc-text">3、Kubernetes中Pod概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-简介（Pod具有命名空间隔离性）"><span class="toc-number">5.0.1.</span> <span class="toc-text">3.1 简介（Pod具有命名空间隔离性）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Pod的类型"><span class="toc-number">5.0.2.</span> <span class="toc-text">3.2 Pod的类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-Pause容器"><span class="toc-number">5.0.2.1.</span> <span class="toc-text">3.2.1 Pause容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-静态Pod"><span class="toc-number">5.0.2.2.</span> <span class="toc-text">3.2.2 静态Pod</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-定义一个Pod"><span class="toc-number">5.0.3.</span> <span class="toc-text">3.3 定义一个Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-Kubernetes修改Pod内容器的启动命令"><span class="toc-number">5.0.4.</span> <span class="toc-text">3.4 Kubernetes修改Pod内容器的启动命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-Pod的创建过程"><span class="toc-number">5.0.5.</span> <span class="toc-text">3.5  Pod的创建过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-Pod的删除过程"><span class="toc-number">5.0.6.</span> <span class="toc-text">3.6 Pod的删除过程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4、kubernetes中Pod的各种状态"><span class="toc-number">6.</span> <span class="toc-text">4、kubernetes中Pod的各种状态</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5、kubernetes中Pod的镜像拉取策略"><span class="toc-number">7.</span> <span class="toc-text">5、kubernetes中Pod的镜像拉取策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-简介"><span class="toc-number">7.0.1.</span> <span class="toc-text">5.1 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-更改镜像拉取策略为lfNotPresent"><span class="toc-number">7.0.2.</span> <span class="toc-text">5.2 更改镜像拉取策略为lfNotPresent</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-更改镜像拉取策略为Always"><span class="toc-number">7.0.3.</span> <span class="toc-text">5.3 更改镜像拉取策略为Always</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-更改镜像拉取策略为Never"><span class="toc-number">7.0.4.</span> <span class="toc-text">5.4 更改镜像拉取策略为Never</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6、kubernetes中Pod的重启策略"><span class="toc-number">8.</span> <span class="toc-text">6、kubernetes中Pod的重启策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-简介"><span class="toc-number">8.0.1.</span> <span class="toc-text">6.1 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-指定重启策略为Always"><span class="toc-number">8.0.2.</span> <span class="toc-text">6.2 指定重启策略为Always:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-指定重启策略为OnFailure"><span class="toc-number">8.0.3.</span> <span class="toc-text">6.3 指定重启策略为OnFailure:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-指定重启策略为Never"><span class="toc-number">8.0.4.</span> <span class="toc-text">6.4 指定重启策略为Never:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7、kubernetes中Pod的健康检查"><span class="toc-number">9.</span> <span class="toc-text">7、kubernetes中Pod的健康检查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-简介"><span class="toc-number">9.0.1.</span> <span class="toc-text">7.1 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-Pod的探针"><span class="toc-number">9.0.2.</span> <span class="toc-text">7.2 Pod的探针</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-1-StartupProbe和LivenessProbe的区别"><span class="toc-number">9.0.2.1.</span> <span class="toc-text">7.2.1 StartupProbe和LivenessProbe的区别</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-Pod的四种探针方式（HTTPGetAction建议生产使用）"><span class="toc-number">9.0.3.</span> <span class="toc-text">7.3 Pod的四种探针方式（HTTPGetAction建议生产使用）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3-1-LivenessProbe和ReadinessProbe探针配置"><span class="toc-number">9.0.3.1.</span> <span class="toc-text">7.3.1 LivenessProbe和ReadinessProbe探针配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3-2-StartupProbe探针配置"><span class="toc-number">9.0.3.2.</span> <span class="toc-text">7.3.2 StartupProbe探针配置</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8、Pod平滑退出配置-倒钩"><span class="toc-number">10.</span> <span class="toc-text">8、Pod平滑退出配置 倒钩</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-简介"><span class="toc-number">10.0.1.</span> <span class="toc-text">8.1 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-PreStop钩子配置"><span class="toc-number">10.0.2.</span> <span class="toc-text">8.2 PreStop钩子配置</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://l66stbz.github.io/2024/09/14/Kubernetes容器编排工具部署（adm）/02-Kubernetes容器编排工具部署（adm）/1.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">L66</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/photo/"><i class="fa-fw fa fa-film"></i><span> Photo</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Kubernetes容器编排工具部署（adm）</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2024-09-14 21:50:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2024-09-14</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2024-09-26 20:41:30"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2024-09-26</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Kubernetes容器编排adm部署"><a href="#Kubernetes容器编排adm部署" class="headerlink" title="Kubernetes容器编排adm部署"></a>Kubernetes容器编排adm部署</h1><hr>
<p>[TOC]</p>
<h1 id="1、kubernetes组件信息"><a href="#1、kubernetes组件信息" class="headerlink" title="1、kubernetes组件信息"></a>1、kubernetes组件信息</h1><h2 id="1-1-Master节点组件"><a href="#1-1-Master节点组件" class="headerlink" title="1.1 Master节点组件"></a>1.1 Master节点组件</h2><ul>
<li>*<em>APIServer *</em>：是整个集群的控制中枢，提供集群中各个模块之间的数据交换，并将集群状态和信息存储到分布式键-值(key-value)存储系统Etcd集群中。同时它也是集群管理、资源配额、提供完备的集群安全机制的入口，为集群各类资源对象提供增删改查以及watch的REST API接口。</li>
<li><strong>Scheduler - Scheduler</strong>：是集群Pod的调度中心，主要是通过调度算法将Pod分配到最佳的Node节点，它通过APIServer监听所有Pod的状态，一旦发现新的未被调度到任何Node节点的Pod( PodSpec.NodeName为空），就会根据一系列策略选择最佳节点进行调度。</li>
<li><strong>Controller Manager</strong> ：是集群状态管理器，以保证Pod或其他资源达到期望值。当集群中某个Pod的副本数或其他资源因故障和错误导致无法正常运行，没有达到设定的值时，Controller Manager会尝试自动修复并使其达到期望状态。</li>
<li><strong>Etcd -Etcd</strong>：由Coreos开发，用于可靠地存储集群的配置数据，是一种持久性、轻量型、分布式的键-值（key-value）数据存储组件，作为Kubernetes集群的持久化存储系统。</li>
</ul>
<h2 id="1-2-Node节点组件"><a href="#1-2-Node节点组件" class="headerlink" title="1.2 Node节点组件"></a>1.2 Node节点组件</h2><ul>
<li><strong>Kubelet</strong>：负责与Master通信协作，管理该节点上的Pod，对容器进行健康检查及监控，同时负责玊报节点和节点上面Pod的状态。</li>
<li><strong>Kube-Proxy</strong>：负责各Pod之间的通信和负载均衡，将指定的流量分发到后端正确的机器上。Runtime:负责容器的管理。</li>
<li><strong>CoreDNS</strong>：用于Kubernetes集群内部Service的解析，可以让Pod把Service名称解析成Service的IP，然后通过service的IP地址进行连接到对应的应用上。</li>
<li><strong>Calico</strong>：符合CNI标准的一个网络插件，它负责给每个Pod分配一个不会重复的IP，并且把每个节点当做一各“路由器”，这样一个节点的Pod就可以通过IP地址访问到其他节点的Pod。</li>
</ul>
<h1 id="2、安装初始化"><a href="#2、安装初始化" class="headerlink" title="2、安装初始化"></a>2、安装初始化</h1><p>⚠️：<strong>生产环境当中一般选择3台master。</strong></p>
<p>​         <strong>Master节点和Worker节点的IP地址网段区分开；防止后期由于业务增长，节点资源需要扩充，方便运维管理。</strong></p>
<table>
<thead>
<tr>
<th>role</th>
<th>ipaddress</th>
<th>configure</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master01（etcd )</td>
<td>192.168.174.110</td>
<td>4 core, 4Gb; 50GBS, CentOS 7.9</td>
</tr>
<tr>
<td>k8s-node01</td>
<td>192.168.174.120</td>
<td>4 core, 16Gb; 100GBS, CentOS 7.9</td>
</tr>
<tr>
<td>k8s-node02</td>
<td>192.168.174.121</td>
<td>4 core, 16Gb; 100GBS, CentOS 7.9</td>
</tr>
</tbody></table>
<h2 id="2-1-所有节点中都需要执行-初始化环境"><a href="#2-1-所有节点中都需要执行-初始化环境" class="headerlink" title="2.1 所有节点中都需要执行(初始化环境)"></a>2.1 所有节点中都需要执行(初始化环境)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 关闭防火墙及安全策略</span></span><br><span class="line">$ systemctl <span class="built_in">disable</span> --now firewalld NetworkManager</span><br><span class="line">$ sed -ri <span class="string">"s/^SELINUX=enforcing/SELINUX=disabled/"</span> /etc/selinux/config</span><br><span class="line">$ setenforce 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 禁用swap分区</span></span><br><span class="line">$ swapoff -a &amp;&amp; sysctl -w vm.swappiness=0 &amp;&amp; sed -ri <span class="string">'/^[^#]*swap/s@^@#@'</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 修改本地解析</span></span><br><span class="line">$ cat &lt;&lt;-EOF &gt;&gt;/etc/hosts</span><br><span class="line">192.168.174.20     k8s-master01</span><br><span class="line">192.168.174.21     k8s-node01</span><br><span class="line">192.168.174.22     k8s-node02</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 修改YUM源并且安装epel源（中国科技大学或者阿里源）</span></span><br><span class="line">$ curl -o /etc/yum.repos.d/docker-ce.repo https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">$ sed -i <span class="string">'s#download.docker.com#mirrors.ustc.edu.cn/docker-ce#'</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"></span><br><span class="line">$ sed -e <span class="string">'s|^mirrorlist=|#mirrorlist=|g'</span> \</span><br><span class="line">    -e <span class="string">'s|^#baseurl=http://mirror.centos.org/centos|baseurl=https://mirrors.ustc.edu.cn/centos|g'</span> \</span><br><span class="line">    -i.bak \</span><br><span class="line">    /etc/yum.repos.d/CentOS-Base.repo</span><br><span class="line"></span><br><span class="line">$ yum clean all &amp;&amp; yum -y install epel-release</span><br><span class="line"></span><br><span class="line">$ sed -e <span class="string">'s|^metalink=|#metalink=|g'</span> \</span><br><span class="line">    -e <span class="string">'s|^#baseurl=https\?://download.fedoraproject.org/pub/epel/|baseurl=https://mirrors.ustc.edu.cn/epel/|g'</span> \</span><br><span class="line">    -e <span class="string">'s|^#baseurl=https\?://download.example/pub/epel/|baseurl=https://mirrors.ustc.edu.cn/epel/|g'</span> \</span><br><span class="line">    -i.bak \</span><br><span class="line">    /etc/yum.repos.d/epel.repo</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 安装kubernetes的YUM源（阿里云）(v1.23+)</span></span><br><span class="line">$ cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line">$ yum makecache fast</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 或者v1.24以下的需安装一下源</span></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 更新系统内rpm软件包(除内核外)</span></span><br><span class="line">$ yum -y update --exclude=kernel*</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看docker版本</span></span><br><span class="line">$ yum list docker-ce.x86_64 --showduplicates | sort -r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 安装所需要的服务及依赖(安装Docker是需到github.com/kubernetes中查看当版本适应什么版本的Docker)</span></span><br><span class="line">$ yum -y install wget jq psmisc vim net-tools telnet yum-utils \</span><br><span class="line">               device-mapper-persistent-data lvm2 git ntpdate \</span><br><span class="line">               ipvsadm ipset sysstat conntrack libseccomp \</span><br><span class="line">               docker-ce-20.10.* docker-ce-cli-20.10.* containerd </span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 校准时间修改上海时区并且加到开机自启</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"*/5 * * * *        ntpdate -b ntp.aliyun.com"</span> &gt;&gt;/var/spool/cron/root</span><br><span class="line">$ ln -sf /usr/share/zoneinfo/Asia/Shanghai  /etc/localtime</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'ASia/Shanghai'</span> &gt; /etc/tiomezone</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 服务器之间进行免密验证方便后期进行文件传输,选做</span></span><br><span class="line">$ ssh-keygen -t rsa</span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> k8s-node01 k8s-node02;<span class="keyword">do</span> ssh-copy-id -i .ssh/id_rsa.pub <span class="variable">$i</span>;<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 设置最大文件打开数</span></span><br><span class="line">$ cat &lt;&lt;-EOF &gt;&gt;/etc/security/limits.conf</span><br><span class="line">* soft nofile 655360</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft nproc 655350</span><br><span class="line">* hard nproc 655350</span><br><span class="line">* soft memlock unlimited</span><br><span class="line">* hard memlock unlimited</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 生成ipvs内核配置</span></span><br><span class="line">$ cat &lt;&lt;-EOF &gt;&gt;/etc/modules-load.d/ipvs.conf</span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_lc</span><br><span class="line">ip_vs_wlc</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_lblc</span><br><span class="line">ip_vs_lblcr</span><br><span class="line">ip_vs_dh</span><br><span class="line">ip_vs_sh</span><br><span class="line">ip_vs_fo</span><br><span class="line">ip_vs_nq</span><br><span class="line">ip_vs_sed</span><br><span class="line">ip_vs_ftp</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br><span class="line">ip_tables</span><br><span class="line">ip_set</span><br><span class="line">xt_set</span><br><span class="line">ipt_set</span><br><span class="line">ipt_rpfilter</span><br><span class="line">ipt_REJECT</span><br><span class="line">ipip</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; k8s内核配置项</span></span><br><span class="line">$ cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line">net.ipv4.conf.all.route_localnet = 1</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_watches=89100</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">net.ipv4.tcp_keepalive_time = 600</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.tcp_keepalive_intvl =15</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 36000</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_max_orphans = 327680</span><br><span class="line">net.ipv4.tcp_orphan_retries = 3</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line">net.ipv4.ip_conntrack_max = 65536</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line">net.ipv4.tcp_timestamps = 0</span><br><span class="line">net.core.somaxconn = 16384</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ systemctl <span class="built_in">enable</span> --now docker.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 设置Docker镜像加速器并且修改systemd作为cgroug的驱动</span></span><br><span class="line">$ cat &lt;&lt;-EOF &gt;/etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 重新加载Docker的配置文件且重启</span></span><br><span class="line">$ systemctl daemon-reload &amp;&amp; systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 升级所有节点的内核（v4.19+）,Kubernetes官网推荐内核版本</span></span><br><span class="line">$ yum -y localinstall kernel-m*</span><br><span class="line">$ grub2-set-default 0 &amp;&amp; grub2-mkconfig -o /etc/grub2.cfg</span><br><span class="line">$ grubby --args=<span class="string">"user_namespace.enable=1"</span> --update-kernel=<span class="string">"<span class="variable">$(grubby --default-kernel)</span>"</span></span><br><span class="line">$ reboot</span><br></pre></td></tr></table></figure>

<h2 id="2-2-安装kubernetes组件（v1-23-Master-and-Node）"><a href="#2-2-安装kubernetes组件（v1-23-Master-and-Node）" class="headerlink" title="2.2 安装kubernetes组件（v1.23 Master and Node）"></a>2.2 安装kubernetes组件（v1.23 Master and Node）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 查看组件的版本信息</span></span><br><span class="line">$ yum list kubeadm.x86_64 --showduplicates | sort -r</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; Master节点执行</span></span><br><span class="line">$ yum install -y  kubeadm-1.23*  kubelet-1.23* kubectl-1.23*</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; Node节点执行</span></span><br><span class="line">$ yum install -y  kubeadm-1.23*  kubelet-1.23*</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看kubeadm版本</span></span><br><span class="line">$ kubeadm version</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 将所有kubelet配置成systemd作为cgroug驱动，保持系统稳定。（Docker亦是如此）</span></span><br><span class="line">$ cat &lt;&lt;-EOF &gt;/etc/sysconfig/kubelet</span><br><span class="line">KUBELET_EXTRA_ARGS=<span class="string">"--cgroup-driver=systemd"</span></span><br><span class="line">EOF</span><br><span class="line">$ systemctl <span class="built_in">enable</span> --now kubelet</span><br></pre></td></tr></table></figure>

<blockquote>
<p>⚠️#为什么将kubelet配置成systemd作为cgroug驱动？<br>Kubernetes默认设置cgroup驱动（cgroupdriver） 为“systemd”，而Docker服务的cgroup驱动默认值为“cgroupfs”，建议将其修改为“systemd”，与Kubernetes保持一致。</p>
</blockquote>
<h2 id="2-3-集群初始化"><a href="#2-3-集群初始化" class="headerlink" title="2.3 集群初始化"></a>2.3 集群初始化</h2><h3 id="2-3-1-初始化yaml文件-Master01"><a href="#2-3-1-初始化yaml文件-Master01" class="headerlink" title="2.3.1 初始化yaml文件(Master01)"></a>2.3.1 初始化yaml文件(Master01)</h3><p>kubeadm的初始化控制平面（init）命令和加入节点（join）命令均可以通过指定的配置文件修改默认参数的值。kubeadm将配置文件以 ConfigMap形式保存到集群中，便于后续的查询和升级工作。</p>
<p>kubeadm config子命令提供了对这组功能的支持。 </p>
<ul>
<li>kubeadm config print init-defaults：输出kubeadm init命令默认参数的内容。 </li>
<li>kubeadm config print join-defaults：输出kubeadm join命令默认参数的内容。 </li>
<li>kubeadm config migrate：在新旧版本之间进行配置转换。 </li>
<li>kubeadm config images list：列出所需的镜像列表。 </li>
<li>kubeadm config images pull：拉取镜像到本地。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># vim /root/kubeadm-config.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- groups:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: abcdef.0123456789abcdef</span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 192.168.174.110</span><br><span class="line">  bindPort: 6443</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  name: k8s-master01</span><br><span class="line">  taints:</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/master</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:</span><br><span class="line">  - 192.168.174.110</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controlPlaneEndpoint: 192.168.174.110:6443</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.23.17</span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  podSubnet: 172.168.0.0/16</span><br><span class="line">  serviceSubnet: 10.96.0.0/16</span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line"></span><br><span class="line">⚠️:配置文件参数需要修改，修改前备份，或者直接用命令行直接生成新的配置文件，但是仍需要修改配置文件中的参数</span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubeadm config print init-defaults &gt;/root/kubeadm-config.yaml</span></span><br><span class="line">  ⚠️配置文件需改参数 </span><br><span class="line">      advertiseAddress: 192.168.174.140   <span class="comment"># Master01 的ip地址</span></span><br><span class="line">      name: k8s-master01                <span class="comment"># Master01 的主机名</span></span><br><span class="line">      - 192.168.174.110                   <span class="comment"># master01 ip地址</span></span><br><span class="line">      controlPlaneEndpoint: 192.168.174.110:6443   <span class="comment"># master01 ip地址:端口</span></span><br><span class="line">      imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers <span class="comment">#镜像仓库地址(阿里)</span></span><br><span class="line">      kubernetesVersion: v1.23.17        <span class="comment"># kubernetes的版本号</span></span><br><span class="line">      podSubnet: 172.168.0.0/16           <span class="comment"># Pod 的网段地址</span></span><br><span class="line">      serviceSubnet: 10.96.0.0/12        <span class="comment"># service 的网段地址 </span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 生成新的初始化文件(可以不生成，区别不大)</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubeadm config migrate --old-config kubeadm-config.yaml --new-config new.yaml</span></span><br></pre></td></tr></table></figure>

<h2 id="2-4-拉取kubernetes组件镜像"><a href="#2-4-拉取kubernetes组件镜像" class="headerlink" title="2.4 拉取kubernetes组件镜像"></a>2.4 拉取kubernetes组件镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 拉取初始化所需要的镜像文件（根据当前配置文件拉去所需要的配置文件）(Master01)</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubeadm config images pull --config new.yaml</span></span><br><span class="line">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.23.17</span><br><span class="line">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.23.17</span><br><span class="line">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.23.17</span><br><span class="line">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.23.17</span><br><span class="line">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6</span><br><span class="line">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.6-0</span><br><span class="line">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.6</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 初始化集群（生成安全证书并且生成node节点加入集群中的哈希码）(Master01)</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubeadm init --config new.yaml --upload-certs</span></span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line">  mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line">You can now join any number of the control-plane node running the following <span class="built_in">command</span> on each as root:</span><br><span class="line">  </span><br><span class="line">  kubeadm join 192.168.174.140:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:65e8558fcc0d9964de4ce8de880182df2de6e03d6b3402724e35ab7ff8482033 \</span><br><span class="line">    --control-plane --certificate-key d4be6bdc8043c565516325e270525e24e7ed6ed6c200f836be2bd52f2ad1ab11</span><br><span class="line"></span><br><span class="line">Please note that the certificate-key gives access to cluster sensitive data, keep it secret!</span><br><span class="line">As a safeguard, uploaded-certs will be deleted <span class="keyword">in</span> two hours; If necessary, you can use</span><br><span class="line"><span class="string">"kubeadm init phase upload-certs --upload-certs"</span> to reload certs afterward.</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.174.140:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:65e8558fcc0d9964de4ce8de880182df2de6e03d6b3402724e35ab7ff8482033</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 如果初始化失败，重置后再次初始化，命令如下（没有失败不要执行）</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubeadm reset -f ; ipvsadm --clear  ; rm -rf ~/.kube</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 所有Node节点执行</span></span><br><span class="line">[root@k8s-node01 ~]<span class="comment"># kubeadm join 192.168.174.140:6443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:65e8558fcc0d9964de4ce8de880182df2de6e03d6b3402724e35ab7ff8482033</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; k8s-master01执行</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># mkdir -p $HOME/.kube</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; Master01执行查看node状态</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get nodes</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>kubeadm init命令在执行具体的安装操作之前，会执行一系列被称 为pre-flight checks的系统预检查，以确保主机环境符合安装要求，如果检查失败就直接终止，不再进行init操作。</p>
</blockquote>
<h2 id="2-5-Calico网络插件安装-Master01"><a href="#2-5-Calico网络插件安装-Master01" class="headerlink" title="2.5 Calico网络插件安装(Master01)"></a>2.5 Calico网络插件安装(Master01)</h2><p>​          Calico网站：<a href="https://projectcalico.docs.tigera.io" target="_blank" rel="noopener">https://projectcalico.docs.tigera.io</a></p>
<p>​              ⚠️ ：注意kubernetes和calico之间的版本关联；详细信息去官网查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># cd /root/ &amp;&amp; git clone  https://gitee.com/BRWYZ/kubernetes_install.git</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># cd /root/kubernetes_install &amp;&amp; git checkout v1.23+  &amp;&amp; cd calico/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 修改calico配置文件中Pod的网段</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># POD_SUBNET=`cat /etc/kubernetes/manifests/kube-controller-manager.yaml | grep cluster-cidr= | awk -F= '&#123;print $NF&#125;'`</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># sed -i "s#POD_CIDR#$&#123;POD_SUBNET&#125;#g" calico.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建calico容器</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl apply -f calico.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Pod的信息</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po -n kube-system</span></span><br><span class="line"> NAME                                       READY   STATUS    RESTARTS        AGE</span><br><span class="line">calico-kube-controllers-6f6595874c-kqvbc   1/1     Running   0               2m15s</span><br><span class="line">calico-node-f2kgm                          1/1     Running   0               2m15s</span><br><span class="line">calico-node-gh9vh                          1/1     Running   0               2m15s</span><br><span class="line">calico-typha-6b6cf8cbdf-g8cl7              1/1     Running   0               2m15s</span><br><span class="line">coredns-65c54cc984-7jp42                   1/1     Running   0               11h</span><br><span class="line">coredns-65c54cc984-cgcbb                   1/1     Running   0               11h</span><br><span class="line">etcd-k8s-master01                          1/1     Running   1 (5m20s ago)   11h</span><br><span class="line">kube-apiserver-k8s-master01                1/1     Running   1 (5m20s ago)   11h</span><br><span class="line">kube-controller-manager-k8s-master01       1/1     Running   1 (5m20s ago)   11h</span><br><span class="line">kube-proxy-rpp8q                           1/1     Running   1 (5m17s ago)   11h</span><br><span class="line">kube-proxy-z5p22                           1/1     Running   1 (5m20s ago)   11h</span><br><span class="line">kube-scheduler-k8s-master01                1/1     Running   1 (5m20s ago)   11h</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt;  官网下载calico的yaml文件</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment">#curl https://docs.projectcalico.org/archive/v3.18/manifests/calico-typha.yaml -o calico.yaml</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># vim /root/calico.yaml</span></span><br><span class="line">  <span class="comment">#修改处</span></span><br><span class="line">    - name: CALICO_IPV4POOL_CIDR</span><br><span class="line">               value: <span class="string">"172.168.0.0/16"</span>  <span class="comment">#Pod的网段</span></span><br><span class="line">             Disable file logging so `kubectl logs` works.</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 生成calico的yaml文件（部署calico网络插件）</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl apply -f calico.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt;  查看是否拉取成功</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po -n kube-system</span></span><br></pre></td></tr></table></figure>



<h2 id="2-6-生成新的token-key值"><a href="#2-6-生成新的token-key值" class="headerlink" title="2.6 生成新的token key值"></a>2.6 生成新的token key值</h2><p>​             ⚠️：由于生成的token值有效期较短，或者有新的master或者node节点需要添加集群当中，所以需要获取新的token值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 生成新的master的token值(一般不需要，三台master足够支撑)</span></span><br><span class="line">$ kubeadm init phase upload-cers --upload-certs</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 生成新的node的token值</span></span><br><span class="line">$ kubeadm token create --<span class="built_in">print</span>-join-command</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看token值过期时间（在/root/new.yaml文件中token: abcdef.0123456789abcdef对应bootstrap-token-abcdef）</span></span><br><span class="line">$ kubectl get secret -n kube-system</span><br><span class="line"> bootstrap-token-abcdef</span><br><span class="line">$ kubectl get secret bootstrap-token-abcdef -n kube-system -oyaml</span><br><span class="line">  找到 expiration: MjAyMi0xMS0yM1QxNDowNjowOFo=</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"MjAyMi0xMS0yM1QxNDowNjowOFo="</span> | base64 --decode</span><br></pre></td></tr></table></figure>

<h2 id="2-7-Metrics-server部署-Master01"><a href="#2-7-Metrics-server部署-Master01" class="headerlink" title="2.7 Metrics  server部署(Master01)"></a>2.7 Metrics  server部署(Master01)</h2><p>​            在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 将Master01节点的front-proxy-ca.crt复制到所有Node节点</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># scp /etc/kubernetes/pki/front-proxy-ca.crt k8s-node0&#123;1..2&#125;:/etc/kubernetes/pki/front-proxy-ca.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 安装Metrics server</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># cd kubernetes_install/kubeadm-metrics-server/</span></span><br><span class="line">[root@k8s-master01 kubeadm-metrics-server]<span class="comment"># kubectl  create -f comp.yaml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Metrics server状态</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po -n kube-system -l k8s-app=metrics-server</span></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">metrics-server-5cf8885b66-8j4nn   1/1     Running   0          46s</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看节点状态</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl top node</span></span><br><span class="line">  NAME           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">k8s-master01   295m         7%     1338Mi          34%       </span><br><span class="line">k8s-node01     140m         3%     782Mi           20%    </span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看pod的状态</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl top po -A</span></span><br><span class="line">  NAMESPACE     NAME                                       CPU(cores)   MEMORY(bytes)   </span><br><span class="line">kube-system   calico-kube-controllers-6f6595874c-kqvbc   3m           21Mi            </span><br><span class="line">kube-system   calico-node-f2kgm                          56m          109Mi           </span><br><span class="line">kube-system   calico-node-gh9vh                          64m          145Mi           </span><br><span class="line">kube-system   calico-typha-6b6cf8cbdf-g8cl7              4m           29Mi            </span><br><span class="line">kube-system   coredns-65c54cc984-7jp42                   3m           13Mi            </span><br><span class="line">kube-system   coredns-65c54cc984-cgcbb                   3m           16Mi            </span><br><span class="line">kube-system   etcd-k8s-master01                          24m          58Mi            </span><br><span class="line">kube-system   kube-apiserver-k8s-master01                104m         325Mi           </span><br><span class="line">kube-system   kube-controller-manager-k8s-master01       28m          57Mi            </span><br><span class="line">kube-system   kube-proxy-rpp8q                           1m           18Mi            </span><br><span class="line">kube-system   kube-proxy-z5p22                           1m           15Mi            </span><br><span class="line">kube-system   kube-scheduler-k8s-master01                6m           24Mi            </span><br><span class="line">kube-system   metrics-server-5cf8885b66-8j4nn            5m           19Mi</span><br></pre></td></tr></table></figure>

<h2 id="2-8-修改Kube-proxy改为ipvs模式-k8s-master01"><a href="#2-8-修改Kube-proxy改为ipvs模式-k8s-master01" class="headerlink" title="2.8 修改Kube-proxy改为ipvs模式(k8s-master01)"></a>2.8 修改Kube-proxy改为ipvs模式(k8s-master01)</h2><p>初始化集群的时注释了ipvs配置（Master01）,将 <code>kube-proxy</code> 模式从 <code>iptables</code> 修改为 <code>ipvs</code> 是为了提升性能和功能。</p>
<p><strong>详解：</strong></p>
<ol>
<li><strong>性能优势</strong>：<code>ipvs</code>可以更有效地处理大量并发连接。这使得它在高流量场景下表现更佳。更好地扩展以处理更多的服务和后端 pod，而 <code>iptables</code> 在规则数量非常多时，性能可能会显著下降。</li>
<li><strong>低延迟和高吞吐量</strong>：<code>ipvs</code> 通过在内核空间处理数据包，减少了用户空间和内核空间之间的切换，从而提高了数据包处理的效率，带来更低的延迟和更高的吞吐量。</li>
<li><strong>快速规则应用</strong>：<code>ipvs</code> 在处理和应用网络规则时速度更快，特别是在规则变更频繁的情况下。</li>
<li><strong>多种调度算法</strong>：<code>ipvs</code> 提供了多种负载均衡算法（如轮询、最小连接、最短延迟等），可以根据具体需求选择最合适的算法，而 <code>iptables</code> 则缺乏这种灵活性。</li>
<li><strong>稳定性</strong>：<code>ipvs</code> 的实现更加稳定，尤其是在大型集群中，它能更好地应对复杂的网络环境和高负载。</li>
<li><strong>简化的规则管理</strong>：<code>ipvs</code> 使用专用的内核模块管理规则，相比 <code>iptables</code> 更加简洁和高效。<code>iptables</code> 规则在处理和管理上会更加复杂，特别是当规则数量增多时。</li>
<li><strong>维护方便</strong>：<code>ipvs</code> 的规则结构更清晰，维护起来更为方便，不像 <code>iptables</code> 那样需要处理大量的规则链和复杂的规则匹配逻辑。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl edit cm kube-proxy -n kube-system</span></span><br><span class="line">  	<span class="comment"># 找到mode字段添加ipvs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 更新Kube-Proxy的Pod</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl patch daemonset kube-proxy -p "&#123;\"spec\":&#123;\"template\":&#123;\"metadata\":&#123;\"annotations\":&#123;\"date\":\"`date +'%s'`\"&#125;&#125;&#125;&#125;&#125;" -n kube-system</span></span><br><span class="line">  daemonset.apps/kube-proxy patched</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 验证Kube-Proxy模式</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># curl 127.0.0.1:10249/proxyMode</span></span><br><span class="line">ipvs</span><br></pre></td></tr></table></figure>



<h1 id="3、kubernetes常用命令"><a href="#3、kubernetes常用命令" class="headerlink" title="3、kubernetes常用命令"></a>3、kubernetes常用命令</h1><p>1.kubectl查看组件主从节点信息（apiserver是无状态的）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get leases -n kube-system</span><br></pre></td></tr></table></figure>

<p>2.kubectl创建一个容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubetctl create -f nginx.yaml</span><br></pre></td></tr></table></figure>

<p>3.kubectl查看Pod的状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get po nginx(Pod名称)</span><br></pre></td></tr></table></figure>

<p>4.kubectl run 创建一个Pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run nginx-run --image=nginx:1.21</span><br></pre></td></tr></table></figure>

<p>5.kubectl 查看Pod的IP地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get po nginx -owide</span><br></pre></td></tr></table></figure>

<p>6.kubectl生成一个nginx的yaml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run nginx --image=nginx:1.21 -oyaml --dry-run &gt; nginx.yaml</span><br></pre></td></tr></table></figure>

<p>7.kubectl 查看pod的apiversion的版本号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl api-resources | grep pod</span><br></pre></td></tr></table></figure>

<p>8.kubectl查看你kubernetes中的pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get po -n kube-system</span><br></pre></td></tr></table></figure>

<p>9.kubectl查看pod的信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe po nginx(Pod名称)</span><br></pre></td></tr></table></figure>

<p>10.kubectl查看Pod的日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs -f nginx(Pod名称) -n kube-system(命名空间)</span><br></pre></td></tr></table></figure>

<p>11.kubectl查看Pod的更新历史</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout <span class="built_in">history</span> deploy(命名空间) nginx（Pod的名称）--revision=3</span><br></pre></td></tr></table></figure>



<h1 id="3、Kubernetes中Pod概念"><a href="#3、Kubernetes中Pod概念" class="headerlink" title="3、Kubernetes中Pod概念"></a>3、Kubernetes中Pod概念</h1><p><img src="/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/2.png" alt="image-20240614195424071"></p>
<h3 id="3-1-简介（Pod具有命名空间隔离性）"><a href="#3-1-简介（Pod具有命名空间隔离性）" class="headerlink" title="3.1 简介（Pod具有命名空间隔离性）"></a>3.1 简介（Pod具有命名空间隔离性）</h3><p>​    <strong>Pod是Kubernetes中最重要的基本概念之一；每个Pod都有一个特殊的被称为“根容器”的Pause容器。Pause容器对应的镜像属于Kubernetes平台的一部分，除了Pause容器，<code>每个Pod都还包含一个或多个紧密相关的用户业务容器。</code></strong></p>
<img src="/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/3.png" alt="image-20240614193928309" style="zoom:50%;">

<p><strong>为什么Kubernetes会设计出一个全新的Pod概念并且Pod有这样特殊的组成结构？</strong></p>
<ul>
<li>为多进程之间的协作提供一个抽象模型，使用<strong>Pod作为基本的调度、复制等管理工作的最小单位，让多个应用进程能一起有效地调度和伸缩。</strong></li>
<li>Pod里的多个业务容器<code>共享Pause容器的IP</code>，<code>共享Pause容器挂接的Volume</code>，这样既简化了密切关联的业务容器之间的通信问题，也很好地解决了它们之间的文件共享问题。</li>
</ul>
<p>Kubernetes为每个Pod都<code>分配了唯一的IP地址</code>，称之为Pod IP，一个 Pod里的多个容器共享Pod IP地址。Kubernetes要求底层网络支持集群内任意两个Pod之间的TCP/IP直接通信，因此在 Kubernetes里，一个Pod里的容器与另外主机上的Pod容器能够直接通信。</p>
<h3 id="3-2-Pod的类型"><a href="#3-2-Pod的类型" class="headerlink" title="3.2 Pod的类型"></a>3.2 Pod的类型</h3><p>Pod其实有两种类型：<code>普通的Pod及静态Pod（Static Pod）</code>。后者比较特殊，它并没<code>被存放在Kubernetes的etcd中</code>，而是被存放在某个具体的Node上的一个具体文件中，并且只能在此Node上启动、运行。而普通的Pod一旦被创建，就会被放入etcd中存储，随后被Kubernetes Master 调度到某个具体的Node上并绑定（Binding），该Pod被对应的Node上的 kubelet进程实例化成一组相关的Docker容器并启动。在默认情况下，当Pod里的某个容器停止时，Kubernetes会自动检测到这个问题并且重新启动这个Pod（重启Pod里的所有容器），<strong>如果Pod所在的Node宕机，就会将这个Node上的所有Pod都重新调度到其他节点上。</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ll /etc/kubernetes/manifests/</span><br><span class="line">总用量 16</span><br><span class="line">-rw------- 1 root root 2328 6月  14 15:57 etcd.yaml</span><br><span class="line">-rw------- 1 root root 3395 6月  14 15:57 kube-apiserver.yaml</span><br><span class="line">-rw------- 1 root root 2892 6月  14 15:57 kube-controller-manager.yaml</span><br><span class="line">-rw------- 1 root root 1477 6月  14 15:57 kube-scheduler.yaml</span><br></pre></td></tr></table></figure>

<h4 id="3-2-1-Pause容器"><a href="#3-2-1-Pause容器" class="headerlink" title="3.2.1 Pause容器"></a>3.2.1 Pause容器</h4><p>​    Pod运行在一个被称为节点 （Node）的环境中，这个节点既可以是物理机，也可以是私有云或者公有云中的一个虚拟机，在一个节点上能够运行多个Pod；其次，<code>在每个Pod中都运行着一个特殊的被称为Pause的容器，其他容器则为业务容器</code>，这些业务容器<code>共享Pause容器的网络栈和Volume挂载卷</code>，因此它们之间的通信和数据交换更为高效，在设计时我们可以充分利用这一特性将一组密切相关的服务进程放入同一个Pod中；<code>但不推荐</code>。用pause镜像为每个Pod都创建一个容器。该<code>Pause容器用于接管Pod中所有其他容器的网络</code>。每创建一个新的Pod，kubelet 都会先创建一个Pause容器，然后创建其他容器。pause镜像大概有200KB，是个非常小的容器镜像。</p>
<p><strong>举例：</strong></p>
<p>​    首先，一个Pod内的所有容器都需要共用同一个IP地址，这就意味着一定要使用网络的容器映射模式。然而，为什么不能只启动1个容器，而将第2个容器关联到第1个容器呢？Kubernetes是从两方面来考虑这个问题的：首先，如果在Pod内有多个容器，则可能很难连接这些容器；其次，后面的容器还要依赖第1个被关联的容器，如果第2个容器关联到第1个容器，且第1个容器死掉的话，那么第2个容器也将无法正常提供服务。<code>启动一个基础容器，然后将Pod内的所有容器都连接到它上面会更容易一些。因为我们只需为基础的pause容器执行端口映射规则，这也简化了端口映射的过程。</code></p>
<p><img src="/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/4.png" alt="image-20240614201248670"></p>
<p><strong>上图有点儿取巧地显示了是pause容器将端口80的流量转发给了相关容器。而Pause容器只是看起来转发了网络流量，但它并没有真的这么做。实际上，应用容器直接监听了这些端口，和pause容器共享同一个网络堆栈。</strong></p>
<h4 id="3-2-2-静态Pod"><a href="#3-2-2-静态Pod" class="headerlink" title="3.2.2 静态Pod"></a>3.2.2 静态Pod</h4><p>​    静态Pod是由kubelet进行管理的仅存在于特定Node上的Pod。它们不能通过API Server进行管理，无法与ReplicationController、Deployment 或者DaemonSet进行关联，并且kubelet无法对它们进行健康检查。静态Pod总是由kubelet创建的，并且总在kubelet所在的Node上运行。</p>
<h3 id="3-3-定义一个Pod"><a href="#3-3-定义一个Pod" class="headerlink" title="3.3 定义一个Pod"></a>3.3 定义一个Pod</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 命令行创建一个Pod</span></span><br><span class="line">$ kubectl run <span class="built_in">test</span> --image=registry.cn-hangzhou.aliyuncs.com/hujiaming/nginx:1.24.0</span><br><span class="line">pod/nginx created</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 命令行编写一个Pod的yaml文件</span></span><br><span class="line">$ kubectl run nginx --image=registry.cn-hangzhou.aliyuncs.com/hujiaming/nginx:1.24.0 -oyaml --dry-run=client &gt; <span class="built_in">test</span>-pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看生成的文件</span></span><br><span class="line">$ vim <span class="built_in">test</span>-pod.yaml</span><br><span class="line">---</span><br><span class="line">apiVersion: v1		<span class="comment">#  api版本号</span></span><br><span class="line">kind: Pod			<span class="comment"># 资源类型 (Deployment|StatefulSet|Service) </span></span><br><span class="line">metadata:			<span class="comment"># 元数据信息</span></span><br><span class="line">  labels:			<span class="comment"># Pod标签</span></span><br><span class="line">    run: nginx		<span class="comment"># 标签形式 key=value</span></span><br><span class="line">  name: nginx		<span class="comment"># Pod名称</span></span><br><span class="line">spec:				<span class="comment"># 定义Pod声明</span></span><br><span class="line">  containers:		<span class="comment"># 配置容器位置（Pod管理容器）</span></span><br><span class="line">  - image: registry.cn-hangzhou.aliyuncs.com/hujiaming/nginx:1.24.0		<span class="comment"># 容器镜像版本</span></span><br><span class="line">    name: nginx		<span class="comment"># 容器名称</span></span><br><span class="line">  restartPolicy: Always		<span class="comment"># 重启策略</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 通过yaml文件创建Pod</span></span><br><span class="line">$ kubectl apply -f <span class="built_in">test</span>-pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Pod的状态</span></span><br><span class="line">$ kubectl describe po nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Pod</span></span><br><span class="line">$ kubectl get po</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx   1/1     Running   0          4m10s</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 删除Pod</span></span><br><span class="line">$ kubectl delete po nginx</span><br><span class="line">pod <span class="string">"nginx"</span> deleted</span><br><span class="line">	<span class="comment"># 或者</span></span><br><span class="line">$ kubectl delete -f &lt;Pod资源清单/yaml文件&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看api版本号</span></span><br><span class="line">$ kubectl api-resources</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/5.png" alt="image-20240618201317406"></p>
<h3 id="3-4-Kubernetes修改Pod内容器的启动命令"><a href="#3-4-Kubernetes修改Pod内容器的启动命令" class="headerlink" title="3.4 Kubernetes修改Pod内容器的启动命令"></a>3.4 Kubernetes修改Pod内容器的启动命令</h3><p>​    简介：<strong>覆盖容器的默认启动命令。重新定义容器的启动命令或者添加新的参数。</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ vim <span class="built_in">test</span>-pod.yaml </span><br><span class="line">---</span><br><span class="line">apiVersion: v1   <span class="comment"># api版本号</span></span><br><span class="line">kind: Pod        <span class="comment"># 资源类型 Deployment/StatefulSet/Service</span></span><br><span class="line">metadata:		 <span class="comment"># 元数据信息</span></span><br><span class="line">  labels:  		 <span class="comment"># Pod标签</span></span><br><span class="line">    run: nginx   <span class="comment"># 标签形式 key=value</span></span><br><span class="line">  name: nginx    <span class="comment"># Pod名称</span></span><br><span class="line">spec:            <span class="comment"># 定义Pod声明</span></span><br><span class="line">  containers:    <span class="comment"># 配置容器位置（Pod管理容器）</span></span><br><span class="line">  - image: registry.cn-hangzhou.aliyuncs.com/hujiaming/nginx:1.24.0  <span class="comment"># 容器镜像版本</span></span><br><span class="line">    name: nginx          <span class="comment"># 容器名称，唯一性不能重复</span></span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">'ls'</span>,<span class="string">'/'</span>] </span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80   <span class="comment"># 容器端口，唯一性不能重复</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建Pod</span></span><br><span class="line">$ kubectl create -f <span class="built_in">test</span>-pod.yaml </span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Pod</span></span><br><span class="line">$ kubectl get po -owide</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/6.png" alt="image-20240618200945099"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试Pod连通性</span></span><br><span class="line">$ curl 172.16.32.131</span><br><span class="line">curl: (7) Failed connect to 172.16.32.131:80; 拒绝连接</span><br></pre></td></tr></table></figure>

<blockquote>
<p>思考题：为什么修改了容器的默认启动命令后，容器无法正常启动，且状态变成了<code>CrashLoopBackOff</code></p>
</blockquote>
<h3 id="3-5-Pod的创建过程"><a href="#3-5-Pod的创建过程" class="headerlink" title="3.5  Pod的创建过程"></a>3.5  <code>Pod的创建过程</code></h3><ol>
<li>用户通过 <strong>kubectl</strong> 命令行工具、Kubernetes API 或其他工具提交 Pod 定义（通常是一个 YAML 文件）给 Kubernetes 集群。</li>
<li>用户提交的 Pod 定义被发送到 Kubernetes API Server。</li>
<li>API Server 验证请求并将其存储在 etcd 中。</li>
<li>Scheduler 监视 etcd 中的新建 Pod 事件，并决定将 Pod 分配到哪个节点上运行。调度器考虑多种因素，包括资源需求、节点容量、节点健康状态、亲和性和反亲和性规则等。</li>
<li>调度器将调度决定（即 Pod 应该运行在哪个节点上）写回到 API Server，API Server 更新 etcd 中的 Pod 状态，将其绑定到指定节点。</li>
<li>每个节点上运行的 Kubelet 组件监视 etcd 中分配到该节点的 Pod。Kubelet 检测到新分配的 Pod 后，开始创建和管理 Pod 中的容器。</li>
<li>Kubelet 使用容器运行时（如 Docker、containerd 等）来拉取指定的镜像，并在节点上启动容器。</li>
<li>在启动容器时，Kubelet 会配置网络设置（通过 CNI 插件），挂载卷，并根据 Pod 定义的配置（如环境变量、ConfigMap、Secret 等）初始化容器。</li>
<li>如果 Pod 定义中配置了探针（LivenessProbe、ReadinessProbe），Kubelet 会定期执行这些探针来检测容器的健康状态。</li>
<li>容器启动并运行后，Kubelet 会持续监视容器的状态，并报告给 API Server。Kubelet 还会处理探针检测结果，根据需要重启容器或将其从服务负载均衡中移除。</li>
<li>整个过程中，Kubelet 不断地将容器的状态（如运行状态、资源使用情况、探针检测结果等）更新到 API Server，API Server 再将这些状态更新存储到 etcd 中。</li>
</ol>
<h3 id="3-6-Pod的删除过程"><a href="#3-6-Pod的删除过程" class="headerlink" title="3.6 Pod的删除过程"></a>3.6 <code>Pod的删除过程</code></h3><ol>
<li>用户通过 <code>kubectl</code> 命令行工具、Kubernetes API 或其他工具提交删除 Pod 的请求。</li>
<li>删除请求被发送到 Kubernetes API Server，API Server 验证并处理该请求。</li>
<li>API Server 将 Pod 的状态更新为 <code>Terminating</code> 并存储到 etcd 中。此时，Pod 仍然存在，但其状态表明正在进行删除操作。</li>
<li>如果 Pod 配置了 <code>PreStop</code> 钩子，Kubelet 会在终止容器前执行该钩子。<code>PreStop</code> 钩子可以是一个在容器内运行的命令或发送到指定 HTTP 端点的请求。</li>
<li>如果 Pod 配置了 <code>Readiness</code> 探针，Kubernetes 会将其从服务负载均衡器中移除，确保不再接受新的请求。</li>
<li>Kubelet 发送信号（如 SIGTERM）给容器，通知其终止进程。Kubelet 等待一段时间（由 <code>terminationGracePeriodSeconds</code> 定义，默认为 30 秒）以允许容器进行清理和优雅关闭。</li>
<li>如果容器在优雅终止期内未能退出，Kubelet 会发送强制终止信号（如 SIGKILL）来强制终止容器。</li>
<li>Kubelet 调用容器运行时（如 Docker、containerd 等）删除容器。容器的所有资源（如文件系统、网络等）也会被清理。</li>
<li>Kubelet 更新 Pod 的状态为已删除，并通知 API Server。API Server 将 Pod 的最终状态存储到 etcd 中。</li>
<li>API Server 从 etcd 中删除 Pod 的定义和状态信息。此时，Pod 从 Kubernetes 集群中完全消失。</li>
</ol>
<h1 id="4、kubernetes中Pod的各种状态"><a href="#4、kubernetes中Pod的各种状态" class="headerlink" title="4、kubernetes中Pod的各种状态"></a>4、kubernetes中Pod的各种状态</h1><ul>
<li><p><strong>Pending</strong>：Pod 已被 Kubernetes系统接收，但仍有一个或多个容器未被创建，可以通过kubectl describe查看处于Pending状态的原因（有可能请求的资源过大，无法调度；有可能挂载的东西不存在；有可能没有可用的节点；有可能节点异常）</p>
</li>
<li><p><strong>Running</strong>：Pod已经被绑定到一个节点上，并且所有的容器都已经被创建，而且至少有一个是运行状态，或者是正在启动或者重启，可以通过kubectl logs查看Pod的日志。</p>
</li>
<li><p><strong>Failed</strong>：所有容器都已终止，并且至少有一个容器以失败的方式终止，也就是说这个容器要么以非零状态退出，要么被系统终止，可以通过logs和 describe查看Pod日志和状态</p>
</li>
<li><p><strong>Succeeded</strong>：所有容器执行成功并终止，并且不会再次重启，可以通过kubectl logs查看Pod日志</p>
</li>
<li><p><strong>Unknown</strong>：通常是由于通信问题造成的无法获得Pod的状态</p>
</li>
<li><p><strong>ImagePullBackOff ErrlmagePull：</strong>镜像拉取失败，一般是由于镜像不存在、网络不通或者需要登录认证引起的，可以使用describe命令查看具体原因</p>
</li>
<li><p><strong>CrashLoopBackOff</strong>：容器启动失败，可以通过logs命令查看具体原因，一般为启动命令不正确，健康检查不通过等</p>
</li>
<li><p><strong>OOMKilled</strong>：容器内存溢出，一般是容器的内存Limit设置的过小,或者程序本身有内存溢出，可以通过logs查看程序启动日志</p>
</li>
<li><p><strong>Terminating</strong>：Pod正在被删除，可以通过describe查看状态</p>
</li>
<li><p><strong>SysctlForbidden</strong>：Pod自定义了内核配置，但 kubelet 没有添加内核配置或配置的内核参数不支持，可以通过describe查看具体原因</p>
</li>
<li><p><strong>Completed</strong>：容器内部主进程退出，一般计划任务执行结束会显示该状态，此时可以通过 logs查看容器日志</p>
</li>
<li><p><strong>ContainerCreating</strong>：Pod 正在创建，一般为正在下载镜像，或者有配置不当的地方，可以通过describe查看具体原因。</p>
</li>
</ul>
<h1 id="5、kubernetes中Pod的镜像拉取策略"><a href="#5、kubernetes中Pod的镜像拉取策略" class="headerlink" title="5、kubernetes中Pod的镜像拉取策略"></a>5、kubernetes中Pod的镜像拉取策略</h1><h3 id="5-1-简介"><a href="#5-1-简介" class="headerlink" title="5.1 简介"></a>5.1 简介</h3><p>​    在 Kubernetes 中，镜像拉取策略（Image Pull Policy）决定了 Kubernetes 节点如何从镜像仓库中拉取容器镜像策略。</p>
<p><strong>通过spec.containers[].imagePullPolicy参数可以指定镜像的拉取策略（latest为最新版本镜像）</strong></p>
<ul>
<li><strong>Always</strong>：总是拉取，每次创建Pod 时，Kubernetes 都会尝试从镜像仓库中拉取镜像。当镜像 tag为latest时，且imagePullPolicy未配置，默认为Always。适用于开发环境中频繁更新的镜像。</li>
<li><strong>Never</strong>：不管本地是否存在镜像都不会拉取。必须保证节点上已经存在所需的镜像。否则Pod启动失败。</li>
<li><strong>IfNotPresent</strong>：指定镜像版本在本地不存在时才去拉取镜像,如果tag为非latest,且 imagePullPolicy未配置,默认为IfNotPresent。</li>
</ul>
<h3 id="5-2-更改镜像拉取策略为lfNotPresent"><a href="#5-2-更改镜像拉取策略为lfNotPresent" class="headerlink" title="5.2 更改镜像拉取策略为lfNotPresent"></a><strong>5.2 更改镜像拉取策略为<code>lfNotPresent</code></strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># mkdir /root/imagePull  &amp;&amp;  cd /root/imagePull</span></span><br><span class="line">[root@k8s-master01 imagePull]<span class="comment"># vim nginx-ifnotpresent.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1	<span class="comment"># API的版本号</span></span><br><span class="line">kind: Pod		<span class="comment"># 类型Pod</span></span><br><span class="line">metadata:		<span class="comment"># 元数据</span></span><br><span class="line">  name: nginx-study		<span class="comment"># Pod名称</span></span><br><span class="line">spec:		<span class="comment"># 定义Pod的详细信息</span></span><br><span class="line">  containers:		<span class="comment"># 容器定义</span></span><br><span class="line">  - name: nginx-study	<span class="comment"># 容器名称</span></span><br><span class="line">    image: registry.cn-hangzhou.aliyuncs.com/hujiaming/nginx:1.24.0	 <span class="comment"># 容器所用的镜像的地址	</span></span><br><span class="line">    imagePullPolicy: IfNotPresent	 <span class="comment"># 镜像拉取策略</span></span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80 <span class="comment"># 容器的端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 启动容器</span></span><br><span class="line">[root@k8s-master01 imagePull]<span class="comment"># kubectl apply -f nginx-ifnotpresent.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Pod的详细信息</span></span><br><span class="line">[root@k8s-master01 imagePull]<span class="comment"># kubectl describe po nginx-study</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/7.png" alt="image-20240617204647224"></p>
<h3 id="5-3-更改镜像拉取策略为Always"><a href="#5-3-更改镜像拉取策略为Always" class="headerlink" title="5.3 更改镜像拉取策略为Always"></a><strong>5.3 更改镜像拉取策略为<code>Always</code></strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 删除旧的Pod</span></span><br><span class="line">[root@k8s-master01 imagePull]<span class="comment"># kubectl delete -f nginx-ifnotpresent.yaml </span></span><br><span class="line">pod <span class="string">"nginx-study"</span> deleted</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建新的文件</span></span><br><span class="line">[root@k8s-master01 imagePull]<span class="comment"># vim nginx-alway.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1  <span class="comment"># API的版本号</span></span><br><span class="line">kind: Pod               <span class="comment"># 类型Pod</span></span><br><span class="line">metadata:               <span class="comment"># 元数据</span></span><br><span class="line">  name: nginx-study           <span class="comment"># Pod名称</span></span><br><span class="line">spec:           <span class="comment"># 定义Pod的详细信息</span></span><br><span class="line">  containers:           <span class="comment"># 容器定义</span></span><br><span class="line">  - name: nginx-study   <span class="comment"># 容器名称</span></span><br><span class="line">    image: registry.cn-hangzhou.aliyuncs.com/hujiaming/nginx:1.24.0      <span class="comment"># 容器所用的镜像的地址 </span></span><br><span class="line">    imagePullPolicy: Always        <span class="comment"># 镜像拉取策略</span></span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80 <span class="comment"># 容器的端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建Pod</span></span><br><span class="line">[root@k8s-master01 imagePull]<span class="comment"># kubectl create -f nginx-alway.yaml </span></span><br><span class="line">pod/nginx-study created</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建Pod的详细信息</span></span><br><span class="line">[root@k8s-master01 imagePull]<span class="comment"># kubectl describe po nginx-study</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/8.png" alt="image-20240617205129600"></p>
<h3 id="5-4-更改镜像拉取策略为Never"><a href="#5-4-更改镜像拉取策略为Never" class="headerlink" title="5.4 更改镜像拉取策略为Never"></a><strong>5.4 更改镜像拉取策略为<code>Never</code></strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 删除旧的Pod</span></span><br><span class="line">[root@k8s-master01 imagePull]<span class="comment"># kubectl delete -f nginx-ifnotpresent.yaml </span></span><br><span class="line">pod <span class="string">"nginx-study"</span> deleted</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建新的文件</span></span><br><span class="line">[root@k8s-master01 imagePull]<span class="comment"># vim nginx-never.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1  <span class="comment"># API的版本号</span></span><br><span class="line">kind: Pod               <span class="comment"># 类型Pod</span></span><br><span class="line">metadata:               <span class="comment"># 元数据</span></span><br><span class="line">  name: nginx-study           <span class="comment"># Pod名称</span></span><br><span class="line">spec:           <span class="comment"># 定义Pod的详细信息</span></span><br><span class="line">  containers:           <span class="comment"># 容器定义</span></span><br><span class="line">  - name: nginx-study   <span class="comment"># 容器名称</span></span><br><span class="line">    image: registry.cn-hangzhou.aliyuncs.com/hujiaming/nginx:1.24.0      <span class="comment"># 容器所用的镜像的地址 </span></span><br><span class="line">    imagePullPolicy: Never        <span class="comment"># 镜像拉取策略</span></span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80 <span class="comment"># 容器的端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建Pod</span></span><br><span class="line">[root@k8s-master01 imagePull]<span class="comment"># kubectl create -f nginx-never.yaml </span></span><br><span class="line">pod/nginx-study created</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Pod</span></span><br><span class="line">[root@k8s-master01 imagePull]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME          READY   STATUS              RESTARTS   AGE</span><br><span class="line">nginx-study   0/1     ErrImageNeverPull   0          4s</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Pod详细信息</span></span><br><span class="line">[root@k8s-master01 imagePull]<span class="comment"># kubectl describe po nginx-study</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/9.png" alt="image-20240617205528785"></p>
<h1 id="6、kubernetes中Pod的重启策略"><a href="#6、kubernetes中Pod的重启策略" class="headerlink" title="6、kubernetes中Pod的重启策略"></a>6、kubernetes中Pod的重启策略</h1><h3 id="6-1-简介"><a href="#6-1-简介" class="headerlink" title="6.1 简介"></a>6.1 简介</h3><p>​    在 Kubernetes 中，Pod 的重启策略（<code>Restart Policy</code>）定义了 Pod 中的容器在失败或终止后的重启行为。</p>
<p><strong>可以使用<code>spec.restartPolicy</code>指定容器的重启策略操作方式（Always生产环境居多）</strong></p>
<ul>
<li><strong><code>Always</code></strong>：默认策略。无论容器的退出状态如何，Kubernetes 始终会重启容器。</li>
<li><strong>OnFailure</strong>：当容器以非零退出码（表示失败）终止时，Kubernetes 才会重启容器。</li>
<li><strong>Never</strong>：容器终止后不会被重启。</li>
</ul>
<h3 id="6-2-指定重启策略为Always"><a href="#6-2-指定重启策略为Always" class="headerlink" title="6.2 指定重启策略为Always:"></a><strong>6.2 指定重启策略为<code>Always</code>:</strong></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@k8s-master01</span> <span class="string">~]#</span> <span class="string">mkdir</span> <span class="string">restartPoilcy</span></span><br><span class="line"><span class="string">[root@k8s-master01</span> <span class="string">restartPolicy]#</span> <span class="string">vim</span> <span class="string">nginx-always.yaml</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming/nginx:1.24.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"10"</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span> 	<span class="comment"># Pod的重启策略</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建Pod</span></span><br><span class="line"><span class="string">[root@k8s-master01</span> <span class="string">restartPolicy]#</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">nginx-always.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Pod</span></span><br><span class="line"><span class="string">[root@k8s-master01</span> <span class="string">restartPolicy]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">po</span> </span><br><span class="line"><span class="string">NAME</span>    <span class="string">READY</span>   <span class="string">STATUS</span>             <span class="string">RESTARTS</span>      <span class="string">AGE</span></span><br><span class="line"><span class="string">nginx</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">CrashLoopBackOff</span>   <span class="number">6</span> <span class="string">(21s</span> <span class="string">ago)</span>   <span class="string">7m33s</span></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Pod启动记录</span></span><br><span class="line"><span class="string">[root@k8s-master01</span> <span class="string">restartPolicy]#</span> <span class="string">kubectl</span> <span class="string">describe</span> <span class="string">po</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/10.png" alt="image-20240619100659953"></p>
<h3 id="6-3-指定重启策略为OnFailure"><a href="#6-3-指定重启策略为OnFailure" class="headerlink" title="6.3 指定重启策略为OnFailure:"></a><strong>6.3 指定重启策略为<code>OnFailure</code>:</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt;&gt;&gt; 创建Pod</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl  delete po nginx</span></span><br><span class="line">pod <span class="string">"nginx"</span> deleted</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 编写资源清单</span></span><br><span class="line">[root@k8s-master01 restartPolicy]<span class="comment"># vim nginx-OnFailure.yaml </span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1 </span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: registry.cn-hangzhou.aliyuncs.com/hujiaming/nginx:1.24.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">    - sleep</span><br><span class="line">    - <span class="string">"10"</span></span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">  restartPolicy: OnFailure 	<span class="comment"># Pod的重启策略</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建Pod</span></span><br><span class="line">[root@k8s-master01 restartPolicy]<span class="comment"># kubectl create -f  nginx-OnFailure.yaml </span></span><br><span class="line">pod/nginx created</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Pod</span></span><br><span class="line">[root@k8s-master01 restartPolicy]<span class="comment"># kubectl get po </span></span><br><span class="line">NAME    READY   STATUS      RESTARTS   AGE</span><br><span class="line">nginx   0/1     Completed   0          14s</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Pod启动记录</span></span><br><span class="line">[root@k8s-master01 restartPolicy]<span class="comment"># kubectl describe po nginx</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/11.png" alt="image-20240619101111320"></p>
<blockquote>
<p>思考题：为什么查看Pod的状态的时候是<code>Completed</code>，但是kubernetes却没有重启该Pod呢？</p>
</blockquote>
<h3 id="6-4-指定重启策略为Never"><a href="#6-4-指定重启策略为Never" class="headerlink" title="6.4 指定重启策略为Never:"></a><strong>6.4 指定重启策略为<code>Never</code>:</strong></h3><p>略</p>
<h1 id="7、kubernetes中Pod的健康检查"><a href="#7、kubernetes中Pod的健康检查" class="headerlink" title="7、kubernetes中Pod的健康检查"></a>7、kubernetes中Pod的健康检查</h1><p><img src="/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/12.png" alt="image-20240917231740513"></p>
<h3 id="7-1-简介"><a href="#7-1-简介" class="headerlink" title="7.1 简介"></a>7.1 简介</h3><p>​    在 Kubernetes 中，探针（Probe）用于<code>检测 Pod 中容器的健康状态和生命周期管理</code>。探针可以帮助 Kubernetes 确保应用程序在运行中的健康状态，并在需要时采取适当的动作（如重启容器、将流量切换到健康的容器等）。Kubernetes对Pod的健康状态可以通过三类探针来检查：<code>LivenessProbe</code>、<code>ReadinessProbe</code>及<code>StartupProbe</code>，其中最主要的探针为 <code>LivenessProbe</code>与<code>ReadinessProbe</code>，kubelet会<code>定期执行</code>这两类探针来诊断容器的健康状况。</p>
<h3 id="7-2-Pod的探针"><a href="#7-2-Pod的探针" class="headerlink" title="7.2 Pod的探针"></a><strong>7.2 Pod的探针</strong></h3><ul>
<li><p><strong>StartupProbe</strong>：用于判断容器内应用程序是否已经启动。某些应用会遇到启动比较慢的情况，例如应用程序启动时需要与远程服务器建立网络连接，或者遇到网络访问较慢等情况时，会造成容器启动缓慢， 因为这属于<code>“有且仅有一次”</code>的超长延时，可以通过StartupProbe探针解决该问题。<strong>如果配置了startupProbe，就会先禁止其他的探针，直到它成功为止，成功后将不在进行探测。如果探针失败，kubelet则杀死容器，并且按照预先在<code>资源清单</code>中设定的<code>重启策略</code>重启容器。</strong></p>
</li>
<li><p><strong>LivenessProbe</strong>：<code>用于探测容器是否运行</code>，如果探测失败，kubelet会根据配置的重启策略进行相应的处理。若没有配置该探针，默认就是success。（存活探针，探针失败；按照预先在<code>资源清单</code>中设定的<code>重启策略</code>重启容器）</p>
</li>
<li><p><strong>ReadinessProbe</strong>：用于判断容器服务是否可用（Ready状态），达到Ready状态的Pod才可以接收请求。并且程序已经是可以接受流量的状态。对于被Service管理的 Pod，Service与Pod Endpoint的关联关系也将基于Pod是否Ready进行设置。如果在运行过程中Ready状态变为False，则系统自动将其从Service 的后端Endpoint列表中隔离出去，后续再把恢复到Ready状态的Pod加回后端Endpoint列表。这样就能保证客户端在访问Service时不会被转发到服务不可用的Pod实例上。需要注意的是，ReadinessProbe也是定期触发执行的，存在于Pod的整个生命周期中。（<strong>就绪探针，探针失败不会重启pod</strong>）</p>
</li>
</ul>
<h4 id="7-2-1-StartupProbe和LivenessProbe的区别"><a href="#7-2-1-StartupProbe和LivenessProbe的区别" class="headerlink" title="7.2.1 StartupProbe和LivenessProbe的区别"></a>7.2.1 StartupProbe和LivenessProbe的区别</h4><p>​    <strong>StartupProbe</strong>用于检测容器的启动是否完成，特别适用于启动时间较长的应用程序。在应用程序启动时间较长，可能超过默认的 <strong>LivenessProbe</strong> 超时时间，以防止应用程序在启动过程中被误判为不健康并被杀死。而<strong>StartupProbe</strong>可以预先设置推迟存活检测时间，如果配置了 <strong>StartupProbe</strong>，在其成功之前，<strong>LivenessProbe</strong> 将被禁用。一旦 <strong>StartupProbe</strong>成功，<strong>LivenessProbe</strong>开始工作。如果 <strong>StartupProbe</strong> 失败，容器将被重启。<code>其中最重要的一个作用StartupProbe在第一次探针完成后后续将不再执行探针，但是LivenessProbe将在容器的整个生命周期循环执行。</code></p>
<p><strong>StartupProbe</strong>：专注于应用程序启动阶段，防止应用程序启动时间较长时被误判为不健康。</p>
<p><strong>LivenessProbe</strong>：专注于应用程序的运行阶段，确保应用程序在运行过程中保持健康。</p>
<h3 id="7-3-Pod的四种探针方式（HTTPGetAction建议生产使用）"><a href="#7-3-Pod的四种探针方式（HTTPGetAction建议生产使用）" class="headerlink" title="7.3 Pod的四种探针方式（HTTPGetAction建议生产使用）"></a><strong>7.3 Pod的四种探针方式（HTTPGetAction建议生产使用）</strong></h3><ul>
<li><strong><code>ExecAction</code></strong>：在容器内执行一个命令，如果返回值为0，则认为容器健康。</li>
<li><strong><code>TCPSocketAction</code></strong>：通过TCP连接检查容器内的端口是否是通的，如果是通的就认为容器健康。</li>
<li><strong><code>HTTPGetAction</code></strong>：通过应用程序暴露的API地址来检查程序是否是正常的，如果状态码为200~400之间，则认为容器健康。</li>
<li><code>gRPC探针</code>：1.24版本之后开启</li>
</ul>
<h4 id="7-3-1-LivenessProbe和ReadinessProbe探针配置"><a href="#7-3-1-LivenessProbe和ReadinessProbe探针配置" class="headerlink" title="7.3.1 LivenessProbe和ReadinessProbe探针配置"></a>7.3.1 <code>LivenessProbe</code>和<code>ReadinessProbe</code>探针配置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@k8s-master01</span> <span class="string">~]#</span> <span class="string">mkdir</span> <span class="string">probe</span> <span class="string">&amp;&amp;</span> <span class="string">cd</span> <span class="string">probe/</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span> </span><br><span class="line"><span class="attr">spec:</span> 			</span><br><span class="line">  <span class="attr">containers:</span> 		</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming/nginx:1.24.0</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span> </span><br><span class="line">    <span class="attr">readinessProbe:</span> 	<span class="comment"># 就绪探针,一种探针只能同时使用一种探针方式</span></span><br><span class="line">        <span class="attr">httpGet:</span>          	<span class="comment"># URI接口检测方式</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/index.html</span>  	<span class="comment"># 检查路径</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">scheme:</span> <span class="string">HTTP</span>   	<span class="comment"># HTTP或者HTTPS </span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">15</span> 	<span class="comment"># 初始化时间，健康检查延迟执行时间</span></span><br><span class="line">        <span class="attr">timeoutSeconds:</span> <span class="number">3</span>  	<span class="comment"># 超时时间</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">15</span> 	<span class="comment"># 检测间隔</span></span><br><span class="line">        <span class="attr">successThreshold:</span> <span class="number">1</span>  <span class="comment"># 检查成功为1次表示就绪</span></span><br><span class="line">        <span class="attr">failureThreshold:</span> <span class="number">2</span>  <span class="comment"># 检测失败2次，切断流量，用户请求则不转发到该容器</span></span><br><span class="line">    <span class="attr">livenessProbe:</span> 			<span class="comment"># 存活探针，一种探针只能同时使用一种探针方式</span></span><br><span class="line">        <span class="attr">tcpSocket:</span>   		<span class="comment"># 端口检测方式</span></span><br><span class="line">          <span class="attr">port :</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">initialDelaySeconds:</span> <span class="number">15</span> 	<span class="comment"># 初始化时间</span></span><br><span class="line">        <span class="attr">timeoutSeconds:</span> <span class="number">3</span> 			<span class="comment"># 超时时间</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">15</span> 			<span class="comment"># 检测间隔</span></span><br><span class="line">        <span class="attr">successThreshold:</span> <span class="number">1</span> 		<span class="comment"># 检查成功为1次表示存活</span></span><br><span class="line">        <span class="attr">failureThreshold:</span> <span class="number">2</span> 		<span class="comment"># 检测失败2次则按照重启策略重启容器</span></span><br><span class="line">    <span class="attr">command:</span> 						<span class="comment"># 容器启动命令</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span> <span class="number">30</span><span class="string">;nginx</span> <span class="string">-g</span> <span class="string">"daemon off;"</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 创建Pod</span></span><br><span class="line"><span class="string">[root@k8s-master01</span> <span class="string">probe]#</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">nginx-probe.yaml</span></span><br></pre></td></tr></table></figure>



<h4 id="7-3-2-StartupProbe探针配置"><a href="#7-3-2-StartupProbe探针配置" class="headerlink" title="7.3.2 StartupProbe探针配置"></a><strong>7.3.2 <code>StartupProbe</code>探针配置</strong></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming/nginx:1.24.0</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">startupProbe:</span> <span class="comment"># 存活探针</span></span><br><span class="line">      <span class="attr">tcpSocket:</span>  <span class="comment"># 探针方式</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span>  <span class="comment"># 探针端口</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span> <span class="comment">#初始化时间，健康检查延迟执行时间(随着程序启动的长久来设定)</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">2</span>    <span class="comment"># 超时时间</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span>    <span class="comment"># 检测间隔</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="string">l</span>  <span class="comment"># 检查成功为1次表示存活</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">2</span>  <span class="comment"># 检测失败2次表示未存活</span></span><br><span class="line">    <span class="attr">readinessProbe:</span>       <span class="comment"># 就绪探针，三种检查方式同时只能使用一种。</span></span><br><span class="line">      <span class="attr">httpGet:</span>            <span class="comment"># 接口检测方式</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/index.html</span>    <span class="comment"># 检查路径</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span>          <span class="comment"># 检查端口</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span>  <span class="comment"># 初始化时间，健康检查延迟执行时间</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">2</span>     <span class="comment"># 超时时间</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span>     <span class="comment"># 检测间隔</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span>  <span class="comment">#检查成功为1次表示就绪</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">2</span>  <span class="comment">#检测失败2次表示未就绪</span></span><br><span class="line">    <span class="attr">livenessProbe:</span>        <span class="comment"># 存活探针</span></span><br><span class="line">      <span class="attr">tcpSocket:</span>          <span class="comment"># 端口检测方式</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span>    <span class="comment"># 初始化时间</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">2</span>        <span class="comment"># 超时时间</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span>        <span class="comment"># 检测间隔</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span>     <span class="comment"># 检查成功为1次表示就绪</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">2</span>      <span class="comment"># 检测失败2次表示未就绪</span></span><br><span class="line">    <span class="attr">command:</span>      <span class="comment"># 容器启动执行的命令</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"10"</span></span><br><span class="line">    <span class="attr">ports:</span>         <span class="comment"># 容器端口</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span>     <span class="comment"># 容器端口号</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>



<h1 id="8、Pod平滑退出配置-倒钩"><a href="#8、Pod平滑退出配置-倒钩" class="headerlink" title="8、Pod平滑退出配置 倒钩"></a>8、Pod平滑退出配置 倒钩</h1><p><img src="/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/13.png" alt="image-20240917233535831"></p>
<p>kubernetes默认设置Pod退出宽限期为30s，但也可以自定义。配置代码处如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/hujiaming/nginx:1.24.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">mkdir</span> <span class="string">/data/</span></span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">sleep</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span>   <span class="comment"># Pod平滑退出宽限期，默认30s</span></span><br></pre></td></tr></table></figure>

<ul>
<li>当 Kubernetes 终止一个 Pod 时，会触发 <code>PreStop</code> 钩子，同时开始计时宽限期（例如 30 秒）。</li>
<li>容器会接收到 SIGTERM 信号，进入关闭状态，同时 Kubernetes 等待容器的正常退出。</li>
<li>如果 Pod 在宽限期内（30 秒）完成了生命周期钩子的执行并干净地关闭了，那么 Pod 将被成功终止。</li>
<li>如果宽限期到达时，Pod 仍然没有停止，将会再次的得到2s的宽限期。2s后，Kubernetes 将发送 SIGKILL 信号，强制终止 Pod。</li>
</ul>
<h3 id="8-1-简介"><a href="#8-1-简介" class="headerlink" title="8.1 简介"></a>8.1 简介</h3><p>​    在 Kubernetes 中，<code>preStop</code> 钩子是 Pod 生命周期管理的一部分。它允许你在容器终止之前运行一个命令或脚本，用于优雅地关闭服务、关闭连接或清理资源。<code>preStop</code> 钩子是在 Pod 中定义的生命周期钩子之一。当容器收到终止信号时，<code>preStop</code> 钩子会在容器实际终止前执行。</p>
<h3 id="8-2-PreStop钩子配置"><a href="#8-2-PreStop钩子配置" class="headerlink" title="8.2 PreStop钩子配置"></a>8.2 PreStop钩子配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># vim pod-prestop.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1 </span><br><span class="line">kind: Pod </span><br><span class="line">metadata: </span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers: </span><br><span class="line">  - name: nginx </span><br><span class="line">    image: registry.cn-hangzhou.aliyuncs.com/hujiaming/nginx:1.24.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    lifecycle:</span><br><span class="line">      postStart: <span class="comment"># 容器创建完成后执行的指令, 可以是 exec httpGet TCPSocket</span></span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>:</span><br><span class="line">          - sh</span><br><span class="line">          - -c</span><br><span class="line">          - <span class="string">'mkdir /data/'</span></span><br><span class="line">      preStop:</span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>:</span><br><span class="line">          - sh</span><br><span class="line">          - -c</span><br><span class="line">          - psleep 10  </span><br><span class="line">    ports:</span><br><span class="line">      - containerPort: 80</span><br><span class="line">  restartPolicy: Never</span><br><span class="line">  </span><br><span class="line"><span class="comment">#&gt;&gt;&gt;创建Pod</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl  create  -f pod-prestop.yaml </span></span><br><span class="line">pod/nginx created</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt;查看Pod</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po </span></span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx   1/1     Running   0          6s</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 删除Pod</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl delete po nginx </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Pod状态</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po </span></span><br><span class="line">NAME    READY   STATUS        RESTARTS   AGE</span><br><span class="line">nginx   1/1     Terminating   0          22s</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt;&gt;&gt; 查看Pod的停止记录</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl  describe po nginx</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/14.png" alt="image-20240619200553178"></p>
<blockquote>
<p>注意：在容器创建之后，容器的<code>Entrypoint</code>执行之前，这时候Pod已经被调度到某台node上，被某个 kubelet管理了，这时候kubelet会调用postStart操作，该操作跟容器的启动命令是在同步执行的，也就是说在postStart操作执行完成之前，kubelet会锁住容器，不让应用程序的进程启动，只有在 postStart操作完成之后容器的状态才会被设置成为RUNNING。</p>
</blockquote>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">L66</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://l66stbz.github.io/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/">https://l66stbz.github.io/2024/09/14/Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/02-Kubernetes%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7%E9%83%A8%E7%BD%B2%EF%BC%88adm%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://l66stbz.github.io" target="_blank">L66</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a></div><div class="post_share"><div class="social-share" data-image="https://l66stbz.github.io/2024/09/23/spring cloud k8s容器化部署/spring cloud k8s容器化部署若依/1.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2024/09/15/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%88v1.23+%EF%BC%89/"><img class="prev_cover" src="https://l66stbz.github.io/2024/09/15/kubernetes 二进制高可用安装部署（v1.23+）/kubernetes 二进制高可用安装部署（v1.23+）/1.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">kubernetes 二进制高可用安装部署（v1.23+）</div></div></a></div><div class="next-post pull_right"><a href="/2024/09/13/Kubernetes%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/01-Kubernetes%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/"><img class="next_cover" src="https://l66stbz.github.io/2024/09/13/Kubernetes基础概念/01-Kubernetes基础概念/1.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Kubernetes基础概念</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2024/09/23/spring cloud k8s容器化部署/spring cloud k8s容器化部署若依/" title="spring cloud k8s容器化部署"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/23/spring cloud k8s容器化部署/spring cloud k8s容器化部署若依/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-23</div><div class="relatedPosts_title">spring cloud k8s容器化部署</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/13/Kubernetes基础概念/01-Kubernetes基础概念/" title="Kubernetes基础概念"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/13/Kubernetes基础概念/01-Kubernetes基础概念/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-13</div><div class="relatedPosts_title">Kubernetes基础概念</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/15/kubernetes 二进制高可用安装部署（v1.23+）/kubernetes 二进制高可用安装部署（v1.23+）/" title="kubernetes 二进制高可用安装部署（v1.23+）"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/15/kubernetes 二进制高可用安装部署（v1.23+）/kubernetes 二进制高可用安装部署（v1.23+）/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-15</div><div class="relatedPosts_title">kubernetes 二进制高可用安装部署（v1.23+）</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/19/Kubernetes RBAC细粒度权限划分/07-Kubernetes RBAC细粒度权限划分/" title="Kubernetes RBAC细粒度权限划分"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/19/Kubernetes RBAC细粒度权限划分/07-Kubernetes RBAC细粒度权限划分/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-19</div><div class="relatedPosts_title">Kubernetes RBAC细粒度权限划分</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/20/Kubernetes持久化文件存储/08-Kubernetes持久化文件存储/" title="Kubernetes持久化文件存储"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/20/Kubernetes持久化文件存储/08-Kubernetes持久化文件存储/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-20</div><div class="relatedPosts_title">Kubernetes持久化文件存储</div></div></a></div><div class="relatedPosts_item"><a href="/2024/09/18/Kubernetes配置管理/06-Kubernetes配置管理/" title="Kubernetes配置管理"><img class="relatedPosts_cover" src="https://l66stbz.github.io/2024/09/18/Kubernetes配置管理/06-Kubernetes配置管理/1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2024-09-18</div><div class="relatedPosts_title">Kubernetes配置管理</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By L66</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/js/third-party/click_heart.js"></script></body></html>